function logErr(a){return a?Meteor._debug("Exception in callback of async function",a.stack?a.stack:a):void 0}function useSetImmediate(){if(global.setImmediate){var a=function(a){global.setImmediate(a)};return a.implementation="setImmediate",a}return null}function usePostMessage(){function a(a,b){return"string"==typeof a&&a.substring(0,b.length)===b}function b(b){if(b.source===global&&a(b.data,g)){var c=b.data.substring(g.length);try{f[c]&&f[c]()}finally{delete f[c]}}}if(!global.postMessage||global.importScripts)return null;var c=!0,d=global.onmessage;if(global.onmessage=function(){c=!1},global.postMessage("","*"),global.onmessage=d,!c)return null;var e=0,f={},g="Meteor._setImmediate."+Math.random()+".";global.addEventListener?global.addEventListener("message",b,!1):global.attachEvent("onmessage",b);var h=function(a){++e,f[e]=a,global.postMessage(g+e,"*")};return h.implementation="postMessage",h}function useTimeout(){var a=function(a){global.setTimeout(a,0)};return a.implementation="setTimeout",a}if(__meteor_runtime_config__={},Meteor={isClient:!0,isServer:!1,isCordova:!1},"object"==typeof __meteor_runtime_config__&&__meteor_runtime_config__.PUBLIC_SETTINGS&&(Meteor.settings={"public":__meteor_runtime_config__.PUBLIC_SETTINGS}),Meteor.isServer)var Future=Npm.require("fibers/future");"object"==typeof __meteor_runtime_config__&&__meteor_runtime_config__.meteorRelease&&(Meteor.release=__meteor_runtime_config__.meteorRelease),_.extend(Meteor,{_get:function(a){for(var b=1;b<arguments.length;b++){if(!(arguments[b]in a))return void 0;a=a[arguments[b]]}return a},_ensure:function(a){for(var b=1;b<arguments.length;b++){var c=arguments[b];c in a||(a[c]={}),a=a[c]}return a},_delete:function(a){for(var b=[a],c=!0,d=1;d<arguments.length-1;d++){var e=arguments[d];if(!(e in a)){c=!1;break}if(a=a[e],"object"!=typeof a)break;b.push(a)}for(var d=b.length-1;d>=0;d--){var e=arguments[d+1];if(c)c=!1;else for(var f in b[d][e])return;delete b[d][e]}},wrapAsync:function(a,b){return function(){for(var c,d=b||this,e=_.toArray(arguments),f=e.length-1;f>=0;--f){var g=e[f],h=typeof g;if("undefined"!==h){"function"===h&&(c=g);break}}if(!c){if(Meteor.isClient)c=logErr;else{var i=new Future;c=i.resolver()}++f}e[f]=Meteor.bindEnvironment(c);var j=a.apply(d,e);return i?i.wait():j}},_inherits:function(a,b){for(var c in b)_.has(b,c)&&(a[c]=b[c]);var d=function(){this.constructor=a};return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a}});var warnedAboutWrapAsync=!1;Meteor._wrapAsync=function(){return warnedAboutWrapAsync||(Meteor._debug("Meteor._wrapAsync has been renamed to Meteor.wrapAsync"),warnedAboutWrapAsync=!0),Meteor.wrapAsync.apply(Meteor,arguments)};var global=this;Meteor._setImmediate=useSetImmediate()||usePostMessage()||useTimeout();var withoutInvocation=function(a){if(Package.ddp){var b=Package.ddp.DDP._CurrentInvocation;if(b.get()&&b.get().isSimulation)throw new Error("Can't set timers inside simulations");return function(){b.withValue(null,a)}}return a},bindAndCatch=function(a,b){return Meteor.bindEnvironment(withoutInvocation(b),a)};_.extend(Meteor,{setTimeout:function(a,b){return setTimeout(bindAndCatch("setTimeout callback",a),b)},setInterval:function(a,b){return setInterval(bindAndCatch("setInterval callback",a),b)},clearInterval:function(a){return clearInterval(a)},clearTimeout:function(a){return clearTimeout(a)},defer:function(a){Meteor._setImmediate(bindAndCatch("defer callback",a))}}),Meteor.makeErrorType=function(a,b){var c=function(){var d=this;if(Error.captureStackTrace)Error.captureStackTrace(d,c);else{var e=new Error;e.__proto__=c.prototype,e instanceof c&&(d=e)}return b.apply(d,arguments),d.errorType=a,d};return Meteor._inherits(c,Error),c},Meteor.Error=Meteor.makeErrorType("Meteor.Error",function(a,b,c){var d=this;d.error=a,d.reason=b,d.details=c,d.message=d.reason?d.reason+" ["+d.error+"]":"["+d.error+"]"}),Meteor.Error.prototype.clone=function(){var a=this;return new Meteor.Error(a.error,a.reason,a.details)},Meteor._noYieldsAllowed=function(a){return a()},Meteor._SynchronousQueue=function(){var a=this;a._tasks=[],a._running=!1,a._runTimeout=null},_.extend(Meteor._SynchronousQueue.prototype,{runTask:function(a){var b=this;if(!b.safeToRunTask())throw new Error("Could not synchronously run a task from a running task");b._tasks.push(a);var c=b._tasks;b._tasks=[],b._running=!0,b._runTimeout&&(clearTimeout(b._runTimeout),b._runTimeout=null);try{for(;!_.isEmpty(c);){var d=c.shift();try{d()}catch(e){if(_.isEmpty(c))throw e;Meteor._debug("Exception in queued task: "+e.stack)}}}finally{b._running=!1}},queueTask:function(a){var b=this;b._tasks.push(a),b._runTimeout||(b._runTimeout=setTimeout(_.bind(b.flush,b),0))},flush:function(){var a=this;a.runTask(function(){})},drain:function(){var a=this;if(a.safeToRunTask())for(;!_.isEmpty(a._tasks);)a.flush()},safeToRunTask:function(){var a=this;return!a._running}});var suppress=0;Meteor._debug=function(){if(suppress)return void suppress--;if("undefined"!=typeof console&&"undefined"!=typeof console.log)if(0==arguments.length)console.log("");else if("function"==typeof console.log.apply){for(var a=!0,b=0;b<arguments.length;b++)"string"!=typeof arguments[b]&&(a=!1);a?console.log.apply(console,[Array.prototype.join.call(arguments," ")]):console.log.apply(console,arguments)}else if("function"==typeof Function.prototype.bind){var c=Function.prototype.bind.call(console.log,console);c.apply(console,arguments)}else Function.prototype.call.call(console.log,console,Array.prototype.slice.call(arguments))},Meteor._suppress_log=function(a){suppress+=a},Meteor._supressed_log_expected=function(){return 0!==suppress};for(var BASE_64_CHARS="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",BASE_64_VALS={},i=0;i<BASE_64_CHARS.length;i++)BASE_64_VALS[BASE_64_CHARS.charAt(i)]=i;Base64={},Base64.encode=function(a){if("string"==typeof a){var b=a;a=Base64.newBinary(b.length);for(var c=0;c<b.length;c++){var d=b.charCodeAt(c);if(d>255)throw new Error("Not ascii. Base64.encode can only take ascii strings.");a[c]=d}}for(var e=[],f=null,g=null,h=null,i=null,c=0;c<a.length;c++)switch(c%3){case 0:f=a[c]>>2&63,g=(3&a[c])<<4;break;case 1:g|=a[c]>>4&15,h=(15&a[c])<<2;break;case 2:h|=a[c]>>6&3,i=63&a[c],e.push(getChar(f)),e.push(getChar(g)),e.push(getChar(h)),e.push(getChar(i)),f=null,g=null,h=null,i=null}return null!=f&&(e.push(getChar(f)),e.push(getChar(g)),e.push(null==h?"=":getChar(h)),null==i&&e.push("=")),e.join("")};var getChar=function(a){return BASE_64_CHARS.charAt(a)},getVal=function(a){return"="===a?-1:BASE_64_VALS[a]};Base64.newBinary=function(a){if("undefined"==typeof Uint8Array||"undefined"==typeof ArrayBuffer){for(var b=[],c=0;a>c;c++)b.push(0);return b.$Uint8ArrayPolyfill=!0,b}return new Uint8Array(new ArrayBuffer(a))},Base64.decode=function(a){var b=Math.floor(3*a.length/4);"="==a.charAt(a.length-1)&&(b--,"="==a.charAt(a.length-2)&&b--);for(var c=Base64.newBinary(b),d=null,e=null,f=null,g=0,h=0;h<a.length;h++){var i=a.charAt(h),j=getVal(i);switch(h%4){case 0:if(0>j)throw new Error("invalid base64 string");d=j<<2;break;case 1:if(0>j)throw new Error("invalid base64 string");d|=j>>4,c[g++]=d,e=(15&j)<<4;break;case 2:j>=0&&(e|=j>>2,c[g++]=e,f=(3&j)<<6);break;case 3:j>=0&&(c[g++]=f|j)}}return c},EJSON={},EJSONTest={};var customTypes={};EJSON.addType=function(a,b){if(_.has(customTypes,a))throw new Error("Type "+a+" already present");customTypes[a]=b};var isInfOrNan=function(a){return _.isNaN(a)||a===1/0||a===-(1/0)},builtinConverters=[{matchJSONValue:function(a){return _.has(a,"$date")&&1===_.size(a)},matchObject:function(a){return a instanceof Date},toJSONValue:function(a){return{$date:a.getTime()}},fromJSONValue:function(a){return new Date(a.$date)}},{matchJSONValue:function(a){return _.has(a,"$InfNaN")&&1===_.size(a)},matchObject:isInfOrNan,toJSONValue:function(a){var b;return b=_.isNaN(a)?0:a===1/0?1:-1,{$InfNaN:b}},fromJSONValue:function(a){return a.$InfNaN/0}},{matchJSONValue:function(a){return _.has(a,"$binary")&&1===_.size(a)},matchObject:function(a){return"undefined"!=typeof Uint8Array&&a instanceof Uint8Array||a&&_.has(a,"$Uint8ArrayPolyfill")},toJSONValue:function(a){return{$binary:Base64.encode(a)}},fromJSONValue:function(a){return Base64.decode(a.$binary)}},{matchJSONValue:function(a){return _.has(a,"$escape")&&1===_.size(a)},matchObject:function(a){return _.isEmpty(a)||_.size(a)>2?!1:_.any(builtinConverters,function(b){return b.matchJSONValue(a)})},toJSONValue:function(a){var b={};return _.each(a,function(a,c){b[c]=EJSON.toJSONValue(a)}),{$escape:b}},fromJSONValue:function(a){var b={};return _.each(a.$escape,function(a,c){b[c]=EJSON.fromJSONValue(a)}),b}},{matchJSONValue:function(a){return _.has(a,"$type")&&_.has(a,"$value")&&2===_.size(a)},matchObject:function(a){return EJSON._isCustomType(a)},toJSONValue:function(a){var b=Meteor._noYieldsAllowed(function(){return a.toJSONValue()});return{$type:a.typeName(),$value:b}},fromJSONValue:function(a){var b=a.$type;if(!_.has(customTypes,b))throw new Error("Custom EJSON type "+b+" is not defined");var c=customTypes[b];return Meteor._noYieldsAllowed(function(){return c(a.$value)})}}];EJSON._isCustomType=function(a){return a&&"function"==typeof a.toJSONValue&&"function"==typeof a.typeName&&_.has(customTypes,a.typeName())};var adjustTypesToJSONValue=EJSON._adjustTypesToJSONValue=function(a){if(null===a)return null;var b=toJSONValueHelper(a);return void 0!==b?b:"object"!=typeof a?a:(_.each(a,function(b,c){if("object"==typeof b||void 0===b||isInfOrNan(b)){var d=toJSONValueHelper(b);return d?void(a[c]=d):void adjustTypesToJSONValue(b)}}),a)},toJSONValueHelper=function(a){for(var b=0;b<builtinConverters.length;b++){var c=builtinConverters[b];if(c.matchObject(a))return c.toJSONValue(a)}return void 0};EJSON.toJSONValue=function(a){var b=toJSONValueHelper(a);return void 0!==b?b:("object"==typeof a&&(a=EJSON.clone(a),adjustTypesToJSONValue(a)),a)};var adjustTypesFromJSONValue=EJSON._adjustTypesFromJSONValue=function(a){if(null===a)return null;var b=fromJSONValueHelper(a);return b!==a?b:"object"!=typeof a?a:(_.each(a,function(b,c){if("object"==typeof b){var d=fromJSONValueHelper(b);if(b!==d)return void(a[c]=d);adjustTypesFromJSONValue(b)}}),a)},fromJSONValueHelper=function(a){if("object"==typeof a&&null!==a&&_.size(a)<=2&&_.all(a,function(a,b){return"string"==typeof b&&"$"===b.substr(0,1)}))for(var b=0;b<builtinConverters.length;b++){var c=builtinConverters[b];if(c.matchJSONValue(a))return c.fromJSONValue(a)}return a};EJSON.fromJSONValue=function(a){var b=fromJSONValueHelper(a);return b===a&&"object"==typeof a?(a=EJSON.clone(a),adjustTypesFromJSONValue(a),a):b},EJSON.stringify=function(a,b){var c=EJSON.toJSONValue(a);return b&&(b.canonical||b.indent)?EJSON._canonicalStringify(c,b):JSON.stringify(c)},EJSON.parse=function(a){if("string"!=typeof a)throw new Error("EJSON.parse argument should be a string");return EJSON.fromJSONValue(JSON.parse(a))},EJSON.isBinary=function(a){return!!("undefined"!=typeof Uint8Array&&a instanceof Uint8Array||a&&a.$Uint8ArrayPolyfill)},EJSON.equals=function(a,b,c){var d,e=!(!c||!c.keyOrderSensitive);if(a===b)return!0;if(_.isNaN(a)&&_.isNaN(b))return!0;if(!a||!b)return!1;if("object"!=typeof a||"object"!=typeof b)return!1;if(a instanceof Date&&b instanceof Date)return a.valueOf()===b.valueOf();if(EJSON.isBinary(a)&&EJSON.isBinary(b)){if(a.length!==b.length)return!1;for(d=0;d<a.length;d++)if(a[d]!==b[d])return!1;return!0}if("function"==typeof a.equals)return a.equals(b,c);if("function"==typeof b.equals)return b.equals(a,c);if(a instanceof Array){if(!(b instanceof Array))return!1;if(a.length!==b.length)return!1;for(d=0;d<a.length;d++)if(!EJSON.equals(a[d],b[d],c))return!1;return!0}switch(EJSON._isCustomType(a)+EJSON._isCustomType(b)){case 1:return!1;case 2:return EJSON.equals(EJSON.toJSONValue(a),EJSON.toJSONValue(b))}var f;if(e){var g=[];return _.each(b,function(a,b){g.push(b)}),d=0,f=_.all(a,function(a,e){return d>=g.length?!1:e!==g[d]?!1:EJSON.equals(a,b[g[d]],c)?(d++,!0):!1}),f&&d===g.length}return d=0,f=_.all(a,function(a,e){return _.has(b,e)&&EJSON.equals(a,b[e],c)?(d++,!0):!1}),f&&_.size(b)===d},EJSON.clone=function(a){var b;if("object"!=typeof a)return a;if(null===a)return null;if(a instanceof Date)return new Date(a.getTime());if(a instanceof RegExp)return a;if(EJSON.isBinary(a)){b=EJSON.newBinary(a.length);for(var c=0;c<a.length;c++)b[c]=a[c];return b}if(_.isArray(a)||_.isArguments(a)){for(b=[],c=0;c<a.length;c++)b[c]=EJSON.clone(a[c]);return b}return"function"==typeof a.clone?a.clone():EJSON._isCustomType(a)?EJSON.fromJSONValue(EJSON.clone(EJSON.toJSONValue(a)),!0):(b={},_.each(a,function(a,c){b[c]=EJSON.clone(a)}),b)},EJSON.newBinary=Base64.newBinary,IdMap=function(a,b){var c=this;c._map={},c._idStringify=a||JSON.stringify,c._idParse=b||JSON.parse},_.extend(IdMap.prototype,{get:function(a){var b=this,c=b._idStringify(a);return b._map[c]},set:function(a,b){var c=this,d=c._idStringify(a);c._map[d]=b},remove:function(a){var b=this,c=b._idStringify(a);delete b._map[c]},has:function(a){var b=this,c=b._idStringify(a);return _.has(b._map,c)},empty:function(){var a=this;return _.isEmpty(a._map)},clear:function(){var a=this;a._map={}},forEach:function(a){for(var b=this,c=_.keys(b._map),d=0;d<c.length;d++){var e=a.call(null,b._map[c[d]],b._idParse(c[d]));if(e===!1)return}},size:function(){var a=this;return _.size(a._map)},setDefault:function(a,b){var c=this,d=c._idStringify(a);return _.has(c._map,d)?c._map[d]:(c._map[d]=b,b)},clone:function(){var a=this,b=new IdMap(a._idStringify,a._idParse);return a.forEach(function(a,c){b.set(c,EJSON.clone(a))}),b}});var element=function(a,b,c,d){return{key:a,value:b,next:c,prev:d}};OrderedDict=function(){var a=this;a._dict={},a._first=null,a._last=null,a._size=0;var b=_.toArray(arguments);a._stringify=function(a){return a},"function"==typeof b[0]&&(a._stringify=b.shift()),_.each(b,function(b){a.putBefore(b[0],b[1],null)})},_.extend(OrderedDict.prototype,{_k:function(a){return" "+this._stringify(a)},empty:function(){var a=this;return!a._first},size:function(){var a=this;return a._size},_linkEltIn:function(a){var b=this;a.next?(a.prev=a.next.prev,a.next.prev=a,a.prev&&(a.prev.next=a)):(a.prev=b._last,b._last&&(b._last.next=a),b._last=a),(null===b._first||b._first===a.next)&&(b._first=a)},_linkEltOut:function(a){var b=this;a.next&&(a.next.prev=a.prev),a.prev&&(a.prev.next=a.next),a===b._last&&(b._last=a.prev),a===b._first&&(b._first=a.next)},putBefore:function(a,b,c){var d=this;if(d._dict[d._k(a)])throw new Error("Item "+a+" already present in OrderedDict");var e=c?element(a,b,d._dict[d._k(c)]):element(a,b,null);if(void 0===e.next)throw new Error("could not find item to put this one before");d._linkEltIn(e),d._dict[d._k(a)]=e,d._size++},append:function(a,b){var c=this;c.putBefore(a,b,null)},remove:function(a){var b=this,c=b._dict[b._k(a)];if(void 0===c)throw new Error("Item "+a+" not present in OrderedDict");return b._linkEltOut(c),b._size--,delete b._dict[b._k(a)],c.value},get:function(a){var b=this;return b.has(a)?b._dict[b._k(a)].value:void 0},has:function(a){var b=this;return _.has(b._dict,b._k(a))},forEach:function(a){for(var b=this,c=0,d=b._first;null!==d;){var e=a(d.value,d.key,c);if(e===OrderedDict.BREAK)return;d=d.next,c++}},first:function(){var a=this;return a.empty()?void 0:a._first.key},firstValue:function(){var a=this;return a.empty()?void 0:a._first.value},last:function(){var a=this;return a.empty()?void 0:a._last.key},lastValue:function(){var a=this;return a.empty()?void 0:a._last.value},prev:function(a){var b=this;if(b.has(a)){var c=b._dict[b._k(a)];if(c.prev)return c.prev.key}return null},next:function(a){var b=this;if(b.has(a)){var c=b._dict[b._k(a)];if(c.next)return c.next.key}return null},moveBefore:function(a,b){var c=this,d=c._dict[c._k(a)],e=b?c._dict[c._k(b)]:null;if(void 0===d)throw new Error("Item to move is not present");if(void 0===e)throw new Error("Could not find element to move this one before");e!==d.next&&(c._linkEltOut(d),d.next=e,c._linkEltIn(d))},indexOf:function(a){var b=this,c=null;return b.forEach(function(d,e,f){return b._k(e)===b._k(a)?(c=f,OrderedDict.BREAK):void 0}),c},_checkRep:function(){var a=this;_.each(a._dict,function(a,b){if(b.next===b)throw new Error("Next is a loop");if(b.prev===b)throw new Error("Prev is a loop")})}}),OrderedDict.BREAK={"break":!0},Tracker={},Tracker.active=!1,Tracker.currentComputation=null,Tracker._computations={};var setCurrentComputation=function(a){Tracker.currentComputation=a,Tracker.active=!!a},_debugFunc=function(){return"undefined"!=typeof Meteor?Meteor._debug:"undefined"!=typeof console&&console.error?function(){console.error.apply(console,arguments)}:function(){}},_maybeSupressMoreLogs=function(a){"undefined"!=typeof Meteor&&Meteor._supressed_log_expected()&&Meteor._suppress_log(a-1)},_throwOrLog=function(a,b){if(throwFirstError)throw b;var c=["Exception from Tracker "+a+" function:"];if(b.stack&&b.message&&b.name){var d=b.stack.indexOf(b.message);if(0>d||d>b.name.length+2){var e=b.name+": "+b.message;c.push(e)}}c.push(b.stack),_maybeSupressMoreLogs(c.length);for(var f=0;f<c.length;f++)_debugFunc()(c[f])},withNoYieldsAllowed=function(a){return"undefined"==typeof Meteor||Meteor.isClient?a:function(){var b=arguments;Meteor._noYieldsAllowed(function(){a.apply(null,b)})}},nextId=1,pendingComputations=[],willFlush=!1,inFlush=!1,inCompute=!1,throwFirstError=!1,afterFlushCallbacks=[],requireFlush=function(){willFlush||("undefined"!=typeof Meteor?Meteor._setImmediate(Tracker._runFlush):setTimeout(Tracker._runFlush,0),willFlush=!0)},constructingComputation=!1;if(Tracker.Computation=function(a,b,c){if(!constructingComputation)throw new Error("Tracker.Computation constructor is private; use Tracker.autorun");constructingComputation=!1;var d=this;d.stopped=!1,d.invalidated=!1,d.firstRun=!0,d._id=nextId++,d._onInvalidateCallbacks=[],d._parent=b,d._func=a,d._onError=c,d._recomputing=!1,Tracker._computations[d._id]=d;var e=!0;try{d._compute(),e=!1}finally{d.firstRun=!1,e&&d.stop()}},Tracker.Computation.prototype.onInvalidate=function(a){var b=this;if("function"!=typeof a)throw new Error("onInvalidate requires a function");b.invalidated?Tracker.nonreactive(function(){withNoYieldsAllowed(a)(b)}):b._onInvalidateCallbacks.push(a)},Tracker.Computation.prototype.invalidate=function(){var a=this;if(!a.invalidated){a._recomputing||a.stopped||(requireFlush(),pendingComputations.push(this)),a.invalidated=!0;for(var b,c=0;b=a._onInvalidateCallbacks[c];c++)Tracker.nonreactive(function(){withNoYieldsAllowed(b)(a)});a._onInvalidateCallbacks=[]}},Tracker.Computation.prototype.stop=function(){this.stopped||(this.stopped=!0,this.invalidate(),delete Tracker._computations[this._id])},Tracker.Computation.prototype._compute=function(){var a=this;a.invalidated=!1;var b=Tracker.currentComputation;setCurrentComputation(a);var c=inCompute;inCompute=!0;try{withNoYieldsAllowed(a._func)(a)}finally{setCurrentComputation(b),inCompute=c}},Tracker.Computation.prototype._needsRecompute=function(){var a=this;return a.invalidated&&!a.stopped},Tracker.Computation.prototype._recompute=function(){var a=this;a._recomputing=!0;try{if(a._needsRecompute())try{a._compute()}catch(b){a._onError?a._onError(b):_throwOrLog("recompute",b)}}finally{a._recomputing=!1}},Tracker.Dependency=function(){this._dependentsById={}},Tracker.Dependency.prototype.depend=function(a){if(!a){if(!Tracker.active)return!1;a=Tracker.currentComputation}var b=this,c=a._id;return c in b._dependentsById?!1:(b._dependentsById[c]=a,a.onInvalidate(function(){delete b._dependentsById[c]}),!0)},Tracker.Dependency.prototype.changed=function(){var a=this;for(var b in a._dependentsById)a._dependentsById[b].invalidate()},Tracker.Dependency.prototype.hasDependents=function(){var a=this;for(var b in a._dependentsById)return!0;return!1},Tracker.flush=function(a){Tracker._runFlush({finishSynchronously:!0,throwFirstError:a&&a._throwFirstError})},Tracker._runFlush=function(a){if(inFlush)throw new Error("Can't call Tracker.flush while flushing");if(inCompute)throw new Error("Can't flush inside Tracker.autorun");a=a||{},inFlush=!0,willFlush=!0,throwFirstError=!!a.throwFirstError;var b=0,c=!1;try{for(;pendingComputations.length||afterFlushCallbacks.length;){for(;pendingComputations.length;){var d=pendingComputations.shift();if(d._recompute(),d._needsRecompute()&&pendingComputations.unshift(d),!a.finishSynchronously&&++b>1e3)return void(c=!0)}if(afterFlushCallbacks.length){var e=afterFlushCallbacks.shift();try{e()}catch(f){_throwOrLog("afterFlush",f)}}}c=!0}finally{if(c||(inFlush=!1,Tracker._runFlush({finishSynchronously:a.finishSynchronously,throwFirstError:!1})),willFlush=!1,inFlush=!1,pendingComputations.length||afterFlushCallbacks.length){if(a.finishSynchronously)throw new Error("still have more to do?");setTimeout(requireFlush,10)}}},Tracker.autorun=function(a,b){if("function"!=typeof a)throw new Error("Tracker.autorun requires a function argument");b=b||{},constructingComputation=!0;var c=new Tracker.Computation(a,Tracker.currentComputation,b.onError);return Tracker.active&&Tracker.onInvalidate(function(){c.stop()}),c},Tracker.nonreactive=function(a){var b=Tracker.currentComputation;setCurrentComputation(null);try{return a()}finally{setCurrentComputation(b)}},Tracker.onInvalidate=function(a){if(!Tracker.active)throw new Error("Tracker.onInvalidate requires a currentComputation");Tracker.currentComputation.onInvalidate(a)},Tracker.afterFlush=function(a){afterFlushCallbacks.push(a),requireFlush()},Meteor.flush=Tracker.flush,Meteor.autorun=Tracker.autorun,Meteor.autosubscribe=Tracker.autorun,Tracker.depend=function(a){return a.depend()},Deps=Tracker,Meteor.isServer)var nodeCrypto=Npm.require("crypto");var Alea=function(){function a(){var a=4022871197,b=function(b){b=b.toString();for(var c=0;c<b.length;c++){a+=b.charCodeAt(c);var d=.02519603282416938*a;a=d>>>0,d-=a,d*=a,a=d>>>0,d-=a,a+=4294967296*d}return 2.3283064365386963e-10*(a>>>0)};return b.version="Mash 0.9",b}return function(b){var c=0,d=0,e=0,f=1;0==b.length&&(b=[+new Date]);var g=a();c=g(" "),d=g(" "),e=g(" ");for(var h=0;h<b.length;h++)c-=g(b[h]),0>c&&(c+=1),d-=g(b[h]),0>d&&(d+=1),e-=g(b[h]),0>e&&(e+=1);g=null;var i=function(){var a=2091639*c+2.3283064365386963e-10*f;return c=d,d=e,e=a-(f=0|a)};return i.uint32=function(){return 4294967296*i()},i.fract53=function(){return i()+1.1102230246251565e-16*(2097152*i()|0)},i.version="Alea 0.9",i.args=b,i}(Array.prototype.slice.call(arguments))},UNMISTAKABLE_CHARS="23456789ABCDEFGHJKLMNPQRSTWXYZabcdefghijkmnopqrstuvwxyz",BASE64_CHARS="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-_",RandomGenerator=function(a){var b=this;void 0!==a&&(b.alea=Alea.apply(null,a))};RandomGenerator.prototype.fraction=function(){var a=this;if(a.alea)return a.alea();if(nodeCrypto){var b=parseInt(a.hexString(8),16);return 2.3283064365386963e-10*b}if("undefined"!=typeof window&&window.crypto&&window.crypto.getRandomValues){var c=new Uint32Array(1);return window.crypto.getRandomValues(c),2.3283064365386963e-10*c[0]}throw new Error("No random generator available")},RandomGenerator.prototype.hexString=function(a){var b=this;if(nodeCrypto&&!b.alea){var c,d=Math.ceil(a/2);try{c=nodeCrypto.randomBytes(d)}catch(e){c=nodeCrypto.pseudoRandomBytes(d)}var f=c.toString("hex");return f.substring(0,a)}for(var g=[],h=0;a>h;++h)g.push(b.choice("0123456789abcdef"));return g.join("")},RandomGenerator.prototype._randomString=function(a,b){for(var c=this,d=[],e=0;a>e;e++)d[e]=c.choice(b);return d.join("")},RandomGenerator.prototype.id=function(a){var b=this;return void 0===a&&(a=17),b._randomString(a,UNMISTAKABLE_CHARS)},RandomGenerator.prototype.secret=function(a){var b=this;return void 0===a&&(a=43),b._randomString(a,BASE64_CHARS)},RandomGenerator.prototype.choice=function(a){var b=Math.floor(this.fraction()*a.length);return"string"==typeof a?a.substr(b,1):a[b]};var height="undefined"!=typeof window&&window.innerHeight||"undefined"!=typeof document&&document.documentElement&&document.documentElement.clientHeight||"undefined"!=typeof document&&document.body&&document.body.clientHeight||1,width="undefined"!=typeof window&&window.innerWidth||"undefined"!=typeof document&&document.documentElement&&document.documentElement.clientWidth||"undefined"!=typeof document&&document.body&&document.body.clientWidth||1,agent="undefined"!=typeof navigator&&navigator.userAgent||"";Random=nodeCrypto||"undefined"!=typeof window&&window.crypto&&window.crypto.getRandomValues?new RandomGenerator:new RandomGenerator([new Date,height,width,agent,Math.random()]),Random.createWithSeeds=function(){if(0===arguments.length)throw new Error("No seeds were provided");return new RandomGenerator(arguments)},module={exports:{}},function(){function a(a){for(var b=[],c=[],d=0;d<a[0].length;d++)b.push(a[0][d][1]),c.push(a[0][d][0]);return b=b.sort(function(a,b){return a-b}),c=c.sort(function(a,b){return a-b}),[[b[0],c[0]],[b[b.length-1],c[c.length-1]]]}function b(a,b,c){for(var d=[[0,0]],e=0;e<c.length;e++){for(var f=0;f<c[e].length;f++)d.push(c[e][f]);d.push([0,0])}for(var g=!1,e=0,f=d.length-1;e<d.length;f=e++)d[e][0]>b!=d[f][0]>b&&a<(d[f][1]-d[e][1])*(b-d[e][0])/(d[f][0]-d[e][0])+d[e][1]&&(g=!g);return g}var c={};"undefined"!=typeof module&&module.exports&&(module.exports=c),c.lineStringsIntersect=function(a,b){for(var c=[],d=0;d<=a.coordinates.length-2;++d)for(var e=0;e<=b.coordinates.length-2;++e){var f={x:a.coordinates[d][1],y:a.coordinates[d][0]},g={x:a.coordinates[d+1][1],y:a.coordinates[d+1][0]},h={x:b.coordinates[e][1],y:b.coordinates[e][0]},i={x:b.coordinates[e+1][1],y:b.coordinates[e+1][0]},j=(i.x-h.x)*(f.y-h.y)-(i.y-h.y)*(f.x-h.x),k=(g.x-f.x)*(f.y-h.y)-(g.y-f.y)*(f.x-h.x),l=(i.y-h.y)*(g.x-f.x)-(i.x-h.x)*(g.y-f.y);if(0!=l){var m=j/l,n=k/l;m>=0&&1>=m&&n>=0&&1>=n&&c.push({type:"Point",coordinates:[f.x+m*(g.x-f.x),f.y+m*(g.y-f.y)]})}}return 0==c.length&&(c=!1),c},c.pointInBoundingBox=function(a,b){return!(a.coordinates[1]<b[0][0]||a.coordinates[1]>b[1][0]||a.coordinates[0]<b[0][1]||a.coordinates[0]>b[1][1])},c.pointInPolygon=function(d,e){for(var f="Polygon"==e.type?[e.coordinates]:e.coordinates,g=!1,h=0;h<f.length;h++)c.pointInBoundingBox(d,a(f[h]))&&(g=!0);if(!g)return!1;for(var i=!1,h=0;h<f.length;h++)b(d.coordinates[1],d.coordinates[0],f[h])&&(i=!0);return i},c.numberToRadius=function(a){return a*Math.PI/180},c.numberToDegree=function(a){return 180*a/Math.PI},c.drawCircle=function(a,b,d){for(var e=[b.coordinates[1],b.coordinates[0]],f=a/1e3/6371,g=[c.numberToRadius(e[0]),c.numberToRadius(e[1])],d=d||15,h=[[e[0],e[1]]],i=0;d>i;i++){var j=2*Math.PI*i/d,k=Math.asin(Math.sin(g[0])*Math.cos(f)+Math.cos(g[0])*Math.sin(f)*Math.cos(j)),l=g[1]+Math.atan2(Math.sin(j)*Math.sin(f)*Math.cos(g[0]),Math.cos(f)-Math.sin(g[0])*Math.sin(k));h[i]=[],h[i][1]=c.numberToDegree(k),h[i][0]=c.numberToDegree(l)}return{type:"Polygon",coordinates:[h]}},c.rectangleCentroid=function(a){var b=a.coordinates[0],c=b[0][0],d=b[0][1],e=b[2][0],f=b[2][1],g=e-c,h=f-d;return{type:"Point",coordinates:[c+g/2,d+h/2]}},c.pointDistance=function(a,b){var d=a.coordinates[0],e=a.coordinates[1],f=b.coordinates[0],g=b.coordinates[1],h=c.numberToRadius(g-e),i=c.numberToRadius(f-d),j=Math.pow(Math.sin(h/2),2)+Math.cos(c.numberToRadius(e))*Math.cos(c.numberToRadius(g))*Math.pow(Math.sin(i/2),2),k=2*Math.atan2(Math.sqrt(j),Math.sqrt(1-j));return 6371*k*1e3},c.geometryWithinRadius=function(a,b,d){if("Point"==a.type)return c.pointDistance(a,b)<=d;if("LineString"==a.type||"Polygon"==a.type){var e,f={};e="Polygon"==a.type?a.coordinates[0]:a.coordinates;for(var g in e)if(f.coordinates=e[g],c.pointDistance(f,b)>d)return!1}return!0},c.area=function(a){for(var b,c,d=0,e=a.coordinates[0],f=e.length-1,g=0;g<e.length;f=g++){var b={x:e[g][1],y:e[g][0]},c={x:e[f][1],y:e[f][0]};d+=b.x*c.y,d-=b.y*c.x}return d/=2},c.centroid=function(a){for(var b,d,e,f=0,g=0,h=a.coordinates[0],i=h.length-1,j=0;j<h.length;i=j++){var d={x:h[j][1],y:h[j][0]},e={x:h[i][1],y:h[i][0]};b=d.x*e.y-e.x*d.y,f+=(d.x+e.x)*b,g+=(d.y+e.y)*b}return b=6*c.area(a),{type:"Point",coordinates:[g/b,f/b]}},c.simplify=function(a,b){b=b||20,a=a.map(function(a){return{lng:a.coordinates[0],lat:a.coordinates[1]}});var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v=Math.PI/180*.5,w=new Array,x=new Array,y=new Array;if(a.length<3)return a;for(c=a.length,l=360*b/(2*Math.PI*6378137),l*=l,e=0,x[0]=0,y[0]=c-1,d=1;d>0;)if(f=x[d-1],g=y[d-1],d--,g-f>1){for(m=a[g].lng()-a[f].lng(),n=a[g].lat()-a[f].lat(),Math.abs(m)>180&&(m=360-Math.abs(m)),m*=Math.cos(v*(a[g].lat()+a[f].lat())),o=m*m+n*n,h=f+1,i=f,k=-1;g>h;h++)p=a[h].lng()-a[f].lng(),q=a[h].lat()-a[f].lat(),Math.abs(p)>180&&(p=360-Math.abs(p)),p*=Math.cos(v*(a[h].lat()+a[f].lat())),r=p*p+q*q,s=a[h].lng()-a[g].lng(),t=a[h].lat()-a[g].lat(),Math.abs(s)>180&&(s=360-Math.abs(s)),s*=Math.cos(v*(a[h].lat()+a[g].lat())),u=s*s+t*t,j=r>=o+u?u:u>=o+r?r:(p*n-q*m)*(p*n-q*m)/o,j>k&&(i=h,k=j);l>k?(w[e]=f,e++):(d++,x[d-1]=i,y[d-1]=g,d++,x[d-1]=f,y[d-1]=i)}else w[e]=f,e++;w[e]=c-1,e++;for(var z=new Array,h=0;e>h;h++)z.push(a[w[h]]);return z.map(function(a){return{type:"Point",coordinates:[a.lng,a.lat]}})},c.destinationPoint=function(a,b,d){d/=6371,b=c.numberToRadius(b);var e=c.numberToRadius(a.coordinates[0]),f=c.numberToRadius(a.coordinates[1]),g=Math.asin(Math.sin(e)*Math.cos(d)+Math.cos(e)*Math.sin(d)*Math.cos(b)),h=f+Math.atan2(Math.sin(b)*Math.sin(d)*Math.cos(e),Math.cos(d)-Math.sin(e)*Math.sin(g));return h=(h+3*Math.PI)%(2*Math.PI)-Math.PI,{type:"Point",coordinates:[c.numberToDegree(g),c.numberToDegree(h)]}}}(),GeoJSON=module.exports,LocalCollection=function(a){var b=this;b.name=a,b._docs=new LocalCollection._IdMap,b._observeQueue=new Meteor._SynchronousQueue,b.next_qid=1,b.queries={},b._savedOriginals=null,b.paused=!1},Minimongo={},MinimongoTest={},LocalCollection._applyChanges=function(a,b){_.each(b,function(b,c){void 0===b?delete a[c]:a[c]=b})},MinimongoError=function(a){var b=new Error(a);return b.name="MinimongoError",b},LocalCollection.prototype.find=function(a,b){return 0===arguments.length&&(a={}),new LocalCollection.Cursor(this,a,b)},LocalCollection.Cursor=function(a,b,c){var d=this;c||(c={}),d.collection=a,d.sorter=null,LocalCollection._selectorIsId(b)?(d._selectorId=b,d.matcher=new Minimongo.Matcher(b)):(d._selectorId=void 0,d.matcher=new Minimongo.Matcher(b),(d.matcher.hasGeoQuery()||c.sort)&&(d.sorter=new Minimongo.Sorter(c.sort||[],{matcher:d.matcher}))),d.skip=c.skip,d.limit=c.limit,d.fields=c.fields,d._projectionFn=LocalCollection._compileProjection(d.fields||{}),d._transform=LocalCollection.wrapTransform(c.transform),"undefined"!=typeof Tracker&&(d.reactive=void 0===c.reactive?!0:c.reactive)},LocalCollection.Cursor.prototype.rewind=function(){},LocalCollection.prototype.findOne=function(a,b){return 0===arguments.length&&(a={}),b=b||{},b.limit=1,this.find(a,b).fetch()[0]},LocalCollection.Cursor.prototype.forEach=function(a,b){var c=this,d=c._getRawObjects({ordered:!0});c.reactive&&c._depend({addedBefore:!0,removed:!0,changed:!0,movedBefore:!0}),_.each(d,function(d,e){d=c._projectionFn(d),c._transform&&(d=c._transform(d)),a.call(b,d,e,c)})},LocalCollection.Cursor.prototype.getTransform=function(){return this._transform},LocalCollection.Cursor.prototype.map=function(a,b){var c=this,d=[];return c.forEach(function(e,f){d.push(a.call(b,e,f,c))}),d},LocalCollection.Cursor.prototype.fetch=function(){var a=this,b=[];return a.forEach(function(a){b.push(a)}),b},LocalCollection.Cursor.prototype.count=function(){var a=this;return a.reactive&&a._depend({added:!0,removed:!0},!0),a._getRawObjects({ordered:!0}).length},LocalCollection.Cursor.prototype._publishCursor=function(a){var b=this;if(!b.collection.name)throw new Error("Can't publish a cursor from a collection without a name.");var c=b.collection.name;return Mongo.Collection._publishCursor(b,a,c)},LocalCollection.Cursor.prototype._getCollectionName=function(){var a=this;return a.collection.name},LocalCollection._observeChangesCallbacksAreOrdered=function(a){
if(a.added&&a.addedBefore)throw new Error("Please specify only one of added() and addedBefore()");return!(!a.addedBefore&&!a.movedBefore)},LocalCollection._observeCallbacksAreOrdered=function(a){if(a.addedAt&&a.added)throw new Error("Please specify only one of added() and addedAt()");if(a.changedAt&&a.changed)throw new Error("Please specify only one of changed() and changedAt()");if(a.removed&&a.removedAt)throw new Error("Please specify only one of removed() and removedAt()");return!!(a.addedAt||a.movedTo||a.changedAt||a.removedAt)},LocalCollection.ObserveHandle=function(){},_.extend(LocalCollection.Cursor.prototype,{observe:function(a){var b=this;return LocalCollection._observeFromObserveChanges(b,a)},observeChanges:function(a){var b=this,c=LocalCollection._observeChangesCallbacksAreOrdered(a);if(!a._allow_unordered&&!c&&(b.skip||b.limit))throw new Error("must use ordered observe (ie, 'addedBefore' instead of 'added') with skip or limit");if(b.fields&&(0===b.fields._id||b.fields._id===!1))throw Error("You may not observe a cursor with {fields: {_id: 0}}");var d,e={matcher:b.matcher,sorter:c&&b.sorter,distances:b.matcher.hasGeoQuery()&&c&&new LocalCollection._IdMap,resultsSnapshot:null,ordered:c,cursor:b,projectionFn:b._projectionFn};b.reactive&&(d=b.collection.next_qid++,b.collection.queries[d]=e),e.results=b._getRawObjects({ordered:c,distances:e.distances}),b.collection.paused&&(e.resultsSnapshot=c?[]:new LocalCollection._IdMap);var f=function(a){return a?function(){var c=this,d=arguments;b.collection.paused||b.collection._observeQueue.queueTask(function(){a.apply(c,d)})}:function(){}};if(e.added=f(a.added),e.changed=f(a.changed),e.removed=f(a.removed),c&&(e.addedBefore=f(a.addedBefore),e.movedBefore=f(a.movedBefore)),!a._suppress_initial&&!b.collection.paused){var g=c?_.bind(_.each,null,e.results):_.bind(e.results.forEach,e.results);g(function(a){var d=EJSON.clone(a);delete d._id,c&&e.addedBefore(a._id,b._projectionFn(d),null),e.added(a._id,b._projectionFn(d))})}var h=new LocalCollection.ObserveHandle;return _.extend(h,{collection:b.collection,stop:function(){b.reactive&&delete b.collection.queries[d]}}),b.reactive&&Tracker.active&&Tracker.onInvalidate(function(){h.stop()}),b.collection._observeQueue.drain(),h}}),LocalCollection.Cursor.prototype._getRawObjects=function(a){var b=this;a=a||{};var c=a.ordered?[]:new LocalCollection._IdMap;if(void 0!==b._selectorId){if(b.skip)return c;var d=b.collection._docs.get(b._selectorId);return d&&(a.ordered?c.push(d):c.set(b._selectorId,d)),c}var e;if(b.matcher.hasGeoQuery()&&a.ordered&&(a.distances?(e=a.distances,e.clear()):e=new LocalCollection._IdMap),b.collection._docs.forEach(function(d,f){var g=b.matcher.documentMatches(d);return g.result&&(a.ordered?(c.push(d),e&&void 0!==g.distance&&e.set(f,g.distance)):c.set(f,d)),!b.limit||b.skip||b.sorter||c.length!==b.limit?!0:!1}),!a.ordered)return c;if(b.sorter){var f=b.sorter.getComparator({distances:e});c.sort(f)}var g=b.skip||0,h=b.limit?b.limit+g:c.length;return c.slice(g,h)},LocalCollection.Cursor.prototype._depend=function(a,b){var c=this;if(Tracker.active){var d=new Tracker.Dependency;d.depend();var e=_.bind(d.changed,d),f={_suppress_initial:!0,_allow_unordered:b};_.each(["added","changed","removed","addedBefore","movedBefore"],function(b){a[b]&&(f[b]=e)}),c.observeChanges(f)}},LocalCollection.prototype.insert=function(a,b){var c=this;a=EJSON.clone(a),_.has(a,"_id")||(a._id=LocalCollection._useOID?new LocalCollection._ObjectID:Random.id());var d=a._id;if(c._docs.has(d))throw MinimongoError("Duplicate _id '"+d+"'");c._saveOriginal(d,void 0),c._docs.set(d,a);var e=[];for(var f in c.queries){var g=c.queries[f],h=g.matcher.documentMatches(a);h.result&&(g.distances&&void 0!==h.distance&&g.distances.set(d,h.distance),g.cursor.skip||g.cursor.limit?e.push(f):LocalCollection._insertInResults(g,a))}return _.each(e,function(a){c.queries[a]&&c._recomputeResults(c.queries[a])}),c._observeQueue.drain(),b&&Meteor.defer(function(){b(null,d)}),d},LocalCollection.prototype._eachPossiblyMatchingDoc=function(a,b){var c=this,d=LocalCollection._idsMatchedBySelector(a);if(d)for(var e=0;e<d.length;++e){var f=d[e],g=c._docs.get(f);if(g){var h=b(g,f);if(h===!1)break}}else c._docs.forEach(b)},LocalCollection.prototype.remove=function(a,b){var c=this;if(c.paused&&!c._savedOriginals&&EJSON.equals(a,{})){var d=c._docs.size();return c._docs.clear(),_.each(c.queries,function(a){a.ordered?a.results=[]:a.results.clear()}),b&&Meteor.defer(function(){b(null,d)}),d}var e=new Minimongo.Matcher(a),f=[];c._eachPossiblyMatchingDoc(a,function(a,b){e.documentMatches(a).result&&f.push(b)});for(var g=[],h=[],i=0;i<f.length;i++){var j=f[i],k=c._docs.get(j);_.each(c.queries,function(a,b){a.matcher.documentMatches(k).result&&(a.cursor.skip||a.cursor.limit?g.push(b):h.push({qid:b,doc:k}))}),c._saveOriginal(j,k),c._docs.remove(j)}return _.each(h,function(a){var b=c.queries[a.qid];b&&(b.distances&&b.distances.remove(a.doc._id),LocalCollection._removeFromResults(b,a.doc))}),_.each(g,function(a){var b=c.queries[a];b&&c._recomputeResults(b)}),c._observeQueue.drain(),d=f.length,b&&Meteor.defer(function(){b(null,d)}),d},LocalCollection.prototype.update=function(a,b,c,d){var e=this;!d&&c instanceof Function&&(d=c,c=null),c||(c={});var f=new Minimongo.Matcher(a),g={};_.each(e.queries,function(a,b){!a.cursor.skip&&!a.cursor.limit||e.paused||(g[b]=EJSON.clone(a.results))});var h={},i=0;e._eachPossiblyMatchingDoc(a,function(a,d){var g=f.documentMatches(a);return g.result&&(e._saveOriginal(d,a),e._modifyAndNotify(a,b,h,g.arrayIndices),++i,!c.multi)?!1:!0}),_.each(h,function(a,b){var c=e.queries[b];c&&e._recomputeResults(c,g[b])}),e._observeQueue.drain();var j;if(0===i&&c.upsert){var k=LocalCollection._removeDollarOperators(a);LocalCollection._modify(k,b,{isInsert:!0}),!k._id&&c.insertedId&&(k._id=c.insertedId),j=e.insert(k),i=1}var l;return c._returnObject?(l={numberAffected:i},void 0!==j&&(l.insertedId=j)):l=i,d&&Meteor.defer(function(){d(null,l)}),l},LocalCollection.prototype.upsert=function(a,b,c,d){var e=this;return d||"function"!=typeof c||(d=c,c={}),e.update(a,b,_.extend({},c,{upsert:!0,_returnObject:!0}),d)},LocalCollection.prototype._modifyAndNotify=function(a,b,c,d){var e=this,f={};for(var g in e.queries){var h=e.queries[g];f[g]=h.ordered?h.matcher.documentMatches(a).result:h.results.has(a._id)}var i=EJSON.clone(a);LocalCollection._modify(a,b,{arrayIndices:d});for(g in e.queries){h=e.queries[g];var j=f[g],k=h.matcher.documentMatches(a),l=k.result;l&&h.distances&&void 0!==k.distance&&h.distances.set(a._id,k.distance),h.cursor.skip||h.cursor.limit?(j||l)&&(c[g]=!0):j&&!l?LocalCollection._removeFromResults(h,a):!j&&l?LocalCollection._insertInResults(h,a):j&&l&&LocalCollection._updateInResults(h,a,i)}},LocalCollection._insertInResults=function(a,b){var c=EJSON.clone(b);if(delete c._id,a.ordered){if(a.sorter){var d=LocalCollection._insertInSortedList(a.sorter.getComparator({distances:a.distances}),a.results,b),e=a.results[d+1];e=e?e._id:null,a.addedBefore(b._id,a.projectionFn(c),e)}else a.addedBefore(b._id,a.projectionFn(c),null),a.results.push(b);a.added(b._id,a.projectionFn(c))}else a.added(b._id,a.projectionFn(c)),a.results.set(b._id,b)},LocalCollection._removeFromResults=function(a,b){if(a.ordered){var c=LocalCollection._findInOrderedResults(a,b);a.removed(b._id),a.results.splice(c,1)}else{var d=b._id;a.removed(b._id),a.results.remove(d)}},LocalCollection._updateInResults=function(a,b,c){if(!EJSON.equals(b._id,c._id))throw new Error("Can't change a doc's _id while updating");var d=a.projectionFn,e=LocalCollection._makeChangedFields(d(b),d(c));if(!a.ordered)return void(_.isEmpty(e)||(a.changed(b._id,e),a.results.set(b._id,b)));var f=LocalCollection._findInOrderedResults(a,b);if(_.isEmpty(e)||a.changed(b._id,e),a.sorter){a.results.splice(f,1);var g=LocalCollection._insertInSortedList(a.sorter.getComparator({distances:a.distances}),a.results,b);if(f!==g){var h=a.results[g+1];h=h?h._id:null,a.movedBefore&&a.movedBefore(b._id,h)}}},LocalCollection.prototype._recomputeResults=function(a,b){var c=this;c.paused||b||(b=a.results),a.distances&&a.distances.clear(),a.results=a.cursor._getRawObjects({ordered:a.ordered,distances:a.distances}),c.paused||LocalCollection._diffQueryChanges(a.ordered,b,a.results,a,{projectionFn:a.projectionFn})},LocalCollection._findInOrderedResults=function(a,b){if(!a.ordered)throw new Error("Can't call _findInOrderedResults on unordered query");for(var c=0;c<a.results.length;c++)if(a.results[c]===b)return c;throw Error("object missing from query")},LocalCollection._binarySearch=function(a,b,c){for(var d=0,e=b.length;e>0;){var f=Math.floor(e/2);a(c,b[d+f])>=0?(d+=f+1,e-=f+1):e=f}return d},LocalCollection._insertInSortedList=function(a,b,c){if(0===b.length)return b.push(c),0;var d=LocalCollection._binarySearch(a,b,c);return b.splice(d,0,c),d},LocalCollection.prototype.saveOriginals=function(){var a=this;if(a._savedOriginals)throw new Error("Called saveOriginals twice without retrieveOriginals");a._savedOriginals=new LocalCollection._IdMap},LocalCollection.prototype.retrieveOriginals=function(){var a=this;if(!a._savedOriginals)throw new Error("Called retrieveOriginals without saveOriginals");var b=a._savedOriginals;return a._savedOriginals=null,b},LocalCollection.prototype._saveOriginal=function(a,b){var c=this;c._savedOriginals&&(c._savedOriginals.has(a)||c._savedOriginals.set(a,EJSON.clone(b)))},LocalCollection.prototype.pauseObservers=function(){if(!this.paused){this.paused=!0;for(var a in this.queries){var b=this.queries[a];b.resultsSnapshot=EJSON.clone(b.results)}}},LocalCollection.prototype.resumeObservers=function(){var a=this;if(this.paused){this.paused=!1;for(var b in this.queries){var c=a.queries[b];LocalCollection._diffQueryChanges(c.ordered,c.resultsSnapshot,c.results,c,{projectionFn:c.projectionFn}),c.resultsSnapshot=null}a._observeQueue.drain()}},LocalCollection._idStringify=function(a){if(a instanceof LocalCollection._ObjectID)return a.valueOf();if("string"==typeof a)return""===a?a:"-"===a.substr(0,1)||"~"===a.substr(0,1)||LocalCollection._looksLikeObjectID(a)||"{"===a.substr(0,1)?"-"+a:a;if(void 0===a)return"-";if("object"==typeof a&&null!==a)throw new Error("Meteor does not currently support objects other than ObjectID as ids");return"~"+JSON.stringify(a)},LocalCollection._idParse=function(a){return""===a?a:"-"===a?void 0:"-"===a.substr(0,1)?a.substr(1):"~"===a.substr(0,1)?JSON.parse(a.substr(1)):LocalCollection._looksLikeObjectID(a)?new LocalCollection._ObjectID(a):a},LocalCollection._makeChangedFields=function(a,b){var c={};return LocalCollection._diffObjects(b,a,{leftOnly:function(a){c[a]=void 0},rightOnly:function(a,b){c[a]=b},both:function(a,b,d){EJSON.equals(b,d)||(c[a]=d)}}),c},LocalCollection.wrapTransform=function(a){if(!a)return null;if(a.__wrappedTransform__)return a;var b=function(b){if(!_.has(b,"_id"))throw new Error("can only transform documents with _id");var c=b._id,d=Tracker.nonreactive(function(){return a(b)});if(!isPlainObject(d))throw new Error("transform must return object");if(_.has(d,"_id")){if(!EJSON.equals(d._id,c))throw new Error("transformed document can't have different _id")}else d._id=c;return d};return b.__wrappedTransform__=!0,b},isArray=function(a){return _.isArray(a)&&!EJSON.isBinary(a)},isPlainObject=LocalCollection._isPlainObject=function(a){return a&&3===LocalCollection._f._type(a)},isIndexable=function(a){return isArray(a)||isPlainObject(a)},isOperatorObject=function(a,b){if(!isPlainObject(a))return!1;var c=void 0;return _.each(a,function(d,e){var f="$"===e.substr(0,1);if(void 0===c)c=f;else if(c!==f){if(!b)throw new Error("Inconsistent operator: "+JSON.stringify(a));c=!1}}),!!c},isNumericKey=function(a){return/^[0-9]+$/.test(a)},Minimongo.Matcher=function(a){var b=this;b._paths={},b._hasGeoQuery=!1,b._hasWhere=!1,b._isSimple=!0,b._matchingDocument=void 0,b._selector=null,b._docMatcher=b._compileSelector(a)},_.extend(Minimongo.Matcher.prototype,{documentMatches:function(a){if(!a||"object"!=typeof a)throw Error("documentMatches needs a document");return this._docMatcher(a)},hasGeoQuery:function(){return this._hasGeoQuery},hasWhere:function(){return this._hasWhere},isSimple:function(){return this._isSimple},_compileSelector:function(a){var b=this;if(a instanceof Function)return b._isSimple=!1,b._selector=a,b._recordPathUsed(""),function(b){return{result:!!a.call(b)}};if(LocalCollection._selectorIsId(a))return b._selector={_id:a},b._recordPathUsed("_id"),function(b){return{result:EJSON.equals(b._id,a)}};if(!a||"_id"in a&&!a._id)return b._isSimple=!1,nothingMatcher;if("boolean"==typeof a||isArray(a)||EJSON.isBinary(a))throw new Error("Invalid selector: "+a);return b._selector=EJSON.clone(a),compileDocumentSelector(a,b,{isRoot:!0})},_recordPathUsed:function(a){this._paths[a]=!0},_getPaths:function(){return _.keys(this._paths)}});var compileDocumentSelector=function(a,b,c){c=c||{};var d=[];return _.each(a,function(a,e){if("$"===e.substr(0,1)){if(!_.has(LOGICAL_OPERATORS,e))throw new Error("Unrecognized logical operator: "+e);b._isSimple=!1,d.push(LOGICAL_OPERATORS[e](a,b,c.inElemMatch))}else{c.inElemMatch||b._recordPathUsed(e);var f=makeLookupFunction(e),g=compileValueSelector(a,b,c.isRoot);d.push(function(a){var b=f(a);return g(b)})}}),andDocumentMatchers(d)},compileValueSelector=function(a,b,c){return a instanceof RegExp?(b._isSimple=!1,convertElementMatcherToBranchedMatcher(regexpElementMatcher(a))):isOperatorObject(a)?operatorBranchedMatcher(a,b,c):convertElementMatcherToBranchedMatcher(equalityElementMatcher(a))},convertElementMatcherToBranchedMatcher=function(a,b){return b=b||{},function(c){var d=c;b.dontExpandLeafArrays||(d=expandArraysInBranches(c,b.dontIncludeLeafArrays));var e={};return e.result=_.any(d,function(b){var c=a(b.value);return"number"==typeof c&&(b.arrayIndices||(b.arrayIndices=[c]),c=!0),c&&b.arrayIndices&&(e.arrayIndices=b.arrayIndices),c}),e}};regexpElementMatcher=function(a){return function(b){return b instanceof RegExp?_.isEqual(b,a):"string"!=typeof b?!1:(a.lastIndex=0,a.test(b))}},equalityElementMatcher=function(a){if(isOperatorObject(a))throw Error("Can't create equalityValueSelector for operator object");return null==a?function(a){return null==a}:function(b){return LocalCollection._f._equal(a,b)}};var operatorBranchedMatcher=function(a,b,c){var d=[];return _.each(a,function(e,f){var g=_.contains(["$lt","$lte","$gt","$gte"],f)&&_.isNumber(e),h="$ne"===f&&!_.isObject(e),i=_.contains(["$in","$nin"],f)&&_.isArray(e)&&!_.any(e,_.isObject);if("$eq"===f||g||i||h||(b._isSimple=!1),_.has(VALUE_OPERATORS,f))d.push(VALUE_OPERATORS[f](e,a,b,c));else{if(!_.has(ELEMENT_OPERATORS,f))throw new Error("Unrecognized operator: "+f);var j=ELEMENT_OPERATORS[f];d.push(convertElementMatcherToBranchedMatcher(j.compileElementSelector(e,a,b),j))}}),andBranchedMatchers(d)},compileArrayOfDocumentSelectors=function(a,b,c){if(!isArray(a)||_.isEmpty(a))throw Error("$and/$or/$nor must be nonempty array");return _.map(a,function(a){if(!isPlainObject(a))throw Error("$or/$and/$nor entries need to be full objects");return compileDocumentSelector(a,b,{inElemMatch:c})})},LOGICAL_OPERATORS={$and:function(a,b,c){var d=compileArrayOfDocumentSelectors(a,b,c);return andDocumentMatchers(d)},$or:function(a,b,c){var d=compileArrayOfDocumentSelectors(a,b,c);return 1===d.length?d[0]:function(a){var b=_.any(d,function(b){return b(a).result});return{result:b}}},$nor:function(a,b,c){var d=compileArrayOfDocumentSelectors(a,b,c);return function(a){var b=_.all(d,function(b){return!b(a).result});return{result:b}}},$where:function(a,b){return b._recordPathUsed(""),b._hasWhere=!0,a instanceof Function||(a=Function("obj","return "+a)),function(b){return{result:a.call(b,b)}}},$comment:function(){return function(){return{result:!0}}}},invertBranchedMatcher=function(a){return function(b){var c=a(b);return{result:!c.result}}},VALUE_OPERATORS={$not:function(a,b,c){return invertBranchedMatcher(compileValueSelector(a,c))},$ne:function(a){return invertBranchedMatcher(convertElementMatcherToBranchedMatcher(equalityElementMatcher(a)))},$nin:function(a){return invertBranchedMatcher(convertElementMatcherToBranchedMatcher(ELEMENT_OPERATORS.$in.compileElementSelector(a)))},$exists:function(a){var b=convertElementMatcherToBranchedMatcher(function(a){return void 0!==a});return a?b:invertBranchedMatcher(b)},$options:function(a,b){if(!_.has(b,"$regex"))throw Error("$options needs a $regex");return everythingMatcher},$maxDistance:function(a,b){if(!b.$near)throw Error("$maxDistance needs a $near");return everythingMatcher},$all:function(a,b,c){if(!isArray(a))throw Error("$all requires array");if(_.isEmpty(a))return nothingMatcher;var d=[];return _.each(a,function(a){if(isOperatorObject(a))throw Error("no $ expressions in $all");d.push(compileValueSelector(a,c))}),andBranchedMatchers(d)},$near:function(a,b,c,d){if(!d)throw Error("$near can't be inside another $ operator");c._hasGeoQuery=!0;var e,f,g;if(isPlainObject(a)&&_.has(a,"$geometry"))e=a.$maxDistance,f=a.$geometry,g=function(a){return a&&a.type?"Point"===a.type?GeoJSON.pointDistance(f,a):GeoJSON.geometryWithinRadius(a,f,e)?0:e+1:null};else{if(e=b.$maxDistance,!isArray(a)&&!isPlainObject(a))throw Error("$near argument must be coordinate pair or GeoJSON");f=pointToArray(a),g=function(a){return isArray(a)||isPlainObject(a)?distanceCoordinatePairs(f,a):null}}return function(a){a=expandArraysInBranches(a);var b={result:!1};return _.each(a,function(a){var c=g(a.value);null===c||c>e||void 0!==b.distance&&b.distance<=c||(b.result=!0,b.distance=c,a.arrayIndices?b.arrayIndices=a.arrayIndices:delete b.arrayIndices)}),b}}},distanceCoordinatePairs=function(a,b){a=pointToArray(a),b=pointToArray(b);var c=a[0]-b[0],d=a[1]-b[1];return _.isNaN(c)||_.isNaN(d)?null:Math.sqrt(c*c+d*d)},pointToArray=function(a){return _.map(a,_.identity)},makeInequality=function(a){return{compileElementSelector:function(b){if(isArray(b))return function(){return!1};void 0===b&&(b=null);var c=LocalCollection._f._type(b);return function(d){return void 0===d&&(d=null),LocalCollection._f._type(d)!==c?!1:a(LocalCollection._f._cmp(d,b))}}}};ELEMENT_OPERATORS={$lt:makeInequality(function(a){return 0>a}),$gt:makeInequality(function(a){return a>0}),$lte:makeInequality(function(a){return 0>=a}),$gte:makeInequality(function(a){return a>=0}),$mod:{compileElementSelector:function(a){if(!isArray(a)||2!==a.length||"number"!=typeof a[0]||"number"!=typeof a[1])throw Error("argument to $mod must be an array of two numbers");var b=a[0],c=a[1];return function(a){return"number"==typeof a&&a%b===c}}},$in:{compileElementSelector:function(a){if(!isArray(a))throw Error("$in needs an array");var b=[];return _.each(a,function(a){if(a instanceof RegExp)b.push(regexpElementMatcher(a));else{if(isOperatorObject(a))throw Error("cannot nest $ under $in");b.push(equalityElementMatcher(a))}}),function(a){return void 0===a&&(a=null),_.any(b,function(b){return b(a)})}}},$size:{dontExpandLeafArrays:!0,compileElementSelector:function(a){if("string"==typeof a)a=0;else if("number"!=typeof a)throw Error("$size needs a number");return function(b){return isArray(b)&&b.length===a}}},$type:{dontIncludeLeafArrays:!0,compileElementSelector:function(a){if("number"!=typeof a)throw Error("$type needs a number");return function(b){return void 0!==b&&LocalCollection._f._type(b)===a}}},$regex:{compileElementSelector:function(a,b){if(!("string"==typeof a||a instanceof RegExp))throw Error("$regex has to be a string or RegExp");var c;if(void 0!==b.$options){if(/[^gim]/.test(b.$options))throw new Error("Only the i, m, and g regexp options are supported");var d=a instanceof RegExp?a.source:a;c=new RegExp(d,b.$options)}else c=a instanceof RegExp?a:new RegExp(a);return regexpElementMatcher(c)}},$elemMatch:{dontExpandLeafArrays:!0,compileElementSelector:function(a,b,c){if(!isPlainObject(a))throw Error("$elemMatch need an object");var d,e;return isOperatorObject(a,!0)?(d=compileValueSelector(a,c),e=!1):(d=compileDocumentSelector(a,c,{inElemMatch:!0}),e=!0),function(a){if(!isArray(a))return!1;for(var b=0;b<a.length;++b){var c,f=a[b];if(e){if(!isPlainObject(f)&&!isArray(f))return!1;c=f}else c=[{value:f,dontIterate:!0}];if(d(c).result)return b}return!1}}}},makeLookupFunction=function(a,b){b=b||{};var c,d=a.split("."),e=d.length?d[0]:"",f=isNumericKey(e),g=d.length>=2&&isNumericKey(d[1]);d.length>1&&(c=makeLookupFunction(d.slice(1).join(".")));var h=function(a){return a.dontIterate||delete a.dontIterate,a.arrayIndices&&!a.arrayIndices.length&&delete a.arrayIndices,a};return function(a,d){if(d||(d=[]),isArray(a)){if(!(f&&e<a.length))return[];d=d.concat(+e,"x")}var i=a[e];if(!c)return[h({value:i,dontIterate:isArray(a)&&isArray(i),arrayIndices:d})];if(!isIndexable(i))return isArray(a)?[]:[h({value:void 0,arrayIndices:d})];var j=[],k=function(a){Array.prototype.push.apply(j,a)};return k(c(i,d)),!isArray(i)||g&&b.forSort||_.each(i,function(a,b){isPlainObject(a)&&k(c(a,d.concat(b)))}),j}},MinimongoTest.makeLookupFunction=makeLookupFunction,expandArraysInBranches=function(a,b){var c=[];return _.each(a,function(a){var d=isArray(a.value);b&&d&&!a.dontIterate||c.push({value:a.value,arrayIndices:a.arrayIndices}),d&&!a.dontIterate&&_.each(a.value,function(b,d){c.push({value:b,arrayIndices:(a.arrayIndices||[]).concat(d)})})}),c};var nothingMatcher=function(){return{result:!1}},everythingMatcher=function(){return{result:!0}},andSomeMatchers=function(a){return 0===a.length?everythingMatcher:1===a.length?a[0]:function(b){var c={};return c.result=_.all(a,function(a){var d=a(b);return d.result&&void 0!==d.distance&&void 0===c.distance&&(c.distance=d.distance),d.result&&d.arrayIndices&&(c.arrayIndices=d.arrayIndices),d.result}),c.result||(delete c.distance,delete c.arrayIndices),c}},andDocumentMatchers=andSomeMatchers,andBranchedMatchers=andSomeMatchers;LocalCollection._f={_type:function(a){return"number"==typeof a?1:"string"==typeof a?2:"boolean"==typeof a?8:isArray(a)?4:null===a?10:a instanceof RegExp?11:"function"==typeof a?13:a instanceof Date?9:EJSON.isBinary(a)?5:a instanceof LocalCollection._ObjectID?7:3},_equal:function(a,b){return EJSON.equals(a,b,{keyOrderSensitive:!0})},_typeorder:function(a){return[-1,1,2,3,4,5,-1,6,7,8,0,9,-1,100,2,100,1,8,1][a]},_cmp:function(a,b){if(void 0===a)return void 0===b?0:-1;if(void 0===b)return 1;var c=LocalCollection._f._type(a),d=LocalCollection._f._type(b),e=LocalCollection._f._typeorder(c),f=LocalCollection._f._typeorder(d);if(e!==f)return f>e?-1:1;if(c!==d)throw Error("Missing type coercion logic in _cmp");if(7===c&&(c=d=2,a=a.toHexString(),b=b.toHexString()),9===c&&(c=d=1,a=a.getTime(),b=b.getTime()),1===c)return a-b;if(2===d)return b>a?-1:a===b?0:1;if(3===c){var g=function(a){var b=[];for(var c in a)b.push(c),b.push(a[c]);return b};return LocalCollection._f._cmp(g(a),g(b))}if(4===c)for(var h=0;;h++){if(h===a.length)return h===b.length?0:-1;if(h===b.length)return 1;var i=LocalCollection._f._cmp(a[h],b[h]);if(0!==i)return i}if(5===c){if(a.length!==b.length)return a.length-b.length;for(h=0;h<a.length;h++){if(a[h]<b[h])return-1;if(a[h]>b[h])return 1}return 0}if(8===c)return a?b?0:1:b?-1:0;if(10===c)return 0;if(11===c)throw Error("Sorting not supported on regular expression");if(13===c)throw Error("Sorting not supported on Javascript code");throw Error("Unknown type to sort")}},LocalCollection._removeDollarOperators=function(a){var b={};for(var c in a)"$"!==c.substr(0,1)&&(b[c]=a[c]);return b},Minimongo.Sorter=function(a,b){var c=this;b=b||{},c._sortSpecParts=[];var d=function(a,b){if(!a)throw Error("sort keys must be non-empty");if("$"===a.charAt(0))throw Error("unsupported sort key: "+a);c._sortSpecParts.push({path:a,lookup:makeLookupFunction(a,{forSort:!0}),ascending:b})};if(a instanceof Array)for(var e=0;e<a.length;e++)"string"==typeof a[e]?d(a[e],!0):d(a[e][0],"desc"!==a[e][1]);else{if("object"!=typeof a)throw Error("Bad sort specification: "+JSON.stringify(a));_.each(a,function(a,b){d(b,a>=0)})}if(c.affectedByModifier){var f={};_.each(c._sortSpecParts,function(a){f[a.path]=1}),c._selectorForAffectedByModifier=new Minimongo.Matcher(f)}c._keyComparator=composeComparators(_.map(c._sortSpecParts,function(a,b){return c._keyFieldComparator(b)})),c._keyFilter=null,b.matcher&&c._useWithMatcher(b.matcher)},_.extend(Minimongo.Sorter.prototype,{getComparator:function(a){var b=this;if(!a||!a.distances)return b._getBaseComparator();var c=a.distances;return composeComparators([b._getBaseComparator(),function(a,b){if(!c.has(a._id))throw Error("Missing distance for "+a._id);if(!c.has(b._id))throw Error("Missing distance for "+b._id);return c.get(a._id)-c.get(b._id)}])},_getPaths:function(){var a=this;return _.pluck(a._sortSpecParts,"path")},_getMinKeyFromDoc:function(a){var b=this,c=null;if(b._generateKeysFromDoc(a,function(a){return b._keyCompatibleWithSelector(a)?null===c?void(c=a):void(b._compareKeys(a,c)<0&&(c=a)):void 0}),null===c)throw Error("sort selector found no keys in doc?");return c},_keyCompatibleWithSelector:function(a){var b=this;return!b._keyFilter||b._keyFilter(a)},_generateKeysFromDoc:function(a,b){var c=this;if(0===c._sortSpecParts.length)throw new Error("can't generate keys without a spec");var d=[],e=function(a){return a.join(",")+","},f=null;if(_.each(c._sortSpecParts,function(b,c){var g=expandArraysInBranches(b.lookup(a),!0);g.length||(g=[{value:null}]);var h=!1;if(d[c]={},_.each(g,function(a){if(!a.arrayIndices){if(g.length>1)throw Error("multiple branches but no array used?");return void(d[c][""]=a.value)}h=!0;var b=e(a.arrayIndices);if(_.has(d[c],b))throw Error("duplicate path: "+b);if(d[c][b]=a.value,f&&!_.has(f,b))throw Error("cannot index parallel arrays")}),f){if(!_.has(d[c],"")&&_.size(f)!==_.size(d[c]))throw Error("cannot index parallel arrays!")}else h&&(f={},_.each(d[c],function(a,b){f[b]=!0}))}),!f){var g=_.map(d,function(a){if(!_.has(a,""))throw Error("no value in sole key case?");return a[""]});return void b(g)}_.each(f,function(a,c){var e=_.map(d,function(a){if(_.has(a,""))return a[""];if(!_.has(a,c))throw Error("missing path?");return a[c]});b(e)})},_compareKeys:function(a,b){var c=this;if(a.length!==c._sortSpecParts.length||b.length!==c._sortSpecParts.length)throw Error("Key has wrong length");return c._keyComparator(a,b)},_keyFieldComparator:function(a){var b=this,c=!b._sortSpecParts[a].ascending;return function(b,d){var e=LocalCollection._f._cmp(b[a],d[a]);return c&&(e=-e),e}},_getBaseComparator:function(){var a=this;return a._sortSpecParts.length?function(b,c){var d=a._getMinKeyFromDoc(b),e=a._getMinKeyFromDoc(c);return a._compareKeys(d,e)}:function(){return 0}},_useWithMatcher:function(a){var b=this;if(b._keyFilter)throw Error("called _useWithMatcher twice?");if(!_.isEmpty(b._sortSpecParts)){var c=a._selector;if(!(c instanceof Function)){var d={};_.each(b._sortSpecParts,function(a){d[a.path]=[]}),_.each(c,function(a,b){var c=d[b];if(c){if(a instanceof RegExp){if(a.ignoreCase||a.multiline)return;return void c.push(regexpElementMatcher(a))}return isOperatorObject(a)?void _.each(a,function(b,d){_.contains(["$lt","$lte","$gt","$gte"],d)&&c.push(ELEMENT_OPERATORS[d].compileElementSelector(b)),"$regex"!==d||a.$options||c.push(ELEMENT_OPERATORS.$regex.compileElementSelector(b,a))}):void c.push(equalityElementMatcher(a))}}),_.isEmpty(d[b._sortSpecParts[0].path])||(b._keyFilter=function(a){return _.all(b._sortSpecParts,function(b,c){return _.all(d[b.path],function(b){return b(a[c])})})})}}}});var composeComparators=function(a){return function(b,c){for(var d=0;d<a.length;++d){var e=a[d](b,c);if(0!==e)return e}return 0}};LocalCollection._compileProjection=function(a){LocalCollection._checkSupportedProjection(a);var b=_.isUndefined(a._id)?!0:a._id,c=projectionDetails(a),d=function(a,b){if(_.isArray(a))return _.map(a,function(a){return d(a,b)});var e=c.including?{}:EJSON.clone(a);return _.each(b,function(b,f){_.has(a,f)&&(_.isObject(b)?_.isObject(a[f])&&(e[f]=d(a[f],b)):c.including?e[f]=EJSON.clone(a[f]):delete e[f])}),e};return function(a){var e=d(a,c.tree);return b&&_.has(a,"_id")&&(e._id=a._id),!b&&_.has(e,"_id")&&delete e._id,e}},projectionDetails=function(a){var b=_.keys(a).sort();b.length>0&&(1!==b.length||"_id"!==b[0])&&(b=_.reject(b,function(a){return"_id"===a}));var c=null;_.each(b,function(b){var d=!!a[b];if(null===c&&(c=d),c!==d)throw MinimongoError("You cannot currently mix including and excluding fields.")});var d=pathsToTree(b,function(){return c},function(a,b,c){var d=c,e=b;throw MinimongoError("both "+d+" and "+e+" found in fields option, using both of them may trigger unexpected behavior. Did you mean to use only one of them?")});return{tree:d,including:c}},pathsToTree=function(a,b,c,d){return d=d||{},_.each(a,function(a){var e=d,f=a.split("."),g=_.all(f.slice(0,-1),function(b,d){if(_.has(e,b)){if(!_.isObject(e[b])&&(e[b]=c(e[b],f.slice(0,d+1).join("."),a),!_.isObject(e[b])))return!1}else e[b]={};return e=e[b],!0});if(g){var h=_.last(f);e[h]=_.has(e,h)?c(e[h],a,a):b(a)}}),d},LocalCollection._checkSupportedProjection=function(a){if(!_.isObject(a)||_.isArray(a))throw MinimongoError("fields option must be an object");_.each(a,function(a,b){if(_.contains(b.split("."),"$"))throw MinimongoError("Minimongo doesn't support $ operator in projections yet.");if(-1===_.indexOf([1,0,!0,!1],a))throw MinimongoError("Projection values should be one of 1, 0, true, or false")})},LocalCollection._modify=function(a,b,c){if(c=c||{},!isPlainObject(b))throw MinimongoError("Modifier must be an object");var d,e=isOperatorObject(b);if(e)d=EJSON.clone(a),_.each(b,function(a,b){var e=MODIFIERS[b];if(c.isInsert&&"$setOnInsert"===b&&(e=MODIFIERS.$set),!e)throw MinimongoError("Invalid modifier specified "+b);_.each(a,function(a,f){if(""===f)throw MinimongoError("An empty update path is not valid.");if("_id"===f)throw MinimongoError("Mod on _id not allowed");var g=f.split(".");if(!_.all(g,_.identity))throw MinimongoError("The update path '"+f+"' contains an empty field name, which is not allowed.");var h=(_.has(NO_CREATE_MODIFIERS,b),findModTarget(d,g,{noCreate:NO_CREATE_MODIFIERS[b],forbidArray:"$rename"===b,arrayIndices:c.arrayIndices})),i=g.pop();e(h,i,a,f,d)})});else{if(b._id&&!EJSON.equals(a._id,b._id))throw MinimongoError("Cannot change the _id of a document");for(var f in b)if(/\./.test(f))throw MinimongoError("When replacing document, field name may not contain '.'");d=b}_.each(_.keys(a),function(b){"_id"!==b&&delete a[b]}),_.each(d,function(b,c){a[c]=b})};var findModTarget=function(a,b,c){c=c||{};for(var d=!1,e=0;e<b.length;e++){var f=e===b.length-1,g=b[e],h=isIndexable(a);if(!h){if(c.noCreate)return void 0;var i=MinimongoError("cannot use the part '"+g+"' to traverse "+a);throw i.setPropertyError=!0,i}if(a instanceof Array){if(c.forbidArray)return null;if("$"===g){if(d)throw MinimongoError("Too many positional (i.e. '$') elements");if(!c.arrayIndices||!c.arrayIndices.length)throw MinimongoError("The positional operator did not find the match needed from the query");g=c.arrayIndices[0],d=!0}else{if(!isNumericKey(g)){if(c.noCreate)return void 0;throw MinimongoError("can't append to array using string field name ["+g+"]")}g=parseInt(g)}if(f&&(b[e]=g),c.noCreate&&g>=a.length)return void 0;for(;a.length<g;)a.push(null);if(!f)if(a.length===g)a.push({});else if("object"!=typeof a[g])throw MinimongoError("can't modify field '"+b[e+1]+"' of list value "+JSON.stringify(a[g]))}else{if(g.length&&"$"===g.substr(0,1))throw MinimongoError("can't set field named "+g);if(!(g in a)){if(c.noCreate)return void 0;f||(a[g]={})}}if(f)return a;a=a[g]}},NO_CREATE_MODIFIERS={$unset:!0,$pop:!0,$rename:!0,$pull:!0,$pullAll:!0},MODIFIERS={$inc:function(a,b,c){if("number"!=typeof c)throw MinimongoError("Modifier $inc allowed for numbers only");if(b in a){if("number"!=typeof a[b])throw MinimongoError("Cannot apply $inc modifier to non-number");a[b]+=c}else a[b]=c},$set:function(a,b,c){if(!_.isObject(a)){var d=MinimongoError("Cannot set property on non-object field");

throw d.setPropertyError=!0,d}if(null===a){var d=MinimongoError("Cannot set property on null");throw d.setPropertyError=!0,d}a[b]=EJSON.clone(c)},$setOnInsert:function(){},$unset:function(a,b){void 0!==a&&(a instanceof Array?b in a&&(a[b]=null):delete a[b])},$push:function(a,b,c){if(void 0===a[b]&&(a[b]=[]),!(a[b]instanceof Array))throw MinimongoError("Cannot apply $push modifier to non-array");if(!c||!c.$each)return void a[b].push(EJSON.clone(c));var d=c.$each;if(!(d instanceof Array))throw MinimongoError("$each must be an array");var e=void 0;if("$slice"in c){if("number"!=typeof c.$slice)throw MinimongoError("$slice must be a numeric value");if(c.$slice>0)throw MinimongoError("$slice in $push must be zero or negative");e=c.$slice}var f=void 0;if(c.$sort){if(void 0===e)throw MinimongoError("$sort requires $slice to be present");f=new Minimongo.Sorter(c.$sort).getComparator();for(var g=0;g<d.length;g++)if(3!==LocalCollection._f._type(d[g]))throw MinimongoError("$push like modifiers using $sort require all elements to be objects")}for(var h=0;h<d.length;h++)a[b].push(EJSON.clone(d[h]));f&&a[b].sort(f),void 0!==e&&(a[b]=0===e?[]:a[b].slice(e))},$pushAll:function(a,b,c){if(!("object"==typeof c&&c instanceof Array))throw MinimongoError("Modifier $pushAll/pullAll allowed for arrays only");var d=a[b];if(void 0===d)a[b]=c;else{if(!(d instanceof Array))throw MinimongoError("Cannot apply $pushAll modifier to non-array");for(var e=0;e<c.length;e++)d.push(c[e])}},$addToSet:function(a,b,c){var d=!1;if("object"==typeof c)for(var e in c){"$each"===e&&(d=!0);break}var f=d?c.$each:[c],g=a[b];if(void 0===g)a[b]=f;else{if(!(g instanceof Array))throw MinimongoError("Cannot apply $addToSet modifier to non-array");_.each(f,function(a){for(var b=0;b<g.length;b++)if(LocalCollection._f._equal(a,g[b]))return;g.push(EJSON.clone(a))})}},$pop:function(a,b,c){if(void 0!==a){var d=a[b];if(void 0!==d){if(!(d instanceof Array))throw MinimongoError("Cannot apply $pop modifier to non-array");"number"==typeof c&&0>c?d.splice(0,1):d.pop()}}},$pull:function(a,b,c){if(void 0!==a){var d=a[b];if(void 0!==d){if(!(d instanceof Array))throw MinimongoError("Cannot apply $pull/pullAll modifier to non-array");var e=[];if("object"!=typeof c||c instanceof Array)for(var f=0;f<d.length;f++)LocalCollection._f._equal(d[f],c)||e.push(d[f]);else for(var g=new Minimongo.Matcher(c),f=0;f<d.length;f++)g.documentMatches(d[f]).result||e.push(d[f]);a[b]=e}}},$pullAll:function(a,b,c){if(!("object"==typeof c&&c instanceof Array))throw MinimongoError("Modifier $pushAll/pullAll allowed for arrays only");if(void 0!==a){var d=a[b];if(void 0!==d){if(!(d instanceof Array))throw MinimongoError("Cannot apply $pull/pullAll modifier to non-array");for(var e=[],f=0;f<d.length;f++){for(var g=!1,h=0;h<c.length;h++)if(LocalCollection._f._equal(d[f],c[h])){g=!0;break}g||e.push(d[f])}a[b]=e}}},$rename:function(a,b,c,d,e){if(d===c)throw MinimongoError("$rename source must differ from target");if(null===a)throw MinimongoError("$rename source field invalid");if("string"!=typeof c)throw MinimongoError("$rename target must be a string");if(void 0!==a){var f=a[b];delete a[b];var g=c.split("."),h=findModTarget(e,g,{forbidArray:!0});if(null===h)throw MinimongoError("$rename target field invalid");var i=g.pop();h[i]=f}},$bit:function(){throw MinimongoError("$bit is not supported")}};LocalCollection._diffQueryChanges=function(a,b,c,d,e){a?LocalCollection._diffQueryOrderedChanges(b,c,d,e):LocalCollection._diffQueryUnorderedChanges(b,c,d,e)},LocalCollection._diffQueryUnorderedChanges=function(a,b,c,d){d=d||{};var e=d.projectionFn||EJSON.clone;if(c.movedBefore)throw new Error("_diffQueryUnordered called with a movedBefore observer!");b.forEach(function(b,d){var f=a.get(d);if(f){if(c.changed&&!EJSON.equals(f,b)){var g=e(b),h=e(f),i=LocalCollection._makeChangedFields(g,h);_.isEmpty(i)||c.changed(d,i)}}else if(c.added){var j=e(b);delete j._id,c.added(b._id,j)}}),c.removed&&a.forEach(function(a,d){b.has(d)||c.removed(d)})},LocalCollection._diffQueryOrderedChanges=function(a,b,c,d){d=d||{};var e=d.projectionFn||EJSON.clone,f={};_.each(b,function(a){f[a._id]&&Meteor._debug("Duplicate _id in new_results"),f[a._id]=!0});var g={};_.each(a,function(a,b){a._id in g&&Meteor._debug("Duplicate _id in old_results"),g[a._id]=b});for(var h=[],i=0,j=b.length,k=new Array(j),l=new Array(j),m=function(a){return g[b[a]._id]},n=0;j>n;n++)if(void 0!==g[b[n]._id]){for(var o=i;o>0&&!(m(k[o-1])<m(n));)o--;l[n]=0===o?-1:k[o-1],k[o]=n,o+1>i&&(i=o+1)}for(var p=0===i?-1:k[i-1];p>=0;)h.push(p),p=l[p];h.reverse(),h.push(b.length),_.each(a,function(a){f[a._id]||c.removed&&c.removed(a._id)});var q=0;_.each(h,function(d){for(var f,h,i,j,k,l=b[d]?b[d]._id:null,m=q;d>m;m++)h=b[m],_.has(g,h._id)?(f=a[g[h._id]],j=e(h),k=e(f),i=LocalCollection._makeChangedFields(j,k),_.isEmpty(i)||c.changed&&c.changed(h._id,i),c.movedBefore&&c.movedBefore(h._id,l)):(i=e(h),delete i._id,c.addedBefore&&c.addedBefore(h._id,i,l),c.added&&c.added(h._id,i));l&&(h=b[d],f=a[g[h._id]],j=e(h),k=e(f),i=LocalCollection._makeChangedFields(j,k),_.isEmpty(i)||c.changed&&c.changed(h._id,i)),q=d+1})},LocalCollection._diffObjects=function(a,b,c){_.each(a,function(a,d){_.has(b,d)?c.both&&c.both(d,a,b[d]):c.leftOnly&&c.leftOnly(d,a)}),c.rightOnly&&_.each(b,function(b,d){_.has(a,d)||c.rightOnly(d,b)})},LocalCollection._IdMap=function(){var a=this;IdMap.call(a,LocalCollection._idStringify,LocalCollection._idParse)},Meteor._inherits(LocalCollection._IdMap,IdMap),LocalCollection._CachingChangeObserver=function(a){var b=this;a=a||{};var c=a.callbacks&&LocalCollection._observeChangesCallbacksAreOrdered(a.callbacks);if(_.has(a,"ordered")){if(b.ordered=a.ordered,a.callbacks&&a.ordered!==c)throw Error("ordered option doesn't match callbacks")}else{if(!a.callbacks)throw Error("must provide ordered or callbacks");b.ordered=c}var d=a.callbacks||{};b.ordered?(b.docs=new OrderedDict(LocalCollection._idStringify),b.applyChange={addedBefore:function(a,c,e){var f=EJSON.clone(c);f._id=a,d.addedBefore&&d.addedBefore.call(b,a,c,e),d.added&&d.added.call(b,a,c),b.docs.putBefore(a,f,e||null)},movedBefore:function(a,c){b.docs.get(a);d.movedBefore&&d.movedBefore.call(b,a,c),b.docs.moveBefore(a,c||null)}}):(b.docs=new LocalCollection._IdMap,b.applyChange={added:function(a,c){var e=EJSON.clone(c);d.added&&d.added.call(b,a,c),e._id=a,b.docs.set(a,e)}}),b.applyChange.changed=function(a,c){var e=b.docs.get(a);if(!e)throw new Error("Unknown id for changed: "+a);d.changed&&d.changed.call(b,a,EJSON.clone(c)),LocalCollection._applyChanges(e,c)},b.applyChange.removed=function(a){d.removed&&d.removed.call(b,a),b.docs.remove(a)}},LocalCollection._observeFromObserveChanges=function(a,b){var c,d=a.getTransform()||function(a){return a},e=!!b._suppress_initial;if(LocalCollection._observeCallbacksAreOrdered(b)){var f=!b._no_indices;c={addedBefore:function(a,c,g){var h=this;if(!e&&(b.addedAt||b.added)){var i=d(_.extend(c,{_id:a}));if(b.addedAt){var j=f?g?h.docs.indexOf(g):h.docs.size():-1;b.addedAt(i,j,g)}else b.added(i)}},changed:function(a,c){var e=this;if(b.changedAt||b.changed){var g=EJSON.clone(e.docs.get(a));if(!g)throw new Error("Unknown id for changed: "+a);var h=d(EJSON.clone(g));if(LocalCollection._applyChanges(g,c),g=d(g),b.changedAt){var i=f?e.docs.indexOf(a):-1;b.changedAt(g,h,i)}else b.changed(g,h)}},movedBefore:function(a,c){var e=this;if(b.movedTo){var g=f?e.docs.indexOf(a):-1,h=f?c?e.docs.indexOf(c):e.docs.size():-1;h>g&&--h,b.movedTo(d(EJSON.clone(e.docs.get(a))),g,h,c||null)}},removed:function(a){var c=this;if(b.removedAt||b.removed){var e=d(c.docs.get(a));if(b.removedAt){var g=f?c.docs.indexOf(a):-1;b.removedAt(e,g)}else b.removed(e)}}}}else c={added:function(a,c){if(!e&&b.added){var f=_.extend(c,{_id:a});b.added(d(f))}},changed:function(a,c){var e=this;if(b.changed){var f=e.docs.get(a),g=EJSON.clone(f);LocalCollection._applyChanges(g,c),b.changed(d(g),d(EJSON.clone(f)))}},removed:function(a){var c=this;b.removed&&b.removed(d(c.docs.get(a)))}};var g=new LocalCollection._CachingChangeObserver({callbacks:c}),h=a.observeChanges(g.applyChange);return e=!1,h},LocalCollection._looksLikeObjectID=function(a){return 24===a.length&&a.match(/^[0-9a-f]*$/)},LocalCollection._ObjectID=function(a){var b=this;if(a){if(a=a.toLowerCase(),!LocalCollection._looksLikeObjectID(a))throw new Error("Invalid hexadecimal string for creating an ObjectID");b._str=a}else b._str=Random.hexString(24)},LocalCollection._ObjectID.prototype.toString=function(){var a=this;return'ObjectID("'+a._str+'")'},LocalCollection._ObjectID.prototype.equals=function(a){var b=this;return a instanceof LocalCollection._ObjectID&&b.valueOf()===a.valueOf()},LocalCollection._ObjectID.prototype.clone=function(){var a=this;return new LocalCollection._ObjectID(a._str)},LocalCollection._ObjectID.prototype.typeName=function(){return"oid"},LocalCollection._ObjectID.prototype.getTimestamp=function(){var a=this;return parseInt(a._str.substr(0,8),16)},LocalCollection._ObjectID.prototype.valueOf=LocalCollection._ObjectID.prototype.toJSONValue=LocalCollection._ObjectID.prototype.toHexString=function(){return this._str},LocalCollection._selectorIsId=function(a){return"string"==typeof a||"number"==typeof a||a instanceof LocalCollection._ObjectID},LocalCollection._selectorIsIdPerhapsAsObject=function(a){return LocalCollection._selectorIsId(a)||a&&"object"==typeof a&&a._id&&LocalCollection._selectorIsId(a._id)&&1===_.size(a)},LocalCollection._idsMatchedBySelector=function(a){if(LocalCollection._selectorIsId(a))return[a];if(!a)return null;if(_.has(a,"_id"))return LocalCollection._selectorIsId(a._id)?[a._id]:a._id&&a._id.$in&&_.isArray(a._id.$in)&&!_.isEmpty(a._id.$in)&&_.all(a._id.$in,LocalCollection._selectorIsId)?a._id.$in:null;if(a.$and&&_.isArray(a.$and))for(var b=0;b<a.$and.length;++b){var c=LocalCollection._idsMatchedBySelector(a.$and[b]);if(c)return c}return null},EJSON.addType("oid",function(a){return new LocalCollection._ObjectID(a)});var nextSlot=0,currentValues=[];Meteor.EnvironmentVariable=function(){this.slot=nextSlot++},_.extend(Meteor.EnvironmentVariable.prototype,{get:function(){return currentValues[this.slot]},getOrNullIfOutsideFiber:function(){return this.get()},withValue:function(a,b){var c=currentValues[this.slot];try{currentValues[this.slot]=a;var d=b()}finally{currentValues[this.slot]=c}return d}}),Meteor.bindEnvironment=function(a,b,c){var d=_.clone(currentValues);if(!b||"string"==typeof b){var e=b||"callback of async function";b=function(a){Meteor._debug("Exception in "+e+":",a&&a.stack||a)}}return function(){var e=currentValues;try{currentValues=d;var f=a.apply(c,_.toArray(arguments))}catch(g){b(g)}finally{currentValues=e}return f}},Meteor._nodeCodeMustBeInFiber=function(){},ReactiveVar=function(a,b){return this instanceof ReactiveVar?(this.curValue=a,this.equalsFunc=b,void(this.dep=new Tracker.Dependency)):new ReactiveVar(a,b)},ReactiveVar._isEqual=function(a,b){var c=a,d=b;return c!==d?!1:!c||"number"==typeof c||"boolean"==typeof c||"string"==typeof c},ReactiveVar.prototype.get=function(){return Tracker.active&&this.dep.depend(),this.curValue},ReactiveVar.prototype.set=function(a){var b=this.curValue;(this.equalsFunc||ReactiveVar._isEqual)(b,a)||(this.curValue=a,this.dep.changed())},ReactiveVar.prototype.toString=function(){return"ReactiveVar{"+this.get()+"}"},ReactiveVar.prototype._numListeners=function(){var a=0;for(var b in this.dep._dependentsById)a++;return a};var stringify=function(a){return void 0===a?"undefined":EJSON.stringify(a)},parse=function(a){return void 0===a||"undefined"===a?void 0:EJSON.parse(a)},changed=function(a){a&&a.changed()};ReactiveDict=function(a){if(a)if("string"==typeof a)ReactiveDict._registerDictForMigrate(a,this),this.keys=ReactiveDict._loadMigratedDict(a)||{};else{if("object"!=typeof a)throw new Error("Invalid ReactiveDict argument: "+a);this.keys=a}else this.keys={};this.allDeps=new Tracker.Dependency,this.keyDeps={},this.keyValueDeps={}},_.extend(ReactiveDict.prototype,{set:function(a,b){var c=this;if("object"==typeof a&&void 0===b)return void c._setObject(a);var d=a;b=stringify(b);var e="undefined";_.has(c.keys,d)&&(e=c.keys[d]),b!==e&&(c.keys[d]=b,c.allDeps.changed(),changed(c.keyDeps[d]),c.keyValueDeps[d]&&(changed(c.keyValueDeps[d][e]),changed(c.keyValueDeps[d][b])))},setDefault:function(a,b){var c=this;void 0===c.keys[a]&&c.set(a,b)},get:function(a){var b=this;return b._ensureKey(a),b.keyDeps[a].depend(),parse(b.keys[a])},equals:function(a,b){var c=this,d=null;if("undefined"!=typeof Mongo&&(d=Mongo.ObjectID),!("string"==typeof b||"number"==typeof b||"boolean"==typeof b||"undefined"==typeof b||b instanceof Date||d&&b instanceof d||null===b))throw new Error("ReactiveDict.equals: value must be scalar");var e=stringify(b);if(Tracker.active){c._ensureKey(a),_.has(c.keyValueDeps[a],e)||(c.keyValueDeps[a][e]=new Tracker.Dependency);var f=c.keyValueDeps[a][e].depend();f&&Tracker.onInvalidate(function(){c.keyValueDeps[a][e].hasDependents()||delete c.keyValueDeps[a][e]})}var g=void 0;return _.has(c.keys,a)&&(g=parse(c.keys[a])),EJSON.equals(g,b)},all:function(){this.allDeps.depend();var a={};return _.each(this.keys,function(b,c){a[c]=parse(b)}),a},clear:function(){var a=this,b=a.keys;a.keys={},a.allDeps.changed(),_.each(b,function(b,c){changed(a.keyDeps[c]),changed(a.keyValueDeps[c][b]),changed(a.keyValueDeps[c].undefined)})},_setObject:function(a){var b=this;_.each(a,function(a,c){b.set(c,a)})},_ensureKey:function(a){var b=this;a in b.keyDeps||(b.keyDeps[a]=new Tracker.Dependency,b.keyValueDeps[a]={})},_getMigrationData:function(){return this.keys}});var Future;Meteor.isServer&&(Future=Npm.require("fibers/future")),TestCaseResults=function(a,b,c,d){var e=this;e.test_case=a,e.onEvent=b,e.expecting_failure=!1,e.current_fail_count=0,e.stop_at_offset=d,e.onException=c,e.id=Random.id(),e.extraDetails={}},_.extend(TestCaseResults.prototype,{ok:function(a){var b=this,c={type:"ok"};a&&(c.details=a),b.expecting_failure&&(c.details=c.details||{},c.details.was_expecting_failure=!0,b.expecting_failure=!1),b.onEvent(c)},expect_fail:function(){var a=this;a.expecting_failure=!0},fail:function(a){var b=this;if("string"==typeof a&&(a={type:"fail",message:a}),a=_.extend({},a,b.extraDetails),0===b.stop_at_offset){if(Meteor.isClient){var c=+new Date;+new Date-c<100&&alert("To use this feature, first enable your browser's debugger.")}b.stop_at_offset=null}if(b.stop_at_offset&&b.stop_at_offset--,Error.captureStackTrace){var d=Error.prepareStackTrace;Error.prepareStackTrace=function(a,b){return b};var e=new Error;Error.captureStackTrace(e);var f=e.stack;Error.prepareStackTrace=d;for(var g=f.length-1;g>=0;--g){var h=f[g];if(h.getFileName().match(/:tests\.js/)){a.filename=h.getFileName(),a.line=h.getLineNumber();break}}}b.onEvent({type:b.expecting_failure?"expected_fail":"fail",details:a,cookie:{name:b.test_case.name,offset:b.current_fail_count,groupPath:b.test_case.groupPath,shortName:b.test_case.shortName}}),b.expecting_failure=!1,b.current_fail_count++},exception:function(a){this.onException(a)},runId:function(){return this.id},equal:function(a,b,c,d){if(!d&&"string"==typeof a&&"string"==typeof b)return void this._stringEqual(a,b,c);var e;if("object"==typeof b&&b&&b.nodeType)e=b===a,b="[Node]",a="[Unknown]";else if("undefined"!=typeof Uint8Array&&b instanceof Uint8Array){a instanceof Uint8Array||this.fail({type:"assert_equal",message:"found object is not a typed array",expected:"A typed array",actual:a.constructor.toString()}),b.length!==a.length&&this.fail({type:"assert_equal",message:"lengths of typed arrays do not match",expected:b.length,actual:a.length});for(var f=0;f<b.length;f++)this.equal(a[f],b[f])}else e=EJSON.equals(b,a);e===!!d?this.fail({type:"assert_equal",message:c,expected:JSON.stringify(b),actual:JSON.stringify(a),not:!!d}):this.ok()},notEqual:function(a,b,c){this.equal(a,b,c,!0)},instanceOf:function(a,b,c){a instanceof b?this.ok():this.fail({type:"instanceOf",message:c,not:!1})},notInstanceOf:function(a,b,c){a instanceof b?this.fail({type:"instanceOf",message:c,not:!0}):this.ok()},matches:function(a,b,c){b.test(a)?this.ok():this.fail({type:"matches",message:c,actual:a,regexp:b.toString(),not:!1})},notMatches:function(a,b,c){b.test(a)?this.fail({type:"matches",message:c,actual:a,regexp:b.toString(),not:!0}):this.ok()},"throws":function(a,b){var c,d;if(void 0===b)d=function(){return!0};else if(_.isString(b))d=function(a){return _.isString(a.message)&&-1!==a.message.indexOf(b)};else if(b instanceof RegExp)d=function(a){return b.test(a.message)};else{if("function"!=typeof b)throw new Error("expected should be a string, regexp, or predicate function");d=b}try{a()}catch(e){c=e}c&&d(c)?this.ok():this.fail({type:"throws",message:c?"wrong error thrown: "+c.message:"did not throw an error as expected"})},isTrue:function(a,b){a?this.ok():this.fail({type:"true",message:b,not:!1})},isFalse:function(a,b){a?this.fail({type:"true",message:b,not:!0}):this.ok()},isNull:function(a,b){null===a?this.ok():this.fail({type:"null",message:b,not:!1})},isNotNull:function(a,b){null===a?this.fail({type:"null",message:b,not:!0}):this.ok()},isUndefined:function(a,b){void 0===a?this.ok():this.fail({type:"undefined",message:b,not:!1})},isNotUndefined:function(a,b){void 0===a?this.fail({type:"undefined",message:b,not:!0}):this.ok()},isNaN:function(a,b){isNaN(a)?this.ok():this.fail({type:"NaN",message:b,not:!1})},isNotNaN:function(a,b){isNaN(a)?this.fail({type:"NaN",message:b,not:!0}):this.ok()},include:function(a,b,c,d){var e=!1;a instanceof Array?e=_.any(a,function(a){return _.isEqual(b,a)}):"object"==typeof a?e=b in a:"string"==typeof a&&a.indexOf(b)>-1&&(e=!0),e===!d?this.ok():this.fail({type:"include",message:c,sequence:a,should_contain_value:b,not:!!d})},notInclude:function(a,b,c){this.include(a,b,c,!0)},length:function(a,b,c){a.length===b?this.ok():this.fail({type:"length",expected:b,actual:a.length,message:c})},_stringEqual:function(a,b,c){a!==b?this.fail({type:"string_equal",message:c,expected:b,actual:a}):this.ok()}}),TestCase=function(a,b){var c=this;c.name=a,c.func=b;var d=_.map(a.split(" - "),function(a){return a.replace(/^\s*|\s*$/g,"")});c.shortName=d.pop(),d.unshift("tinytest"),c.groupPath=d},_.extend(TestCase.prototype,{run:function(a,b,c,d){var e=this,f=!1,g=function(){return f?(Meteor._debug("*** Test error -- test '"+e.name+"' returned multiple times."),!1):(f=!0,!0)},h=function(b){return f&&console.trace("event after complete!"),a(b)},i=new TestCaseResults(e,h,function(a){g()&&c(a)},d);Meteor.defer(function(){try{e.func(i,function(){g()&&b()})}catch(a){g()&&c(a)}})}}),TestManager=function(){var a=this;a.tests={},a.ordered_tests=[],a.testQueue=Meteor.isServer&&new Meteor._SynchronousQueue},Meteor.isServer&&process.env.TINYTEST_FILTER&&(__meteor_runtime_config__.tinytestFilter=process.env.TINYTEST_FILTER),_.extend(TestManager.prototype,{addCase:function(a){var b=this;if(a.name in b.tests)throw new Error("Every test needs a unique name, but there are two tests named '"+a.name+"'");__meteor_runtime_config__.tinytestFilter&&-1===a.name.indexOf(__meteor_runtime_config__.tinytestFilter)||(b.tests[a.name]=a,b.ordered_tests.push(a))},createRun:function(a,b){var c=this;return new TestRun(c,a,b)}}),TestManager=new TestManager,TestRun=function(a,b,c){var d=this;d.manager=a,d.onReport=b,d.next_sequence_number=0,d._pathPrefix=c||[],_.each(d.manager.ordered_tests,function(a){d._prefixMatch(a.groupPath)&&d._report(a)})},_.extend(TestRun.prototype,{_prefixMatch:function(a){for(var b=this,c=0;c<b._pathPrefix.length;c++)if(!a[c]||b._pathPrefix[c]!==a[c])return!1;return!0},_runTest:function(a,b,c){var d=this,e=+new Date;a.run(function(b){a.timedOut||d._report(a,b)},function(){if(!a.timedOut){var c=+new Date-e;d._report(a,{type:"finish",timeMs:c}),b()}},function(c){a.timedOut||(d._report(a,{type:"exception",details:{message:c.message,stack:c.stack}}),b())},c)},_runOne:function(a,b,c){var d=this;return d._prefixMatch(a.groupPath)?void(Meteor.isServer?d.manager.testQueue.queueTask(function(){var e=new Future;Meteor.setTimeout(function(){e.isResolved()||(a.timedOut=!0,d._report(a,{type:"exception",details:{message:"test timed out"}}),e["return"]())},18e4),d._runTest(a,function(){e.isResolved()||e["return"]()},c),e.wait(),b&&b()}):d._runTest(a,function(){b&&b()},c)):void(b&&b())},run:function(a){var b=this,c=_.clone(b.manager.ordered_tests),d=function(a){Meteor.isClient&&Tinytest._onCurrentClientTest(a)},e=function(){if(c.length){var f=c.shift();d(f.name),b._runOne(f,e)}else d(null),a&&a()};e()},debug:function(a,b){var c=this,d=c.manager.tests[a.name];if(!d)throw new Error("No such test '"+a.name+"'");c._runOne(d,b,a.offset)},_report:function(a,b){var c=this;if(b)var d=[_.extend({sequence:c.next_sequence_number++},b)];else var d=[];c.onReport({groupPath:a.groupPath,test:a.shortName,events:d})}}),Tinytest={},Tinytest.addAsync=function(a,b){TestManager.addCase(new TestCase(a,b))},Tinytest.add=function(a,b){Tinytest.addAsync(a,function(a,c){b(a),c()})},Tinytest._runTests=function(a,b,c){var d=TestManager.createRun(a,c);d.run(b)},Tinytest._debugTest=function(a,b,c){var d=TestManager.createRun(b);d.debug(a,c)},Tinytest._onCurrentClientTest=function(){},Tinytest._runTestsEverywhere=function(a,b,c,d){var e=Random.id(),f=!1,g=!1,h=!1,i=!1;d=_.extend({serial:!0},d);var j,k=!!d.serial,l=function(){!i&&f&&h&&(i=!0,b&&b()),k&&h&&!g&&m()},m=function(){g=!0,Tinytest._runTests(a,function(){f=!0,l()},c)};Meteor.connection.registerStore(Meteor._ServerTestResultsCollection,{update:function(b){b.id===e&&(_.each(b.fields,function(b,c){"complete"!==c&&(_.each(b.events,function(a){delete a.cookie}),b.server=!0,a(b))}),b.fields&&_.has(b.fields,"complete")&&(h=!0,j.stop(),Meteor.call("tinytest/clearResults",e),l()))}}),j=Meteor.subscribe(Meteor._ServerTestResultsSubscription,e),Meteor.call("tinytest/run",e,c,function(a){if(a)throw new Error("Test server returned an error")}),k||m()},LocalCollection._useOID=!0;var assert_ordering=function(a,b,c){for(var d=0;d<c.length;d++){var e=b(c[d],c[d]);if(0!==e&&a.fail({type:"minimongo-ordering",message:"value doesn't order as equal to itself",value:JSON.stringify(c[d]),should_be_zero_but_got:JSON.stringify(e)}),d+1<c.length){var f=c[d],g=c[d+1],e=b(f,g);0>e||a.fail({type:"minimongo-ordering",message:"ordering test failed",first:JSON.stringify(f),second:JSON.stringify(g),should_be_negative_but_got:JSON.stringify(e)}),e=b(g,f),e>0||a.fail({type:"minimongo-ordering",message:"ordering test failed",first:JSON.stringify(f),second:JSON.stringify(g),should_be_positive_but_got:JSON.stringify(e)})}}},log_callbacks=function(a){return{addedAt:function(b,c,d){delete b._id,a.push(EJSON.clone(["added",b,c,d]))},changedAt:function(b,c,d){delete b._id,delete c._id,a.push(EJSON.clone(["changed",b,d,c]))},movedTo:function(b,c,d,e){delete b._id,a.push(EJSON.clone(["moved",b,c,d,e]))},removedAt:function(b,c){var d=b._id;delete b._id,a.push(EJSON.clone(["removed",d,c,b]))}}};Tinytest.add("minimongo - basics",function(a){var b,c,d=new LocalCollection;b=d.insert({type:"kitten",name:"fluffy"}),d.insert({type:"kitten",name:"snookums"}),d.insert({type:"cryptographer",name:"alice"}),d.insert({type:"cryptographer",name:"bob"}),d.insert({type:"cryptographer",name:"cara"}),a.equal(d.find().count(),5),a.equal(d.find({type:"kitten"}).count(),2),a.equal(d.find({type:"cryptographer"}).count(),3),a.length(d.find({type:"kitten"}).fetch(),2),a.length(d.find({type:"cryptographer"}).fetch(),3),a.equal(b,d.findOne({type:"kitten",name:"fluffy"})._id),d.remove({name:"cara"}),a.equal(d.find().count(),4),a.equal(d.find({type:"kitten"}).count(),2),a.equal(d.find({type:"cryptographer"}).count(),2),a.length(d.find({type:"kitten"}).fetch(),2),a.length(d.find({type:"cryptographer"}).fetch(),2),c=d.update({name:"snookums"},{$set:{type:"cryptographer"}}),a.equal(c,1),a.equal(d.find().count(),4),a.equal(d.find({type:"kitten"}).count(),1),a.equal(d.find({type:"cryptographer"}).count(),3),a.length(d.find({type:"kitten"}).fetch(),1),a.length(d.find({type:"cryptographer"}).fetch(),3),d.remove(null),d.remove(!1),d.remove(void 0),a.equal(d.find().count(),4),d.remove({_id:null}),d.remove({_id:!1}),d.remove({_id:void 0}),c=d.remove(),a.equal(c,0),a.equal(d.find().count(),4),c=d.remove({}),a.equal(c,4),a.equal(d.find().count(),0),d.insert({_id:1,name:"strawberry",tags:["fruit","red","squishy"]}),d.insert({_id:2,name:"apple",tags:["fruit","red","hard"]}),d.insert({_id:3,name:"rose",tags:["flower","red","squishy"]}),a.equal(d.find({tags:"flower"}).count(),1),a.equal(d.find({tags:"fruit"}).count(),2),a.equal(d.find({tags:"red"}).count(),3),a.length(d.find({tags:"flower"}).fetch(),1),a.length(d.find({tags:"fruit"}).fetch(),2),a.length(d.find({tags:"red"}).fetch(),3),a.equal(d.findOne(1).name,"strawberry"),a.equal(d.findOne(2).name,"apple"),a.equal(d.findOne(3).name,"rose"),a.equal(d.findOne(4),void 0),a.equal(d.findOne("abc"),void 0),a.equal(d.findOne(void 0),void 0),a.equal(d.find(1).count(),1),a.equal(d.find(4).count(),0),a.equal(d.find("abc").count(),0),a.equal(d.find(void 0).count(),0),a.equal(d.find().count(),3),a.equal(d.find(1,{skip:1}).count(),0),a.equal(d.find({_id:1},{skip:1}).count(),0),a.equal(d.find({},{skip:1}).count(),2),a.equal(d.find({},{skip:2}).count(),1),a.equal(d.find({},{limit:2}).count(),2),a.equal(d.find({},{limit:1}).count(),1),a.equal(d.find({},{skip:1,limit:1}).count(),1),a.equal(d.find({tags:"fruit"},{skip:1}).count(),1),a.equal(d.find({tags:"fruit"},{limit:1}).count(),1),a.equal(d.find({tags:"fruit"},{skip:1,limit:1}).count(),1),a.equal(d.find(1,{sort:["_id","desc"],skip:1}).count(),0),a.equal(d.find({_id:1},{sort:["_id","desc"],skip:1}).count(),0),a.equal(d.find({},{sort:["_id","desc"],skip:1}).count(),2),a.equal(d.find({},{sort:["_id","desc"],skip:2}).count(),1),a.equal(d.find({},{sort:["_id","desc"],limit:2}).count(),2),a.equal(d.find({},{sort:["_id","desc"],limit:1}).count(),1),a.equal(d.find({},{sort:["_id","desc"],skip:1,limit:1}).count(),1),a.equal(d.find({tags:"fruit"},{sort:["_id","desc"],skip:1}).count(),1),a.equal(d.find({tags:"fruit"},{sort:["_id","desc"],limit:1}).count(),1),a.equal(d.find({tags:"fruit"},{sort:["_id","desc"],skip:1,limit:1}).count(),1),d.insert({foo:{bar:"baz"}}),a.equal(d.find({foo:{bam:"baz"}}).count(),0),a.equal(d.find({foo:{bar:"baz"}}).count(),1)}),Tinytest.add("minimongo - cursors",function(a){for(var b,c=new LocalCollection,d=0;20>d;d++)c.insert({i:d});var e=c.find();a.equal(e.count(),20),b=e.fetch(),a.length(b,20);for(var d=0;20>d;d++)a.equal(b[d].i,d);a.length(e.fetch(),20);var f=0,g={};e.forEach(function(b,c,d){a.equal(b.i,f++),a.equal(b.i,c),a.isTrue(g===this),a.isTrue(d===e)},g),a.equal(f,20),a.length(e.fetch(),20),b=e.map(function(b,c,d){return a.equal(b.i,c),a.isTrue(g===this),a.isTrue(d===e),2*b.i},g),a.length(b,20);for(var d=0;20>d;d++)a.equal(b[d],2*d);a.length(e.fetch(),20),a.equal(c.findOne({i:0}).i,0),a.equal(c.findOne({i:1}).i,1);var h=c.findOne({i:2})._id;a.equal(c.findOne(h).i,2)}),Tinytest.add("minimongo - transform",function(a){var b=new LocalCollection;b.insert({});var c=function(a){return a._id};a["throws"](function(){b.findOne({},{transform:c})});var d=function(a){return _.omit(a,"_id")};a.equal(b.findOne({},{transform:d})._id,b.findOne()._id)}),Tinytest.add("minimongo - misc",function(a){var b={a:[1,2,3],b:"x",c:!0,d:{x:12,y:[12]},f:null,g:new Date},c=EJSON.clone(b);a.equal(b,c),a.isTrue(LocalCollection._f._equal(b,c)),b.a.push(4),a.length(c.a,3),b.c=!1,a.isTrue(c.c),c.d.z=15,b.d.z=14,a.equal(c.d.z,15),b.d.y.push(88),a.length(c.d.y,1),a.equal(b.g,c.g),c.g.setDate(c.g.getDate()+1),a.notEqual(b.g,c.g),b={x:function(){}},c=EJSON.clone(b),b.x.a=14,a.equal(c.x.a,14)}),Tinytest.add("minimongo - lookup",function(a){var b=MinimongoTest.makeLookupFunction("a");a.equal(b({}),[{value:void 0}]),a.equal(b({a:1}),[{value:1}]),a.equal(b({a:[1]}),[{value:[1]}]);var c=MinimongoTest.makeLookupFunction("a.x");a.equal(c({a:{x:1}}),[{value:1}]),a.equal(c({a:{x:[1]}}),[{value:[1]}]),a.equal(c({a:5}),[{value:void 0}]),a.equal(c({a:[{x:1},{x:[2]},{y:3}]}),[{value:1,arrayIndices:[0]},{value:[2],arrayIndices:[1]},{value:void 0,arrayIndices:[2]}]);var d=MinimongoTest.makeLookupFunction("a.0.x");a.equal(d({a:[{x:1}]}),[{value:1,arrayIndices:[0,"x"]},{value:void 0,arrayIndices:[0]}]),a.equal(d({a:[{x:[1]}]}),[{value:[1],arrayIndices:[0,"x"]},{value:void 0,arrayIndices:[0]}]),a.equal(d({a:5}),[{value:void 0}]),a.equal(d({a:[{x:1},{x:[2]},{y:3}]}),[{value:1,arrayIndices:[0,"x"]},{value:void 0,arrayIndices:[0]},{value:void 0,arrayIndices:[1]},{value:void 0,arrayIndices:[2]}]),a.equal(MinimongoTest.makeLookupFunction("w.x.0.z")({w:[{x:[{z:5}]}]}),[{value:5,arrayIndices:[0,0,"x"]},{value:void 0,arrayIndices:[0,0]}])}),Tinytest.add("minimongo - selector_compiler",function(a){var b=function(b,c,d){var e=new Minimongo.Matcher(c).documentMatches(d).result;e!=b&&a.fail({message:"minimongo match failure: document "+(b?"should match, but doesn't":"shouldn't match, but does"),selector:JSON.stringify(c),document:JSON.stringify(d)})},c=_.bind(b,null,!0),d=_.bind(b,null,!1);c({},{}),c({},{a:12}),c(1,{_id:1,a:"foo"}),d(1,{_id:2,a:"foo"}),c("a",{_id:"a",a:"foo"}),d("a",{_id:"b",a:"foo"}),d(void 0,{}),d(void 0,{_id:"foo"}),d(!1,{_id:"foo"}),d(null,{_id:"foo"}),d({_id:void 0},{_id:"foo"}),d({_id:!1},{_id:"foo"}),d({_id:null},{_id:"foo"}),d({a:12},{}),c({a:12},{a:12}),c({a:12},{a:12,b:13}),c({a:12,b:13},{a:12,b:13}),c({a:12,b:13},{a:12,b:13,c:14}),d({a:12,b:13,c:14},{a:12,b:13}),d({a:12,b:13},{b:13,c:14}),c({a:12},{a:[12]}),c({a:12},{a:[11,12,13]}),d({a:12},{a:[11,13]}),c({a:12,b:13},{a:[11,12,13],b:[13,14,15]}),d({a:12,b:13},{a:[11,12,13],b:[14,15]});var e=new Date,f=new Date(e.getTime()+1e3);c({a:e},{a:e}),d({a:e},{a:f}),c({a:[1,2]},{a:[1,2]}),c({a:[1,2]},{a:[[1,2]]}),c({a:[1,2]},{a:[[3,4],[1,2]]}),d({a:[1,2]},{a:[3,4]}),d({a:[1,2]},{a:[[[1,2]]]}),c({a:{b:12}},{a:{b:12}}),d({a:{b:12,c:13}},{a:{b:12}}),d({a:{b:12}},{a:{b:12,c:13}}),c({a:{b:12,c:13}},{a:{b:12,c:13}}),d({a:{b:12,c:13}},{a:{c:13,b:12}}),d({a:{}},{a:{b:12}}),d({a:{b:12}},{a:{}}),c({a:{b:12,c:[13,!0,!1,2.2,"a",null,{d:14}]}},{a:{b:12,c:[13,!0,!1,2.2,"a",null,{d:14}]}}),c({a:{b:12}},{a:{b:12},k:99}),c({a:{b:12}},{a:[{b:12}]}),d({a:{b:12}},{a:[[{b:12}]]}),c({a:{b:12}},{a:[{b:11},{b:12},{b:13}]}),d({a:{b:12}},{a:[{b:11},{b:12,c:20},{b:13}]}),d({a:{b:12,c:20}},{a:[{b:11},{b:12},{c:20}]}),c({a:{b:12,c:20}},{a:[{b:11},{b:12,c:20},{b:13}]}),c({a:null},{a:null}),c({a:null},{b:12}),d({a:null},{a:12}),c({a:null},{a:[1,2,null,3]}),d({a:null},{a:[1,2,{},3]}),c({a:{$lt:10}},{a:9}),d({a:{$lt:10}},{a:10}),d({a:{$lt:10}},{a:11}),c({a:{$gt:10}},{a:11}),d({a:{$gt:10}},{a:10}),d({a:{$gt:10}},{a:9}),c({a:{$lte:10}},{a:9}),c({a:{$lte:10}},{a:10}),d({a:{$lte:10}},{a:11}),c({a:{$gte:10}},{a:11}),c({a:{$gte:10}},{a:10}),d({a:{$gte:10}},{a:9}),c({a:{$lt:10}},{a:[11,9,12]}),d({a:{$lt:10}},{a:[11,12]}),d({a:{$lt:"null"}},{a:null}),c({a:{$lt:{x:[2,3,4]}}},{a:{x:[1,3,4]}}),c({a:{$gt:{x:[2,3,4]}}},{a:{x:[3,3,4]}}),d({a:{$gt:{x:[2,3,4]}}},{a:{x:[1,3,4]}}),d({a:{$gt:{x:[2,3,4]}}},{a:{x:[2,3,4]}}),d({a:{$lt:{x:[2,3,4]}}},{a:{x:[2,3,4]}}),c({a:{$gte:{x:[2,3,4]}}},{a:{x:[2,3,4]}}),c({a:{$lte:{x:[2,3,4]}}},{a:{x:[2,3,4]}}),d({a:{$gt:[2,3]}},{a:[1,2]}),d({a:{$lt:11,$gt:9}},{a:8}),d({a:{$lt:11,$gt:9}},{a:9}),c({a:{$lt:11,$gt:9}},{a:10}),d({a:{$lt:11,$gt:9}},{a:11}),d({a:{$lt:11,$gt:9}},{a:12}),c({a:{$lt:11,$gt:9}},{a:[8,9,10,11,12]}),c({a:{$lt:11,$gt:9}},{a:[8,9,11,12]}),c({a:{$all:[1,2]}},{a:[1,2]}),d({a:{$all:[1,2,3]}},{a:[1,2]}),c({a:{$all:[1,2]}},{a:[3,2,1]}),c({a:{$all:[1,"x"]}},{a:[3,"x",1]}),d({a:{$all:["2"]}},{a:2}),d({a:{$all:[2]}},{a:"2"}),c({a:{$all:[[1,2],[1,3]]}},{a:[[1,3],[1,2],[1,4]]}),d({a:{$all:[[1,2],[1,3]]}},{a:[[1,4],[1,2],[1,4]]}),c({a:{$all:[2,2]}},{a:[2]}),d({a:{$all:[2,3]}},{a:[2,2]}),d({a:{$all:[1,2]}},{a:[[1,2]]}),d({a:{$all:[1,2]}},{}),d({a:{$all:[1,2]}},{a:{foo:"bar"}}),d({a:{$all:[]}},{a:[]}),d({a:{$all:[]}},{a:[5]}),c({a:{$all:[/i/,/e/i]}},{a:["foo","bEr","biz"]}),d({a:{$all:[/i/,/e/i]
}},{a:["foo","bar","biz"]}),c({a:{$all:[{b:3}]}},{a:[{b:3}]}),d({a:{$all:[{b:3}]}},{a:[{b:3,k:4}]}),a["throws"](function(){c({a:{$all:[{$gt:4}]}},{})}),c({a:{$exists:!0}},{a:12}),d({a:{$exists:!0}},{b:12}),d({a:{$exists:!1}},{a:12}),c({a:{$exists:!1}},{b:12}),c({a:{$exists:!0}},{a:[]}),d({a:{$exists:!0}},{b:[]}),d({a:{$exists:!1}},{a:[]}),c({a:{$exists:!1}},{b:[]}),c({a:{$exists:!0}},{a:[1]}),d({a:{$exists:!0}},{b:[1]}),d({a:{$exists:!1}},{a:[1]}),c({a:{$exists:!1}},{b:[1]}),c({a:{$exists:1}},{a:5}),c({a:{$exists:0}},{b:5}),d({"a.x":{$exists:!1}},{a:[{},{x:5}]}),c({"a.x":{$exists:!0}},{a:[{},{x:5}]}),c({"a.x":{$exists:!0}},{a:[{},{x:5}]}),c({"a.x":{$exists:!0}},{a:{x:[]}}),c({"a.x":{$exists:!0}},{a:{x:null}}),c({a:{$mod:[10,1]}},{a:11}),d({a:{$mod:[10,1]}},{a:12}),c({a:{$mod:[10,1]}},{a:[10,11,12]}),d({a:{$mod:[10,1]}},{a:[10,12]}),_.each([5,[10],[10,1,2],"foo",{bar:1},[]],function(b){a["throws"](function(){c({a:{$mod:b}},{a:11})})}),c({a:{$ne:1}},{a:2}),d({a:{$ne:2}},{a:2}),c({a:{$ne:[1]}},{a:[2]}),d({a:{$ne:[1,2]}},{a:[1,2]}),d({a:{$ne:1}},{a:[1,2]}),d({a:{$ne:2}},{a:[1,2]}),c({a:{$ne:3}},{a:[1,2]}),d({"a.b":{$ne:1}},{a:[{b:1},{b:2}]}),d({"a.b":{$ne:2}},{a:[{b:1},{b:2}]}),c({"a.b":{$ne:3}},{a:[{b:1},{b:2}]}),d({a:{$ne:{x:1}}},{a:{x:1}}),c({a:{$ne:{x:1}}},{a:{x:2}}),c({a:{$ne:{x:1}}},{a:{x:1,y:2}}),c({"a.b":{$ne:5,$gt:6}},{a:[{b:2},{b:10}]}),d({"a.b":{$ne:5,$gt:6}},{a:[{b:2},{b:4}]}),d({"a.b":{$ne:5,$gt:6}},{a:[{b:2},{b:5}]}),d({"a.b":{$ne:5,$gt:6}},{a:[{b:10},{b:5}]}),c({a:{$ne:5,$gt:6}},{a:[2,10]}),d({a:{$ne:5,$gt:6}},{a:[2,4]}),d({a:{$ne:5,$gt:6}},{a:[2,5]}),d({a:{$ne:5,$gt:6}},{a:[10,5]}),c({a:{$in:[1,2,3]}},{a:2}),d({a:{$in:[1,2,3]}},{a:4}),c({a:{$in:[[1],[2],[3]]}},{a:[2]}),d({a:{$in:[[1],[2],[3]]}},{a:[4]}),c({a:{$in:[{b:1},{b:2},{b:3}]}},{a:{b:2}}),d({a:{$in:[{b:1},{b:2},{b:3}]}},{a:{b:4}}),c({a:{$in:[1,2,3]}},{a:[2]}),c({a:{$in:[{x:1},{x:2},{x:3}]}},{a:[{x:2}]}),c({a:{$in:[1,2,3]}},{a:[4,2]}),d({a:{$in:[1,2,3]}},{a:[4]}),c({a:{$in:["x",/foo/i]}},{a:"x"}),c({a:{$in:["x",/foo/i]}},{a:"fOo"}),c({a:{$in:["x",/foo/i]}},{a:["f","fOo"]}),d({a:{$in:["x",/foo/i]}},{a:["f","fOx"]}),c({a:{$in:[1,null]}},{}),c({"a.b":{$in:[1,null]}},{}),c({"a.b":{$in:[1,null]}},{a:{}}),c({"a.b":{$in:[1,null]}},{a:{b:null}}),d({"a.b":{$in:[1,null]}},{a:{b:5}}),d({"a.b":{$in:[1]}},{a:{b:null}}),d({"a.b":{$in:[1]}},{a:{}}),d({"a.b":{$in:[1,null]}},{a:[{b:5}]}),c({"a.b":{$in:[1,null]}},{a:[{b:5},{}]}),d({"a.b":{$in:[1,null]}},{a:[{b:5},[]]}),d({"a.b":{$in:[1,null]}},{a:[{b:5},5]}),d({a:{$nin:[1,2,3]}},{a:2}),c({a:{$nin:[1,2,3]}},{a:4}),d({a:{$nin:[[1],[2],[3]]}},{a:[2]}),c({a:{$nin:[[1],[2],[3]]}},{a:[4]}),d({a:{$nin:[{b:1},{b:2},{b:3}]}},{a:{b:2}}),c({a:{$nin:[{b:1},{b:2},{b:3}]}},{a:{b:4}}),d({a:{$nin:[1,2,3]}},{a:[2]}),d({a:{$nin:[{x:1},{x:2},{x:3}]}},{a:[{x:2}]}),d({a:{$nin:[1,2,3]}},{a:[4,2]}),d({"a.b":{$nin:[1,2,3]}},{a:[{b:4},{b:2}]}),c({a:{$nin:[1,2,3]}},{a:[4]}),c({"a.b":{$nin:[1,2,3]}},{a:[{b:4}]}),d({a:{$nin:["x",/foo/i]}},{a:"x"}),d({a:{$nin:["x",/foo/i]}},{a:"fOo"}),d({a:{$nin:["x",/foo/i]}},{a:["f","fOo"]}),c({a:{$nin:["x",/foo/i]}},{a:["f","fOx"]}),d({a:{$nin:[1,null]}},{}),d({"a.b":{$nin:[1,null]}},{}),d({"a.b":{$nin:[1,null]}},{a:{}}),d({"a.b":{$nin:[1,null]}},{a:{b:null}}),c({"a.b":{$nin:[1,null]}},{a:{b:5}}),c({"a.b":{$nin:[1]}},{a:{b:null}}),c({"a.b":{$nin:[1]}},{a:{}}),c({"a.b":{$nin:[1,null]}},{a:[{b:5}]}),d({"a.b":{$nin:[1,null]}},{a:[{b:5},{}]}),c({"a.b":{$nin:[1,null]}},{a:[{b:5},[]]}),c({"a.b":{$nin:[1,null]}},{a:[{b:5},5]}),c({a:{$size:0}},{a:[]}),c({a:{$size:1}},{a:[2]}),c({a:{$size:2}},{a:[2,2]}),d({a:{$size:0}},{a:[2]}),d({a:{$size:1}},{a:[]}),d({a:{$size:1}},{a:[2,2]}),d({a:{$size:0}},{a:"2"}),d({a:{$size:1}},{a:"2"}),d({a:{$size:2}},{a:"2"}),d({a:{$size:2}},{a:[[2,2]]}),c({a:{$type:1}},{a:1.1}),c({a:{$type:1}},{a:1}),d({a:{$type:1}},{a:"1"}),c({a:{$type:2}},{a:"1"}),d({a:{$type:2}},{a:1}),c({a:{$type:3}},{a:{}}),c({a:{$type:3}},{a:{b:2}}),d({a:{$type:3}},{a:[]}),d({a:{$type:3}},{a:[1]}),d({a:{$type:3}},{a:null}),c({a:{$type:5}},{a:EJSON.newBinary(0)}),c({a:{$type:5}},{a:EJSON.newBinary(4)}),d({a:{$type:5}},{a:[]}),d({a:{$type:5}},{a:[42]}),c({a:{$type:7}},{a:new LocalCollection._ObjectID}),d({a:{$type:7}},{a:"1234567890abcd1234567890"}),c({a:{$type:8}},{a:!0}),c({a:{$type:8}},{a:!1}),d({a:{$type:8}},{a:"true"}),d({a:{$type:8}},{a:0}),d({a:{$type:8}},{a:null}),d({a:{$type:8}},{a:""}),d({a:{$type:8}},{}),c({a:{$type:9}},{a:new Date}),d({a:{$type:9}},{a:+new Date}),c({a:{$type:10}},{a:null}),d({a:{$type:10}},{a:!1}),d({a:{$type:10}},{a:""}),d({a:{$type:10}},{a:0}),d({a:{$type:10}},{}),c({a:{$type:11}},{a:/x/}),d({a:{$type:11}},{a:"x"}),d({a:{$type:11}},{}),d({a:{$type:4}},{a:[]}),d({a:{$type:4}},{a:[1]}),c({a:{$type:1}},{a:[1]}),d({a:{$type:2}},{a:[1]}),c({a:{$type:1}},{a:["1",1]}),c({a:{$type:2}},{a:["1",1]}),d({a:{$type:3}},{a:["1",1]}),d({a:{$type:4}},{a:["1",1]}),d({a:{$type:1}},{a:["1",[]]}),c({a:{$type:2}},{a:["1",[]]}),c({a:{$type:4}},{a:["1",[]]}),c({"a.0":{$type:4}},{a:[[0]]}),d({"a.0":{$type:1}},{a:[[0]]}),c({a:/a/},{a:"cat"}),d({a:/a/},{a:"cut"}),d({a:/a/},{a:"CAT"}),c({a:/a/i},{a:"CAT"}),c({a:/a/},{a:["foo","bar"]}),d({a:/,/},{a:["foo","bar"]}),c({a:{$regex:"a"}},{a:["foo","bar"]}),d({a:{$regex:","}},{a:["foo","bar"]}),c({a:{$regex:/a/}},{a:"cat"}),d({a:{$regex:/a/}},{a:"cut"}),d({a:{$regex:/a/}},{a:"CAT"}),c({a:{$regex:/a/i}},{a:"CAT"}),c({a:{$regex:/a/,$options:"i"}},{a:"CAT"}),c({a:{$regex:/a/i,$options:"i"}},{a:"CAT"}),d({a:{$regex:/a/i,$options:""}},{a:"CAT"}),c({a:{$regex:"a"}},{a:"cat"}),d({a:{$regex:"a"}},{a:"cut"}),d({a:{$regex:"a"}},{a:"CAT"}),c({a:{$regex:"a",$options:"i"}},{a:"CAT"}),c({a:{$regex:"",$options:"i"}},{a:"foo"}),d({a:{$regex:"",$options:"i"}},{}),d({a:{$regex:"",$options:"i"}},{a:5}),d({a:/undefined/},{}),d({a:{$regex:"undefined"}},{}),d({a:/xxx/},{}),d({a:{$regex:"xxx"}},{});var g=/sh/gi;c({a:g},{a:"Shorts"}),c({a:g},{a:"Shorts"}),c({a:g},{a:"Shorts"}),c({a:{$regex:g}},{a:"Shorts"}),c({a:{$regex:g}},{a:"Shorts"}),c({a:{$regex:g}},{a:"Shorts"}),a["throws"](function(){c({a:{$options:"i"}},{a:12})}),c({a:/a/},{a:["dog","cat"]}),d({a:/a/},{a:["dog","puppy"]}),c({a:/a/},{a:/a/}),c({a:/a/},{a:["x",/a/]}),d({a:/a/},{a:/a/i}),d({a:/a/m},{a:/a/}),d({a:/a/},{a:/b/}),d({a:/5/},{a:5}),d({a:/t/},{a:!0}),c({a:/m/i},{a:["x","xM"]}),a["throws"](function(){c({a:{$regex:/a/,$options:"x"}},{a:"cat"})}),a["throws"](function(){c({a:{$regex:/a/,$options:"s"}},{a:"cat"})}),c({x:{$not:{$gt:7}}},{x:6}),d({x:{$not:{$gt:7}}},{x:8}),c({x:{$not:{$lt:10,$gt:7}}},{x:11}),d({x:{$not:{$lt:10,$gt:7}}},{x:9}),c({x:{$not:{$lt:10,$gt:7}}},{x:6}),c({x:{$not:{$gt:7}}},{x:[2,3,4]}),c({"x.y":{$not:{$gt:7}}},{x:[{y:2},{y:3},{y:4}]}),d({x:{$not:{$gt:7}}},{x:[2,3,4,10]}),d({"x.y":{$not:{$gt:7}}},{x:[{y:2},{y:3},{y:4},{y:10}]}),c({x:{$not:/a/}},{x:"dog"}),d({x:{$not:/a/}},{x:"cat"}),c({x:{$not:/a/}},{x:["dog","puppy"]}),d({x:{$not:/a/}},{x:["kitten","cat"]}),c({"a.b":1},{a:{b:1}}),d({"a.b":1},{a:{b:2}}),c({"a.b":[1,2,3]},{a:{b:[1,2,3]}}),d({"a.b":[1,2,3]},{a:{b:[4]}}),c({"a.b":/a/},{a:{b:"cat"}}),d({"a.b":/a/},{a:{b:"dog"}}),c({"a.b.c":null},{}),c({"a.b.c":null},{a:1}),c({"a.b":null},{a:1}),c({"a.b.c":null},{a:{b:4}}),d({"a.b":null},{a:[1]}),c({"a.b":[]},{a:{b:[]}});var h={a:[{b:1},2,{},{b:[3,4]}]};c({"a.b":1},h),c({"a.b":[3,4]},h),c({"a.b":3},h),c({"a.b":4},h),c({"a.b":null},h),c({"a.1":8},{a:[7,8,9]}),d({"a.1":7},{a:[7,8,9]}),d({"a.1":null},{a:[7,8,9]}),c({"a.1":[8,9]},{a:[7,[8,9]]}),d({"a.1":6},{a:[[6,7],[8,9]]}),d({"a.1":7},{a:[[6,7],[8,9]]}),d({"a.1":8},{a:[[6,7],[8,9]]}),d({"a.1":9},{a:[[6,7],[8,9]]}),c({"a.1":2},{a:[0,{1:2},3]}),c({"a.1":{1:2}},{a:[0,{1:2},3]}),c({"x.1.y":8},{x:[7,{y:8},9]}),c({"x.1.y":null},{x:[7,{y:8},9]}),c({"a.1.b":9},{a:[7,{b:9},{1:{b:"foo"}}]}),c({"a.1.b":"foo"},{a:[7,{b:9},{1:{b:"foo"}}]}),c({"a.1.b":null},{a:[7,{b:9},{1:{b:"foo"}}]}),c({"a.1.b":2},{a:[1,[{b:2}],3]}),d({"a.1.b":null},{a:[1,[{b:2}],3]}),d({"a.0.b":null},{a:[5]}),c({"a.1":4},{a:[{1:4},5]}),c({"a.1":5},{a:[{1:4},5]}),d({"a.1":null},{a:[{1:4},5]}),c({"a.1.foo":4},{a:[{1:{foo:4}},{foo:5}]}),c({"a.1.foo":5},{a:[{1:{foo:4}},{foo:5}]}),c({"a.1.foo":null},{a:[{1:{foo:4}},{foo:5}]}),d({"a.b":1},{x:2}),d({"a.b.c":1},{a:{x:2}}),d({"a.b.c":1},{a:{b:{x:2}}}),d({"a.b.c":1},{a:{b:1}}),d({"a.b.c":1},{a:{b:0}}),c({"a.b":{c:1}},{a:{b:{c:1}}}),d({"a.b":{c:1}},{a:{b:{c:2}}}),d({"a.b":{c:1}},{a:{b:2}}),c({"a.b":{c:1,d:2}},{a:{b:{c:1,d:2}}}),d({"a.b":{c:1,d:2}},{a:{b:{c:1,d:1}}}),d({"a.b":{c:1,d:2}},{a:{b:{d:2}}}),c({"a.b":{$in:[1,2,3]}},{a:{b:[2]}}),c({"a.b":{$in:[{x:1},{x:2},{x:3}]}},{a:{b:[{x:2}]}}),c({"a.b":{$in:[1,2,3]}},{a:{b:[4,2]}}),d({"a.b":{$in:[1,2,3]}},{a:{b:[4]}}),a["throws"](function(){c({$or:[]},{})}),a["throws"](function(){c({$or:[5]},{})}),a["throws"](function(){c({$or:[]},{a:1})}),c({$or:[{a:1}]},{a:1}),d({$or:[{b:2}]},{a:1}),c({$or:[{a:1},{b:2}]},{a:1}),d({$or:[{c:3},{d:4}]},{a:1}),c({$or:[{a:1},{b:2}]},{a:[1,2,3]}),d({$or:[{a:1},{b:2}]},{c:[1,2,3]}),d({$or:[{a:1},{b:2}]},{a:[2,3,4]}),c({$or:[{a:1},{a:2}]},{a:1}),c({$or:[{a:1},{a:2}],b:2},{a:1,b:2}),d({$or:[{a:2},{a:3}],b:2},{a:1,b:2}),d({$or:[{a:1},{a:2}],b:3},{a:1,b:2}),c({x:1,$or:[{a:1},{b:1}]},{x:1,b:1}),c({$or:[{a:1},{b:1}],x:1},{x:1,b:1}),d({x:1,$or:[{a:1},{b:1}]},{b:1}),d({x:1,$or:[{a:1},{b:1}]},{x:1}),c({$or:[{a:{$lte:1}},{a:2}]},{a:1}),d({$or:[{a:{$lt:1}},{a:2}]},{a:1}),c({$or:[{a:{$gte:1}},{a:2}]},{a:1}),d({$or:[{a:{$gt:1}},{a:2}]},{a:1}),c({$or:[{b:{$gt:1}},{b:{$lt:3}}]},{b:2}),d({$or:[{b:{$lt:1}},{b:{$gt:3}}]},{b:2}),c({$or:[{a:{$in:[1,2,3]}}]},{a:1}),d({$or:[{a:{$in:[4,5,6]}}]},{a:1}),c({$or:[{a:{$in:[1,2,3]}},{b:2}]},{a:1}),c({$or:[{a:{$in:[1,2,3]}},{b:2}]},{b:2}),d({$or:[{a:{$in:[1,2,3]}},{b:2}]},{c:3}),c({$or:[{a:{$in:[1,2,3]}},{b:{$in:[1,2,3]}}]},{b:2}),d({$or:[{a:{$in:[1,2,3]}},{b:{$in:[4,5,6]}}]},{b:2}),d({$or:[{a:{$nin:[1,2,3]}}]},{a:1}),c({$or:[{a:{$nin:[4,5,6]}}]},{a:1}),d({$or:[{a:{$nin:[1,2,3]}},{b:2}]},{a:1}),c({$or:[{a:{$nin:[1,2,3]}},{b:2}]},{b:2}),c({$or:[{a:{$nin:[1,2,3]}},{b:2}]},{c:3}),c({$or:[{a:{$nin:[1,2,3]}},{b:{$nin:[1,2,3]}}]},{b:2}),d({$or:[{a:{$nin:[1,2,3]}},{b:{$nin:[1,2,3]}}]},{a:1,b:2}),c({$or:[{a:{$nin:[1,2,3]}},{b:{$nin:[4,5,6]}}]},{b:2}),c({$or:[{"a.b":1},{"a.b":2}]},{a:{b:1}}),c({$or:[{"a.b":1},{"a.c":1}]},{a:{b:1}}),d({$or:[{"a.b":2},{"a.c":1}]},{a:{b:1}}),c({$or:[{a:{b:1,c:2}},{a:{b:2,c:1}}]},{a:{b:1,c:2}}),d({$or:[{a:{b:1,c:3}},{a:{b:2,c:1}}]},{a:{b:1,c:2}}),c({$or:[{a:/a/}]},{a:"cat"}),d({$or:[{a:/o/}]},{a:"cat"}),c({$or:[{a:/a/},{a:/o/}]},{a:"cat"}),d({$or:[{a:/i/},{a:/o/}]},{a:"cat"}),c({$or:[{a:/i/},{b:/o/}]},{a:"cat",b:"dog"}),c({$or:[{a:{$ne:1}}]},{}),d({$or:[{a:{$ne:1}}]},{a:1}),c({$or:[{a:{$ne:1}}]},{a:2}),c({$or:[{a:{$ne:1}}]},{b:1}),c({$or:[{a:{$ne:1}},{a:{$ne:2}}]},{a:1}),c({$or:[{a:{$ne:1}},{b:{$ne:1}}]},{a:1}),d({$or:[{a:{$ne:1}},{b:{$ne:2}}]},{a:1,b:2}),c({$or:[{a:{$not:{$mod:[10,1]}}}]},{}),d({$or:[{a:{$not:{$mod:[10,1]}}}]},{a:1}),c({$or:[{a:{$not:{$mod:[10,1]}}}]},{a:2}),c({$or:[{a:{$not:{$mod:[10,1]}}},{a:{$not:{$mod:[10,2]}}}]},{a:1}),d({$or:[{a:{$not:{$mod:[10,1]}}},{a:{$mod:[10,2]}}]},{a:1}),c({$or:[{a:{$not:{$mod:[10,1]}}},{a:{$mod:[10,2]}}]},{a:2}),c({$or:[{a:{$not:{$mod:[10,1]}}},{a:{$mod:[10,2]}}]},{a:3}),a["throws"](function(){c({$nor:[]},{})}),a["throws"](function(){c({$nor:[5]},{})}),a["throws"](function(){c({$nor:[]},{a:1})}),d({$nor:[{a:1}]},{a:1}),c({$nor:[{b:2}]},{a:1}),d({$nor:[{a:1},{b:2}]},{a:1}),c({$nor:[{c:3},{d:4}]},{a:1}),d({$nor:[{a:1},{b:2}]},{a:[1,2,3]}),c({$nor:[{a:1},{b:2}]},{c:[1,2,3]}),c({$nor:[{a:1},{b:2}]},{a:[2,3,4]}),d({$nor:[{a:1},{a:2}]},{a:1}),d({$nor:[{a:{$lte:1}},{a:2}]},{a:1}),c({$nor:[{a:{$lt:1}},{a:2}]},{a:1}),d({$nor:[{a:{$gte:1}},{a:2}]},{a:1}),c({$nor:[{a:{$gt:1}},{a:2}]},{a:1}),d({$nor:[{b:{$gt:1}},{b:{$lt:3}}]},{b:2}),c({$nor:[{b:{$lt:1}},{b:{$gt:3}}]},{b:2}),d({$nor:[{a:{$in:[1,2,3]}}]},{a:1}),c({$nor:[{a:{$in:[4,5,6]}}]},{a:1}),d({$nor:[{a:{$in:[1,2,3]}},{b:2}]},{a:1}),d({$nor:[{a:{$in:[1,2,3]}},{b:2}]},{b:2}),c({$nor:[{a:{$in:[1,2,3]}},{b:2}]},{c:3}),d({$nor:[{a:{$in:[1,2,3]}},{b:{$in:[1,2,3]}}]},{b:2}),c({$nor:[{a:{$in:[1,2,3]}},{b:{$in:[4,5,6]}}]},{b:2}),c({$nor:[{a:{$nin:[1,2,3]}}]},{a:1}),d({$nor:[{a:{$nin:[4,5,6]}}]},{a:1}),c({$nor:[{a:{$nin:[1,2,3]}},{b:2}]},{a:1}),d({$nor:[{a:{$nin:[1,2,3]}},{b:2}]},{b:2}),d({$nor:[{a:{$nin:[1,2,3]}},{b:2}]},{c:3}),d({$nor:[{a:{$nin:[1,2,3]}},{b:{$nin:[1,2,3]}}]},{b:2}),c({$nor:[{a:{$nin:[1,2,3]}},{b:{$nin:[1,2,3]}}]},{a:1,b:2}),d({$nor:[{a:{$nin:[1,2,3]}},{b:{$nin:[4,5,6]}}]},{b:2}),d({$nor:[{"a.b":1},{"a.b":2}]},{a:{b:1}}),d({$nor:[{"a.b":1},{"a.c":1}]},{a:{b:1}}),c({$nor:[{"a.b":2},{"a.c":1}]},{a:{b:1}}),d({$nor:[{a:{b:1,c:2}},{a:{b:2,c:1}}]},{a:{b:1,c:2}}),c({$nor:[{a:{b:1,c:3}},{a:{b:2,c:1}}]},{a:{b:1,c:2}}),d({$nor:[{a:/a/}]},{a:"cat"}),c({$nor:[{a:/o/}]},{a:"cat"}),d({$nor:[{a:/a/},{a:/o/}]},{a:"cat"}),c({$nor:[{a:/i/},{a:/o/}]},{a:"cat"}),d({$nor:[{a:/i/},{b:/o/}]},{a:"cat",b:"dog"}),d({$nor:[{a:{$ne:1}}]},{}),c({$nor:[{a:{$ne:1}}]},{a:1}),d({$nor:[{a:{$ne:1}}]},{a:2}),d({$nor:[{a:{$ne:1}}]},{b:1}),d({$nor:[{a:{$ne:1}},{a:{$ne:2}}]},{a:1}),d({$nor:[{a:{$ne:1}},{b:{$ne:1}}]},{a:1}),c({$nor:[{a:{$ne:1}},{b:{$ne:2}}]},{a:1,b:2}),d({$nor:[{a:{$not:{$mod:[10,1]}}}]},{}),c({$nor:[{a:{$not:{$mod:[10,1]}}}]},{a:1}),d({$nor:[{a:{$not:{$mod:[10,1]}}}]},{a:2}),d({$nor:[{a:{$not:{$mod:[10,1]}}},{a:{$not:{$mod:[10,2]}}}]},{a:1}),c({$nor:[{a:{$not:{$mod:[10,1]}}},{a:{$mod:[10,2]}}]},{a:1}),d({$nor:[{a:{$not:{$mod:[10,1]}}},{a:{$mod:[10,2]}}]},{a:2}),d({$nor:[{a:{$not:{$mod:[10,1]}}},{a:{$mod:[10,2]}}]},{a:3}),a["throws"](function(){c({$and:[]},{})}),a["throws"](function(){c({$and:[5]},{})}),a["throws"](function(){c({$and:[]},{a:1})}),c({$and:[{a:1}]},{a:1}),d({$and:[{a:1},{a:2}]},{a:1}),d({$and:[{a:1},{b:1}]},{a:1}),c({$and:[{a:1},{b:2}]},{a:1,b:2}),d({$and:[{a:1},{b:1}]},{a:1,b:2}),c({$and:[{a:1},{b:2}],c:3},{a:1,b:2,c:3}),d({$and:[{a:1},{b:2}],c:4},{a:1,b:2,c:3}),c({$and:[{a:/a/}]},{a:"cat"}),c({$and:[{a:/a/i}]},{a:"CAT"}),d({$and:[{a:/o/}]},{a:"cat"}),d({$and:[{a:/a/},{a:/o/}]},{a:"cat"}),c({$and:[{a:/a/},{b:/o/}]},{a:"cat",b:"dog"}),d({$and:[{a:/a/},{b:/a/}]},{a:"cat",b:"dog"}),c({$and:[{"a.b":1}]},{a:{b:1}}),c({$and:[{a:{b:1}}]},{a:{b:1}}),d({$and:[{"a.b":2}]},{a:{b:1}}),d({$and:[{"a.c":1}]},{a:{b:1}}),d({$and:[{"a.b":1},{"a.b":2}]},{a:{b:1}}),d({$and:[{"a.b":1},{a:{b:2}}]},{a:{b:1}}),c({$and:[{"a.b":1},{"c.d":2}]},{a:{b:1},c:{d:2}}),d({$and:[{"a.b":1},{"c.d":1}]},{a:{b:1},c:{d:2}}),c({$and:[{"a.b":1},{c:{d:2}}]},{a:{b:1},c:{d:2}}),d({$and:[{"a.b":1},{c:{d:1}}]},{a:{b:1},c:{d:2}}),d({$and:[{"a.b":2},{c:{d:2}}]},{a:{b:1},c:{d:2}}),c({$and:[{a:{b:1}},{c:{d:2}}]},{a:{b:1},c:{d:2}}),d({$and:[{a:{b:2}},{c:{d:2}}]},{a:{b:1},c:{d:2}}),d({$and:[{a:{$in:[]}}]},{}),c({$and:[{a:{$in:[1,2,3]}}]},{a:1}),d({$and:[{a:{$in:[4,5,6]}}]},{a:1}),d({$and:[{a:{$in:[1,2,3]}},{a:{$in:[4,5,6]}}]},{a:1}),d({$and:[{a:{$in:[1,2,3]}},{b:{$in:[1,2,3]}}]},{a:1,b:4}),c({$and:[{a:{$in:[1,2,3]}},{b:{$in:[4,5,6]}}]},{a:1,b:4}),c({$and:[{a:{$nin:[]}}]},{}),d({$and:[{a:{$nin:[1,2,3]}}]},{a:1}),c({$and:[{a:{$nin:[4,5,6]}}]},{a:1}),d({$and:[{a:{$nin:[1,2,3]}},{a:{$nin:[4,5,6]}}]},{a:1}),d({$and:[{a:{$nin:[1,2,3]}},{b:{$nin:[1,2,3]}}]},{a:1,b:4}),d({$and:[{a:{$nin:[1,2,3]}},{b:{$nin:[4,5,6]}}]},{a:1,b:4}),c({$and:[{a:{$lt:2}}]},{a:1}),d({$and:[{a:{$lt:1}}]},{a:1}),c({$and:[{a:{$lte:1}}]},{a:1}),c({$and:[{a:{$gt:0}}]},{a:1}),d({$and:[{a:{$gt:1}}]},{a:1}),c({$and:[{a:{$gte:1}}]},{a:1}),c({$and:[{a:{$gt:0}},{a:{$lt:2}}]},{a:1}),d({$and:[{a:{$gt:1}},{a:{$lt:2}}]},{a:1}),d({$and:[{a:{$gt:0}},{a:{$lt:1}}]},{a:1}),c({$and:[{a:{$gte:1}},{a:{$lte:1}}]},{a:1}),d({$and:[{a:{$gte:2}},{a:{$lte:0}}]},{a:1}),c({$and:[{a:{$ne:1}}]},{}),d({$and:[{a:{$ne:1}}]},{a:1}),c({$and:[{a:{$ne:1}}]},{a:2}),d({$and:[{a:{$ne:1}},{a:{$ne:2}}]},{a:2}),c({$and:[{a:{$ne:1}},{a:{$ne:3}}]},{a:2}),c({$and:[{a:{$not:{$gt:2}}}]},{a:1}),d({$and:[{a:{$not:{$lt:2}}}]},{a:1}),c({$and:[{a:{$not:{$lt:0}}},{a:{$not:{$gt:2}}}]},{a:1}),d({$and:[{a:{$not:{$lt:2}}},{a:{$not:{$gt:0}}}]},{a:1}),c({$where:"this.a === 1"},{a:1}),c({$where:"obj.a === 1"},{a:1}),d({$where:"this.a !== 1"},{a:1}),d({$where:"obj.a !== 1"},{a:1}),d({$where:"this.a === 1",a:2},{a:1}),c({$where:"this.a === 1",b:2},{a:1,b:2}),c({$where:"this.a === 1 && this.b === 2"},{a:1,b:2}),c({$where:"this.a instanceof Array"},{a:[]}),d({$where:"this.a instanceof Array"},{a:1}),c({"dogs.0.name":"Fido"},{dogs:[{name:"Fido"},{name:"Rex"}]}),c({"dogs.1.name":"Rex"},{dogs:[{name:"Fido"},{name:"Rex"}]}),d({"dogs.1.name":"Fido"},{dogs:[{name:"Fido"},{name:"Rex"}]}),c({"room.1b":"bla"},{room:{"1b":"bla"}}),c({"dogs.name":"Fido"},{dogs:[{name:"Fido"},{name:"Rex"}]}),c({"dogs.name":"Rex"},{dogs:[{name:"Fido"},{name:"Rex"}]}),c({"animals.dogs.name":"Fido"},{animals:[{dogs:[{name:"Rover"}]},{},{dogs:[{name:"Fido"},{name:"Rex"}]}]}),c({"animals.dogs.name":"Fido"},{animals:[{dogs:{name:"Rex"}},{dogs:{name:"Fido"}}]}),c({"animals.dogs.name":"Fido"},{animals:[{dogs:[{name:"Rover"}]},{},{dogs:[{name:["Fido"]},{name:"Rex"}]}]}),d({"dogs.name":"Fido"},{dogs:[]}),c({dogs:{$elemMatch:{name:/e/}}},{dogs:[{name:"Fido"},{name:"Rex"}]}),d({dogs:{$elemMatch:{name:/a/}}},{dogs:[{name:"Fido"},{name:"Rex"}]}),c({dogs:{$elemMatch:{age:{$gt:4}}}},{dogs:[{name:"Fido",age:5},{name:"Rex",age:3}]}),c({dogs:{$elemMatch:{name:"Fido",age:{$gt:4}}}},{dogs:[{name:"Fido",age:5},{name:"Rex",age:3}]}),d({dogs:{$elemMatch:{name:"Fido",age:{$gt:5}}}},{dogs:[{name:"Fido",age:5},{name:"Rex",age:3}]}),c({dogs:{$elemMatch:{name:/i/,age:{$gt:4}}}},{dogs:[{name:"Fido",age:5},{name:"Rex",age:3}]}),d({dogs:{$elemMatch:{name:/e/,age:5}}},{dogs:[{name:"Fido",age:5},{name:"Rex",age:3}]}),c({x:{$elemMatch:{y:9}}},{x:[{y:9}]}),d({x:{$elemMatch:{y:9}}},{x:[[{y:9}]]}),c({x:{$elemMatch:{$gt:5,$lt:9}}},{x:[8]}),d({x:{$elemMatch:{$gt:5,$lt:9}}},{x:[[8]]}),c({"a.x":{$elemMatch:{y:9}}},{a:[{x:[]},{x:[{y:9}]}]}),d({a:{$elemMatch:{x:5}}},{a:{x:5}}),c({a:{$elemMatch:{0:{$gt:5,$lt:9}}}},{a:[[6]]}),c({a:{$elemMatch:{"0.b":{$gt:5,$lt:9}}}},{a:[[{b:6}]]}),c({a:{$elemMatch:{x:1,$or:[{a:1},{b:1}]}}},{a:[{x:1,b:1}]}),c({a:{$elemMatch:{$or:[{a:1},{b:1}],x:1}}},{a:[{x:1,b:1}]}),d({a:{$elemMatch:{x:1,$or:[{a:1},{b:1}]}}},{a:[{b:1}]}),d({a:{$elemMatch:{x:1,$or:[{a:1},{b:1}]}}},{a:[{x:1}]}),d({a:{$elemMatch:{x:1,$or:[{a:1},{b:1}]}}},{a:[{x:1},{b:1}]}),c({a:5,$comment:"asdf"},{a:5}),d({a:6,$comment:"asdf"},{a:5})}),Tinytest.add("minimongo - projection_compiler",function(a){var b=function(b,c){var d=LocalCollection._compileProjection(b),e=function(b,c,d){a.isTrue(_.isEqual(b,c),d)};_.each(c,function(a){e(d(a[0]),a[1],a[2])})};b({foo:1,bar:1},[[{foo:42,bar:"something",baz:"else"},{foo:42,bar:"something"},"simplest - whitelist"],[{foo:{nested:17},baz:{}},{foo:{nested:17}},"nested whitelisted field"],[{_id:"uid",bazbaz:42},{_id:"uid"},"simplest whitelist - preserve _id"]]),b({foo:0,bar:0},[[{foo:42,bar:"something",baz:"else"},{baz:"else"},"simplest - blacklist"],[{foo:{nested:17},baz:{foo:"something"}},{baz:{foo:"something"}},"nested blacklisted field"],[{_id:"uid",bazbaz:42},{_id:"uid",bazbaz:42},"simplest blacklist - preserve _id"]]),b({_id:0,foo:1},[[{foo:42,bar:33,_id:"uid"},{foo:42},"whitelist - _id blacklisted"]]),b({_id:0,foo:0},[[{foo:42,bar:33,_id:"uid"},{bar:33},"blacklist - _id blacklisted"]]),b({"foo.bar.baz":1},[[{foo:{meh:"fur",bar:{baz:42},tr:1},bar:33,baz:"trolololo"},{foo:{bar:{baz:42}}},"whitelist nested"],[{foo:{meh:"fur",bar:"nope",tr:1},bar:33,baz:"trolololo"},{foo:{}},"whitelist nested - path not found in doc, different type"],[{foo:{meh:"fur",bar:[],tr:1},bar:33,baz:"trolololo"},{foo:{bar:[]}},"whitelist nested - path not found in doc"]]),b({"hope.humanity":0,"hope.people":0},[[{hope:{humanity:"lost",people:"broken",candies:"long live!"}},{hope:{candies:"long live!"}},"blacklist nested"],[{hope:"new"},{hope:"new"},"blacklist nested - path not found in doc"]]),b({_id:1},[[{_id:42,x:1,y:{z:"2"}},{_id:42},"_id whitelisted"],[{_id:33},{_id:33},"_id whitelisted, _id only"],[{x:1},{},"_id whitelisted, no _id"]]),b({_id:0},[[{_id:42,x:1,y:{z:"2"}},{x:1,y:{z:"2"}},"_id blacklisted"],[{_id:33},{},"_id blacklisted, _id only"],[{x:1},{x:1},"_id blacklisted, no _id"]]),b({},[[{a:1,b:2,c:"3"},{a:1,b:2,c:"3"},"empty projection"]]),a["throws"](function(){b({inc:1,excl:0},[[{inc:42,excl:42},{inc:42},"Can't combine incl/excl rules"]])}),a["throws"](function(){b({a:1,"a.b":1},[[{a:{b:42}},{a:{b:42}},"Can't have ambiguous rules (one is prefix of another)"]])}),a["throws"](function(){b({"a.b.c":1,"a.b":1,a:1},[[{a:{b:42}},{a:{b:42}},"Can't have ambiguous rules (one is prefix of another)"]])}),a["throws"](function(){b("some string",[[{a:{b:42}},{a:{b:42}},"Projection is not a hash"]])})}),Tinytest.add("minimongo - fetch with fields",function(a){var b=new LocalCollection;_.times(30,function(a){b.insert({something:Random.id(),anything:{foo:"bar",cool:"hot"},nothing:a,i:a})});var c=b.find({},{fields:{something:1,"anything.foo":1}}).fetch();a.isTrue(_.all(c,function(a){return a&&a.something&&a.anything&&a.anything.foo&&"bar"===a.anything.foo&&!_.has(a,"nothing")&&!_.has(a.anything,"cool")})),c=b.find({nothing:{$gte:5}},{fields:{nothing:0}}).fetch(),a.isTrue(_.all(c,function(a){return a&&a.something&&a.anything&&"bar"===a.anything.foo&&"hot"===a.anything.cool&&!_.has(a,"nothing")&&a.i&&a.i>=5})),a.isTrue(25===c.length),c=b.find({},{sort:{nothing:1},limit:10,skip:10,fields:{i:1,something:1}}).fetch(),a.isTrue(_.all(c,function(a){return a&&a.something&&a.i>=10&&a.i<20})),_.each(c,function(b,c,d){c&&a.isTrue(b.i===d[c-1].i+1)}),a["throws"](function(){b.find({},{fields:{"grades.$":1}})}),a["throws"](function(){b.find({},{fields:{grades:{$elemMatch:{mean:70}}}})}),a["throws"](function(){b.find({},{fields:{grades:{$slice:[20,10]}}})})}),Tinytest.add("minimongo - fetch with projection, subarrays",function(a){var b=new LocalCollection;b.insert({setA:[{fieldA:42,fieldB:33},{fieldA:"the good",fieldB:"the bad",fieldC:"the ugly"}],setB:[{anotherA:{},anotherB:"meh"},{anotherA:1234,anotherB:431}]});var c=function(b,c,d){a.isTrue(_.isEqual(b,c),d)},d=function(a,d){var e=b.find({},{fields:a}).fetch()[0];c(e,d,"failed sub-set projection: "+JSON.stringify(a))};d({"setA.fieldA":1,"setB.anotherB":1,_id:0},{setA:[{fieldA:42},{fieldA:"the good"}],setB:[{anotherB:"meh"},{anotherB:431}]}),d({"setA.fieldA":0,"setB.anotherA":0,_id:0},{setA:[{fieldB:33},{fieldB:"the bad",fieldC:"the ugly"}],setB:[{anotherB:"meh"},{anotherB:431}]}),b.remove({}),b.insert({a:[[{b:1,c:2},{b:2,c:4}],{b:3,c:5},[{b:4,c:9}]]}),d({"a.b":1,_id:0},{a:[[{b:1},{b:2}],{b:3},[{b:4}]]}),d({"a.b":0,_id:0},{a:[[{c:2},{c:4}],{c:5},[{c:9}]]})}),Tinytest.add("minimongo - fetch with projection, deep copy",function(a){var b={a:{x:42},b:{y:{z:33}},c:"asdf"},c={a:1,"b.y":1},d=LocalCollection._compileProjection(c),e=d(b);b.a.x++,b.b.y.z--,a.equal(e.a.x,42,"projection returning deep copy - including"),a.equal(e.b.y.z,33,"projection returning deep copy - including"),c={c:0},d=LocalCollection._compileProjection(c),e=d(b),b.a.x=5,a.equal(e.a.x,43,"projection returning deep copy - excluding")}),Tinytest.add("minimongo - observe ordered with projection",function(a){var b,c=[],d=log_callbacks(c),e=new LocalCollection;b=e.find({},{sort:{a:1},fields:{a:1}}).observe(d),a.isTrue(b.collection===e),e.insert({_id:"foo",a:1,b:2}),a.equal(c.shift(),["added",{a:1},0,null]),e.update({a:1},{$set:{a:2,b:1}}),a.equal(c.shift(),["changed",{a:2},0,{a:1}]),e.insert({_id:"bar",a:10,c:33}),a.equal(c.shift(),["added",{a:10},1,null]),e.update({},{$inc:{a:1}},{multi:!0}),e.update({},{$inc:{c:1}},{multi:!0}),a.equal(c.shift(),["changed",{a:3},0,{a:2}]),a.equal(c.shift(),["changed",{a:11},1,{a:10}]),e.update({a:11},{a:1,b:44}),a.equal(c.shift(),["changed",{a:1},1,{a:11}]),a.equal(c.shift(),["moved",{a:1},1,0,"foo"]),e.remove({a:2}),a.equal(c.shift(),void 0),e.remove({a:3}),a.equal(c.shift(),["removed","foo",1,{a:3}]),b.stop();var f=Random.id();e.insert({_id:f,a:2}),a.equal(c.shift(),void 0);var g=e.find({},{fields:{a:1,_id:0}});a["throws"](function(){g.observeChanges({added:function(){}})}),a["throws"](function(){g.observe({added:function(){}})}),b=e.find({},{sort:{a:-1},fields:{a:1}}).observe(d),a.equal(c.shift(),["added",{a:2},0,null]),a.equal(c.shift(),["added",{a:1},1,null]),b.stop(),b=e.find({},{sort:{a:-1},fields:{a:1}}).observe(_.extend(d,{_suppress_initial:!0})),a.equal(c.shift(),void 0),e.insert({a:100,b:{foo:"bar"}}),a.equal(c.shift(),["added",{a:100},0,f]),b.stop(),e.remove({}),b=e.find({},{sort:{a:1},skip:1,limit:2,fields:{blacklisted:0}}).observe(d),a.equal(c.shift(),void 0),e.insert({a:1,blacklisted:1324}),a.equal(c.shift(),void 0),e.insert({_id:"foo",a:2,blacklisted:["something"]}),a.equal(c.shift(),["added",{a:2},0,null]),e.insert({a:3,blacklisted:{2:3}}),a.equal(c.shift(),["added",{a:3},1,null]),e.insert({a:4,blacklisted:6}),a.equal(c.shift(),void 0),e.update({a:1},{a:0,blacklisted:4444}),a.equal(c.shift(),void 0),e.update({a:0},{a:5,blacklisted:11111}),a.equal(c.shift(),["removed","foo",0,{a:2}]),a.equal(c.shift(),["added",{a:4},1,null]),e.update({a:3},{a:3.5,blacklisted:333.4444}),a.equal(c.shift(),["changed",{a:3.5},0,{a:3}]),b.stop(),e.remove({}),b=e.find({},{sort:{a:1},fields:{a:1}}).observe(_.extend(d,{_no_indices:!0})),e.insert({_id:"foo",a:1,zoo:"crazy"}),a.equal(c.shift(),["added",{a:1},-1,null]),e.update({a:1},{$set:{a:2,foobar:"player"}}),a.equal(c.shift(),["changed",{a:2},-1,{a:1}]),e.insert({a:10,b:123.45}),a.equal(c.shift(),["added",{a:10},-1,null]),e.update({},{$inc:{a:1,b:2}},{multi:!0}),a.equal(c.shift(),["changed",{a:3},-1,{a:2}]),a.equal(c.shift(),["changed",{a:11},-1,{a:10}]),e.update({a:11,b:125.45},{a:1,b:444}),a.equal(c.shift(),["changed",{a:1},-1,{a:11}]),a.equal(c.shift(),["moved",{a:1},-1,-1,"foo"]),e.remove({a:2}),a.equal(c.shift(),void 0),e.remove({a:3}),a.equal(c.shift(),["removed","foo",-1,{a:3}]),b.stop()}),Tinytest.add("minimongo - ordering",function(a){var b=EJSON.newBinary(1);b[0]=128;var c=EJSON.newBinary(2);c[1]=42;var d=EJSON.newBinary(2);d[1]=50;var e=new Date,f=new Date(e.getTime()+1e3);assert_ordering(a,LocalCollection._f._cmp,[null,1,2.2,3,"03","1","11","2","a","aaa",{},{a:2},{a:3},{a:3,b:4},{b:4},{b:4,a:3},{b:{}},{b:[1,2,3]},{b:[1,2,4]},[],[1,2],[1,2,3],[1,2,4],[1,2,"4"],[1,2,[4]],b,c,d,new LocalCollection._ObjectID("1234567890abcd1234567890"),new LocalCollection._ObjectID("abcd1234567890abcd123456"),!1,!0,e,f]);var g=function(b,c){_.each(_.isArray(b)?b:[b],function(b){var d=new Minimongo.Sorter(b);assert_ordering(a,d.getComparator(),c)})};g([{a:1},["a"],[["a","asc"]]],[{a:[]},{a:1},{a:{}},{a:!0}]),g([{a:1},["a"],[["a","asc"]]],[{c:1},{a:1},{a:{}},{a:!0}]),g([{a:-1},[["a","desc"]]],[{a:!0},{a:{}},{a:1},{c:1}]),g([{a:-1},[["a","desc"]]],[{a:!0},{a:{}},{a:1},{a:[]}]),g([{a:1,b:-1},["a",["b","desc"]],[["a","asc"],["b","desc"]]],[{c:1},{a:1,b:3},{a:1,b:2},{a:2,b:0}]),g([{a:1,b:1},["a","b"],[["a","asc"],["b","asc"]]],[{c:1},{a:1,b:2},{a:1,b:3},{a:2,b:0}]),a["throws"](function(){new Minimongo.Sorter("a")}),a["throws"](function(){new Minimongo.Sorter(123)}),a["throws"](function(){new Minimongo.Sorter({$natural:1})}),a.equal(new Minimongo.Sorter({}).getComparator()({a:1},{a:2}),0),g({a:1},[{a:[1,10,20]},{a:[5,2,99]}]),g({a:-1},[{a:[5,2,99]},{a:[1,10,20]}]),g({"a.1":1},[{a:[5,2,99]},{a:[1,10,20]}]),g({a:1},[{a:[1,[10,15],20]},{a:[5,[-5,-20],18]}]),g({a:-1},[{a:[1,[10,15],20]},{a:[5,[-5,-20],18]}]),g({"a.0":1},[{a:[1,[10,15],20]},{a:[5,[-5,-20],18]}]),g({"a.0":-1},[{a:[5,[-5,-20],18]},{a:[1,[10,15],20]}]),g({"a.1":1},[{a:[5,[-5,-20],18]},{a:[1,[10,15],20]}]),g({"a.1":-1},[{a:[1,[10,15],20]},{a:[5,[-5,-20],18]}]),g({"a.1":1},[{a:[1,[10,15],20]},{a:[5,[19,3],18]}]),g({"a.1":-1},[{a:[5,[19,3],18]},{a:[1,[10,15],20]}]),g({a:1},[{a:[1,[10,15],20]},{a:[5,[19,3],18]}]),g({a:-1},[{a:[5,[19,3],18]},{a:[1,[10,15],20]}]),g({a:-1},[{a:[1,[10,15],20]},{a:[5,[3,19],18]}]),g({"a.x":1,"a.y":1},[{a:[{x:0,y:4}]},{a:[{x:0,y:5},{x:1,y:3}]}]),g({"a.0.s":1},[{a:[{s:1}]},{a:[{s:2}]}])}),Tinytest.add("minimongo - sort",function(a){for(var b=new LocalCollection,c=0;50>c;c++)for(var d=0;2>d;d++)b.insert({a:c,b:d,_id:c+"_"+d});a.equal(b.find({a:{$gt:10}},{sort:{b:-1,a:1},limit:5}).fetch(),[{a:11,b:1,_id:"11_1"},{a:12,b:1,_id:"12_1"},{a:13,b:1,_id:"13_1"},{a:14,b:1,_id:"14_1"},{a:15,b:1,_id:"15_1"}]),a.equal(b.find({a:{$gt:10}},{sort:{b:-1,a:1},skip:3,limit:5}).fetch(),[{a:14,b:1,_id:"14_1"},{a:15,b:1,_id:"15_1"},{a:16,b:1,_id:"16_1"},{a:17,b:1,_id:"17_1"},{a:18,b:1,_id:"18_1"}]),a.equal(b.find({a:{$gte:20}},{sort:{a:1,b:-1},skip:50,limit:5}).fetch(),[{a:45,b:1,_id:"45_1"},{a:45,b:0,_id:"45_0"},{a:46,b:1,_id:"46_1"},{a:46,b:0,_id:"46_0"},{a:47,b:1,_id:"47_1"}])}),Tinytest.add("minimongo - subkey sort",function(a){var b=new LocalCollection;b.insert({a:{b:2}}),b.insert({a:{b:1}}),b.insert({a:{b:3}}),a.equal(_.pluck(b.find({},{sort:{"a.b":-1}}).fetch(),"a"),[{b:3},{b:2},{b:1}]),b.insert({a:1}),a.equal(_.pluck(b.find({},{sort:{"a.b":1}}).fetch(),"a"),[1,{b:1},{b:2},{b:3}]),b.insert({a:{b:{c:1}}}),a.equal(_.pluck(b.find({},{sort:{"a.b":-1}}).fetch(),"a"),[{b:{c:1}},{b:3},{b:2},{b:1},1]),b.insert({c:1}),a.equal(_.pluck(b.find({},{sort:{"a.b":-1}}).fetch(),"a"),[{b:{c:1}},{b:3},{b:2},{b:1},1,void 0]),a.equal(b.find({},{sort:{"a.nope.c":-1}}).count(),6)}),Tinytest.add("minimongo - array sort",function(a){var b=new LocalCollection;b.insert({up:1,down:1,selected:2,a:{x:[1,4]}}),b.insert({up:2,down:2,selected:0,a:[{x:[2]},{x:3}]}),b.insert({up:0,down:4,a:{x:0}}),b.insert({up:3,down:3,selected:1,a:{x:2.5}}),b.insert({up:4,down:0,selected:3,a:{x:5}});var c=function(c,d){var e=[];b.find().forEach(function(a){_.has(a,d)&&e.push(a[d])}),a.equal(_.pluck(c.fetch(),d),_.range(_.max(e)+1))};c(b.find({},{sort:{"a.x":1}}),"up"),c(b.find({},{sort:{"a.x":-1}}),"down"),c(b.find({"a.x":{$gt:1}},{sort:{"a.x":1}}),"selected")}),Tinytest.add("minimongo - sort keys",function(a){var b=function(a){var b={};return _.each(a,function(a){b[EJSON.stringify(a)]=!0}),b},c=function(c,d,e){var f=b(e),g=new Minimongo.Sorter(c),h=[];g._generateKeysFromDoc(d,function(a){h.push(a)});var i=b(h);a.equal(i,f)},d=function(b,c){var d=new Minimongo.Sorter(b);a["throws"](function(){d._generateKeysFromDoc(c,function(){})},/parallel arrays/)};c({"a.x":1,"a.y":1},{a:{x:0,y:5}},[[0,5]]),c({"a.x":1,"a.y":1},{a:[{x:0,y:5},{x:1,y:3}]},[[0,5],[1,3]]),c({"a.x":1,"a.y":1,b:-1},{a:[{x:0,y:5},{x:1,y:3}],b:42},[[0,5,42],[1,3,42]]),c({b:-1,"a.x":1,"a.y":1},{a:[{x:0,y:5},{x:1,y:3}],b:42},[[42,0,5],[42,1,3]]),c({"a.x":1,b:-1,"a.y":1},{a:[{x:0,y:5},{x:1,y:3}],b:42},[[0,42,5],[1,42,3]]),c({a:1,b:1},{a:[1,2,3],b:42},[[1,42],[2,42],[3,42]]),d({a:1,b:1},{a:[1,2,3],b:[42]}),d({"a.x":1,"a.y":1},{a:[{x:1,y:[2,3]},{x:2,y:[4,5]}]})}),Tinytest.add("minimongo - sort key filter",function(a){var b=function(b,c,d,e){var f=new Minimongo.Matcher(c),g=new Minimongo.Sorter(b,{matcher:f}),h=g.getComparator(),i=h(d,e);a.isTrue(0>i)};b({"a.x":1},{"a.x":{$gt:1}},{a:{x:3}},{a:{x:[1,4]}}),b({"a.x":1},{"a.x":{$gt:0}},{a:{x:[1,4]}},{a:{x:3}});var c=function(b,c,d,e){var f=new Minimongo.Matcher(c),g=new Minimongo.Sorter(b,{matcher:f}),h=g._keyCompatibleWithSelector(d);a.equal(h,e)};c({a:1},{a:5},[5],!0),c({a:1},{a:5},[8],!1),c({a:1},{a:{x:5}},[{x:5}],!0),c({a:1},{a:{x:5}},[{x:5,y:9}],!1),c({"a.x":1},{a:{x:5}},[5],!0),c({"a.x":1},{a:{x:5}},[1],!0),c({"a.x":1},{"a.x":5},[5],!0),c({"a.x":1},{"a.x":5},[1],!1),c({a:1},{a:/^foo+/},["foo"],!0),c({a:1},{a:/^foo+/},["foooo"],!0),c({a:1},{a:/^foo+/},["foooobar"],!0),c({a:1},{a:/^foo+/},["afoooo"],!1),c({a:1},{a:/^foo+/},[""],!1),c({a:1},{a:{$regex:"^foo+"}},["foo"],!0),c({a:1},{a:{$regex:"^foo+"}},["foooo"],!0),c({a:1},{a:{$regex:"^foo+"}},["foooobar"],!0),c({a:1},{a:{$regex:"^foo+"}},["afoooo"],!1),c({a:1},{a:{$regex:"^foo+"}},[""],!1),c({a:1},{a:/^foo+/i},["foo"],!0),c({a:1},{a:/^foo+/i},["bar"],!0),c({a:1},{a:/^foo+/m},["bar"],!0),c({a:1},{a:{$regex:"^foo+",$options:"i"}},["bar"],!0),c({a:1},{a:{$regex:"^foo+",$options:"m"}},["bar"],!0),c({a:1,b:1,c:1},{a:{$gt:5},c:{$lt:3}},[6,"bla",2],!0),c({a:1,b:1,c:1},{a:{$gt:5},c:{$lt:3}},[6,"bla",4],!1),c({a:1,b:1,c:1},{a:{$gt:5},c:{$lt:3}},[3,"bla",1],!1),c({a:1,b:1,c:1},{c:{$lt:3}},[3,"bla",4],!0);

}),Tinytest.add("minimongo - binary search",function(a){var b=function(a,b){return a-b},c=function(a,c){return-1*b(a,c)},d=function(b,c,d,e,f){var g=LocalCollection._binarySearch(b,c,d);e!=g&&a.fail({type:"minimongo-binary-search",message:f+" : Expected index "+e+" but had "+g})},e=function(a,c,e,f){d(b,a,c,e,f)},f=function(a,b,e,f){d(c,a,b,e,f)};e([1,2,5,7],4,2,"Inner insert"),e([1,2,3,4],3,3,"Inner insert, equal value"),e([1,2,5],4,2,"Inner insert, odd length"),e([1,3,5,6],9,4,"End insert"),e([1,3,5,6],0,0,"Beginning insert"),e([1],0,0,"Single array, less than."),e([1],1,1,"Single array, equal."),e([1],2,1,"Single array, greater than."),e([],1,0,"Empty array"),e([1,1,1,2,2,2,2],1,3,"Highly degenerate array, lower"),e([1,1,1,2,2,2,2],2,7,"Highly degenerate array, upper"),e([2,2,2,2,2,2,2],1,0,"Highly degenerate array, lower"),e([2,2,2,2,2,2,2],2,7,"Highly degenerate array, equal"),e([2,2,2,2,2,2,2],3,7,"Highly degenerate array, upper"),f([7,5,2,1],4,2,"Backward: Inner insert"),f([4,3,2,1],3,2,"Backward: Inner insert, equal value"),f([5,2,1],4,1,"Backward: Inner insert, odd length"),f([6,5,3,1],9,0,"Backward: Beginning insert"),f([6,5,3,1],0,4,"Backward: End insert"),f([1],0,1,"Backward: Single array, less than."),f([1],1,1,"Backward: Single array, equal."),f([1],2,0,"Backward: Single array, greater than."),f([],1,0,"Backward: Empty array"),f([2,2,2,2,1,1,1],1,7,"Backward: Degenerate array, lower"),f([2,2,2,2,1,1,1],2,4,"Backward: Degenerate array, upper"),f([2,2,2,2,2,2,2],1,7,"Backward: Highly degenerate array, upper"),f([2,2,2,2,2,2,2],2,7,"Backward: Highly degenerate array, upper"),f([2,2,2,2,2,2,2],3,0,"Backward: Highly degenerate array, upper")}),Tinytest.add("minimongo - modify",function(a){var b=function(b,c,d,e){var f=new LocalCollection;f.insert(b),f.update(c,d);var g=f.findOne();delete g._id,a.equal(g,e,EJSON.stringify({input:b,mod:d}))},c=function(a,c,d){b(a,{},c,d)},d=function(b,c,d){var e=new LocalCollection;e.insert(b),a["throws"](function(){e.update(c,d)})},e=function(a,b){d(a,{},b)};c({},{},{}),c({a:12},{},{}),c({a:12},{a:13},{a:13}),c({a:12,b:99},{a:13},{a:13}),e({a:12},{a:13,$set:{b:13}}),e({a:12},{$set:{b:13},a:13}),c({},{$set:{a:12}},{a:12}),c({},{$set:{"a.b":12}},{a:{b:12}}),c({},{$set:{"a.b.c":12}},{a:{b:{c:12}}}),c({a:{d:99}},{$set:{"a.b.c":12}},{a:{d:99,b:{c:12}}}),c({},{$set:{"a.b.3.c":12}},{a:{b:{3:{c:12}}}}),c({a:{b:[]}},{$set:{"a.b.3.c":12}},{a:{b:[null,null,null,{c:12}]}}),e({a:[null,null,null]},{$set:{"a.1.b":12}}),e({a:[null,1,null]},{$set:{"a.1.b":12}}),e({a:[null,"x",null]},{$set:{"a.1.b":12}}),e({a:[null,[],null]},{$set:{"a.1.b":12}}),c({a:[null,null,null]},{$set:{"a.3.b":12}},{a:[null,null,null,{b:12}]}),e({a:[]},{$set:{"a.b":12}}),e({a:12},{$set:{"a.b":99}}),e({a:"x"},{$set:{"a.b":99}}),e({a:!0},{$set:{"a.b":99}}),e({a:null},{$set:{"a.b":99}}),c({a:{}},{$set:{"a.3":12}},{a:{3:12}}),c({a:[]},{$set:{"a.3":12}},{a:[null,null,null,12]}),e({},{$set:{"":12}}),e({},{$set:{".":12}}),e({},{$set:{"a.":12}}),e({},{$set:{". ":12}}),e({},{$inc:{"... ":12}}),e({},{$set:{"a..b":12}}),c({a:[1,2,3]},{$set:{"a.01":99}},{a:[1,99,3]}),c({a:[1,{a:98},3]},{$set:{"a.01.b":99}},{a:[1,{a:98,b:99},3]}),c({},{$set:{"2.a.b":12}},{2:{a:{b:12}}}),e({x:[]},{$set:{"x.2..a":99}}),c({x:[null,null]},{$set:{"x.2.a":1}},{x:[null,null,{a:1}]}),e({x:[null,null]},{$set:{"x.1.a":1}}),b({a:[{x:2},{x:4}]},{"a.x":4},{$set:{"a.$.z":9}},{a:[{x:2},{x:4,z:9}]}),e({a:[{x:2},{x:4}]},{$set:{"a.$.z":9}}),d({a:[{x:2},{x:4}],b:5},{b:5},{$set:{"a.$.z":9}}),d({a:[{x:[2]}]},{"a.x":2},{$set:{"a.$.x.$":9}}),b({a:[5,6,7]},{a:6},{$set:{"a.$":9}},{a:[5,9,7]}),b({a:[{b:[{c:9},{c:10}]},{b:{c:11}}]},{"a.b.c":10},{$unset:{"a.$.b":1}},{a:[{},{b:{c:11}}]}),b({a:[{b:[{c:9},{c:10}]},{b:{c:11}}]},{"a.b.c":11},{$unset:{"a.$.b":1}},{a:[{b:[{c:9},{c:10}]},{}]}),b({a:[1]},{"a.0":1},{$set:{"a.$":5}},{a:[5]}),b({a:[9]},{a:{$mod:[2,1]}},{$set:{"a.$":5}},{a:[5]}),d({a:[1]},{$not:{a:2}},{$set:{"a.$":5}}),d({a:[1]},{"a.0":{$ne:2}},{$set:{"a.$":5}}),b({a:[{x:2},{x:4}]},{$or:[{"a.x":4}]},{$set:{"a.$.z":9}},{a:[{x:2},{x:4,z:9}]}),d({a:[{x:2},{x:4}]},{$or:[{"a.x":4},{"a.x":4}]},{$set:{"a.$.z":9}}),b({a:[{x:1},{x:3}]},{$and:[{"a.x":1},{"a.x":3}]},{$set:{"a.$.x":5}},{a:[{x:1},{x:5}]}),b({a:[{x:1},{x:3}]},{$and:[{"a.x":3},{"a.x":1}]},{$set:{"a.$.x":5}},{a:[{x:5},{x:3}]}),b({a:[{x:1},{y:3}]},{"a.x":1,"a.y":3},{$set:{"a.$.z":5}},{a:[{x:1},{y:3,z:5}]}),b({a:[{b:[1,1]},{b:[[3,3],[4,4]]},{b:[9,9]}]},{"a.b":{$near:[5,5]}},{$set:{"a.$.b":"k"}},{a:[{b:[1,1]},{b:"k"},{b:[9,9]}]}),b({a:[{x:1},{y:1},{x:1,y:1}]},{a:{$elemMatch:{x:1,y:1}}},{$set:{"a.$.x":2}},{a:[{x:1},{y:1},{x:2,y:1}]}),b({a:[{b:[{x:1},{y:1},{x:1,y:1}]}]},{"a.b":{$elemMatch:{x:1,y:1}}},{$set:{"a.$.b":3}},{a:[{b:3}]}),c({a:1,b:2},{$inc:{a:10}},{a:11,b:2}),c({a:1,b:2},{$inc:{c:10}},{a:1,b:2,c:10}),e({a:1},{$inc:{a:"10"}}),e({a:1},{$inc:{a:!0}}),e({a:1},{$inc:{a:[10]}}),e({a:"1"},{$inc:{a:10}}),e({a:[1]},{$inc:{a:10}}),e({a:{}},{$inc:{a:10}}),e({a:!1},{$inc:{a:10}}),e({a:null},{$inc:{a:10}}),c({a:[1,2]},{$inc:{"a.1":10}},{a:[1,12]}),c({a:[1,2]},{$inc:{"a.2":10}},{a:[1,2,10]}),c({a:[1,2]},{$inc:{"a.3":10}},{a:[1,2,null,10]}),c({a:{b:2}},{$inc:{"a.b":10}},{a:{b:12}}),c({a:{b:2}},{$inc:{"a.c":10}},{a:{b:2,c:10}}),e({},{$inc:{_id:1}}),c({a:1,b:2},{$set:{a:10}},{a:10,b:2}),c({a:1,b:2},{$set:{c:10}},{a:1,b:2,c:10}),c({a:1,b:2},{$set:{a:{c:10}}},{a:{c:10},b:2}),c({a:[1,2],b:2},{$set:{a:[3,4]}},{a:[3,4],b:2}),c({a:[1,2,3],b:2},{$set:{"a.1":[3,4]}},{a:[1,[3,4],3],b:2}),c({a:[1],b:2},{$set:{"a.1":9}},{a:[1,9],b:2}),c({a:[1],b:2},{$set:{"a.2":9}},{a:[1,null,9],b:2}),c({a:{b:1}},{$set:{"a.c":9}},{a:{b:1,c:9}}),c({},{$set:{"x._id":4}},{x:{_id:4}}),e({},{$set:{_id:4}}),e({_id:4},{$set:{_id:4}}),c({},{$unset:{a:1}},{}),c({a:1},{$unset:{a:1}},{}),c({a:1,b:2},{$unset:{a:1}},{b:2}),c({a:1,b:2},{$unset:{a:0}},{b:2}),c({a:1,b:2},{$unset:{a:!1}},{b:2}),c({a:1,b:2},{$unset:{a:null}},{b:2}),c({a:1,b:2},{$unset:{a:[1]}},{b:2}),c({a:1,b:2},{$unset:{a:{}}},{b:2}),c({a:{b:2,c:3}},{$unset:{"a.b":1}},{a:{c:3}}),c({a:[1,2,3]},{$unset:{"a.1":1}},{a:[1,null,3]}),c({a:[1,2,3]},{$unset:{"a.2":1}},{a:[1,2,null]}),c({a:[1,2,3]},{$unset:{"a.x":1}},{a:[1,2,3]}),c({a:{b:1}},{$unset:{"a.b.c.d":1}},{a:{b:1}}),c({a:{b:1}},{$unset:{"a.x.c.d":1}},{a:{b:1}}),c({a:{b:{c:1}}},{$unset:{"a.b.c":1}},{a:{b:{}}}),e({},{$unset:{_id:1}}),c({},{$push:{a:1}},{a:[1]}),c({a:[]},{$push:{a:1}},{a:[1]}),c({a:[1]},{$push:{a:2}},{a:[1,2]}),e({a:!0},{$push:{a:1}}),c({a:[1]},{$push:{a:[2]}},{a:[1,[2]]}),c({a:[]},{$push:{"a.1":99}},{a:[null,[99]]}),c({a:{}},{$push:{"a.x":99}},{a:{x:[99]}}),c({},{$push:{a:{$each:[1,2,3]}}},{a:[1,2,3]}),c({a:[]},{$push:{a:{$each:[1,2,3]}}},{a:[1,2,3]}),c({a:[!0]},{$push:{a:{$each:[1,2,3]}}},{a:[!0,1,2,3]}),e({},{$push:{a:{$each:[],$slice:5}}}),c({a:[!0]},{$push:{a:{$each:[1,2,3],$slice:-2}}},{a:[2,3]}),c({a:[!1,!0]},{$push:{a:{$each:[1],$slice:-2}}},{a:[!0,1]}),c({a:[{x:3},{x:1}]},{$push:{a:{$each:[{x:4},{x:2}],$slice:-2,$sort:{x:1}}}},{a:[{x:3},{x:4}]}),c({},{$push:{a:{$each:[1,2,3],$slice:0}}},{a:[]}),c({a:[1,2]},{$push:{a:{$each:[1,2,3],$slice:0}}},{a:[]}),c({},{$pushAll:{a:[1]}},{a:[1]}),c({a:[]},{$pushAll:{a:[1]}},{a:[1]}),c({a:[1]},{$pushAll:{a:[2]}},{a:[1,2]}),c({},{$pushAll:{a:[1,2]}},{a:[1,2]}),c({a:[]},{$pushAll:{a:[1,2]}},{a:[1,2]}),c({a:[1]},{$pushAll:{a:[2,3]}},{a:[1,2,3]}),c({},{$pushAll:{a:[]}},{a:[]}),c({a:[]},{$pushAll:{a:[]}},{a:[]}),c({a:[1]},{$pushAll:{a:[]}},{a:[1]}),e({a:!0},{$pushAll:{a:[1]}}),e({a:[]},{$pushAll:{a:1}}),c({a:[]},{$pushAll:{"a.1":[99]}},{a:[null,[99]]}),c({a:[]},{$pushAll:{"a.1":[]}},{a:[null,[]]}),c({a:{}},{$pushAll:{"a.x":[99]}},{a:{x:[99]}}),c({a:{}},{$pushAll:{"a.x":[]}},{a:{x:[]}}),c({},{$addToSet:{a:1}},{a:[1]}),c({a:[]},{$addToSet:{a:1}},{a:[1]}),c({a:[1]},{$addToSet:{a:2}},{a:[1,2]}),c({a:[1,2]},{$addToSet:{a:1}},{a:[1,2]}),c({a:[1,2]},{$addToSet:{a:2}},{a:[1,2]}),c({a:[1,2]},{$addToSet:{a:3}},{a:[1,2,3]}),e({a:!0},{$addToSet:{a:1}}),c({a:[1]},{$addToSet:{a:[2]}},{a:[1,[2]]}),c({},{$addToSet:{a:{x:1}}},{a:[{x:1}]}),c({a:[{x:1}]},{$addToSet:{a:{x:1}}},{a:[{x:1}]}),c({a:[{x:1}]},{$addToSet:{a:{x:2}}},{a:[{x:1},{x:2}]}),c({a:[{x:1,y:2}]},{$addToSet:{a:{x:1,y:2}}},{a:[{x:1,y:2}]}),c({a:[{x:1,y:2}]},{$addToSet:{a:{y:2,x:1}}},{a:[{x:1,y:2},{y:2,x:1}]}),c({a:[1,2]},{$addToSet:{a:{$each:[3,1,4]}}},{a:[1,2,3,4]}),c({a:[1,2]},{$addToSet:{a:{$each:[3,1,4],b:12}}},{a:[1,2,3,4]}),c({a:[1,2]},{$addToSet:{a:{b:12,$each:[3,1,4]}}},{a:[1,2,{b:12,$each:[3,1,4]}]}),c({},{$addToSet:{a:{$each:[]}}},{a:[]}),c({},{$addToSet:{a:{$each:[1]}}},{a:[1]}),c({a:[]},{$addToSet:{"a.1":99}},{a:[null,[99]]}),c({a:{}},{$addToSet:{"a.x":99}},{a:{x:[99]}}),c({},{$pop:{a:1}},{}),c({},{$pop:{a:-1}},{}),c({a:[]},{$pop:{a:1}},{a:[]}),c({a:[]},{$pop:{a:-1}},{a:[]}),c({a:[1,2,3]},{$pop:{a:1}},{a:[1,2]}),c({a:[1,2,3]},{$pop:{a:10}},{a:[1,2]}),c({a:[1,2,3]},{$pop:{a:.001}},{a:[1,2]}),c({a:[1,2,3]},{$pop:{a:0}},{a:[1,2]}),c({a:[1,2,3]},{$pop:{a:"stuff"}},{a:[1,2]}),c({a:[1,2,3]},{$pop:{a:-1}},{a:[2,3]}),c({a:[1,2,3]},{$pop:{a:-10}},{a:[2,3]}),c({a:[1,2,3]},{$pop:{a:-.001}},{a:[2,3]}),e({a:!0},{$pop:{a:1}}),e({a:!0},{$pop:{a:-1}}),c({a:[]},{$pop:{"a.1":1}},{a:[]}),c({a:[1,[2,3],4]},{$pop:{"a.1":1}},{a:[1,[2],4]}),c({a:{}},{$pop:{"a.x":1}},{a:{}}),c({a:{x:[2,3]}},{$pop:{"a.x":1}},{a:{x:[2]}}),c({},{$pull:{a:1}},{}),c({},{$pull:{"a.x":1}},{}),c({a:{}},{$pull:{"a.x":1}},{a:{}}),e({a:!0},{$pull:{a:1}}),c({a:[2,1,2]},{$pull:{a:1}},{a:[2,2]}),c({a:[2,1,2]},{$pull:{a:2}},{a:[1]}),c({a:[2,1,2]},{$pull:{a:3}},{a:[2,1,2]}),c({a:[]},{$pull:{a:3}},{a:[]}),c({a:[[2],[2,1],[3]]},{$pull:{a:[2,1]}},{a:[[2],[3]]}),c({a:[{b:1,c:2},{b:2,c:2}]},{$pull:{a:{b:1}}},{a:[{b:2,c:2}]}),c({a:[{b:1,c:2},{b:2,c:2}]},{$pull:{a:{c:2}}},{a:[]}),c({},{$pullAll:{a:[1]}},{}),c({a:[1,2,3]},{$pullAll:{a:[]}},{a:[1,2,3]}),c({a:[1,2,3]},{$pullAll:{a:[2]}},{a:[1,3]}),c({a:[1,2,3]},{$pullAll:{a:[2,1]}},{a:[3]}),c({a:[1,2,3]},{$pullAll:{a:[1,2]}},{a:[3]}),c({},{$pullAll:{"a.b.c":[2]}},{}),e({a:!0},{$pullAll:{a:[1]}}),e({a:[1,2,3]},{$pullAll:{a:1}}),c({x:[{a:1},{a:1,b:2}]},{$pullAll:{x:[{a:1}]}},{x:[{a:1,b:2}]}),c({},{$rename:{a:"b"}},{}),c({a:[12]},{$rename:{a:"b"}},{b:[12]}),c({a:{b:12}},{$rename:{a:"c"}},{c:{b:12}}),c({a:{b:12}},{$rename:{"a.b":"a.c"}},{a:{c:12}}),c({a:{b:12}},{$rename:{"a.b":"x"}},{a:{},x:12}),c({a:{b:12}},{$rename:{"a.b":"q.r"}},{a:{},q:{r:12}}),c({a:{b:12}},{$rename:{"a.b":"q.2.r"}},{a:{},q:{2:{r:12}}}),c({a:{b:12},q:{}},{$rename:{"a.b":"q.2.r"}},{a:{},q:{2:{r:12}}}),e({a:{b:12},q:[]},{$rename:{"a.b":"q.2"}}),e({a:{b:12},q:[]},{$rename:{"a.b":"q.2.r"}}),e({},{$rename:{a:"a"}}),e({},{$rename:{"a.b":"a.b"}}),c({a:12,b:13},{$rename:{a:"b"}},{b:12})}),Tinytest.add("minimongo - observe ordered",function(a){var b,c=[],d=log_callbacks(c),e=new LocalCollection;b=e.find({},{sort:{a:1}}).observe(d),a.isTrue(b.collection===e),e.insert({_id:"foo",a:1}),a.equal(c.shift(),["added",{a:1},0,null]),e.update({a:1},{$set:{a:2}}),a.equal(c.shift(),["changed",{a:2},0,{a:1}]),e.insert({a:10}),a.equal(c.shift(),["added",{a:10},1,null]),e.update({},{$inc:{a:1}},{multi:!0}),a.equal(c.shift(),["changed",{a:3},0,{a:2}]),a.equal(c.shift(),["changed",{a:11},1,{a:10}]),e.update({a:11},{a:1}),a.equal(c.shift(),["changed",{a:1},1,{a:11}]),a.equal(c.shift(),["moved",{a:1},1,0,"foo"]),e.remove({a:2}),a.equal(c.shift(),void 0),e.remove({a:3}),a.equal(c.shift(),["removed","foo",1,{a:3}]),b.stop();var f=Random.id();e.insert({_id:f,a:2}),a.equal(c.shift(),void 0),b=e.find({},{sort:{a:-1}}).observe(d),a.equal(c.shift(),["added",{a:2},0,null]),a.equal(c.shift(),["added",{a:1},1,null]),b.stop(),b=e.find({},{sort:{a:-1}}).observe(_.extend({_suppress_initial:!0},d)),a.equal(c.shift(),void 0),e.insert({a:100}),a.equal(c.shift(),["added",{a:100},0,f]),b.stop(),e.remove({}),b=e.find({},{sort:{a:1},skip:1,limit:2}).observe(d),a.equal(c.shift(),void 0),e.insert({a:1}),a.equal(c.shift(),void 0),e.insert({_id:"foo",a:2}),a.equal(c.shift(),["added",{a:2},0,null]),e.insert({a:3}),a.equal(c.shift(),["added",{a:3},1,null]),e.insert({a:4}),a.equal(c.shift(),void 0),e.update({a:1},{a:0}),a.equal(c.shift(),void 0),e.update({a:0},{a:5}),a.equal(c.shift(),["removed","foo",0,{a:2}]),a.equal(c.shift(),["added",{a:4},1,null]),e.update({a:3},{a:3.5}),a.equal(c.shift(),["changed",{a:3.5},0,{a:3}]),b.stop(),e.remove({}),e.insert({a:1}),e.insert({_id:"two",a:2}),e.insert({a:3}),b=e.find({},{sort:{a:1},limit:2}).observe(d),a.equal(c.shift(),["added",{a:1},0,null]),a.equal(c.shift(),["added",{a:2},1,null]),a.equal(c.shift(),void 0),e.remove({a:2}),a.equal(c.shift(),["removed","two",1,{a:2}]),a.equal(c.shift(),["added",{a:3},1,null]),a.equal(c.shift(),void 0),b.stop(),e.remove({}),b=e.find({},{sort:{a:1}}).observe(_.extend(d,{_no_indices:!0})),e.insert({_id:"foo",a:1}),a.equal(c.shift(),["added",{a:1},-1,null]),e.update({a:1},{$set:{a:2}}),a.equal(c.shift(),["changed",{a:2},-1,{a:1}]),e.insert({a:10}),a.equal(c.shift(),["added",{a:10},-1,null]),e.update({},{$inc:{a:1}},{multi:!0}),a.equal(c.shift(),["changed",{a:3},-1,{a:2}]),a.equal(c.shift(),["changed",{a:11},-1,{a:10}]),e.update({a:11},{a:1}),a.equal(c.shift(),["changed",{a:1},-1,{a:11}]),a.equal(c.shift(),["moved",{a:1},-1,-1,"foo"]),e.remove({a:2}),a.equal(c.shift(),void 0),e.remove({a:3}),a.equal(c.shift(),["removed","foo",-1,{a:3}]),b.stop()}),_.each([!0,!1],function(a){Tinytest.add("minimongo - observe ordered: "+a,function(b){var c=new LocalCollection,d="",e=function(b){var c={};return _.each(["added","changed","removed"],function(e){var f=a?e+"At":e;c[f]=function(a){d=d+e.substr(0,1)+b+a._id+"_"}}),c},f=function(a){b.equal(d,a),d=""};c.insert({_id:1,name:"strawberry",tags:["fruit","red","squishy"]}),c.insert({_id:2,name:"apple",tags:["fruit","red","hard"]}),c.insert({_id:3,name:"rose",tags:["flower","red","squishy"]});var g=c.find({tags:"flower"}).observe(e("a"));f("aa3_"),c.update({name:"rose"},{$set:{tags:["bloom","red","squishy"]}}),f("ra3_"),c.update({name:"rose"},{$set:{tags:["flower","red","squishy"]}}),f("aa3_"),c.update({name:"rose"},{$set:{food:!1}}),f("ca3_"),c.remove({}),f("ra3_"),c.insert({_id:4,name:"daisy",tags:["flower"]}),f("aa4_"),g.stop(),c.insert({_id:5,name:"iris",tags:["flower"]}),f(""),g=c.find(4).observe(e("b")),f("ab4_"),c.update(4,{$set:{eek:5}}),f("cb4_"),g.stop(),g=c.find({tags:"flower"},{reactive:!1}).observe(e("c")),f("ac4_ac5_"),c.insert({_id:6,name:"river",tags:["flower"]}),f(""),g.stop()})}),Tinytest.add("minimongo - diff changes ordering",function(a){var b=function(a){return _.map(a,function(a){return{_id:a}})},c=function(c,d){var e=b(c),f=b(d),g=EJSON.clone(e);LocalCollection._diffQueryOrderedChanges(e,f,{addedBefore:function(a,b,c){if(null===c)return void g.push(_.extend({_id:a},b));for(var d=0;d<g.length;d++)if(g[d]._id===c)return void g.splice(d,0,_.extend({_id:a},b))},movedBefore:function(a,b){for(var c,d=0;d<g.length;d++)g[d]._id===a&&(c=g[d],g.splice(d,1));if(null===b)return void g.push(_.extend({_id:a},c));for(d=0;d<g.length;d++)if(g[d]._id===b)return void g.splice(d,0,_.extend({_id:a},c))},removed:function(a){for(var b,c=0;c<g.length;c++)g[c]._id===a&&(b=g[c],g.splice(c,1))}}),a.equal(g,f)},d=function(a,b){c(a,b),c(b,a)};d(["a","b","c"],["c","b","a"]),d(["a","b","c"],[]),d(["a","b","c"],["e","f"]),d(["a","b","c","d"],["c","b","a"]),d(["A","B","C","D","E","F","G","H","I"],["A","B","F","G","C","D","I","L","M","N","H"]),d(["A","B","C","D","E","F","G","H","I"],["A","B","C","D","F","G","H","E","I"])}),Tinytest.add("minimongo - diff",function(a){var b=function(b,c){for(var d=new Array(b),e=1;b>=e;e++)d[e-1]={_id:e};var f=_.map(c,function(a){var b={_id:Math.abs(a)};return 0>a&&(b.changed=!0),b}),g=function(a,b){for(var c=0;c<a.length;c++)if(EJSON.equals(a[c]._id,b))return c;return-1},h=_.clone(d),i={addedBefore:function(b,c,d){var e;e=null===d?h.length:g(h,d);var f=_.extend({_id:b},c);a.isFalse(0>e||e>h.length),h.splice(e,0,f)},removed:function(b){var c=g(h,b);a.isFalse(0>c||c>=h.length),h.splice(c,1)},changed:function(b,c){var d=g(h,b),e=h[d],f=EJSON.clone(e);LocalCollection._applyChanges(f,c),a.isFalse(0>d||d>=h.length),a.equal(f._id,e._id),h[d]=f},movedBefore:function(b,c){var d,e=g(h,b);d=null===c?h.length:g(h,c),d>e&&d--,a.isFalse(0>e||e>=h.length),a.isFalse(0>d||d>=h.length),h.splice(d,0,h.splice(e,1)[0])}};LocalCollection._diffQueryOrderedChanges(d,f,i),a.equal(h,f)};b(5,[5,1,2,3,4]),b(0,[1,2,3,4]),b(4,[]),b(7,[4,5,6,7,1,2,3]),b(7,[5,6,7,1,2,3,4]),b(10,[7,4,11,6,12,1,5]),b(3,[3,2,1]),b(10,[2,7,4,6,11,3,8,9]),b(0,[]),b(1,[]),b(0,[1]),b(1,[1]),b(5,[1,2,3,4,5]),b(5,[-5,-1,2,-3,4]),b(7,[-4,-5,6,7,-1,2,3]),b(7,[5,6,-7,1,2,-3,4]),b(10,[7,-4,11,6,12,-1,5]),b(3,[-3,-2,-1]),b(10,[-2,7,4,6,11,-3,-8,9])}),Tinytest.add("minimongo - saveOriginals",function(a){var b,c=new LocalCollection;c.insert({_id:"foo",x:"untouched"}),c.insert({_id:"bar",x:"updateme"}),c.insert({_id:"baz",x:"updateme"}),c.insert({_id:"quux",y:"removeme"}),c.insert({_id:"whoa",y:"removeme"}),c.saveOriginals(),c.insert({_id:"hooray",z:"insertme"}),c.remove({y:"removeme"}),b=c.update({x:"updateme"},{$set:{z:5}},{multi:!0}),c.update("bar",{$set:{k:7}}),a.equal(b,2);var d=c.retrieveOriginals(),e=["bar","baz","quux","whoa","hooray"];a.equal(d.size(),_.size(e)),_.each(e,function(b){a.isTrue(d.has(b))}),a.equal(d.get("bar"),{_id:"bar",x:"updateme"}),a.equal(d.get("baz"),{_id:"baz",x:"updateme"}),a.equal(d.get("quux"),{_id:"quux",y:"removeme"}),a.equal(d.get("whoa"),{_id:"whoa",y:"removeme"}),a.equal(d.get("hooray"),void 0),a.equal(c.find().count(),4),a.equal(c.findOne("foo"),{_id:"foo",x:"untouched"}),a.equal(c.findOne("bar"),{_id:"bar",x:"updateme",z:5,k:7}),a.equal(c.findOne("baz"),{_id:"baz",x:"updateme",z:5}),a.equal(c.findOne("hooray"),{_id:"hooray",z:"insertme"}),c.saveOriginals(),d=c.retrieveOriginals(),a.isTrue(d),a.isTrue(d.empty()),c.saveOriginals(),c.insert({_id:"temp",q:8}),c.remove("temp"),d=c.retrieveOriginals(),a.equal(d.size(),1),a.isTrue(d.has("temp")),a.equal(d.get("temp"),void 0)}),Tinytest.add("minimongo - saveOriginals errors",function(a){var b=new LocalCollection;a["throws"](function(){b.retrieveOriginals()}),b.saveOriginals(),a["throws"](function(){b.saveOriginals()})}),Tinytest.add("minimongo - objectid transformation",function(a){var b=function(b){a.equal(b,LocalCollection._idParse(LocalCollection._idStringify(b)))},c=new LocalCollection._ObjectID;b(c),b("FOO"),b("ffffffffffff"),b("0987654321abcdef09876543"),b(new LocalCollection._ObjectID),b("--a string"),a.equal("ffffffffffff",LocalCollection._idParse(LocalCollection._idStringify("ffffffffffff")))}),Tinytest.add("minimongo - objectid",function(a){var b=new LocalCollection._ObjectID,c=new LocalCollection._ObjectID;a.notEqual(b,c),a["throws"](function(){new LocalCollection._ObjectID("qqqqqqqqqqqqqqqqqqqqqqqq")}),a["throws"](function(){new LocalCollection._ObjectID("ABCDEF")}),a.equal(b,new LocalCollection._ObjectID(b.valueOf()))}),Tinytest.add("minimongo - pause",function(a){var b=[],c=log_callbacks(b),d=new LocalCollection,e=d.find({}).observe(c);d.insert({_id:1,a:1}),a.equal(b.shift(),["added",{a:1},0,null]),d.pauseObservers(),d.remove({_id:1}),a.length(b,0),d.insert({_id:1,a:1}),a.length(b,0),d.resumeObservers(),a.length(b,0),d.pauseObservers(),d.update({_id:1},{a:2}),d.update({_id:1},{a:3}),d.resumeObservers(),a.equal(b.shift(),["changed",{a:3},0,{a:1}]),a.length(b,0),d.pauseObservers(),a.equal(d.remove({}),1),a.length(b,0),d.resumeObservers(),a.equal(b.shift(),["removed",1,0,{a:3}]),a.length(b,0),e.stop()}),Tinytest.add("minimongo - ids matched by selector",function(a){var b=function(b,c){var d=LocalCollection._idsMatchedBySelector(b);a.equal(d,c)};b("foo",["foo"]),b({_id:"foo"},["foo"]);var c=new LocalCollection._ObjectID;b(c,[c]),b({_id:c},[c]),b({_id:"foo",x:42},["foo"]),b({},null),b({_id:{$in:["foo",c]}},["foo",c]),b({_id:{$ne:"foo"}},null),b({$and:["foo"]},["foo"]),b({$and:[{x:42},{_id:c}]},[c]),b({$and:[{x:42},{_id:{$in:[c]}}]},[c])}),Tinytest.add("minimongo - reactive stop",function(a){var b=new LocalCollection;b.insert({_id:"A"}),b.insert({_id:"B"}),b.insert({_id:"C"});var c,d,e=function(a,b,c){var d=a.indexOf(c);return-1===d?a+b:a.slice(0,d)+b+a.slice(d)},f=ReactiveVar(1),g=Tracker.autorun(function(){var a=b.find({},{sort:{_id:f.get()}});c="",a.observe({addedAt:function(a,b,d){c=e(c,a._id,d)}}),d="",a.observeChanges({addedBefore:function(a,b,c){d=e(d,a,c)}})});a.equal(c,"ABC"),a.equal(d,"ABC"),f.set(-1),a.equal(c,"ABC"),a.equal(d,"ABC"),Tracker.flush(),a.equal(c,"CBA"),a.equal(d,"CBA"),b.insert({_id:"D"}),b.insert({_id:"E"}),a.equal(c,"EDCBA"),a.equal(d,"EDCBA"),g.stop(),b.insert({_id:"F"}),a.equal(c,"EDCBA"),a.equal(d,"EDCBA")}),Tinytest.add("minimongo - immediate invalidate",function(){var a=new LocalCollection;a.insert({_id:"A"});var b=Tracker.autorun(function(){a.findOne("A"),a.findOne("A")});a.update("A",{$set:{x:42}}),b.stop()}),Tinytest.add("minimongo - count on cursor with limit",function(a){var b,c=new LocalCollection;c.insert({_id:"A"}),c.insert({_id:"B"}),c.insert({_id:"C"}),c.insert({_id:"D"});var d=Tracker.autorun(function(){var a=c.find({_id:{$exists:!0}},{sort:{_id:1},limit:3});b=a.count()});a.equal(b,3),c.remove("A"),Tracker.flush(),a.equal(b,3),c.remove("B"),Tracker.flush(),a.equal(b,2),c.insert({_id:"A"}),Tracker.flush(),a.equal(b,3),c.insert({_id:"B"}),Tracker.flush(),a.equal(b,3),d.stop()}),Tinytest.add("minimongo - reactive count with cached cursor",function(a){var b,c,d=new LocalCollection,e=d.find({});Tracker.autorun(function(){b=e.count()}),Tracker.autorun(function(){c=d.find({}).count()}),a.equal(b,0),a.equal(c,0),d.insert({i:1}),d.insert({i:2}),d.insert({i:3}),Tracker.flush(),a.equal(b,3),a.equal(c,3)}),Tinytest.add("minimongo - $near operator tests",function(a){function b(a,b){var c=a[0]-b[0],d=a[1]-b[1];return Math.sqrt(c*c+d*d)}var c=new LocalCollection;c.insert({rest:{loc:[2,3]}}),c.insert({rest:{loc:[-3,3]}}),c.insert({rest:{loc:[5,5]}}),a.equal(c.find({"rest.loc":{$near:[0,0],$maxDistance:30}}).count(),3),a.equal(c.find({"rest.loc":{$near:[0,0],$maxDistance:4}}).count(),1);var d=c.find({"rest.loc":{$near:[0,0],$maxDistance:6}}).fetch();_.each(d,function(c,d,e){a.isTrue(!d||b([0,0],c.rest.loc)>=b([0,0],e[d-1].rest.loc))}),c=new LocalCollection;var e=[{category:"BURGLARY",descript:"BURGLARY OF STORE, FORCIBLE ENTRY",address:"100 Block of 10TH ST",location:{type:"Point",coordinates:[-122.415449723856,37.7749518087273]}},{category:"WEAPON LAWS",descript:"POSS OF PROHIBITED WEAPON",address:"900 Block of MINNA ST",location:{type:"Point",coordinates:[-122.415386041221,37.7747879744156]}},{category:"LARCENY/THEFT",descript:"GRAND THEFT OF PROPERTY",address:"900 Block of MINNA ST",location:{type:"Point",coordinates:[-122.41538270191,37.774683628213]}},{category:"LARCENY/THEFT",descript:"PETTY THEFT FROM LOCKED AUTO",address:"900 Block of MINNA ST",location:{type:"Point",coordinates:[-122.415396041221,37.7747879744156]}},{category:"OTHER OFFENSES",descript:"POSSESSION OF BURGLARY TOOLS",address:"900 Block of MINNA ST",location:{type:"Point",coordinates:[-122.415386041221,37.7747879734156]}}];_.each(e,function(a,b){c.insert(_.extend(a,{x:b}))});var f=c.find({location:{$near:{$geometry:{type:"Point",coordinates:[-122.4154282,37.7746115]},$maxDistance:15}}}).fetch();a.length(f,1),a.equal(f[0].descript,"GRAND THEFT OF PROPERTY");var g=c.find({location:{$near:{$geometry:{type:"Point",coordinates:[-122.4154282,37.7746115]},$maxDistance:20}}}).fetch();a.length(g,4),a.equal(g[0].descript,"GRAND THEFT OF PROPERTY"),a.equal(g[1].descript,"PETTY THEFT FROM LOCKED AUTO"),a.equal(g[2].descript,"POSSESSION OF BURGLARY TOOLS"),a.equal(g[3].descript,"POSS OF PROHIBITED WEAPON"),a["throws"](function(){c.find({location:{$not:{$near:{$geometry:{type:"Point",coordinates:[-122.4154282,37.7746115]},$maxDistance:20}}}})}),a["throws"](function(){c.find({$and:[{location:{$near:{$geometry:{type:"Point",coordinates:[-122.4154282,37.7746115]},$maxDistance:20}}},{x:0}]})}),a["throws"](function(){c.find({$or:[{location:{$near:{$geometry:{type:"Point",coordinates:[-122.4154282,37.7746115]},$maxDistance:20}}},{x:0}]})}),a["throws"](function(){c.find({$nor:[{location:{$near:{$geometry:{type:"Point",coordinates:[-122.4154282,37.7746115]},$maxDistance:1}}},{x:0}]})}),a["throws"](function(){c.find({$and:[{$and:[{location:{$near:{$geometry:{type:"Point",coordinates:[-122.4154282,37.7746115]},$maxDistance:1}}}]}]})}),c=new LocalCollection,c.insert({_id:"x",k:9,a:[{b:[[100,100],[1,1]]},{b:[150,150]}]}),c.insert({_id:"y",k:9,a:{b:[5,5]}});var h=function(b,d,e){a.equal(_.pluck(c.find({"a.b":{$near:b,$maxDistance:d}}).fetch(),"_id"),e)};h([149,149],4,["x"]),h([149,149],1e3,["x","y"]),h([2,2],1e3,["x","y"]),a.equal(_.pluck(c.find({"a.b":{$near:[1,1]}},{sort:{k:1}}).fetch(),"_id"),["x","y"]),a.equal(_.pluck(c.find({"a.b":{$near:[5,5]}},{sort:{k:1}}).fetch(),"_id"),["y","x"]);var i=[],j=log_callbacks(i),k=c.find({"a.b":{$near:[7,7]}}).observe(j);a.length(i,2),a.equal(i.shift(),["added",{k:9,a:{b:[5,5]}},0,null]),a.equal(i.shift(),["added",{k:9,a:[{b:[[100,100],[1,1]]},{b:[150,150]}]},1,null]),c.insert({a:{b:[3,3]}}),a.length(i,1),a.equal(i.shift(),["added",{a:{b:[3,3]}},1,"x"]),k.stop()}),Tinytest.add("minimongo - fetch in observe",function(a){var b=new LocalCollection,c=!1,d=b.find().observeChanges({added:function(d,e){c=!0,a.equal(e,{foo:1});var f=b.findOne({foo:1});a.isTrue(f),a.equal(f.foo,1)}});a.isFalse(c);var e=Tracker.autorun(function(a){a.firstRun&&b.insert({foo:1})});a.isTrue(c),d.stop(),e.stop()}),Tinytest.add("minimongo - fine-grained reactivity of observe with fields projection",function(a){var b=new LocalCollection,c="asdf";b.insert({_id:c,foo:{bar:123}});var d=!1,e=b.find(c,{fields:{"foo.bar":1}}).observeChanges({changed:function(){d=!0}});a.isFalse(d),b.update(c,{$set:{"foo.baz":456}}),a.isFalse(d),e.stop()}),Tinytest.add("minimongo - fine-grained reactivity of query with fields projection",function(a){var b=new LocalCollection,c="asdf";b.insert({_id:c,foo:{bar:123}});var d=!1,e=Tracker.autorun(function(){return d=!0,b.findOne(c,{fields:{"foo.bar":1}})});a.isTrue(d),d=!1,b.update(c,{$set:{"foo.baz":456}}),a.isFalse(d),b.update(c,{$set:{"foo.bar":124}}),Tracker.flush(),a.isTrue(d),e.stop()}),running=!0,totalCount=0,passedCount=0,failedCount=0,failedTests=[],resultTree=[],Package={},reportResults=function(a){var b=_findTestForResults(a),c=_testStatus(b);if("failed"===c?failedCount--:"succeeded"===c&&passedCount--,_.isArray(a.events)){Array.prototype.push.apply(b.events||(b.events=[]),a.events),b.events.sort(function(a,b){return a.sequence-b.sequence});var d=[];_.each(b.events,function(a){(0===d.length||d[d.length-1].sequence!==a.sequence)&&d.push(a)}),b.events=d}c=_testStatus(b),"failed"===c?(failedCount++,void 0===b.expanded&&(b.expanded=!0),_.contains(failedTests,b.fullName)||failedTests.push(b.fullName)):"succeeded"===c?passedCount++:b.expanded};var _findTestForResults=function(a){var b=a.groupPath;if(!_.isArray(b)||b.length<1)throw new Error("Test must be part of a group");var c,d=0;_.each(b,function(a){var e=c?c.groups||(c.groups=[]):resultTree,f=_.find(e,function(b){return b.name===a});f||(f={name:a,parent:c||null,path:b.slice(0,d+1),dep:new Tracker.Dependency},e.push(f)),c=f,d++});var e=a.test,f=!!a.server,g=_.find(c.tests||(c.tests=[]),function(a){return a.name===e&&a.server===f});if(!g){var h=_.clone(b);h.push(e);var i=h.join(" - ");g={name:e,parent:c,server:f,fullName:i,dep:new Tracker.Dependency},c.tests.push(g),totalCount++}return g},_testTime=function(a){if(a.events&&a.events.length>0){var b=_.last(a.events);if("finish"===b.type&&"number"==typeof b.timeMs)return b.timeMs}return null},_testStatus=function(a){var b=a.events||[];return _.find(b,function(a){return"exception"===a.type})?"failed":0==b.length||"finish"!=_.last(b).type?"running":_.any(b,function(a){return"fail"==a.type||"exception"==a.type})?"failed":"succeeded"};