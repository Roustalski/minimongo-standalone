!function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(){LocalCollection._diffQueryChanges=function(a,b,c,d,e){a?LocalCollection._diffQueryOrderedChanges(b,c,d,e):LocalCollection._diffQueryUnorderedChanges(b,c,d,e)},LocalCollection._diffQueryUnorderedChanges=function(a,b,c,d){d=d||{};var e=d.projectionFn||EJSON.clone;if(c.movedBefore)throw new Error("_diffQueryUnordered called with a movedBefore observer!");b.forEach(function(b,d){var f=a.get(d);if(f){if(c.changed&&!EJSON.equals(f,b)){var g=e(b),h=e(f),i=LocalCollection._makeChangedFields(g,h);_.isEmpty(i)||c.changed(d,i)}}else if(c.added){var j=e(b);delete j._id,c.added(b._id,j)}}),c.removed&&a.forEach(function(a,d){b.has(d)||c.removed(d)})},LocalCollection._diffQueryOrderedChanges=function(a,b,c,d){d=d||{};var e=d.projectionFn||EJSON.clone,f={};_.each(b,function(a){f[a._id]&&Meteor._debug("Duplicate _id in new_results"),f[a._id]=!0});var g={};_.each(a,function(a,b){a._id in g&&Meteor._debug("Duplicate _id in old_results"),g[a._id]=b});for(var h=[],i=0,j=b.length,k=new Array(j),l=new Array(j),m=function(a){return g[b[a]._id]},n=0;j>n;n++)if(void 0!==g[b[n]._id]){for(var o=i;o>0&&!(m(k[o-1])<m(n));)o--;l[n]=0===o?-1:k[o-1],k[o]=n,o+1>i&&(i=o+1)}for(var p=0===i?-1:k[i-1];p>=0;)h.push(p),p=l[p];h.reverse(),h.push(b.length),_.each(a,function(a){f[a._id]||c.removed&&c.removed(a._id)});var q=0;_.each(h,function(d){for(var f,h,i,j,k,l=b[d]?b[d]._id:null,m=q;d>m;m++)h=b[m],_.has(g,h._id)?(f=a[g[h._id]],j=e(h),k=e(f),i=LocalCollection._makeChangedFields(j,k),_.isEmpty(i)||c.changed&&c.changed(h._id,i),c.movedBefore&&c.movedBefore(h._id,l)):(i=e(h),delete i._id,c.addedBefore&&c.addedBefore(h._id,i,l),c.added&&c.added(h._id,i));l&&(h=b[d],f=a[g[h._id]],j=e(h),k=e(f),i=LocalCollection._makeChangedFields(j,k),_.isEmpty(i)||c.changed&&c.changed(h._id,i)),q=d+1})},LocalCollection._diffObjects=function(a,b,c){_.each(a,function(a,d){_.has(b,d)?c.both&&c.both(d,a,b[d]):c.leftOnly&&c.leftOnly(d,a)}),c.rightOnly&&_.each(b,function(b,d){_.has(a,d)||c.rightOnly(d,b)})}},{}],2:[function(){isArray=function(a){return _.isArray(a)&&!EJSON.isBinary(a)},isPlainObject=LocalCollection._isPlainObject=function(a){return a&&3===LocalCollection._f._type(a)},isIndexable=function(a){return isArray(a)||isPlainObject(a)},isOperatorObject=function(a,b){if(!isPlainObject(a))return!1;var c=void 0;return _.each(a,function(d,e){var f="$"===e.substr(0,1);if(void 0===c)c=f;else if(c!==f){if(!b)throw new Error("Inconsistent operator: "+JSON.stringify(a));c=!1}}),!!c},isNumericKey=function(a){return/^[0-9]+$/.test(a)}},{}],3:[function(){LocalCollection._IdMap=function(){var a=this;IdMap.call(a,LocalCollection._idStringify,LocalCollection._idParse)},Meteor._inherits(LocalCollection._IdMap,IdMap)},{}],4:[function(){LocalCollection=function(a){var b=this;b.name=a,b._docs=new LocalCollection._IdMap,b._observeQueue=new Meteor._SynchronousQueue,b.next_qid=1,b.queries={},b._savedOriginals=null,b.paused=!1},Minimongo={},MinimongoTest={},LocalCollection._applyChanges=function(a,b){_.each(b,function(b,c){void 0===b?delete a[c]:a[c]=b})},MinimongoError=function(a){var b=new Error(a);return b.name="MinimongoError",b},LocalCollection.prototype.find=function(a,b){return 0===arguments.length&&(a={}),new LocalCollection.Cursor(this,a,b)},LocalCollection.Cursor=function(a,b,c){var d=this;c||(c={}),d.collection=a,d.sorter=null,LocalCollection._selectorIsId(b)?(d._selectorId=b,d.matcher=new Minimongo.Matcher(b)):(d._selectorId=void 0,d.matcher=new Minimongo.Matcher(b),(d.matcher.hasGeoQuery()||c.sort)&&(d.sorter=new Minimongo.Sorter(c.sort||[],{matcher:d.matcher}))),d.skip=c.skip,d.limit=c.limit,d.fields=c.fields,d._projectionFn=LocalCollection._compileProjection(d.fields||{}),d._transform=LocalCollection.wrapTransform(c.transform),"undefined"!=typeof Tracker&&(d.reactive=void 0===c.reactive?!0:c.reactive)},LocalCollection.Cursor.prototype.rewind=function(){},LocalCollection.prototype.findOne=function(a,b){return 0===arguments.length&&(a={}),b=b||{},b.limit=1,this.find(a,b).fetch()[0]},LocalCollection.Cursor.prototype.forEach=function(a,b){var c=this,d=c._getRawObjects({ordered:!0});c.reactive&&c._depend({addedBefore:!0,removed:!0,changed:!0,movedBefore:!0}),_.each(d,function(d,e){d=c._projectionFn(d),c._transform&&(d=c._transform(d)),a.call(b,d,e,c)})},LocalCollection.Cursor.prototype.getTransform=function(){return this._transform},LocalCollection.Cursor.prototype.map=function(a,b){var c=this,d=[];return c.forEach(function(e,f){d.push(a.call(b,e,f,c))}),d},LocalCollection.Cursor.prototype.fetch=function(){var a=this,b=[];return a.forEach(function(a){b.push(a)}),b},LocalCollection.Cursor.prototype.count=function(){var a=this;return a.reactive&&a._depend({added:!0,removed:!0},!0),a._getRawObjects({ordered:!0}).length},LocalCollection.Cursor.prototype._publishCursor=function(a){var b=this;if(!b.collection.name)throw new Error("Can't publish a cursor from a collection without a name.");var c=b.collection.name;return Mongo.Collection._publishCursor(b,a,c)},LocalCollection.Cursor.prototype._getCollectionName=function(){var a=this;return a.collection.name},LocalCollection._observeChangesCallbacksAreOrdered=function(a){if(a.added&&a.addedBefore)throw new Error("Please specify only one of added() and addedBefore()");return!(!a.addedBefore&&!a.movedBefore)},LocalCollection._observeCallbacksAreOrdered=function(a){if(a.addedAt&&a.added)throw new Error("Please specify only one of added() and addedAt()");if(a.changedAt&&a.changed)throw new Error("Please specify only one of changed() and changedAt()");if(a.removed&&a.removedAt)throw new Error("Please specify only one of removed() and removedAt()");return!!(a.addedAt||a.movedTo||a.changedAt||a.removedAt)},LocalCollection.ObserveHandle=function(){},_.extend(LocalCollection.Cursor.prototype,{observe:function(a){var b=this;return LocalCollection._observeFromObserveChanges(b,a)},observeChanges:function(a){var b=this,c=LocalCollection._observeChangesCallbacksAreOrdered(a);if(!a._allow_unordered&&!c&&(b.skip||b.limit))throw new Error("must use ordered observe (ie, 'addedBefore' instead of 'added') with skip or limit");if(b.fields&&(0===b.fields._id||b.fields._id===!1))throw Error("You may not observe a cursor with {fields: {_id: 0}}");var d,e={matcher:b.matcher,sorter:c&&b.sorter,distances:b.matcher.hasGeoQuery()&&c&&new LocalCollection._IdMap,resultsSnapshot:null,ordered:c,cursor:b,projectionFn:b._projectionFn};b.reactive&&(d=b.collection.next_qid++,b.collection.queries[d]=e),e.results=b._getRawObjects({ordered:c,distances:e.distances}),b.collection.paused&&(e.resultsSnapshot=c?[]:new LocalCollection._IdMap);var f=function(a){return a?function(){var c=this,d=arguments;b.collection.paused||b.collection._observeQueue.queueTask(function(){a.apply(c,d)})}:function(){}};if(e.added=f(a.added),e.changed=f(a.changed),e.removed=f(a.removed),c&&(e.addedBefore=f(a.addedBefore),e.movedBefore=f(a.movedBefore)),!a._suppress_initial&&!b.collection.paused){var g=c?_.bind(_.each,null,e.results):_.bind(e.results.forEach,e.results);g(function(a){var d=EJSON.clone(a);delete d._id,c&&e.addedBefore(a._id,b._projectionFn(d),null),e.added(a._id,b._projectionFn(d))})}var h=new LocalCollection.ObserveHandle;return _.extend(h,{collection:b.collection,stop:function(){b.reactive&&delete b.collection.queries[d]}}),b.reactive&&Tracker.active&&Tracker.onInvalidate(function(){h.stop()}),b.collection._observeQueue.drain(),h}}),LocalCollection.Cursor.prototype._getRawObjects=function(a){var b=this;a=a||{};var c=a.ordered?[]:new LocalCollection._IdMap;if(void 0!==b._selectorId){if(b.skip)return c;var d=b.collection._docs.get(b._selectorId);return d&&(a.ordered?c.push(d):c.set(b._selectorId,d)),c}var e;if(b.matcher.hasGeoQuery()&&a.ordered&&(a.distances?(e=a.distances,e.clear()):e=new LocalCollection._IdMap),b.collection._docs.forEach(function(d,f){var g=b.matcher.documentMatches(d);return g.result&&(a.ordered?(c.push(d),e&&void 0!==g.distance&&e.set(f,g.distance)):c.set(f,d)),!b.limit||b.skip||b.sorter||c.length!==b.limit?!0:!1}),!a.ordered)return c;if(b.sorter){var f=b.sorter.getComparator({distances:e});c.sort(f)}var g=b.skip||0,h=b.limit?b.limit+g:c.length;return c.slice(g,h)},LocalCollection.Cursor.prototype._depend=function(a,b){var c=this;if(Tracker.active){var d=new Tracker.Dependency;d.depend();var e=_.bind(d.changed,d),f={_suppress_initial:!0,_allow_unordered:b};_.each(["added","changed","removed","addedBefore","movedBefore"],function(b){a[b]&&(f[b]=e)}),c.observeChanges(f)}},LocalCollection.prototype.insert=function(a,b){var c=this;a=EJSON.clone(a),_.has(a,"_id")||(a._id=LocalCollection._useOID?new LocalCollection._ObjectID:Random.id());var d=a._id;if(c._docs.has(d))throw MinimongoError("Duplicate _id '"+d+"'");c._saveOriginal(d,void 0),c._docs.set(d,a);var e=[];for(var f in c.queries){var g=c.queries[f],h=g.matcher.documentMatches(a);h.result&&(g.distances&&void 0!==h.distance&&g.distances.set(d,h.distance),g.cursor.skip||g.cursor.limit?e.push(f):LocalCollection._insertInResults(g,a))}return _.each(e,function(a){c.queries[a]&&c._recomputeResults(c.queries[a])}),c._observeQueue.drain(),b&&Meteor.defer(function(){b(null,d)}),d},LocalCollection.prototype._eachPossiblyMatchingDoc=function(a,b){var c=this,d=LocalCollection._idsMatchedBySelector(a);if(d)for(var e=0;e<d.length;++e){var f=d[e],g=c._docs.get(f);if(g){var h=b(g,f);if(h===!1)break}}else c._docs.forEach(b)},LocalCollection.prototype.remove=function(a,b){var c=this;if(c.paused&&!c._savedOriginals&&EJSON.equals(a,{})){var d=c._docs.size();return c._docs.clear(),_.each(c.queries,function(a){a.ordered?a.results=[]:a.results.clear()}),b&&Meteor.defer(function(){b(null,d)}),d}var e=new Minimongo.Matcher(a),f=[];c._eachPossiblyMatchingDoc(a,function(a,b){e.documentMatches(a).result&&f.push(b)});for(var g=[],h=[],i=0;i<f.length;i++){var j=f[i],k=c._docs.get(j);_.each(c.queries,function(a,b){a.matcher.documentMatches(k).result&&(a.cursor.skip||a.cursor.limit?g.push(b):h.push({qid:b,doc:k}))}),c._saveOriginal(j,k),c._docs.remove(j)}return _.each(h,function(a){var b=c.queries[a.qid];b&&(b.distances&&b.distances.remove(a.doc._id),LocalCollection._removeFromResults(b,a.doc))}),_.each(g,function(a){var b=c.queries[a];b&&c._recomputeResults(b)}),c._observeQueue.drain(),d=f.length,b&&Meteor.defer(function(){b(null,d)}),d},LocalCollection.prototype.update=function(a,b,c,d){var e=this;!d&&c instanceof Function&&(d=c,c=null),c||(c={});var f=new Minimongo.Matcher(a),g={};_.each(e.queries,function(a,b){!a.cursor.skip&&!a.cursor.limit||e.paused||(g[b]=EJSON.clone(a.results))});var h={},i=0;e._eachPossiblyMatchingDoc(a,function(a,d){var g=f.documentMatches(a);return g.result&&(e._saveOriginal(d,a),e._modifyAndNotify(a,b,h,g.arrayIndices),++i,!c.multi)?!1:!0}),_.each(h,function(a,b){var c=e.queries[b];c&&e._recomputeResults(c,g[b])}),e._observeQueue.drain();var j;if(0===i&&c.upsert){var k=LocalCollection._removeDollarOperators(a);LocalCollection._modify(k,b,{isInsert:!0}),!k._id&&c.insertedId&&(k._id=c.insertedId),j=e.insert(k),i=1}var l;return c._returnObject?(l={numberAffected:i},void 0!==j&&(l.insertedId=j)):l=i,d&&Meteor.defer(function(){d(null,l)}),l},LocalCollection.prototype.upsert=function(a,b,c,d){var e=this;return d||"function"!=typeof c||(d=c,c={}),e.update(a,b,_.extend({},c,{upsert:!0,_returnObject:!0}),d)},LocalCollection.prototype._modifyAndNotify=function(a,b,c,d){var e=this,f={};for(var g in e.queries){var h=e.queries[g];f[g]=h.ordered?h.matcher.documentMatches(a).result:h.results.has(a._id)}var i=EJSON.clone(a);LocalCollection._modify(a,b,{arrayIndices:d});for(g in e.queries){h=e.queries[g];var j=f[g],k=h.matcher.documentMatches(a),l=k.result;l&&h.distances&&void 0!==k.distance&&h.distances.set(a._id,k.distance),h.cursor.skip||h.cursor.limit?(j||l)&&(c[g]=!0):j&&!l?LocalCollection._removeFromResults(h,a):!j&&l?LocalCollection._insertInResults(h,a):j&&l&&LocalCollection._updateInResults(h,a,i)}},LocalCollection._insertInResults=function(a,b){var c=EJSON.clone(b);if(delete c._id,a.ordered){if(a.sorter){var d=LocalCollection._insertInSortedList(a.sorter.getComparator({distances:a.distances}),a.results,b),e=a.results[d+1];e=e?e._id:null,a.addedBefore(b._id,a.projectionFn(c),e)}else a.addedBefore(b._id,a.projectionFn(c),null),a.results.push(b);a.added(b._id,a.projectionFn(c))}else a.added(b._id,a.projectionFn(c)),a.results.set(b._id,b)},LocalCollection._removeFromResults=function(a,b){if(a.ordered){var c=LocalCollection._findInOrderedResults(a,b);a.removed(b._id),a.results.splice(c,1)}else{var d=b._id;a.removed(b._id),a.results.remove(d)}},LocalCollection._updateInResults=function(a,b,c){if(!EJSON.equals(b._id,c._id))throw new Error("Can't change a doc's _id while updating");var d=a.projectionFn,e=LocalCollection._makeChangedFields(d(b),d(c));if(!a.ordered)return void(_.isEmpty(e)||(a.changed(b._id,e),a.results.set(b._id,b)));var f=LocalCollection._findInOrderedResults(a,b);if(_.isEmpty(e)||a.changed(b._id,e),a.sorter){a.results.splice(f,1);var g=LocalCollection._insertInSortedList(a.sorter.getComparator({distances:a.distances}),a.results,b);if(f!==g){var h=a.results[g+1];h=h?h._id:null,a.movedBefore&&a.movedBefore(b._id,h)}}},LocalCollection.prototype._recomputeResults=function(a,b){var c=this;c.paused||b||(b=a.results),a.distances&&a.distances.clear(),a.results=a.cursor._getRawObjects({ordered:a.ordered,distances:a.distances}),c.paused||LocalCollection._diffQueryChanges(a.ordered,b,a.results,a,{projectionFn:a.projectionFn})},LocalCollection._findInOrderedResults=function(a,b){if(!a.ordered)throw new Error("Can't call _findInOrderedResults on unordered query");for(var c=0;c<a.results.length;c++)if(a.results[c]===b)return c;throw Error("object missing from query")},LocalCollection._binarySearch=function(a,b,c){for(var d=0,e=b.length;e>0;){var f=Math.floor(e/2);a(c,b[d+f])>=0?(d+=f+1,e-=f+1):e=f}return d},LocalCollection._insertInSortedList=function(a,b,c){if(0===b.length)return b.push(c),0;var d=LocalCollection._binarySearch(a,b,c);return b.splice(d,0,c),d},LocalCollection.prototype.saveOriginals=function(){var a=this;if(a._savedOriginals)throw new Error("Called saveOriginals twice without retrieveOriginals");a._savedOriginals=new LocalCollection._IdMap},LocalCollection.prototype.retrieveOriginals=function(){var a=this;if(!a._savedOriginals)throw new Error("Called retrieveOriginals without saveOriginals");var b=a._savedOriginals;return a._savedOriginals=null,b},LocalCollection.prototype._saveOriginal=function(a,b){var c=this;c._savedOriginals&&(c._savedOriginals.has(a)||c._savedOriginals.set(a,EJSON.clone(b)))},LocalCollection.prototype.pauseObservers=function(){if(!this.paused){this.paused=!0;for(var a in this.queries){var b=this.queries[a];b.resultsSnapshot=EJSON.clone(b.results)}}},LocalCollection.prototype.resumeObservers=function(){var a=this;if(this.paused){this.paused=!1;for(var b in this.queries){var c=a.queries[b];LocalCollection._diffQueryChanges(c.ordered,c.resultsSnapshot,c.results,c,{projectionFn:c.projectionFn}),c.resultsSnapshot=null}a._observeQueue.drain()}},LocalCollection._idStringify=function(a){if(a instanceof LocalCollection._ObjectID)return a.valueOf();if("string"==typeof a)return""===a?a:"-"===a.substr(0,1)||"~"===a.substr(0,1)||LocalCollection._looksLikeObjectID(a)||"{"===a.substr(0,1)?"-"+a:a;if(void 0===a)return"-";if("object"==typeof a&&null!==a)throw new Error("Meteor does not currently support objects other than ObjectID as ids");return"~"+JSON.stringify(a)},LocalCollection._idParse=function(a){return""===a?a:"-"===a?void 0:"-"===a.substr(0,1)?a.substr(1):"~"===a.substr(0,1)?JSON.parse(a.substr(1)):LocalCollection._looksLikeObjectID(a)?new LocalCollection._ObjectID(a):a},LocalCollection._makeChangedFields=function(a,b){var c={};return LocalCollection._diffObjects(b,a,{leftOnly:function(a){c[a]=void 0},rightOnly:function(a,b){c[a]=b},both:function(a,b,d){EJSON.equals(b,d)||(c[a]=d)}}),c}},{}],5:[function(){Tinytest.add("minimongo - modifier affects selector",function(a){function b(b,c,d){var e=new Minimongo.Matcher(b);a.equal(e._getPaths(),c,d)}function c(b,c,d,e){var f=new Minimongo.Matcher(b);a.equal(f.affectedByModifier(c),d,e)}function d(a,b,d){c(a,b,!0,d)}function e(a,b,d){c(a,b,!1,d)}b({foo:{bar:3,baz:42}},["foo"],"literal"),b({foo:42,bar:33},["foo","bar"],"literal"),b({foo:["something"],bar:"asdf"},["foo","bar"],"literal"),b({a:{$lt:3},b:"you know, literal","path.is.complicated":{$not:{$regex:"acme.*corp"}}},["a","b","path.is.complicated"],"literal + operators"),b({$or:[{"a.b":1},{"a.b.c":{$lt:22}},{$and:[{"x.d":{$ne:5,$gte:433}},{"a.b":234}]}]},["a.b","a.b.c","x.d"],"group operators + duplicates"),b({a:{foo:1,bar:2},"b.c":{literal:"object",but:"we still observe any changes in 'b.c'"}},["a","b.c"],"literal object"),b({$or:[{x:{$elemMatch:{a:5}}},{y:{$elemMatch:{b:7}}}]},["x","y"],"$or and elemMatch"),e({foo:0},{$set:{bar:1}},"simplest"),d({foo:0},{$set:{foo:1}},"simplest"),d({foo:0},{$set:{"foo.bar":1}},"simplest"),e({"foo.bar":0},{$set:{"foo.baz":1}},"simplest"),d({"foo.bar":0},{$set:{"foo.1":1}},"simplest"),d({"foo.bar":0},{$set:{"foo.2.bar":1}},"simplest"),e({foo:0},{$set:{foobaz:1}},"correct prefix check"),e({foobar:0},{$unset:{foo:1}},"correct prefix check"),e({"foo.bar":0},{$unset:{foob:1}},"correct prefix check"),e({"foo.Infinity.x":0},{$unset:{"foo.x":1}},"we convert integer fields correctly"),e({"foo.1e3.x":0},{$unset:{"foo.x":1}},"we convert integer fields correctly"),d({"foo.3.bar":0},{$set:{"foo.3.bar":1}},"observe for an array element"),e({"foo.4.bar.baz":0},{$unset:{"foo.3.bar":1}},"delicate work with numeric fields in selector"),e({"foo.4.bar.baz":0},{$unset:{"foo.bar":1}},"delicate work with numeric fields in selector"),d({"foo.4.bar.baz":0},{$unset:{"foo.4.bar":1}},"delicate work with numeric fields in selector"),d({"foo.bar.baz":0},{$unset:{"foo.3.bar":1}},"delicate work with numeric fields in selector"),d({"foo.0.bar":0},{$set:{"foo.0.0.bar":1}},"delicate work with nested arrays and selectors by indecies"),d({foo:{$elemMatch:{bar:5}}},{$set:{"foo.4.bar":5}},"$elemMatch")}),Tinytest.add("minimongo - selector and projection combination",function(a){function b(b,c,d,e){var f=new Minimongo.Matcher(b);a.equal(f.combineIntoProjection(c),d,e)}b({a:1,b:2},{b:1,c:1,d:1},{a:!0,b:!0,c:!0,d:!0},"simplest incl"),b({$or:[{a:1234,e:{$lt:5}}],b:2},{b:1,c:1,d:1},{a:!0,b:!0,c:!0,d:!0,e:!0},"simplest incl, branching"),b({"a.b":{$lt:3},"y.0":-1,"a.c":15},{d:1,z:1},{"a.b":!0,y:!0,"a.c":!0,d:!0,z:!0},"multikey paths in selector - incl"),b({foo:1234,$and:[{k:-1},{$or:[{b:15}]}]},{"foo.bar":1,"foo.zzz":1,"b.asdf":1},{foo:!0,b:!0,k:!0},"multikey paths in fields - incl"),b({"a.b.c":123,"a.b.d":321,"b.c.0":111,"a.e":12345},{"a.b.z":1,"a.b.d.g":1,"c.c.c":1},{"a.b.c":!0,"a.b.d":!0,"a.b.z":!0,"b.c":!0,"a.e":!0,"c.c.c":!0},"multikey both paths - incl"),b({"a.b.c.d":123,"a.b1.c.d":421,"a.b.c.e":111},{"a.b":1},{"a.b":!0,"a.b1.c.d":!0},"shadowing one another - incl"),b({"a.b":123,"foo.bar":!1},{"a.b.c.d":1,foo:1},{"a.b":!0,foo:!0},"shadowing one another - incl"),b({"a.b.c":1},{"a.b.c":1},{"a.b.c":!0},"same paths - incl"),b({"x.4.y":42,"z.0.1":33},{"x.x":1},{"x.x":!0,"x.y":!0,z:!0},"numbered keys in selector - incl"),b({"a.b.c":42,$where:function(){return!0}},{"a.b":1,"z.z":1},{},"$where in the selector - incl"),b({$or:[{"a.b.c":42},{$where:function(){return!0}}]},{"a.b":1,"z.z":1},{},"$where in the selector - incl"),b({a:1,b:2},{b:0,c:0,d:0},{c:!1,d:!1},"simplest excl"),b({$or:[{a:1234,e:{$lt:5}}],b:2},{b:0,c:0,d:0},{c:!1,d:!1},"simplest excl, branching"),b({"a.b":{$lt:3},"y.0":-1,"a.c":15},{d:0,z:0},{d:!1,z:!1},"multikey paths in selector - excl"),b({foo:1234,$and:[{k:-1},{$or:[{b:15}]}]},{"foo.bar":0,"foo.zzz":0,"b.asdf":0},{},"multikey paths in fields - excl"),b({"a.b.c":123,"a.b.d":321,"b.c.0":111,"a.e":12345},{"a.b.z":0,"a.b.d.g":0,"c.c.c":0},{"a.b.z":!1,"c.c.c":!1},"multikey both paths - excl"),b({"a.b.c.d":123,"a.b1.c.d":421,"a.b.c.e":111},{"a.b":0},{},"shadowing one another - excl"),b({"a.b":123,"foo.bar":!1},{"a.b.c.d":0,foo:0},{},"shadowing one another - excl"),b({"a.b.c":1},{"a.b.c":0},{},"same paths - excl"),b({"a.b":123,"a.c.d":222,ddd:123},{"a.b":0,"a.c.e":0,asdf:0},{"a.c.e":!1,asdf:!1},"intercept the selector path - excl"),b({"a.b.c":14},{"a.b.d":0},{"a.b.d":!1},"different branches - excl"),b({"a.b.c.d":"124","foo.bar.baz.que":"some value"},{"a.b.c.d.e":0,"foo.bar":0},{},"excl on incl paths - excl"),b({"x.4.y":42,"z.0.1":33},{"x.x":0,"x.y":0},{"x.x":!1},"numbered keys in selector - excl"),b({"a.b.c":42,$where:function(){return!0}},{"a.b":0,"z.z":0},{},"$where in the selector - excl"),b({$or:[{"a.b.c":42},{$where:function(){return!0}}]},{"a.b":0,"z.z":0},{},"$where in the selector - excl")}),Tinytest.add("minimongo - sorter and projection combination",function(a){function b(b,c,d,e){var f=new Minimongo.Sorter(b);a.equal(f.combineIntoProjection(c),d,e)}b({a:1,b:1},{b:1,c:1,d:1},{a:!0,b:!0,c:!0,d:!0},"simplest incl"),b({a:1,b:-1},{b:1,c:1,d:1},{a:!0,b:!0,c:!0,d:!0},"simplest incl"),b({"a.c":1},{b:1},{"a.c":!0,b:!0},"dot path incl"),b({"a.1.c":1},{b:1},{"a.c":!0,b:!0},"dot num path incl"),b({"a.1.c":1},{b:1,a:1},{a:!0,b:!0},"dot num path incl overlap"),b({"a.1.c":1,"a.2.b":-1},{b:1},{"a.c":!0,"a.b":!0,b:!0},"dot num path incl"),b({"a.1.c":1,"a.2.b":-1},{},{},"dot num path with empty incl"),b({a:1,b:1},{b:0,c:0,d:0},{c:!1,d:!1},"simplest excl"),b({a:1,b:-1},{b:0,c:0,d:0},{c:!1,d:!1},"simplest excl"),b({"a.c":1},{b:0},{b:!1},"dot path excl"),b({"a.1.c":1},{b:0},{b:!1},"dot num path excl"),b({"a.1.c":1},{b:0,a:0},{b:!1},"dot num path excl overlap"),b({"a.1.c":1,"a.2.b":-1},{b:0},{b:!1},"dot num path excl")}),function(){function a(a,b,c){d(a,b,!0,c)}function b(a,b,c){d(a,b,!1,c)}var c=null,d=function(a,b,d,e){var f=new Minimongo.Matcher(a);c.equal(f.canBecomeTrueByModifier(b),d,e)};Tinytest.add("minimongo - can selector become true by modifier - literals (structured tests)",function(d){c=d;var e={"a.b.c":2,"foo.bar":{z:{y:1}},"foo.baz":[{ans:42},"string",!1,void 0],"empty.field":null};a(e,{$set:{"a.b.c":2}}),b(e,{$unset:{a:1}}),b(e,{$unset:{"a.b":1}}),b(e,{$unset:{"a.b.c":1}}),a(e,{$set:{"a.b":{c:2}}}),b(e,{$set:{"a.b":{}}}),a(e,{$set:{"a.b":{c:2,x:5}}}),b(e,{$set:{"a.b.c.k":3}}),b(e,{$set:{"a.b.c.k":{}}}),b(e,{$unset:{foo:1}}),b(e,{$unset:{"foo.bar":1}}),b(e,{$unset:{"foo.bar.z":1}}),b(e,{$unset:{"foo.bar.z.y":1}}),b(e,{$set:{"foo.bar.x":1}}),b(e,{$set:{"foo.bar":{}}}),b(e,{$set:{"foo.bar":3}}),a(e,{$set:{"foo.bar":{z:{y:1}}}}),a(e,{$set:{"foo.bar.z":{y:1}}}),a(e,{$set:{"foo.bar.z.y":1}}),b(e,{$set:{"empty.field":{}}}),a(e,{$set:{empty:{}}}),a(e,{$set:{"empty.field":null}}),a(e,{$set:{"empty.field":void 0}}),b(e,{$set:{"empty.field.a":3}})}),Tinytest.add("minimongo - can selector become true by modifier - literals (adhoc tests)",function(d){c=d,a({x:1},{$set:{x:1}},"simple set scalar"),a({x:"a"},{$set:{x:"a"}},"simple set scalar"),a({x:!1},{$set:{x:!1}},"simple set scalar"),b({x:!0},{$set:{x:!1}},"simple set scalar"),b({x:2},{$set:{x:3}},"simple set scalar"),b({"foo.bar.baz":1,x:1},{$unset:{"foo.bar.baz":1},$set:{x:1}},"simple unset of the interesting path"),b({"foo.bar.baz":1,x:1},{$unset:{"foo.bar":1},$set:{x:1}},"simple unset of the interesting path prefix"),b({"foo.bar.baz":1,x:1},{$unset:{foo:1},$set:{x:1}},"simple unset of the interesting path prefix"),b({"foo.bar.baz":1},{$unset:{"foo.baz":1}},"simple unset of the interesting path prefix"),b({"foo.bar.baz":1},{$unset:{"foo.bar.bar":1}},"simple unset of the interesting path prefix")}),Tinytest.add("minimongo - can selector become true by modifier - regexps",function(b){c=b,a({"foo.bar":/^[0-9]+$/i},{$set:{"foo.bar":"01233"}},"set of regexp"),a({"foo.bar":/^[0-9]+$/i,x:1},{$set:{"foo.bar":"0a1233",x:1}},"set of regexp"),a({"foo.bar":/^[0-9]+$/i,x:1},{$unset:{"foo.bar":1},$set:{x:1}},"unset of regexp"),a({"foo.bar":/^[0-9]+$/i,x:1},{$set:{x:1}},"don't touch regexp")}),Tinytest.add("minimongo - can selector become true by modifier - undefined/null",function(d){c=d,a({"foo.bar":null},{$set:{"foo.bar":null}},"set of null looking for null"),a({"foo.bar":null},{$set:{"foo.bar":void 0}},"set of undefined looking for null"),a({"foo.bar":void 0},{$set:{"foo.bar":null}},"set of null looking for undefined"),a({"foo.bar":void 0},{$set:{"foo.bar":void 0}},"set of undefined looking for undefined"),a({"foo.bar":null},{$set:{foo:null}},"set of null of parent path looking for null"),b({"foo.bar":null},{$set:{"foo.bar.baz":null}},"set of null of different path looking for null"),a({"foo.bar":null},{$unset:{foo:1}},"unset the parent"),a({"foo.bar":null},{$unset:{"foo.bar":1}},"unset tracked path"),a({"foo.bar":null},{$set:{foo:3}},"set the parent"),a({"foo.bar":null},{$set:{foo:{baz:1}}},"set the parent")}),Tinytest.add("minimongo - can selector become true by modifier - literals with arrays",function(d){c=d,a({"a.1.b":1,x:1},{$unset:{"a.1.b":1},$set:{x:1}},"unset of array element's field with exactly the same index as selector"),b({"a.2.b":1},{$unset:{"a.1.b":1}},"unset of array element's field with different index as selector"),b({"a.2.b":1},{$unset:{"a.b":1}},"unset of field while selector is looking for index"),a({"foo.bar":null},{$set:{"foo.1.bar":null}},"set array's element's field to null looking for null"),a({"foo.bar":null},{$set:{"foo.0.bar":1,"foo.1.bar":null}},"set array's element's field to null looking for null"),a({"a.b":1},{$unset:{"a.1.b":1}},"unset of array element's field")}),Tinytest.add("minimongo - can selector become true by modifier - set an object literal whose fields are selected",function(d){c=d,a({"a.b.c":1},{$set:{"a.b":{c:1}}},"a simple scalar selector and simple set"),b({"a.b.c":1},{$set:{"a.b":{c:2}}},"a simple scalar selector and simple set to false"),b({"a.b.c":1},{$set:{"a.b":{d:1}}},"a simple scalar selector and simple set a wrong literal"),b({"a.b.c":1},{$set:{"a.b":222}},"a simple scalar selector and simple set a wrong type")}),Tinytest.add("minimongo - can selector become true by modifier - $-scalar selectors and simple tests",function(d){c=d,a({"a.b.c":{$lt:5}},{$set:{"a.b":{c:4}}},"nested $lt"),b({"a.b.c":{$lt:5}},{$set:{"a.b":{c:5}}},"nested $lt"),b({"a.b.c":{$lt:5}},{$set:{"a.b":{c:6}}},"nested $lt"),b({"a.b.c":{$lt:5}},{$set:{"a.b.d":7}},"nested $lt, the change doesn't matter"),b({"a.b.c":{$lt:5}},{$set:{"a.b":{d:7}}},"nested $lt, the key disappears"),a({"a.b.c":{$lt:5}},{$set:{"a.b":{d:7,c:-1}}},"nested $lt"),b({a:{$lt:10,$gt:3}},{$unset:{a:1}},"unset $lt"),a({a:{$lt:10,$gt:3}},{$set:{a:4}},"set between x and y"),b({a:{$lt:10,$gt:3}},{$set:{a:3}},"set between x and y"),b({a:{$lt:10,$gt:3}},{$set:{a:10}},"set between x and y"),b({a:{$gt:10,$lt:3}},{$set:{a:9}},"impossible statement"),a({a:{$lte:10,$gte:3}},{$set:{a:3}},"set between x and y"),a({a:{$lte:10,$gte:3}},{$set:{a:10}},"set between x and y"),b({a:{$lte:10,$gte:3}},{$set:{a:-10}},"set between x and y"),a({a:{$lte:10,$gte:3,$gt:3,$lt:10}},{$set:{a:4}},"set between x and y"),b({a:{$lte:10,$gte:3,$gt:3,$lt:10}},{$set:{a:3}},"set between x and y"),b({a:{$lte:10,$gte:3,$gt:3,$lt:10}},{$set:{a:10}},"set between x and y"),b({a:{$lte:10,$gte:3,$gt:3,$lt:10}},{$set:{a:1/0}},"set between x and y"),a({a:{$lte:10,$gte:3,$gt:3,$lt:10},x:1},{$set:{x:1}},"set between x and y - dummy"),b({a:{$lte:10,$gte:13,$gt:3,$lt:9},x:1},{$set:{x:1}},"set between x and y - dummy - impossible"),b({a:{$lte:10}},{$set:{a:1/0}},"Infinity <= 10?"),a({a:{$lte:10}},{$set:{a:-(1/0)}},"-Infinity <= 10?"),a({a:{$gt:9.99999999999999,$lt:10},x:1},{$set:{x:1}},"very close $gt and $lt"),a({a:{$gt:9.999999999999998,$lt:10},x:1},{$set:{x:1}},"very close $gt and $lt"),a({a:{$ne:5}},{$unset:{a:1}},"unset of $ne"),a({a:{$ne:5}},{$set:{a:1}},"set of $ne"),a({a:{$ne:"some string"},x:1},{$set:{x:1}},"$ne dummy"),a({a:{$ne:!0},x:1},{$set:{x:1}},"$ne dummy"),a({a:{$ne:!1},x:1},{$set:{x:1}},"$ne dummy"),a({a:{$ne:null},x:1},{$set:{x:1}},"$ne dummy"),a({a:{$ne:1/0},x:1},{$set:{x:1}},"$ne dummy"),a({a:{$ne:5}},{$set:{a:-10}},"set of $ne"),a({a:{$in:[1,3,5,7]}},{$set:{a:5}},"$in checks"),b({a:{$in:[1,3,5,7]}},{$set:{a:-5}},"$in checks"),a({a:{$in:[1,3,5,7],$gt:6},x:1},{$set:{x:1}},"$in combination with $gt"),b({a:{$lte:10,$gte:3}},{$set:{"a.b":-10}},"sel between x and y, set its subfield"),b({b:{$in:[1,3,5,7]}},{$set:{"b.c":2}},"sel $in, set subfield"),a({b:{$in:[1,3,5,7]}},{$set:{"bd.c":2,b:3}},"sel $in, set similar subfield"),b({"b.c":{$in:[1,3,5,7]}},{$set:{b:2}},"sel subfield of set scalar"),b({"a.b":{$gt:5,$lt:7},x:1},{$set:{"a.b.c":3,x:1}},"set sub-field of $gt,$lt operator (scalar expected)"),b({"a.b":{$gt:5,$lt:7},x:1},{$set:{x:1},$unset:{"a.b.c":1}},"unset sub-field of $gt,$lt operator (scalar expected)")}),Tinytest.add("minimongo - can selector become true by modifier - $-nonscalar selectors and simple tests",function(b){c=b,a({a:{$ne:{x:5}}},{$set:{"a.x":3}},"set of $ne"),a({a:{$ne:{x:5}}},{$set:{"a.x":5}},"set of $ne"),a({a:{$in:[{b:1},{b:3}]}},{$set:{a:{b:3}}},"$in checks"),a({a:{$in:[{b:1},{b:3}]}},{$set:{a:{v:3}}},"$in checks"),a({a:{$ne:{a:2}},x:1},{$set:{x:1}},"$ne dummy"),a({a:{$ne:{a:2}}},{$set:{a:{a:2}}},"$ne object")})}()},{}],6:[function(){LocalCollection._useOID=!0;var a=function(a,b,c){for(var d=0;d<c.length;d++){var e=b(c[d],c[d]);if(0!==e&&a.fail({type:"minimongo-ordering",message:"value doesn't order as equal to itself",value:JSON.stringify(c[d]),should_be_zero_but_got:JSON.stringify(e)}),d+1<c.length){var f=c[d],g=c[d+1],e=b(f,g);0>e||a.fail({type:"minimongo-ordering",message:"ordering test failed",first:JSON.stringify(f),second:JSON.stringify(g),should_be_negative_but_got:JSON.stringify(e)}),e=b(g,f),e>0||a.fail({type:"minimongo-ordering",message:"ordering test failed",first:JSON.stringify(f),second:JSON.stringify(g),should_be_positive_but_got:JSON.stringify(e)})}}},b=function(a){return{addedAt:function(b,c,d){delete b._id,a.push(EJSON.clone(["added",b,c,d]))},changedAt:function(b,c,d){delete b._id,delete c._id,a.push(EJSON.clone(["changed",b,d,c]))},movedTo:function(b,c,d,e){delete b._id,a.push(EJSON.clone(["moved",b,c,d,e]))},removedAt:function(b,c){var d=b._id;delete b._id,a.push(EJSON.clone(["removed",d,c,b]))}}};Tinytest.add("minimongo - basics",function(a){var b,c,d=new LocalCollection;b=d.insert({type:"kitten",name:"fluffy"}),d.insert({type:"kitten",name:"snookums"}),d.insert({type:"cryptographer",name:"alice"}),d.insert({type:"cryptographer",name:"bob"}),d.insert({type:"cryptographer",name:"cara"}),a.equal(d.find().count(),5),a.equal(d.find({type:"kitten"}).count(),2),a.equal(d.find({type:"cryptographer"}).count(),3),a.length(d.find({type:"kitten"}).fetch(),2),a.length(d.find({type:"cryptographer"}).fetch(),3),a.equal(b,d.findOne({type:"kitten",name:"fluffy"})._id),d.remove({name:"cara"}),a.equal(d.find().count(),4),a.equal(d.find({type:"kitten"}).count(),2),a.equal(d.find({type:"cryptographer"}).count(),2),a.length(d.find({type:"kitten"}).fetch(),2),a.length(d.find({type:"cryptographer"}).fetch(),2),c=d.update({name:"snookums"},{$set:{type:"cryptographer"}}),a.equal(c,1),a.equal(d.find().count(),4),a.equal(d.find({type:"kitten"}).count(),1),a.equal(d.find({type:"cryptographer"}).count(),3),a.length(d.find({type:"kitten"}).fetch(),1),a.length(d.find({type:"cryptographer"}).fetch(),3),d.remove(null),d.remove(!1),d.remove(void 0),a.equal(d.find().count(),4),d.remove({_id:null}),d.remove({_id:!1}),d.remove({_id:void 0}),c=d.remove(),a.equal(c,0),a.equal(d.find().count(),4),c=d.remove({}),a.equal(c,4),a.equal(d.find().count(),0),d.insert({_id:1,name:"strawberry",tags:["fruit","red","squishy"]}),d.insert({_id:2,name:"apple",
tags:["fruit","red","hard"]}),d.insert({_id:3,name:"rose",tags:["flower","red","squishy"]}),a.equal(d.find({tags:"flower"}).count(),1),a.equal(d.find({tags:"fruit"}).count(),2),a.equal(d.find({tags:"red"}).count(),3),a.length(d.find({tags:"flower"}).fetch(),1),a.length(d.find({tags:"fruit"}).fetch(),2),a.length(d.find({tags:"red"}).fetch(),3),a.equal(d.findOne(1).name,"strawberry"),a.equal(d.findOne(2).name,"apple"),a.equal(d.findOne(3).name,"rose"),a.equal(d.findOne(4),void 0),a.equal(d.findOne("abc"),void 0),a.equal(d.findOne(void 0),void 0),a.equal(d.find(1).count(),1),a.equal(d.find(4).count(),0),a.equal(d.find("abc").count(),0),a.equal(d.find(void 0).count(),0),a.equal(d.find().count(),3),a.equal(d.find(1,{skip:1}).count(),0),a.equal(d.find({_id:1},{skip:1}).count(),0),a.equal(d.find({},{skip:1}).count(),2),a.equal(d.find({},{skip:2}).count(),1),a.equal(d.find({},{limit:2}).count(),2),a.equal(d.find({},{limit:1}).count(),1),a.equal(d.find({},{skip:1,limit:1}).count(),1),a.equal(d.find({tags:"fruit"},{skip:1}).count(),1),a.equal(d.find({tags:"fruit"},{limit:1}).count(),1),a.equal(d.find({tags:"fruit"},{skip:1,limit:1}).count(),1),a.equal(d.find(1,{sort:["_id","desc"],skip:1}).count(),0),a.equal(d.find({_id:1},{sort:["_id","desc"],skip:1}).count(),0),a.equal(d.find({},{sort:["_id","desc"],skip:1}).count(),2),a.equal(d.find({},{sort:["_id","desc"],skip:2}).count(),1),a.equal(d.find({},{sort:["_id","desc"],limit:2}).count(),2),a.equal(d.find({},{sort:["_id","desc"],limit:1}).count(),1),a.equal(d.find({},{sort:["_id","desc"],skip:1,limit:1}).count(),1),a.equal(d.find({tags:"fruit"},{sort:["_id","desc"],skip:1}).count(),1),a.equal(d.find({tags:"fruit"},{sort:["_id","desc"],limit:1}).count(),1),a.equal(d.find({tags:"fruit"},{sort:["_id","desc"],skip:1,limit:1}).count(),1),d.insert({foo:{bar:"baz"}}),a.equal(d.find({foo:{bam:"baz"}}).count(),0),a.equal(d.find({foo:{bar:"baz"}}).count(),1)}),Tinytest.add("minimongo - cursors",function(a){for(var b,c=new LocalCollection,d=0;20>d;d++)c.insert({i:d});var e=c.find();a.equal(e.count(),20),b=e.fetch(),a.length(b,20);for(var d=0;20>d;d++)a.equal(b[d].i,d);a.length(e.fetch(),20);var f=0,g={};e.forEach(function(b,c,d){a.equal(b.i,f++),a.equal(b.i,c),a.isTrue(g===this),a.isTrue(d===e)},g),a.equal(f,20),a.length(e.fetch(),20),b=e.map(function(b,c,d){return a.equal(b.i,c),a.isTrue(g===this),a.isTrue(d===e),2*b.i},g),a.length(b,20);for(var d=0;20>d;d++)a.equal(b[d],2*d);a.length(e.fetch(),20),a.equal(c.findOne({i:0}).i,0),a.equal(c.findOne({i:1}).i,1);var h=c.findOne({i:2})._id;a.equal(c.findOne(h).i,2)}),Tinytest.add("minimongo - transform",function(a){var b=new LocalCollection;b.insert({});var c=function(a){return a._id};a["throws"](function(){b.findOne({},{transform:c})});var d=function(a){return _.omit(a,"_id")};a.equal(b.findOne({},{transform:d})._id,b.findOne()._id)}),Tinytest.add("minimongo - misc",function(a){var b={a:[1,2,3],b:"x",c:!0,d:{x:12,y:[12]},f:null,g:new Date},c=EJSON.clone(b);a.equal(b,c),a.isTrue(LocalCollection._f._equal(b,c)),b.a.push(4),a.length(c.a,3),b.c=!1,a.isTrue(c.c),c.d.z=15,b.d.z=14,a.equal(c.d.z,15),b.d.y.push(88),a.length(c.d.y,1),a.equal(b.g,c.g),c.g.setDate(c.g.getDate()+1),a.notEqual(b.g,c.g),b={x:function(){}},c=EJSON.clone(b),b.x.a=14,a.equal(c.x.a,14)}),Tinytest.add("minimongo - lookup",function(a){var b=MinimongoTest.makeLookupFunction("a");a.equal(b({}),[{value:void 0}]),a.equal(b({a:1}),[{value:1}]),a.equal(b({a:[1]}),[{value:[1]}]);var c=MinimongoTest.makeLookupFunction("a.x");a.equal(c({a:{x:1}}),[{value:1}]),a.equal(c({a:{x:[1]}}),[{value:[1]}]),a.equal(c({a:5}),[{value:void 0}]),a.equal(c({a:[{x:1},{x:[2]},{y:3}]}),[{value:1,arrayIndices:[0]},{value:[2],arrayIndices:[1]},{value:void 0,arrayIndices:[2]}]);var d=MinimongoTest.makeLookupFunction("a.0.x");a.equal(d({a:[{x:1}]}),[{value:1,arrayIndices:[0,"x"]},{value:void 0,arrayIndices:[0]}]),a.equal(d({a:[{x:[1]}]}),[{value:[1],arrayIndices:[0,"x"]},{value:void 0,arrayIndices:[0]}]),a.equal(d({a:5}),[{value:void 0}]),a.equal(d({a:[{x:1},{x:[2]},{y:3}]}),[{value:1,arrayIndices:[0,"x"]},{value:void 0,arrayIndices:[0]},{value:void 0,arrayIndices:[1]},{value:void 0,arrayIndices:[2]}]),a.equal(MinimongoTest.makeLookupFunction("w.x.0.z")({w:[{x:[{z:5}]}]}),[{value:5,arrayIndices:[0,0,"x"]},{value:void 0,arrayIndices:[0,0]}])}),Tinytest.add("minimongo - selector_compiler",function(a){var b=function(b,c,d){var e=new Minimongo.Matcher(c).documentMatches(d).result;e!=b&&a.fail({message:"minimongo match failure: document "+(b?"should match, but doesn't":"shouldn't match, but does"),selector:JSON.stringify(c),document:JSON.stringify(d)})},c=_.bind(b,null,!0),d=_.bind(b,null,!1);c({},{}),c({},{a:12}),c(1,{_id:1,a:"foo"}),d(1,{_id:2,a:"foo"}),c("a",{_id:"a",a:"foo"}),d("a",{_id:"b",a:"foo"}),d(void 0,{}),d(void 0,{_id:"foo"}),d(!1,{_id:"foo"}),d(null,{_id:"foo"}),d({_id:void 0},{_id:"foo"}),d({_id:!1},{_id:"foo"}),d({_id:null},{_id:"foo"}),d({a:12},{}),c({a:12},{a:12}),c({a:12},{a:12,b:13}),c({a:12,b:13},{a:12,b:13}),c({a:12,b:13},{a:12,b:13,c:14}),d({a:12,b:13,c:14},{a:12,b:13}),d({a:12,b:13},{b:13,c:14}),c({a:12},{a:[12]}),c({a:12},{a:[11,12,13]}),d({a:12},{a:[11,13]}),c({a:12,b:13},{a:[11,12,13],b:[13,14,15]}),d({a:12,b:13},{a:[11,12,13],b:[14,15]});var e=new Date,f=new Date(e.getTime()+1e3);c({a:e},{a:e}),d({a:e},{a:f}),c({a:[1,2]},{a:[1,2]}),c({a:[1,2]},{a:[[1,2]]}),c({a:[1,2]},{a:[[3,4],[1,2]]}),d({a:[1,2]},{a:[3,4]}),d({a:[1,2]},{a:[[[1,2]]]}),c({a:{b:12}},{a:{b:12}}),d({a:{b:12,c:13}},{a:{b:12}}),d({a:{b:12}},{a:{b:12,c:13}}),c({a:{b:12,c:13}},{a:{b:12,c:13}}),d({a:{b:12,c:13}},{a:{c:13,b:12}}),d({a:{}},{a:{b:12}}),d({a:{b:12}},{a:{}}),c({a:{b:12,c:[13,!0,!1,2.2,"a",null,{d:14}]}},{a:{b:12,c:[13,!0,!1,2.2,"a",null,{d:14}]}}),c({a:{b:12}},{a:{b:12},k:99}),c({a:{b:12}},{a:[{b:12}]}),d({a:{b:12}},{a:[[{b:12}]]}),c({a:{b:12}},{a:[{b:11},{b:12},{b:13}]}),d({a:{b:12}},{a:[{b:11},{b:12,c:20},{b:13}]}),d({a:{b:12,c:20}},{a:[{b:11},{b:12},{c:20}]}),c({a:{b:12,c:20}},{a:[{b:11},{b:12,c:20},{b:13}]}),c({a:null},{a:null}),c({a:null},{b:12}),d({a:null},{a:12}),c({a:null},{a:[1,2,null,3]}),d({a:null},{a:[1,2,{},3]}),c({a:{$lt:10}},{a:9}),d({a:{$lt:10}},{a:10}),d({a:{$lt:10}},{a:11}),c({a:{$gt:10}},{a:11}),d({a:{$gt:10}},{a:10}),d({a:{$gt:10}},{a:9}),c({a:{$lte:10}},{a:9}),c({a:{$lte:10}},{a:10}),d({a:{$lte:10}},{a:11}),c({a:{$gte:10}},{a:11}),c({a:{$gte:10}},{a:10}),d({a:{$gte:10}},{a:9}),c({a:{$lt:10}},{a:[11,9,12]}),d({a:{$lt:10}},{a:[11,12]}),d({a:{$lt:"null"}},{a:null}),c({a:{$lt:{x:[2,3,4]}}},{a:{x:[1,3,4]}}),c({a:{$gt:{x:[2,3,4]}}},{a:{x:[3,3,4]}}),d({a:{$gt:{x:[2,3,4]}}},{a:{x:[1,3,4]}}),d({a:{$gt:{x:[2,3,4]}}},{a:{x:[2,3,4]}}),d({a:{$lt:{x:[2,3,4]}}},{a:{x:[2,3,4]}}),c({a:{$gte:{x:[2,3,4]}}},{a:{x:[2,3,4]}}),c({a:{$lte:{x:[2,3,4]}}},{a:{x:[2,3,4]}}),d({a:{$gt:[2,3]}},{a:[1,2]}),d({a:{$lt:11,$gt:9}},{a:8}),d({a:{$lt:11,$gt:9}},{a:9}),c({a:{$lt:11,$gt:9}},{a:10}),d({a:{$lt:11,$gt:9}},{a:11}),d({a:{$lt:11,$gt:9}},{a:12}),c({a:{$lt:11,$gt:9}},{a:[8,9,10,11,12]}),c({a:{$lt:11,$gt:9}},{a:[8,9,11,12]}),c({a:{$all:[1,2]}},{a:[1,2]}),d({a:{$all:[1,2,3]}},{a:[1,2]}),c({a:{$all:[1,2]}},{a:[3,2,1]}),c({a:{$all:[1,"x"]}},{a:[3,"x",1]}),d({a:{$all:["2"]}},{a:2}),d({a:{$all:[2]}},{a:"2"}),c({a:{$all:[[1,2],[1,3]]}},{a:[[1,3],[1,2],[1,4]]}),d({a:{$all:[[1,2],[1,3]]}},{a:[[1,4],[1,2],[1,4]]}),c({a:{$all:[2,2]}},{a:[2]}),d({a:{$all:[2,3]}},{a:[2,2]}),d({a:{$all:[1,2]}},{a:[[1,2]]}),d({a:{$all:[1,2]}},{}),d({a:{$all:[1,2]}},{a:{foo:"bar"}}),d({a:{$all:[]}},{a:[]}),d({a:{$all:[]}},{a:[5]}),c({a:{$all:[/i/,/e/i]}},{a:["foo","bEr","biz"]}),d({a:{$all:[/i/,/e/i]}},{a:["foo","bar","biz"]}),c({a:{$all:[{b:3}]}},{a:[{b:3}]}),d({a:{$all:[{b:3}]}},{a:[{b:3,k:4}]}),a["throws"](function(){c({a:{$all:[{$gt:4}]}},{})}),c({a:{$exists:!0}},{a:12}),d({a:{$exists:!0}},{b:12}),d({a:{$exists:!1}},{a:12}),c({a:{$exists:!1}},{b:12}),c({a:{$exists:!0}},{a:[]}),d({a:{$exists:!0}},{b:[]}),d({a:{$exists:!1}},{a:[]}),c({a:{$exists:!1}},{b:[]}),c({a:{$exists:!0}},{a:[1]}),d({a:{$exists:!0}},{b:[1]}),d({a:{$exists:!1}},{a:[1]}),c({a:{$exists:!1}},{b:[1]}),c({a:{$exists:1}},{a:5}),c({a:{$exists:0}},{b:5}),d({"a.x":{$exists:!1}},{a:[{},{x:5}]}),c({"a.x":{$exists:!0}},{a:[{},{x:5}]}),c({"a.x":{$exists:!0}},{a:[{},{x:5}]}),c({"a.x":{$exists:!0}},{a:{x:[]}}),c({"a.x":{$exists:!0}},{a:{x:null}}),c({a:{$mod:[10,1]}},{a:11}),d({a:{$mod:[10,1]}},{a:12}),c({a:{$mod:[10,1]}},{a:[10,11,12]}),d({a:{$mod:[10,1]}},{a:[10,12]}),_.each([5,[10],[10,1,2],"foo",{bar:1},[]],function(b){a["throws"](function(){c({a:{$mod:b}},{a:11})})}),c({a:{$ne:1}},{a:2}),d({a:{$ne:2}},{a:2}),c({a:{$ne:[1]}},{a:[2]}),d({a:{$ne:[1,2]}},{a:[1,2]}),d({a:{$ne:1}},{a:[1,2]}),d({a:{$ne:2}},{a:[1,2]}),c({a:{$ne:3}},{a:[1,2]}),d({"a.b":{$ne:1}},{a:[{b:1},{b:2}]}),d({"a.b":{$ne:2}},{a:[{b:1},{b:2}]}),c({"a.b":{$ne:3}},{a:[{b:1},{b:2}]}),d({a:{$ne:{x:1}}},{a:{x:1}}),c({a:{$ne:{x:1}}},{a:{x:2}}),c({a:{$ne:{x:1}}},{a:{x:1,y:2}}),c({"a.b":{$ne:5,$gt:6}},{a:[{b:2},{b:10}]}),d({"a.b":{$ne:5,$gt:6}},{a:[{b:2},{b:4}]}),d({"a.b":{$ne:5,$gt:6}},{a:[{b:2},{b:5}]}),d({"a.b":{$ne:5,$gt:6}},{a:[{b:10},{b:5}]}),c({a:{$ne:5,$gt:6}},{a:[2,10]}),d({a:{$ne:5,$gt:6}},{a:[2,4]}),d({a:{$ne:5,$gt:6}},{a:[2,5]}),d({a:{$ne:5,$gt:6}},{a:[10,5]}),c({a:{$in:[1,2,3]}},{a:2}),d({a:{$in:[1,2,3]}},{a:4}),c({a:{$in:[[1],[2],[3]]}},{a:[2]}),d({a:{$in:[[1],[2],[3]]}},{a:[4]}),c({a:{$in:[{b:1},{b:2},{b:3}]}},{a:{b:2}}),d({a:{$in:[{b:1},{b:2},{b:3}]}},{a:{b:4}}),c({a:{$in:[1,2,3]}},{a:[2]}),c({a:{$in:[{x:1},{x:2},{x:3}]}},{a:[{x:2}]}),c({a:{$in:[1,2,3]}},{a:[4,2]}),d({a:{$in:[1,2,3]}},{a:[4]}),c({a:{$in:["x",/foo/i]}},{a:"x"}),c({a:{$in:["x",/foo/i]}},{a:"fOo"}),c({a:{$in:["x",/foo/i]}},{a:["f","fOo"]}),d({a:{$in:["x",/foo/i]}},{a:["f","fOx"]}),c({a:{$in:[1,null]}},{}),c({"a.b":{$in:[1,null]}},{}),c({"a.b":{$in:[1,null]}},{a:{}}),c({"a.b":{$in:[1,null]}},{a:{b:null}}),d({"a.b":{$in:[1,null]}},{a:{b:5}}),d({"a.b":{$in:[1]}},{a:{b:null}}),d({"a.b":{$in:[1]}},{a:{}}),d({"a.b":{$in:[1,null]}},{a:[{b:5}]}),c({"a.b":{$in:[1,null]}},{a:[{b:5},{}]}),d({"a.b":{$in:[1,null]}},{a:[{b:5},[]]}),d({"a.b":{$in:[1,null]}},{a:[{b:5},5]}),d({a:{$nin:[1,2,3]}},{a:2}),c({a:{$nin:[1,2,3]}},{a:4}),d({a:{$nin:[[1],[2],[3]]}},{a:[2]}),c({a:{$nin:[[1],[2],[3]]}},{a:[4]}),d({a:{$nin:[{b:1},{b:2},{b:3}]}},{a:{b:2}}),c({a:{$nin:[{b:1},{b:2},{b:3}]}},{a:{b:4}}),d({a:{$nin:[1,2,3]}},{a:[2]}),d({a:{$nin:[{x:1},{x:2},{x:3}]}},{a:[{x:2}]}),d({a:{$nin:[1,2,3]}},{a:[4,2]}),d({"a.b":{$nin:[1,2,3]}},{a:[{b:4},{b:2}]}),c({a:{$nin:[1,2,3]}},{a:[4]}),c({"a.b":{$nin:[1,2,3]}},{a:[{b:4}]}),d({a:{$nin:["x",/foo/i]}},{a:"x"}),d({a:{$nin:["x",/foo/i]}},{a:"fOo"}),d({a:{$nin:["x",/foo/i]}},{a:["f","fOo"]}),c({a:{$nin:["x",/foo/i]}},{a:["f","fOx"]}),d({a:{$nin:[1,null]}},{}),d({"a.b":{$nin:[1,null]}},{}),d({"a.b":{$nin:[1,null]}},{a:{}}),d({"a.b":{$nin:[1,null]}},{a:{b:null}}),c({"a.b":{$nin:[1,null]}},{a:{b:5}}),c({"a.b":{$nin:[1]}},{a:{b:null}}),c({"a.b":{$nin:[1]}},{a:{}}),c({"a.b":{$nin:[1,null]}},{a:[{b:5}]}),d({"a.b":{$nin:[1,null]}},{a:[{b:5},{}]}),c({"a.b":{$nin:[1,null]}},{a:[{b:5},[]]}),c({"a.b":{$nin:[1,null]}},{a:[{b:5},5]}),c({a:{$size:0}},{a:[]}),c({a:{$size:1}},{a:[2]}),c({a:{$size:2}},{a:[2,2]}),d({a:{$size:0}},{a:[2]}),d({a:{$size:1}},{a:[]}),d({a:{$size:1}},{a:[2,2]}),d({a:{$size:0}},{a:"2"}),d({a:{$size:1}},{a:"2"}),d({a:{$size:2}},{a:"2"}),d({a:{$size:2}},{a:[[2,2]]}),c({a:{$type:1}},{a:1.1}),c({a:{$type:1}},{a:1}),d({a:{$type:1}},{a:"1"}),c({a:{$type:2}},{a:"1"}),d({a:{$type:2}},{a:1}),c({a:{$type:3}},{a:{}}),c({a:{$type:3}},{a:{b:2}}),d({a:{$type:3}},{a:[]}),d({a:{$type:3}},{a:[1]}),d({a:{$type:3}},{a:null}),c({a:{$type:5}},{a:EJSON.newBinary(0)}),c({a:{$type:5}},{a:EJSON.newBinary(4)}),d({a:{$type:5}},{a:[]}),d({a:{$type:5}},{a:[42]}),c({a:{$type:7}},{a:new LocalCollection._ObjectID}),d({a:{$type:7}},{a:"1234567890abcd1234567890"}),c({a:{$type:8}},{a:!0}),c({a:{$type:8}},{a:!1}),d({a:{$type:8}},{a:"true"}),d({a:{$type:8}},{a:0}),d({a:{$type:8}},{a:null}),d({a:{$type:8}},{a:""}),d({a:{$type:8}},{}),c({a:{$type:9}},{a:new Date}),d({a:{$type:9}},{a:+new Date}),c({a:{$type:10}},{a:null}),d({a:{$type:10}},{a:!1}),d({a:{$type:10}},{a:""}),d({a:{$type:10}},{a:0}),d({a:{$type:10}},{}),c({a:{$type:11}},{a:/x/}),d({a:{$type:11}},{a:"x"}),d({a:{$type:11}},{}),d({a:{$type:4}},{a:[]}),d({a:{$type:4}},{a:[1]}),c({a:{$type:1}},{a:[1]}),d({a:{$type:2}},{a:[1]}),c({a:{$type:1}},{a:["1",1]}),c({a:{$type:2}},{a:["1",1]}),d({a:{$type:3}},{a:["1",1]}),d({a:{$type:4}},{a:["1",1]}),d({a:{$type:1}},{a:["1",[]]}),c({a:{$type:2}},{a:["1",[]]}),c({a:{$type:4}},{a:["1",[]]}),c({"a.0":{$type:4}},{a:[[0]]}),d({"a.0":{$type:1}},{a:[[0]]}),c({a:/a/},{a:"cat"}),d({a:/a/},{a:"cut"}),d({a:/a/},{a:"CAT"}),c({a:/a/i},{a:"CAT"}),c({a:/a/},{a:["foo","bar"]}),d({a:/,/},{a:["foo","bar"]}),c({a:{$regex:"a"}},{a:["foo","bar"]}),d({a:{$regex:","}},{a:["foo","bar"]}),c({a:{$regex:/a/}},{a:"cat"}),d({a:{$regex:/a/}},{a:"cut"}),d({a:{$regex:/a/}},{a:"CAT"}),c({a:{$regex:/a/i}},{a:"CAT"}),c({a:{$regex:/a/,$options:"i"}},{a:"CAT"}),c({a:{$regex:/a/i,$options:"i"}},{a:"CAT"}),d({a:{$regex:/a/i,$options:""}},{a:"CAT"}),c({a:{$regex:"a"}},{a:"cat"}),d({a:{$regex:"a"}},{a:"cut"}),d({a:{$regex:"a"}},{a:"CAT"}),c({a:{$regex:"a",$options:"i"}},{a:"CAT"}),c({a:{$regex:"",$options:"i"}},{a:"foo"}),d({a:{$regex:"",$options:"i"}},{}),d({a:{$regex:"",$options:"i"}},{a:5}),d({a:/undefined/},{}),d({a:{$regex:"undefined"}},{}),d({a:/xxx/},{}),d({a:{$regex:"xxx"}},{});var g=/sh/gi;c({a:g},{a:"Shorts"}),c({a:g},{a:"Shorts"}),c({a:g},{a:"Shorts"}),c({a:{$regex:g}},{a:"Shorts"}),c({a:{$regex:g}},{a:"Shorts"}),c({a:{$regex:g}},{a:"Shorts"}),a["throws"](function(){c({a:{$options:"i"}},{a:12})}),c({a:/a/},{a:["dog","cat"]}),d({a:/a/},{a:["dog","puppy"]}),c({a:/a/},{a:/a/}),c({a:/a/},{a:["x",/a/]}),d({a:/a/},{a:/a/i}),d({a:/a/m},{a:/a/}),d({a:/a/},{a:/b/}),d({a:/5/},{a:5}),d({a:/t/},{a:!0}),c({a:/m/i},{a:["x","xM"]}),a["throws"](function(){c({a:{$regex:/a/,$options:"x"}},{a:"cat"})}),a["throws"](function(){c({a:{$regex:/a/,$options:"s"}},{a:"cat"})}),c({x:{$not:{$gt:7}}},{x:6}),d({x:{$not:{$gt:7}}},{x:8}),c({x:{$not:{$lt:10,$gt:7}}},{x:11}),d({x:{$not:{$lt:10,$gt:7}}},{x:9}),c({x:{$not:{$lt:10,$gt:7}}},{x:6}),c({x:{$not:{$gt:7}}},{x:[2,3,4]}),c({"x.y":{$not:{$gt:7}}},{x:[{y:2},{y:3},{y:4}]}),d({x:{$not:{$gt:7}}},{x:[2,3,4,10]}),d({"x.y":{$not:{$gt:7}}},{x:[{y:2},{y:3},{y:4},{y:10}]}),c({x:{$not:/a/}},{x:"dog"}),d({x:{$not:/a/}},{x:"cat"}),c({x:{$not:/a/}},{x:["dog","puppy"]}),d({x:{$not:/a/}},{x:["kitten","cat"]}),c({"a.b":1},{a:{b:1}}),d({"a.b":1},{a:{b:2}}),c({"a.b":[1,2,3]},{a:{b:[1,2,3]}}),d({"a.b":[1,2,3]},{a:{b:[4]}}),c({"a.b":/a/},{a:{b:"cat"}}),d({"a.b":/a/},{a:{b:"dog"}}),c({"a.b.c":null},{}),c({"a.b.c":null},{a:1}),c({"a.b":null},{a:1}),c({"a.b.c":null},{a:{b:4}}),d({"a.b":null},{a:[1]}),c({"a.b":[]},{a:{b:[]}});var h={a:[{b:1},2,{},{b:[3,4]}]};c({"a.b":1},h),c({"a.b":[3,4]},h),c({"a.b":3},h),c({"a.b":4},h),c({"a.b":null},h),c({"a.1":8},{a:[7,8,9]}),d({"a.1":7},{a:[7,8,9]}),d({"a.1":null},{a:[7,8,9]}),c({"a.1":[8,9]},{a:[7,[8,9]]}),d({"a.1":6},{a:[[6,7],[8,9]]}),d({"a.1":7},{a:[[6,7],[8,9]]}),d({"a.1":8},{a:[[6,7],[8,9]]}),d({"a.1":9},{a:[[6,7],[8,9]]}),c({"a.1":2},{a:[0,{1:2},3]}),c({"a.1":{1:2}},{a:[0,{1:2},3]}),c({"x.1.y":8},{x:[7,{y:8},9]}),c({"x.1.y":null},{x:[7,{y:8},9]}),c({"a.1.b":9},{a:[7,{b:9},{1:{b:"foo"}}]}),c({"a.1.b":"foo"},{a:[7,{b:9},{1:{b:"foo"}}]}),c({"a.1.b":null},{a:[7,{b:9},{1:{b:"foo"}}]}),c({"a.1.b":2},{a:[1,[{b:2}],3]}),d({"a.1.b":null},{a:[1,[{b:2}],3]}),d({"a.0.b":null},{a:[5]}),c({"a.1":4},{a:[{1:4},5]}),c({"a.1":5},{a:[{1:4},5]}),d({"a.1":null},{a:[{1:4},5]}),c({"a.1.foo":4},{a:[{1:{foo:4}},{foo:5}]}),c({"a.1.foo":5},{a:[{1:{foo:4}},{foo:5}]}),c({"a.1.foo":null},{a:[{1:{foo:4}},{foo:5}]}),d({"a.b":1},{x:2}),d({"a.b.c":1},{a:{x:2}}),d({"a.b.c":1},{a:{b:{x:2}}}),d({"a.b.c":1},{a:{b:1}}),d({"a.b.c":1},{a:{b:0}}),c({"a.b":{c:1}},{a:{b:{c:1}}}),d({"a.b":{c:1}},{a:{b:{c:2}}}),d({"a.b":{c:1}},{a:{b:2}}),c({"a.b":{c:1,d:2}},{a:{b:{c:1,d:2}}}),d({"a.b":{c:1,d:2}},{a:{b:{c:1,d:1}}}),d({"a.b":{c:1,d:2}},{a:{b:{d:2}}}),c({"a.b":{$in:[1,2,3]}},{a:{b:[2]}}),c({"a.b":{$in:[{x:1},{x:2},{x:3}]}},{a:{b:[{x:2}]}}),c({"a.b":{$in:[1,2,3]}},{a:{b:[4,2]}}),d({"a.b":{$in:[1,2,3]}},{a:{b:[4]}}),a["throws"](function(){c({$or:[]},{})}),a["throws"](function(){c({$or:[5]},{})}),a["throws"](function(){c({$or:[]},{a:1})}),c({$or:[{a:1}]},{a:1}),d({$or:[{b:2}]},{a:1}),c({$or:[{a:1},{b:2}]},{a:1}),d({$or:[{c:3},{d:4}]},{a:1}),c({$or:[{a:1},{b:2}]},{a:[1,2,3]}),d({$or:[{a:1},{b:2}]},{c:[1,2,3]}),d({$or:[{a:1},{b:2}]},{a:[2,3,4]}),c({$or:[{a:1},{a:2}]},{a:1}),c({$or:[{a:1},{a:2}],b:2},{a:1,b:2}),d({$or:[{a:2},{a:3}],b:2},{a:1,b:2}),d({$or:[{a:1},{a:2}],b:3},{a:1,b:2}),c({x:1,$or:[{a:1},{b:1}]},{x:1,b:1}),c({$or:[{a:1},{b:1}],x:1},{x:1,b:1}),d({x:1,$or:[{a:1},{b:1}]},{b:1}),d({x:1,$or:[{a:1},{b:1}]},{x:1}),c({$or:[{a:{$lte:1}},{a:2}]},{a:1}),d({$or:[{a:{$lt:1}},{a:2}]},{a:1}),c({$or:[{a:{$gte:1}},{a:2}]},{a:1}),d({$or:[{a:{$gt:1}},{a:2}]},{a:1}),c({$or:[{b:{$gt:1}},{b:{$lt:3}}]},{b:2}),d({$or:[{b:{$lt:1}},{b:{$gt:3}}]},{b:2}),c({$or:[{a:{$in:[1,2,3]}}]},{a:1}),d({$or:[{a:{$in:[4,5,6]}}]},{a:1}),c({$or:[{a:{$in:[1,2,3]}},{b:2}]},{a:1}),c({$or:[{a:{$in:[1,2,3]}},{b:2}]},{b:2}),d({$or:[{a:{$in:[1,2,3]}},{b:2}]},{c:3}),c({$or:[{a:{$in:[1,2,3]}},{b:{$in:[1,2,3]}}]},{b:2}),d({$or:[{a:{$in:[1,2,3]}},{b:{$in:[4,5,6]}}]},{b:2}),d({$or:[{a:{$nin:[1,2,3]}}]},{a:1}),c({$or:[{a:{$nin:[4,5,6]}}]},{a:1}),d({$or:[{a:{$nin:[1,2,3]}},{b:2}]},{a:1}),c({$or:[{a:{$nin:[1,2,3]}},{b:2}]},{b:2}),c({$or:[{a:{$nin:[1,2,3]}},{b:2}]},{c:3}),c({$or:[{a:{$nin:[1,2,3]}},{b:{$nin:[1,2,3]}}]},{b:2}),d({$or:[{a:{$nin:[1,2,3]}},{b:{$nin:[1,2,3]}}]},{a:1,b:2}),c({$or:[{a:{$nin:[1,2,3]}},{b:{$nin:[4,5,6]}}]},{b:2}),c({$or:[{"a.b":1},{"a.b":2}]},{a:{b:1}}),c({$or:[{"a.b":1},{"a.c":1}]},{a:{b:1}}),d({$or:[{"a.b":2},{"a.c":1}]},{a:{b:1}}),c({$or:[{a:{b:1,c:2}},{a:{b:2,c:1}}]},{a:{b:1,c:2}}),d({$or:[{a:{b:1,c:3}},{a:{b:2,c:1}}]},{a:{b:1,c:2}}),c({$or:[{a:/a/}]},{a:"cat"}),d({$or:[{a:/o/}]},{a:"cat"}),c({$or:[{a:/a/},{a:/o/}]},{a:"cat"}),d({$or:[{a:/i/},{a:/o/}]},{a:"cat"}),c({$or:[{a:/i/},{b:/o/}]},{a:"cat",b:"dog"}),c({$or:[{a:{$ne:1}}]},{}),d({$or:[{a:{$ne:1}}]},{a:1}),c({$or:[{a:{$ne:1}}]},{a:2}),c({$or:[{a:{$ne:1}}]},{b:1}),c({$or:[{a:{$ne:1}},{a:{$ne:2}}]},{a:1}),c({$or:[{a:{$ne:1}},{b:{$ne:1}}]},{a:1}),d({$or:[{a:{$ne:1}},{b:{$ne:2}}]},{a:1,b:2}),c({$or:[{a:{$not:{$mod:[10,1]}}}]},{}),d({$or:[{a:{$not:{$mod:[10,1]}}}]},{a:1}),c({$or:[{a:{$not:{$mod:[10,1]}}}]},{a:2}),c({$or:[{a:{$not:{$mod:[10,1]}}},{a:{$not:{$mod:[10,2]}}}]},{a:1}),d({$or:[{a:{$not:{$mod:[10,1]}}},{a:{$mod:[10,2]}}]},{a:1}),c({$or:[{a:{$not:{$mod:[10,1]}}},{a:{$mod:[10,2]}}]},{a:2}),c({$or:[{a:{$not:{$mod:[10,1]}}},{a:{$mod:[10,2]}}]},{a:3}),a["throws"](function(){c({$nor:[]},{})}),a["throws"](function(){c({$nor:[5]},{})}),a["throws"](function(){c({$nor:[]},{a:1})}),d({$nor:[{a:1}]},{a:1}),c({$nor:[{b:2}]},{a:1}),d({$nor:[{a:1},{b:2}]},{a:1}),c({$nor:[{c:3},{d:4}]},{a:1}),d({$nor:[{a:1},{b:2}]},{a:[1,2,3]}),c({$nor:[{a:1},{b:2}]},{c:[1,2,3]}),c({$nor:[{a:1},{b:2}]},{a:[2,3,4]}),d({$nor:[{a:1},{a:2}]},{a:1}),d({$nor:[{a:{$lte:1}},{a:2}]},{a:1}),c({$nor:[{a:{$lt:1}},{a:2}]},{a:1}),d({$nor:[{a:{$gte:1}},{a:2}]},{a:1}),c({$nor:[{a:{$gt:1}},{a:2}]},{a:1}),d({$nor:[{b:{$gt:1}},{b:{$lt:3}}]},{b:2}),c({$nor:[{b:{$lt:1}},{b:{$gt:3}}]},{b:2}),d({$nor:[{a:{$in:[1,2,3]}}]},{a:1}),c({$nor:[{a:{$in:[4,5,6]}}]},{a:1}),d({$nor:[{a:{$in:[1,2,3]}},{b:2}]},{a:1}),d({$nor:[{a:{$in:[1,2,3]}},{b:2}]},{b:2}),c({$nor:[{a:{$in:[1,2,3]}},{b:2}]},{c:3}),d({$nor:[{a:{$in:[1,2,3]}},{b:{$in:[1,2,3]}}]},{b:2}),c({$nor:[{a:{$in:[1,2,3]}},{b:{$in:[4,5,6]}}]},{b:2}),c({$nor:[{a:{$nin:[1,2,3]}}]},{a:1}),d({$nor:[{a:{$nin:[4,5,6]}}]},{a:1}),c({$nor:[{a:{$nin:[1,2,3]}},{b:2}]},{a:1}),d({$nor:[{a:{$nin:[1,2,3]}},{b:2}]},{b:2}),d({$nor:[{a:{$nin:[1,2,3]}},{b:2}]},{c:3}),d({$nor:[{a:{$nin:[1,2,3]}},{b:{$nin:[1,2,3]}}]},{b:2}),c({$nor:[{a:{$nin:[1,2,3]}},{b:{$nin:[1,2,3]}}]},{a:1,b:2}),d({$nor:[{a:{$nin:[1,2,3]}},{b:{$nin:[4,5,6]}}]},{b:2}),d({$nor:[{"a.b":1},{"a.b":2}]},{a:{b:1}}),d({$nor:[{"a.b":1},{"a.c":1}]},{a:{b:1}}),c({$nor:[{"a.b":2},{"a.c":1}]},{a:{b:1}}),d({$nor:[{a:{b:1,c:2}},{a:{b:2,c:1}}]},{a:{b:1,c:2}}),c({$nor:[{a:{b:1,c:3}},{a:{b:2,c:1}}]},{a:{b:1,c:2}}),d({$nor:[{a:/a/}]},{a:"cat"}),c({$nor:[{a:/o/}]},{a:"cat"}),d({$nor:[{a:/a/},{a:/o/}]},{a:"cat"}),c({$nor:[{a:/i/},{a:/o/}]},{a:"cat"}),d({$nor:[{a:/i/},{b:/o/}]},{a:"cat",b:"dog"}),d({$nor:[{a:{$ne:1}}]},{}),c({$nor:[{a:{$ne:1}}]},{a:1}),d({$nor:[{a:{$ne:1}}]},{a:2}),d({$nor:[{a:{$ne:1}}]},{b:1}),d({$nor:[{a:{$ne:1}},{a:{$ne:2}}]},{a:1}),d({$nor:[{a:{$ne:1}},{b:{$ne:1}}]},{a:1}),c({$nor:[{a:{$ne:1}},{b:{$ne:2}}]},{a:1,b:2}),d({$nor:[{a:{$not:{$mod:[10,1]}}}]},{}),c({$nor:[{a:{$not:{$mod:[10,1]}}}]},{a:1}),d({$nor:[{a:{$not:{$mod:[10,1]}}}]},{a:2}),d({$nor:[{a:{$not:{$mod:[10,1]}}},{a:{$not:{$mod:[10,2]}}}]},{a:1}),c({$nor:[{a:{$not:{$mod:[10,1]}}},{a:{$mod:[10,2]}}]},{a:1}),d({$nor:[{a:{$not:{$mod:[10,1]}}},{a:{$mod:[10,2]}}]},{a:2}),d({$nor:[{a:{$not:{$mod:[10,1]}}},{a:{$mod:[10,2]}}]},{a:3}),a["throws"](function(){c({$and:[]},{})}),a["throws"](function(){c({$and:[5]},{})}),a["throws"](function(){c({$and:[]},{a:1})}),c({$and:[{a:1}]},{a:1}),d({$and:[{a:1},{a:2}]},{a:1}),d({$and:[{a:1},{b:1}]},{a:1}),c({$and:[{a:1},{b:2}]},{a:1,b:2}),d({$and:[{a:1},{b:1}]},{a:1,b:2}),c({$and:[{a:1},{b:2}],c:3},{a:1,b:2,c:3}),d({$and:[{a:1},{b:2}],c:4},{a:1,b:2,c:3}),c({$and:[{a:/a/}]},{a:"cat"}),c({$and:[{a:/a/i}]},{a:"CAT"}),d({$and:[{a:/o/}]},{a:"cat"}),d({$and:[{a:/a/},{a:/o/}]},{a:"cat"}),c({$and:[{a:/a/},{b:/o/}]},{a:"cat",b:"dog"}),d({$and:[{a:/a/},{b:/a/}]},{a:"cat",b:"dog"}),c({$and:[{"a.b":1}]},{a:{b:1}}),c({$and:[{a:{b:1}}]},{a:{b:1}}),d({$and:[{"a.b":2}]},{a:{b:1}}),d({$and:[{"a.c":1}]},{a:{b:1}}),d({$and:[{"a.b":1},{"a.b":2}]},{a:{b:1}}),d({$and:[{"a.b":1},{a:{b:2}}]},{a:{b:1}}),c({$and:[{"a.b":1},{"c.d":2}]},{a:{b:1},c:{d:2}}),d({$and:[{"a.b":1},{"c.d":1}]},{a:{b:1},c:{d:2}}),c({$and:[{"a.b":1},{c:{d:2}}]},{a:{b:1},c:{d:2}}),d({$and:[{"a.b":1},{c:{d:1}}]},{a:{b:1},c:{d:2}}),d({$and:[{"a.b":2},{c:{d:2}}]},{a:{b:1},c:{d:2}}),c({$and:[{a:{b:1}},{c:{d:2}}]},{a:{b:1},c:{d:2}}),d({$and:[{a:{b:2}},{c:{d:2}}]},{a:{b:1},c:{d:2}}),d({$and:[{a:{$in:[]}}]},{}),c({$and:[{a:{$in:[1,2,3]}}]},{a:1}),d({$and:[{a:{$in:[4,5,6]}}]},{a:1}),d({$and:[{a:{$in:[1,2,3]}},{a:{$in:[4,5,6]}}]},{a:1}),d({$and:[{a:{$in:[1,2,3]}},{b:{$in:[1,2,3]}}]},{a:1,b:4}),c({$and:[{a:{$in:[1,2,3]}},{b:{$in:[4,5,6]}}]},{a:1,b:4}),c({$and:[{a:{$nin:[]}}]},{}),d({$and:[{a:{$nin:[1,2,3]}}]},{a:1}),c({$and:[{a:{$nin:[4,5,6]}}]},{a:1}),d({$and:[{a:{$nin:[1,2,3]}},{a:{$nin:[4,5,6]}}]},{a:1}),d({$and:[{a:{$nin:[1,2,3]}},{b:{$nin:[1,2,3]}}]},{a:1,b:4}),d({$and:[{a:{$nin:[1,2,3]}},{b:{$nin:[4,5,6]}}]},{a:1,b:4}),c({$and:[{a:{$lt:2}}]},{a:1}),d({$and:[{a:{$lt:1}}]},{a:1}),c({$and:[{a:{$lte:1}}]},{a:1}),c({$and:[{a:{$gt:0}}]},{a:1}),d({$and:[{a:{$gt:1}}]},{a:1}),c({$and:[{a:{$gte:1}}]},{a:1}),c({$and:[{a:{$gt:0}},{a:{$lt:2}}]},{a:1}),d({$and:[{a:{$gt:1}},{a:{$lt:2}}]},{a:1}),d({$and:[{a:{$gt:0}},{a:{$lt:1}}]},{a:1}),c({$and:[{a:{$gte:1}},{a:{$lte:1}}]},{a:1}),d({$and:[{a:{$gte:2}},{a:{$lte:0}}]},{a:1}),c({$and:[{a:{$ne:1}}]},{}),d({$and:[{a:{$ne:1}}]},{a:1}),c({$and:[{a:{$ne:1}}]},{a:2}),d({$and:[{a:{$ne:1}},{a:{$ne:2}}]},{a:2}),c({$and:[{a:{$ne:1}},{a:{$ne:3}}]},{a:2}),c({$and:[{a:{$not:{$gt:2}}}]},{a:1}),d({$and:[{a:{$not:{$lt:2}}}]},{a:1}),c({$and:[{a:{$not:{$lt:0}}},{a:{$not:{$gt:2}}}]},{a:1}),d({$and:[{a:{$not:{$lt:2}}},{a:{$not:{$gt:0}}}]},{a:1}),c({$where:"this.a === 1"},{a:1}),c({$where:"obj.a === 1"},{a:1}),d({$where:"this.a !== 1"},{a:1}),d({$where:"obj.a !== 1"},{a:1}),d({$where:"this.a === 1",a:2},{a:1}),c({$where:"this.a === 1",b:2},{a:1,b:2}),c({$where:"this.a === 1 && this.b === 2"},{a:1,b:2}),c({$where:"this.a instanceof Array"},{a:[]}),d({$where:"this.a instanceof Array"},{a:1}),c({"dogs.0.name":"Fido"},{dogs:[{name:"Fido"},{name:"Rex"}]}),c({"dogs.1.name":"Rex"},{dogs:[{name:"Fido"},{name:"Rex"}]}),d({"dogs.1.name":"Fido"},{dogs:[{name:"Fido"},{name:"Rex"}]}),c({"room.1b":"bla"},{room:{"1b":"bla"}}),c({"dogs.name":"Fido"},{dogs:[{name:"Fido"},{name:"Rex"}]}),c({"dogs.name":"Rex"},{dogs:[{name:"Fido"},{name:"Rex"}]}),c({"animals.dogs.name":"Fido"},{animals:[{dogs:[{name:"Rover"}]},{},{dogs:[{name:"Fido"},{name:"Rex"}]}]}),c({"animals.dogs.name":"Fido"},{animals:[{dogs:{name:"Rex"}},{dogs:{name:"Fido"}}]}),c({"animals.dogs.name":"Fido"},{animals:[{dogs:[{name:"Rover"}]},{},{dogs:[{name:["Fido"]},{name:"Rex"}]}]}),d({"dogs.name":"Fido"},{dogs:[]}),c({dogs:{$elemMatch:{name:/e/}}},{dogs:[{name:"Fido"},{name:"Rex"}]}),d({dogs:{$elemMatch:{name:/a/}}},{dogs:[{name:"Fido"},{name:"Rex"}]}),c({dogs:{$elemMatch:{age:{$gt:4}}}},{dogs:[{name:"Fido",age:5},{name:"Rex",age:3}]}),c({dogs:{$elemMatch:{name:"Fido",age:{$gt:4}}}},{dogs:[{name:"Fido",age:5},{name:"Rex",age:3}]}),d({dogs:{$elemMatch:{name:"Fido",age:{$gt:5}}}},{dogs:[{name:"Fido",age:5},{name:"Rex",age:3}]}),c({dogs:{$elemMatch:{name:/i/,age:{$gt:4}}}},{dogs:[{name:"Fido",age:5},{name:"Rex",age:3}]}),d({dogs:{$elemMatch:{name:/e/,age:5}}},{dogs:[{name:"Fido",age:5},{name:"Rex",age:3}]}),c({x:{$elemMatch:{y:9}}},{x:[{y:9}]}),d({x:{$elemMatch:{y:9}}},{x:[[{y:9}]]}),c({x:{$elemMatch:{$gt:5,$lt:9}}},{x:[8]}),d({x:{$elemMatch:{$gt:5,$lt:9}}},{x:[[8]]}),c({"a.x":{$elemMatch:{y:9}}},{a:[{x:[]},{x:[{y:9}]}]}),d({a:{$elemMatch:{x:5}}},{a:{x:5}}),c({a:{$elemMatch:{0:{$gt:5,$lt:9}}}},{a:[[6]]}),c({a:{$elemMatch:{"0.b":{$gt:5,$lt:9}}}},{a:[[{b:6}]]}),c({a:{$elemMatch:{x:1,$or:[{a:1},{b:1}]}}},{a:[{x:1,b:1}]}),c({a:{$elemMatch:{$or:[{a:1},{b:1}],x:1}}},{a:[{x:1,b:1}]}),d({a:{$elemMatch:{x:1,$or:[{a:1},{b:1}]}}},{a:[{b:1}]}),d({a:{$elemMatch:{x:1,$or:[{a:1},{b:1}]}}},{a:[{x:1}]}),d({a:{$elemMatch:{x:1,$or:[{a:1},{b:1}]}}},{a:[{x:1},{b:1}]}),c({a:5,$comment:"asdf"},{a:5}),d({a:6,$comment:"asdf"},{a:5})}),Tinytest.add("minimongo - projection_compiler",function(a){var b=function(b,c){var d=LocalCollection._compileProjection(b),e=function(b,c,d){a.isTrue(_.isEqual(b,c),d)};_.each(c,function(a){e(d(a[0]),a[1],a[2])})};b({foo:1,bar:1},[[{foo:42,bar:"something",baz:"else"},{foo:42,bar:"something"},"simplest - whitelist"],[{foo:{nested:17},baz:{}},{foo:{nested:17}},"nested whitelisted field"],[{_id:"uid",bazbaz:42},{_id:"uid"},"simplest whitelist - preserve _id"]]),b({foo:0,bar:0},[[{foo:42,bar:"something",baz:"else"},{baz:"else"},"simplest - blacklist"],[{foo:{nested:17},baz:{foo:"something"}},{baz:{foo:"something"}},"nested blacklisted field"],[{_id:"uid",bazbaz:42},{_id:"uid",bazbaz:42},"simplest blacklist - preserve _id"]]),b({_id:0,foo:1},[[{foo:42,bar:33,_id:"uid"},{foo:42},"whitelist - _id blacklisted"]]),b({_id:0,foo:0},[[{foo:42,bar:33,_id:"uid"},{bar:33},"blacklist - _id blacklisted"]]),b({"foo.bar.baz":1},[[{foo:{meh:"fur",bar:{baz:42},tr:1},bar:33,baz:"trolololo"},{foo:{bar:{baz:42}}},"whitelist nested"],[{foo:{meh:"fur",bar:"nope",tr:1},bar:33,baz:"trolololo"},{foo:{}},"whitelist nested - path not found in doc, different type"],[{foo:{meh:"fur",bar:[],tr:1},bar:33,baz:"trolololo"},{foo:{bar:[]}},"whitelist nested - path not found in doc"]]),b({"hope.humanity":0,"hope.people":0},[[{hope:{humanity:"lost",people:"broken",candies:"long live!"}},{hope:{candies:"long live!"}},"blacklist nested"],[{hope:"new"},{hope:"new"},"blacklist nested - path not found in doc"]]),b({_id:1},[[{_id:42,x:1,y:{z:"2"}},{_id:42},"_id whitelisted"],[{_id:33},{_id:33},"_id whitelisted, _id only"],[{x:1},{},"_id whitelisted, no _id"]]),b({_id:0},[[{_id:42,x:1,y:{z:"2"}},{x:1,y:{z:"2"}},"_id blacklisted"],[{_id:33},{},"_id blacklisted, _id only"],[{x:1},{x:1},"_id blacklisted, no _id"]]),b({},[[{a:1,b:2,c:"3"},{a:1,b:2,c:"3"},"empty projection"]]),a["throws"](function(){b({inc:1,excl:0},[[{inc:42,excl:42},{inc:42},"Can't combine incl/excl rules"]])}),a["throws"](function(){b({a:1,"a.b":1},[[{a:{b:42}},{a:{b:42}},"Can't have ambiguous rules (one is prefix of another)"]])}),a["throws"](function(){b({"a.b.c":1,"a.b":1,a:1},[[{a:{b:42}},{a:{b:42}},"Can't have ambiguous rules (one is prefix of another)"]])}),a["throws"](function(){b("some string",[[{a:{b:42}},{a:{b:42}},"Projection is not a hash"]])})}),Tinytest.add("minimongo - fetch with fields",function(a){var b=new LocalCollection;_.times(30,function(a){b.insert({something:Random.id(),anything:{foo:"bar",cool:"hot"},nothing:a,i:a})});var c=b.find({},{fields:{something:1,"anything.foo":1}}).fetch();a.isTrue(_.all(c,function(a){return a&&a.something&&a.anything&&a.anything.foo&&"bar"===a.anything.foo&&!_.has(a,"nothing")&&!_.has(a.anything,"cool")})),c=b.find({nothing:{$gte:5}},{fields:{nothing:0}}).fetch(),a.isTrue(_.all(c,function(a){return a&&a.something&&a.anything&&"bar"===a.anything.foo&&"hot"===a.anything.cool&&!_.has(a,"nothing")&&a.i&&a.i>=5})),a.isTrue(25===c.length),c=b.find({},{sort:{nothing:1},limit:10,skip:10,fields:{i:1,something:1}}).fetch(),a.isTrue(_.all(c,function(a){return a&&a.something&&a.i>=10&&a.i<20})),_.each(c,function(b,c,d){c&&a.isTrue(b.i===d[c-1].i+1)}),a["throws"](function(){b.find({},{fields:{"grades.$":1}})}),a["throws"](function(){b.find({},{fields:{grades:{$elemMatch:{mean:70}}}})}),a["throws"](function(){b.find({},{fields:{grades:{$slice:[20,10]}}})})}),Tinytest.add("minimongo - fetch with projection, subarrays",function(a){var b=new LocalCollection;b.insert({setA:[{fieldA:42,fieldB:33},{fieldA:"the good",fieldB:"the bad",fieldC:"the ugly"}],setB:[{anotherA:{},anotherB:"meh"},{anotherA:1234,anotherB:431}]});var c=function(b,c,d){a.isTrue(_.isEqual(b,c),d)},d=function(a,d){var e=b.find({},{fields:a}).fetch()[0];c(e,d,"failed sub-set projection: "+JSON.stringify(a))};d({"setA.fieldA":1,"setB.anotherB":1,_id:0},{setA:[{fieldA:42},{fieldA:"the good"}],setB:[{anotherB:"meh"},{anotherB:431}]}),d({"setA.fieldA":0,"setB.anotherA":0,_id:0},{setA:[{fieldB:33},{fieldB:"the bad",fieldC:"the ugly"}],setB:[{anotherB:"meh"},{anotherB:431}]}),b.remove({}),b.insert({a:[[{b:1,c:2},{b:2,c:4}],{b:3,c:5},[{b:4,c:9}]]}),d({"a.b":1,_id:0},{a:[[{b:1},{b:2}],{b:3},[{b:4}]]}),d({"a.b":0,_id:0},{a:[[{c:2},{c:4}],{c:5},[{c:9}]]})}),Tinytest.add("minimongo - fetch with projection, deep copy",function(a){var b={a:{x:42},b:{y:{z:33}},c:"asdf"},c={a:1,"b.y":1},d=LocalCollection._compileProjection(c),e=d(b);b.a.x++,b.b.y.z--,a.equal(e.a.x,42,"projection returning deep copy - including"),a.equal(e.b.y.z,33,"projection returning deep copy - including"),c={c:0},d=LocalCollection._compileProjection(c),e=d(b),b.a.x=5,a.equal(e.a.x,43,"projection returning deep copy - excluding")}),Tinytest.add("minimongo - observe ordered with projection",function(a){var c,d=[],e=b(d),f=new LocalCollection;c=f.find({},{sort:{a:1},fields:{a:1}}).observe(e),a.isTrue(c.collection===f),f.insert({_id:"foo",a:1,b:2}),a.equal(d.shift(),["added",{a:1},0,null]),f.update({a:1},{$set:{a:2,b:1}}),a.equal(d.shift(),["changed",{a:2},0,{a:1}]),f.insert({_id:"bar",a:10,c:33}),a.equal(d.shift(),["added",{a:10},1,null]),f.update({},{$inc:{a:1}},{multi:!0}),f.update({},{$inc:{c:1}},{multi:!0}),a.equal(d.shift(),["changed",{a:3},0,{a:2}]),a.equal(d.shift(),["changed",{a:11},1,{a:10}]),f.update({a:11},{a:1,b:44}),a.equal(d.shift(),["changed",{a:1},1,{a:11}]),a.equal(d.shift(),["moved",{a:1},1,0,"foo"]),f.remove({a:2}),a.equal(d.shift(),void 0),f.remove({a:3}),a.equal(d.shift(),["removed","foo",1,{a:3}]),c.stop();var g=Random.id();f.insert({_id:g,a:2}),a.equal(d.shift(),void 0);var h=f.find({},{fields:{a:1,_id:0}});a["throws"](function(){h.observeChanges({added:function(){}})}),a["throws"](function(){h.observe({added:function(){}})}),c=f.find({},{sort:{a:-1},fields:{a:1}}).observe(e),a.equal(d.shift(),["added",{a:2},0,null]),a.equal(d.shift(),["added",{a:1},1,null]),c.stop(),c=f.find({},{sort:{a:-1},fields:{a:1}}).observe(_.extend(e,{_suppress_initial:!0})),a.equal(d.shift(),void 0),f.insert({a:100,b:{foo:"bar"}}),a.equal(d.shift(),["added",{a:100},0,g]),c.stop(),f.remove({}),c=f.find({},{sort:{a:1},skip:1,limit:2,fields:{blacklisted:0}}).observe(e),
a.equal(d.shift(),void 0),f.insert({a:1,blacklisted:1324}),a.equal(d.shift(),void 0),f.insert({_id:"foo",a:2,blacklisted:["something"]}),a.equal(d.shift(),["added",{a:2},0,null]),f.insert({a:3,blacklisted:{2:3}}),a.equal(d.shift(),["added",{a:3},1,null]),f.insert({a:4,blacklisted:6}),a.equal(d.shift(),void 0),f.update({a:1},{a:0,blacklisted:4444}),a.equal(d.shift(),void 0),f.update({a:0},{a:5,blacklisted:11111}),a.equal(d.shift(),["removed","foo",0,{a:2}]),a.equal(d.shift(),["added",{a:4},1,null]),f.update({a:3},{a:3.5,blacklisted:333.4444}),a.equal(d.shift(),["changed",{a:3.5},0,{a:3}]),c.stop(),f.remove({}),c=f.find({},{sort:{a:1},fields:{a:1}}).observe(_.extend(e,{_no_indices:!0})),f.insert({_id:"foo",a:1,zoo:"crazy"}),a.equal(d.shift(),["added",{a:1},-1,null]),f.update({a:1},{$set:{a:2,foobar:"player"}}),a.equal(d.shift(),["changed",{a:2},-1,{a:1}]),f.insert({a:10,b:123.45}),a.equal(d.shift(),["added",{a:10},-1,null]),f.update({},{$inc:{a:1,b:2}},{multi:!0}),a.equal(d.shift(),["changed",{a:3},-1,{a:2}]),a.equal(d.shift(),["changed",{a:11},-1,{a:10}]),f.update({a:11,b:125.45},{a:1,b:444}),a.equal(d.shift(),["changed",{a:1},-1,{a:11}]),a.equal(d.shift(),["moved",{a:1},-1,-1,"foo"]),f.remove({a:2}),a.equal(d.shift(),void 0),f.remove({a:3}),a.equal(d.shift(),["removed","foo",-1,{a:3}]),c.stop()}),Tinytest.add("minimongo - ordering",function(b){var c=EJSON.newBinary(1);c[0]=128;var d=EJSON.newBinary(2);d[1]=42;var e=EJSON.newBinary(2);e[1]=50;var f=new Date,g=new Date(f.getTime()+1e3);a(b,LocalCollection._f._cmp,[null,1,2.2,3,"03","1","11","2","a","aaa",{},{a:2},{a:3},{a:3,b:4},{b:4},{b:4,a:3},{b:{}},{b:[1,2,3]},{b:[1,2,4]},[],[1,2],[1,2,3],[1,2,4],[1,2,"4"],[1,2,[4]],c,d,e,new LocalCollection._ObjectID("1234567890abcd1234567890"),new LocalCollection._ObjectID("abcd1234567890abcd123456"),!1,!0,f,g]);var h=function(c,d){_.each(_.isArray(c)?c:[c],function(c){var e=new Minimongo.Sorter(c);a(b,e.getComparator(),d)})};h([{a:1},["a"],[["a","asc"]]],[{a:[]},{a:1},{a:{}},{a:!0}]),h([{a:1},["a"],[["a","asc"]]],[{c:1},{a:1},{a:{}},{a:!0}]),h([{a:-1},[["a","desc"]]],[{a:!0},{a:{}},{a:1},{c:1}]),h([{a:-1},[["a","desc"]]],[{a:!0},{a:{}},{a:1},{a:[]}]),h([{a:1,b:-1},["a",["b","desc"]],[["a","asc"],["b","desc"]]],[{c:1},{a:1,b:3},{a:1,b:2},{a:2,b:0}]),h([{a:1,b:1},["a","b"],[["a","asc"],["b","asc"]]],[{c:1},{a:1,b:2},{a:1,b:3},{a:2,b:0}]),b["throws"](function(){new Minimongo.Sorter("a")}),b["throws"](function(){new Minimongo.Sorter(123)}),b["throws"](function(){new Minimongo.Sorter({$natural:1})}),b.equal(new Minimongo.Sorter({}).getComparator()({a:1},{a:2}),0),h({a:1},[{a:[1,10,20]},{a:[5,2,99]}]),h({a:-1},[{a:[5,2,99]},{a:[1,10,20]}]),h({"a.1":1},[{a:[5,2,99]},{a:[1,10,20]}]),h({a:1},[{a:[1,[10,15],20]},{a:[5,[-5,-20],18]}]),h({a:-1},[{a:[1,[10,15],20]},{a:[5,[-5,-20],18]}]),h({"a.0":1},[{a:[1,[10,15],20]},{a:[5,[-5,-20],18]}]),h({"a.0":-1},[{a:[5,[-5,-20],18]},{a:[1,[10,15],20]}]),h({"a.1":1},[{a:[5,[-5,-20],18]},{a:[1,[10,15],20]}]),h({"a.1":-1},[{a:[1,[10,15],20]},{a:[5,[-5,-20],18]}]),h({"a.1":1},[{a:[1,[10,15],20]},{a:[5,[19,3],18]}]),h({"a.1":-1},[{a:[5,[19,3],18]},{a:[1,[10,15],20]}]),h({a:1},[{a:[1,[10,15],20]},{a:[5,[19,3],18]}]),h({a:-1},[{a:[5,[19,3],18]},{a:[1,[10,15],20]}]),h({a:-1},[{a:[1,[10,15],20]},{a:[5,[3,19],18]}]),h({"a.x":1,"a.y":1},[{a:[{x:0,y:4}]},{a:[{x:0,y:5},{x:1,y:3}]}]),h({"a.0.s":1},[{a:[{s:1}]},{a:[{s:2}]}])}),Tinytest.add("minimongo - sort",function(a){for(var b=new LocalCollection,c=0;50>c;c++)for(var d=0;2>d;d++)b.insert({a:c,b:d,_id:c+"_"+d});a.equal(b.find({a:{$gt:10}},{sort:{b:-1,a:1},limit:5}).fetch(),[{a:11,b:1,_id:"11_1"},{a:12,b:1,_id:"12_1"},{a:13,b:1,_id:"13_1"},{a:14,b:1,_id:"14_1"},{a:15,b:1,_id:"15_1"}]),a.equal(b.find({a:{$gt:10}},{sort:{b:-1,a:1},skip:3,limit:5}).fetch(),[{a:14,b:1,_id:"14_1"},{a:15,b:1,_id:"15_1"},{a:16,b:1,_id:"16_1"},{a:17,b:1,_id:"17_1"},{a:18,b:1,_id:"18_1"}]),a.equal(b.find({a:{$gte:20}},{sort:{a:1,b:-1},skip:50,limit:5}).fetch(),[{a:45,b:1,_id:"45_1"},{a:45,b:0,_id:"45_0"},{a:46,b:1,_id:"46_1"},{a:46,b:0,_id:"46_0"},{a:47,b:1,_id:"47_1"}])}),Tinytest.add("minimongo - subkey sort",function(a){var b=new LocalCollection;b.insert({a:{b:2}}),b.insert({a:{b:1}}),b.insert({a:{b:3}}),a.equal(_.pluck(b.find({},{sort:{"a.b":-1}}).fetch(),"a"),[{b:3},{b:2},{b:1}]),b.insert({a:1}),a.equal(_.pluck(b.find({},{sort:{"a.b":1}}).fetch(),"a"),[1,{b:1},{b:2},{b:3}]),b.insert({a:{b:{c:1}}}),a.equal(_.pluck(b.find({},{sort:{"a.b":-1}}).fetch(),"a"),[{b:{c:1}},{b:3},{b:2},{b:1},1]),b.insert({c:1}),a.equal(_.pluck(b.find({},{sort:{"a.b":-1}}).fetch(),"a"),[{b:{c:1}},{b:3},{b:2},{b:1},1,void 0]),a.equal(b.find({},{sort:{"a.nope.c":-1}}).count(),6)}),Tinytest.add("minimongo - array sort",function(a){var b=new LocalCollection;b.insert({up:1,down:1,selected:2,a:{x:[1,4]}}),b.insert({up:2,down:2,selected:0,a:[{x:[2]},{x:3}]}),b.insert({up:0,down:4,a:{x:0}}),b.insert({up:3,down:3,selected:1,a:{x:2.5}}),b.insert({up:4,down:0,selected:3,a:{x:5}});var c=function(c,d){var e=[];b.find().forEach(function(a){_.has(a,d)&&e.push(a[d])}),a.equal(_.pluck(c.fetch(),d),_.range(_.max(e)+1))};c(b.find({},{sort:{"a.x":1}}),"up"),c(b.find({},{sort:{"a.x":-1}}),"down"),c(b.find({"a.x":{$gt:1}},{sort:{"a.x":1}}),"selected")}),Tinytest.add("minimongo - sort keys",function(a){var b=function(a){var b={};return _.each(a,function(a){b[EJSON.stringify(a)]=!0}),b},c=function(c,d,e){var f=b(e),g=new Minimongo.Sorter(c),h=[];g._generateKeysFromDoc(d,function(a){h.push(a)});var i=b(h);a.equal(i,f)},d=function(b,c){var d=new Minimongo.Sorter(b);a["throws"](function(){d._generateKeysFromDoc(c,function(){})},/parallel arrays/)};c({"a.x":1,"a.y":1},{a:{x:0,y:5}},[[0,5]]),c({"a.x":1,"a.y":1},{a:[{x:0,y:5},{x:1,y:3}]},[[0,5],[1,3]]),c({"a.x":1,"a.y":1,b:-1},{a:[{x:0,y:5},{x:1,y:3}],b:42},[[0,5,42],[1,3,42]]),c({b:-1,"a.x":1,"a.y":1},{a:[{x:0,y:5},{x:1,y:3}],b:42},[[42,0,5],[42,1,3]]),c({"a.x":1,b:-1,"a.y":1},{a:[{x:0,y:5},{x:1,y:3}],b:42},[[0,42,5],[1,42,3]]),c({a:1,b:1},{a:[1,2,3],b:42},[[1,42],[2,42],[3,42]]),d({a:1,b:1},{a:[1,2,3],b:[42]}),d({"a.x":1,"a.y":1},{a:[{x:1,y:[2,3]},{x:2,y:[4,5]}]})}),Tinytest.add("minimongo - sort key filter",function(a){var b=function(b,c,d,e){var f=new Minimongo.Matcher(c),g=new Minimongo.Sorter(b,{matcher:f}),h=g.getComparator(),i=h(d,e);a.isTrue(0>i)};b({"a.x":1},{"a.x":{$gt:1}},{a:{x:3}},{a:{x:[1,4]}}),b({"a.x":1},{"a.x":{$gt:0}},{a:{x:[1,4]}},{a:{x:3}});var c=function(b,c,d,e){var f=new Minimongo.Matcher(c),g=new Minimongo.Sorter(b,{matcher:f}),h=g._keyCompatibleWithSelector(d);a.equal(h,e)};c({a:1},{a:5},[5],!0),c({a:1},{a:5},[8],!1),c({a:1},{a:{x:5}},[{x:5}],!0),c({a:1},{a:{x:5}},[{x:5,y:9}],!1),c({"a.x":1},{a:{x:5}},[5],!0),c({"a.x":1},{a:{x:5}},[1],!0),c({"a.x":1},{"a.x":5},[5],!0),c({"a.x":1},{"a.x":5},[1],!1),c({a:1},{a:/^foo+/},["foo"],!0),c({a:1},{a:/^foo+/},["foooo"],!0),c({a:1},{a:/^foo+/},["foooobar"],!0),c({a:1},{a:/^foo+/},["afoooo"],!1),c({a:1},{a:/^foo+/},[""],!1),c({a:1},{a:{$regex:"^foo+"}},["foo"],!0),c({a:1},{a:{$regex:"^foo+"}},["foooo"],!0),c({a:1},{a:{$regex:"^foo+"}},["foooobar"],!0),c({a:1},{a:{$regex:"^foo+"}},["afoooo"],!1),c({a:1},{a:{$regex:"^foo+"}},[""],!1),c({a:1},{a:/^foo+/i},["foo"],!0),c({a:1},{a:/^foo+/i},["bar"],!0),c({a:1},{a:/^foo+/m},["bar"],!0),c({a:1},{a:{$regex:"^foo+",$options:"i"}},["bar"],!0),c({a:1},{a:{$regex:"^foo+",$options:"m"}},["bar"],!0),c({a:1,b:1,c:1},{a:{$gt:5},c:{$lt:3}},[6,"bla",2],!0),c({a:1,b:1,c:1},{a:{$gt:5},c:{$lt:3}},[6,"bla",4],!1),c({a:1,b:1,c:1},{a:{$gt:5},c:{$lt:3}},[3,"bla",1],!1),c({a:1,b:1,c:1},{c:{$lt:3}},[3,"bla",4],!0)}),Tinytest.add("minimongo - binary search",function(a){var b=function(a,b){return a-b},c=function(a,c){return-1*b(a,c)},d=function(b,c,d,e,f){var g=LocalCollection._binarySearch(b,c,d);e!=g&&a.fail({type:"minimongo-binary-search",message:f+" : Expected index "+e+" but had "+g})},e=function(a,c,e,f){d(b,a,c,e,f)},f=function(a,b,e,f){d(c,a,b,e,f)};e([1,2,5,7],4,2,"Inner insert"),e([1,2,3,4],3,3,"Inner insert, equal value"),e([1,2,5],4,2,"Inner insert, odd length"),e([1,3,5,6],9,4,"End insert"),e([1,3,5,6],0,0,"Beginning insert"),e([1],0,0,"Single array, less than."),e([1],1,1,"Single array, equal."),e([1],2,1,"Single array, greater than."),e([],1,0,"Empty array"),e([1,1,1,2,2,2,2],1,3,"Highly degenerate array, lower"),e([1,1,1,2,2,2,2],2,7,"Highly degenerate array, upper"),e([2,2,2,2,2,2,2],1,0,"Highly degenerate array, lower"),e([2,2,2,2,2,2,2],2,7,"Highly degenerate array, equal"),e([2,2,2,2,2,2,2],3,7,"Highly degenerate array, upper"),f([7,5,2,1],4,2,"Backward: Inner insert"),f([4,3,2,1],3,2,"Backward: Inner insert, equal value"),f([5,2,1],4,1,"Backward: Inner insert, odd length"),f([6,5,3,1],9,0,"Backward: Beginning insert"),f([6,5,3,1],0,4,"Backward: End insert"),f([1],0,1,"Backward: Single array, less than."),f([1],1,1,"Backward: Single array, equal."),f([1],2,0,"Backward: Single array, greater than."),f([],1,0,"Backward: Empty array"),f([2,2,2,2,1,1,1],1,7,"Backward: Degenerate array, lower"),f([2,2,2,2,1,1,1],2,4,"Backward: Degenerate array, upper"),f([2,2,2,2,2,2,2],1,7,"Backward: Highly degenerate array, upper"),f([2,2,2,2,2,2,2],2,7,"Backward: Highly degenerate array, upper"),f([2,2,2,2,2,2,2],3,0,"Backward: Highly degenerate array, upper")}),Tinytest.add("minimongo - modify",function(a){var b=function(b,c,d,e){var f=new LocalCollection;f.insert(b),f.update(c,d);var g=f.findOne();delete g._id,a.equal(g,e,EJSON.stringify({input:b,mod:d}))},c=function(a,c,d){b(a,{},c,d)},d=function(b,c,d){var e=new LocalCollection;e.insert(b),a["throws"](function(){e.update(c,d)})},e=function(a,b){d(a,{},b)};c({},{},{}),c({a:12},{},{}),c({a:12},{a:13},{a:13}),c({a:12,b:99},{a:13},{a:13}),e({a:12},{a:13,$set:{b:13}}),e({a:12},{$set:{b:13},a:13}),c({},{$set:{a:12}},{a:12}),c({},{$set:{"a.b":12}},{a:{b:12}}),c({},{$set:{"a.b.c":12}},{a:{b:{c:12}}}),c({a:{d:99}},{$set:{"a.b.c":12}},{a:{d:99,b:{c:12}}}),c({},{$set:{"a.b.3.c":12}},{a:{b:{3:{c:12}}}}),c({a:{b:[]}},{$set:{"a.b.3.c":12}},{a:{b:[null,null,null,{c:12}]}}),e({a:[null,null,null]},{$set:{"a.1.b":12}}),e({a:[null,1,null]},{$set:{"a.1.b":12}}),e({a:[null,"x",null]},{$set:{"a.1.b":12}}),e({a:[null,[],null]},{$set:{"a.1.b":12}}),c({a:[null,null,null]},{$set:{"a.3.b":12}},{a:[null,null,null,{b:12}]}),e({a:[]},{$set:{"a.b":12}}),e({a:12},{$set:{"a.b":99}}),e({a:"x"},{$set:{"a.b":99}}),e({a:!0},{$set:{"a.b":99}}),e({a:null},{$set:{"a.b":99}}),c({a:{}},{$set:{"a.3":12}},{a:{3:12}}),c({a:[]},{$set:{"a.3":12}},{a:[null,null,null,12]}),e({},{$set:{"":12}}),e({},{$set:{".":12}}),e({},{$set:{"a.":12}}),e({},{$set:{". ":12}}),e({},{$inc:{"... ":12}}),e({},{$set:{"a..b":12}}),c({a:[1,2,3]},{$set:{"a.01":99}},{a:[1,99,3]}),c({a:[1,{a:98},3]},{$set:{"a.01.b":99}},{a:[1,{a:98,b:99},3]}),c({},{$set:{"2.a.b":12}},{2:{a:{b:12}}}),e({x:[]},{$set:{"x.2..a":99}}),c({x:[null,null]},{$set:{"x.2.a":1}},{x:[null,null,{a:1}]}),e({x:[null,null]},{$set:{"x.1.a":1}}),b({a:[{x:2},{x:4}]},{"a.x":4},{$set:{"a.$.z":9}},{a:[{x:2},{x:4,z:9}]}),e({a:[{x:2},{x:4}]},{$set:{"a.$.z":9}}),d({a:[{x:2},{x:4}],b:5},{b:5},{$set:{"a.$.z":9}}),d({a:[{x:[2]}]},{"a.x":2},{$set:{"a.$.x.$":9}}),b({a:[5,6,7]},{a:6},{$set:{"a.$":9}},{a:[5,9,7]}),b({a:[{b:[{c:9},{c:10}]},{b:{c:11}}]},{"a.b.c":10},{$unset:{"a.$.b":1}},{a:[{},{b:{c:11}}]}),b({a:[{b:[{c:9},{c:10}]},{b:{c:11}}]},{"a.b.c":11},{$unset:{"a.$.b":1}},{a:[{b:[{c:9},{c:10}]},{}]}),b({a:[1]},{"a.0":1},{$set:{"a.$":5}},{a:[5]}),b({a:[9]},{a:{$mod:[2,1]}},{$set:{"a.$":5}},{a:[5]}),d({a:[1]},{$not:{a:2}},{$set:{"a.$":5}}),d({a:[1]},{"a.0":{$ne:2}},{$set:{"a.$":5}}),b({a:[{x:2},{x:4}]},{$or:[{"a.x":4}]},{$set:{"a.$.z":9}},{a:[{x:2},{x:4,z:9}]}),d({a:[{x:2},{x:4}]},{$or:[{"a.x":4},{"a.x":4}]},{$set:{"a.$.z":9}}),b({a:[{x:1},{x:3}]},{$and:[{"a.x":1},{"a.x":3}]},{$set:{"a.$.x":5}},{a:[{x:1},{x:5}]}),b({a:[{x:1},{x:3}]},{$and:[{"a.x":3},{"a.x":1}]},{$set:{"a.$.x":5}},{a:[{x:5},{x:3}]}),b({a:[{x:1},{y:3}]},{"a.x":1,"a.y":3},{$set:{"a.$.z":5}},{a:[{x:1},{y:3,z:5}]}),b({a:[{b:[1,1]},{b:[[3,3],[4,4]]},{b:[9,9]}]},{"a.b":{$near:[5,5]}},{$set:{"a.$.b":"k"}},{a:[{b:[1,1]},{b:"k"},{b:[9,9]}]}),b({a:[{x:1},{y:1},{x:1,y:1}]},{a:{$elemMatch:{x:1,y:1}}},{$set:{"a.$.x":2}},{a:[{x:1},{y:1},{x:2,y:1}]}),b({a:[{b:[{x:1},{y:1},{x:1,y:1}]}]},{"a.b":{$elemMatch:{x:1,y:1}}},{$set:{"a.$.b":3}},{a:[{b:3}]}),c({a:1,b:2},{$inc:{a:10}},{a:11,b:2}),c({a:1,b:2},{$inc:{c:10}},{a:1,b:2,c:10}),e({a:1},{$inc:{a:"10"}}),e({a:1},{$inc:{a:!0}}),e({a:1},{$inc:{a:[10]}}),e({a:"1"},{$inc:{a:10}}),e({a:[1]},{$inc:{a:10}}),e({a:{}},{$inc:{a:10}}),e({a:!1},{$inc:{a:10}}),e({a:null},{$inc:{a:10}}),c({a:[1,2]},{$inc:{"a.1":10}},{a:[1,12]}),c({a:[1,2]},{$inc:{"a.2":10}},{a:[1,2,10]}),c({a:[1,2]},{$inc:{"a.3":10}},{a:[1,2,null,10]}),c({a:{b:2}},{$inc:{"a.b":10}},{a:{b:12}}),c({a:{b:2}},{$inc:{"a.c":10}},{a:{b:2,c:10}}),e({},{$inc:{_id:1}}),c({a:1,b:2},{$set:{a:10}},{a:10,b:2}),c({a:1,b:2},{$set:{c:10}},{a:1,b:2,c:10}),c({a:1,b:2},{$set:{a:{c:10}}},{a:{c:10},b:2}),c({a:[1,2],b:2},{$set:{a:[3,4]}},{a:[3,4],b:2}),c({a:[1,2,3],b:2},{$set:{"a.1":[3,4]}},{a:[1,[3,4],3],b:2}),c({a:[1],b:2},{$set:{"a.1":9}},{a:[1,9],b:2}),c({a:[1],b:2},{$set:{"a.2":9}},{a:[1,null,9],b:2}),c({a:{b:1}},{$set:{"a.c":9}},{a:{b:1,c:9}}),c({},{$set:{"x._id":4}},{x:{_id:4}}),e({},{$set:{_id:4}}),e({_id:4},{$set:{_id:4}}),c({},{$unset:{a:1}},{}),c({a:1},{$unset:{a:1}},{}),c({a:1,b:2},{$unset:{a:1}},{b:2}),c({a:1,b:2},{$unset:{a:0}},{b:2}),c({a:1,b:2},{$unset:{a:!1}},{b:2}),c({a:1,b:2},{$unset:{a:null}},{b:2}),c({a:1,b:2},{$unset:{a:[1]}},{b:2}),c({a:1,b:2},{$unset:{a:{}}},{b:2}),c({a:{b:2,c:3}},{$unset:{"a.b":1}},{a:{c:3}}),c({a:[1,2,3]},{$unset:{"a.1":1}},{a:[1,null,3]}),c({a:[1,2,3]},{$unset:{"a.2":1}},{a:[1,2,null]}),c({a:[1,2,3]},{$unset:{"a.x":1}},{a:[1,2,3]}),c({a:{b:1}},{$unset:{"a.b.c.d":1}},{a:{b:1}}),c({a:{b:1}},{$unset:{"a.x.c.d":1}},{a:{b:1}}),c({a:{b:{c:1}}},{$unset:{"a.b.c":1}},{a:{b:{}}}),e({},{$unset:{_id:1}}),c({},{$push:{a:1}},{a:[1]}),c({a:[]},{$push:{a:1}},{a:[1]}),c({a:[1]},{$push:{a:2}},{a:[1,2]}),e({a:!0},{$push:{a:1}}),c({a:[1]},{$push:{a:[2]}},{a:[1,[2]]}),c({a:[]},{$push:{"a.1":99}},{a:[null,[99]]}),c({a:{}},{$push:{"a.x":99}},{a:{x:[99]}}),c({},{$push:{a:{$each:[1,2,3]}}},{a:[1,2,3]}),c({a:[]},{$push:{a:{$each:[1,2,3]}}},{a:[1,2,3]}),c({a:[!0]},{$push:{a:{$each:[1,2,3]}}},{a:[!0,1,2,3]}),e({},{$push:{a:{$each:[],$slice:5}}}),c({a:[!0]},{$push:{a:{$each:[1,2,3],$slice:-2}}},{a:[2,3]}),c({a:[!1,!0]},{$push:{a:{$each:[1],$slice:-2}}},{a:[!0,1]}),c({a:[{x:3},{x:1}]},{$push:{a:{$each:[{x:4},{x:2}],$slice:-2,$sort:{x:1}}}},{a:[{x:3},{x:4}]}),c({},{$push:{a:{$each:[1,2,3],$slice:0}}},{a:[]}),c({a:[1,2]},{$push:{a:{$each:[1,2,3],$slice:0}}},{a:[]}),c({},{$pushAll:{a:[1]}},{a:[1]}),c({a:[]},{$pushAll:{a:[1]}},{a:[1]}),c({a:[1]},{$pushAll:{a:[2]}},{a:[1,2]}),c({},{$pushAll:{a:[1,2]}},{a:[1,2]}),c({a:[]},{$pushAll:{a:[1,2]}},{a:[1,2]}),c({a:[1]},{$pushAll:{a:[2,3]}},{a:[1,2,3]}),c({},{$pushAll:{a:[]}},{a:[]}),c({a:[]},{$pushAll:{a:[]}},{a:[]}),c({a:[1]},{$pushAll:{a:[]}},{a:[1]}),e({a:!0},{$pushAll:{a:[1]}}),e({a:[]},{$pushAll:{a:1}}),c({a:[]},{$pushAll:{"a.1":[99]}},{a:[null,[99]]}),c({a:[]},{$pushAll:{"a.1":[]}},{a:[null,[]]}),c({a:{}},{$pushAll:{"a.x":[99]}},{a:{x:[99]}}),c({a:{}},{$pushAll:{"a.x":[]}},{a:{x:[]}}),c({},{$addToSet:{a:1}},{a:[1]}),c({a:[]},{$addToSet:{a:1}},{a:[1]}),c({a:[1]},{$addToSet:{a:2}},{a:[1,2]}),c({a:[1,2]},{$addToSet:{a:1}},{a:[1,2]}),c({a:[1,2]},{$addToSet:{a:2}},{a:[1,2]}),c({a:[1,2]},{$addToSet:{a:3}},{a:[1,2,3]}),e({a:!0},{$addToSet:{a:1}}),c({a:[1]},{$addToSet:{a:[2]}},{a:[1,[2]]}),c({},{$addToSet:{a:{x:1}}},{a:[{x:1}]}),c({a:[{x:1}]},{$addToSet:{a:{x:1}}},{a:[{x:1}]}),c({a:[{x:1}]},{$addToSet:{a:{x:2}}},{a:[{x:1},{x:2}]}),c({a:[{x:1,y:2}]},{$addToSet:{a:{x:1,y:2}}},{a:[{x:1,y:2}]}),c({a:[{x:1,y:2}]},{$addToSet:{a:{y:2,x:1}}},{a:[{x:1,y:2},{y:2,x:1}]}),c({a:[1,2]},{$addToSet:{a:{$each:[3,1,4]}}},{a:[1,2,3,4]}),c({a:[1,2]},{$addToSet:{a:{$each:[3,1,4],b:12}}},{a:[1,2,3,4]}),c({a:[1,2]},{$addToSet:{a:{b:12,$each:[3,1,4]}}},{a:[1,2,{b:12,$each:[3,1,4]}]}),c({},{$addToSet:{a:{$each:[]}}},{a:[]}),c({},{$addToSet:{a:{$each:[1]}}},{a:[1]}),c({a:[]},{$addToSet:{"a.1":99}},{a:[null,[99]]}),c({a:{}},{$addToSet:{"a.x":99}},{a:{x:[99]}}),c({},{$pop:{a:1}},{}),c({},{$pop:{a:-1}},{}),c({a:[]},{$pop:{a:1}},{a:[]}),c({a:[]},{$pop:{a:-1}},{a:[]}),c({a:[1,2,3]},{$pop:{a:1}},{a:[1,2]}),c({a:[1,2,3]},{$pop:{a:10}},{a:[1,2]}),c({a:[1,2,3]},{$pop:{a:.001}},{a:[1,2]}),c({a:[1,2,3]},{$pop:{a:0}},{a:[1,2]}),c({a:[1,2,3]},{$pop:{a:"stuff"}},{a:[1,2]}),c({a:[1,2,3]},{$pop:{a:-1}},{a:[2,3]}),c({a:[1,2,3]},{$pop:{a:-10}},{a:[2,3]}),c({a:[1,2,3]},{$pop:{a:-.001}},{a:[2,3]}),e({a:!0},{$pop:{a:1}}),e({a:!0},{$pop:{a:-1}}),c({a:[]},{$pop:{"a.1":1}},{a:[]}),c({a:[1,[2,3],4]},{$pop:{"a.1":1}},{a:[1,[2],4]}),c({a:{}},{$pop:{"a.x":1}},{a:{}}),c({a:{x:[2,3]}},{$pop:{"a.x":1}},{a:{x:[2]}}),c({},{$pull:{a:1}},{}),c({},{$pull:{"a.x":1}},{}),c({a:{}},{$pull:{"a.x":1}},{a:{}}),e({a:!0},{$pull:{a:1}}),c({a:[2,1,2]},{$pull:{a:1}},{a:[2,2]}),c({a:[2,1,2]},{$pull:{a:2}},{a:[1]}),c({a:[2,1,2]},{$pull:{a:3}},{a:[2,1,2]}),c({a:[]},{$pull:{a:3}},{a:[]}),c({a:[[2],[2,1],[3]]},{$pull:{a:[2,1]}},{a:[[2],[3]]}),c({a:[{b:1,c:2},{b:2,c:2}]},{$pull:{a:{b:1}}},{a:[{b:2,c:2}]}),c({a:[{b:1,c:2},{b:2,c:2}]},{$pull:{a:{c:2}}},{a:[]}),c({},{$pullAll:{a:[1]}},{}),c({a:[1,2,3]},{$pullAll:{a:[]}},{a:[1,2,3]}),c({a:[1,2,3]},{$pullAll:{a:[2]}},{a:[1,3]}),c({a:[1,2,3]},{$pullAll:{a:[2,1]}},{a:[3]}),c({a:[1,2,3]},{$pullAll:{a:[1,2]}},{a:[3]}),c({},{$pullAll:{"a.b.c":[2]}},{}),e({a:!0},{$pullAll:{a:[1]}}),e({a:[1,2,3]},{$pullAll:{a:1}}),c({x:[{a:1},{a:1,b:2}]},{$pullAll:{x:[{a:1}]}},{x:[{a:1,b:2}]}),c({},{$rename:{a:"b"}},{}),c({a:[12]},{$rename:{a:"b"}},{b:[12]}),c({a:{b:12}},{$rename:{a:"c"}},{c:{b:12}}),c({a:{b:12}},{$rename:{"a.b":"a.c"}},{a:{c:12}}),c({a:{b:12}},{$rename:{"a.b":"x"}},{a:{},x:12}),c({a:{b:12}},{$rename:{"a.b":"q.r"}},{a:{},q:{r:12}}),c({a:{b:12}},{$rename:{"a.b":"q.2.r"}},{a:{},q:{2:{r:12}}}),c({a:{b:12},q:{}},{$rename:{"a.b":"q.2.r"}},{a:{},q:{2:{r:12}}}),e({a:{b:12},q:[]},{$rename:{"a.b":"q.2"}}),e({a:{b:12},q:[]},{$rename:{"a.b":"q.2.r"}}),e({},{$rename:{a:"a"}}),e({},{$rename:{"a.b":"a.b"}}),c({a:12,b:13},{$rename:{a:"b"}},{b:12})}),Tinytest.add("minimongo - observe ordered",function(a){var c,d=[],e=b(d),f=new LocalCollection;c=f.find({},{sort:{a:1}}).observe(e),a.isTrue(c.collection===f),f.insert({_id:"foo",a:1}),a.equal(d.shift(),["added",{a:1},0,null]),f.update({a:1},{$set:{a:2}}),a.equal(d.shift(),["changed",{a:2},0,{a:1}]),f.insert({a:10}),a.equal(d.shift(),["added",{a:10},1,null]),f.update({},{$inc:{a:1}},{multi:!0}),a.equal(d.shift(),["changed",{a:3},0,{a:2}]),a.equal(d.shift(),["changed",{a:11},1,{a:10}]),f.update({a:11},{a:1}),a.equal(d.shift(),["changed",{a:1},1,{a:11}]),a.equal(d.shift(),["moved",{a:1},1,0,"foo"]),f.remove({a:2}),a.equal(d.shift(),void 0),f.remove({a:3}),a.equal(d.shift(),["removed","foo",1,{a:3}]),c.stop();var g=Random.id();f.insert({_id:g,a:2}),a.equal(d.shift(),void 0),c=f.find({},{sort:{a:-1}}).observe(e),a.equal(d.shift(),["added",{a:2},0,null]),a.equal(d.shift(),["added",{a:1},1,null]),c.stop(),c=f.find({},{sort:{a:-1}}).observe(_.extend({_suppress_initial:!0},e)),a.equal(d.shift(),void 0),f.insert({a:100}),a.equal(d.shift(),["added",{a:100},0,g]),c.stop(),f.remove({}),c=f.find({},{sort:{a:1},skip:1,limit:2}).observe(e),a.equal(d.shift(),void 0),f.insert({a:1}),a.equal(d.shift(),void 0),f.insert({_id:"foo",a:2}),a.equal(d.shift(),["added",{a:2},0,null]),f.insert({a:3}),a.equal(d.shift(),["added",{a:3},1,null]),f.insert({a:4}),a.equal(d.shift(),void 0),f.update({a:1},{a:0}),a.equal(d.shift(),void 0),f.update({a:0},{a:5}),a.equal(d.shift(),["removed","foo",0,{a:2}]),a.equal(d.shift(),["added",{a:4},1,null]),f.update({a:3},{a:3.5}),a.equal(d.shift(),["changed",{a:3.5},0,{a:3}]),c.stop(),f.remove({}),f.insert({a:1}),f.insert({_id:"two",a:2}),f.insert({a:3}),c=f.find({},{sort:{a:1},limit:2}).observe(e),a.equal(d.shift(),["added",{a:1},0,null]),a.equal(d.shift(),["added",{a:2},1,null]),a.equal(d.shift(),void 0),f.remove({a:2}),a.equal(d.shift(),["removed","two",1,{a:2}]),a.equal(d.shift(),["added",{a:3},1,null]),a.equal(d.shift(),void 0),c.stop(),f.remove({}),c=f.find({},{sort:{a:1}}).observe(_.extend(e,{_no_indices:!0})),f.insert({_id:"foo",a:1}),a.equal(d.shift(),["added",{a:1},-1,null]),f.update({a:1},{$set:{a:2}}),a.equal(d.shift(),["changed",{a:2},-1,{a:1}]),f.insert({a:10}),a.equal(d.shift(),["added",{a:10},-1,null]),f.update({},{$inc:{a:1}},{multi:!0}),a.equal(d.shift(),["changed",{a:3},-1,{a:2}]),a.equal(d.shift(),["changed",{a:11},-1,{a:10}]),f.update({a:11},{a:1}),a.equal(d.shift(),["changed",{a:1},-1,{a:11}]),a.equal(d.shift(),["moved",{a:1},-1,-1,"foo"]),f.remove({a:2}),a.equal(d.shift(),void 0),f.remove({a:3}),a.equal(d.shift(),["removed","foo",-1,{a:3}]),c.stop()}),_.each([!0,!1],function(a){Tinytest.add("minimongo - observe ordered: "+a,function(b){var c=new LocalCollection,d="",e=function(b){var c={};return _.each(["added","changed","removed"],function(e){var f=a?e+"At":e;c[f]=function(a){d=d+e.substr(0,1)+b+a._id+"_"}}),c},f=function(a){b.equal(d,a),d=""};c.insert({_id:1,name:"strawberry",tags:["fruit","red","squishy"]}),c.insert({_id:2,name:"apple",tags:["fruit","red","hard"]}),c.insert({_id:3,name:"rose",tags:["flower","red","squishy"]});var g=c.find({tags:"flower"}).observe(e("a"));f("aa3_"),c.update({name:"rose"},{$set:{tags:["bloom","red","squishy"]}}),f("ra3_"),c.update({name:"rose"},{$set:{tags:["flower","red","squishy"]}}),f("aa3_"),c.update({name:"rose"},{$set:{food:!1}}),f("ca3_"),c.remove({}),f("ra3_"),c.insert({_id:4,name:"daisy",tags:["flower"]}),f("aa4_"),g.stop(),c.insert({_id:5,name:"iris",tags:["flower"]}),f(""),g=c.find(4).observe(e("b")),f("ab4_"),c.update(4,{$set:{eek:5}}),f("cb4_"),g.stop(),g=c.find({tags:"flower"},{reactive:!1}).observe(e("c")),f("ac4_ac5_"),c.insert({_id:6,name:"river",tags:["flower"]}),f(""),g.stop()})}),Tinytest.add("minimongo - diff changes ordering",function(a){var b=function(a){return _.map(a,function(a){return{_id:a}})},c=function(c,d){var e=b(c),f=b(d),g=EJSON.clone(e);LocalCollection._diffQueryOrderedChanges(e,f,{addedBefore:function(a,b,c){if(null===c)return void g.push(_.extend({_id:a},b));for(var d=0;d<g.length;d++)if(g[d]._id===c)return void g.splice(d,0,_.extend({_id:a},b))},movedBefore:function(a,b){for(var c,d=0;d<g.length;d++)g[d]._id===a&&(c=g[d],g.splice(d,1));if(null===b)return void g.push(_.extend({_id:a},c));for(d=0;d<g.length;d++)if(g[d]._id===b)return void g.splice(d,0,_.extend({_id:a},c))},removed:function(a){for(var b,c=0;c<g.length;c++)g[c]._id===a&&(b=g[c],g.splice(c,1))}}),a.equal(g,f)},d=function(a,b){c(a,b),c(b,a)};d(["a","b","c"],["c","b","a"]),d(["a","b","c"],[]),d(["a","b","c"],["e","f"]),d(["a","b","c","d"],["c","b","a"]),d(["A","B","C","D","E","F","G","H","I"],["A","B","F","G","C","D","I","L","M","N","H"]),d(["A","B","C","D","E","F","G","H","I"],["A","B","C","D","F","G","H","E","I"])}),Tinytest.add("minimongo - diff",function(a){var b=function(b,c){for(var d=new Array(b),e=1;b>=e;e++)d[e-1]={_id:e};var f=_.map(c,function(a){var b={_id:Math.abs(a)};return 0>a&&(b.changed=!0),b}),g=function(a,b){for(var c=0;c<a.length;c++)if(EJSON.equals(a[c]._id,b))return c;return-1},h=_.clone(d),i={addedBefore:function(b,c,d){var e;e=null===d?h.length:g(h,d);var f=_.extend({_id:b},c);a.isFalse(0>e||e>h.length),h.splice(e,0,f)},removed:function(b){var c=g(h,b);a.isFalse(0>c||c>=h.length),h.splice(c,1)},changed:function(b,c){var d=g(h,b),e=h[d],f=EJSON.clone(e);LocalCollection._applyChanges(f,c),a.isFalse(0>d||d>=h.length),a.equal(f._id,e._id),h[d]=f},movedBefore:function(b,c){var d,e=g(h,b);d=null===c?h.length:g(h,c),d>e&&d--,a.isFalse(0>e||e>=h.length),a.isFalse(0>d||d>=h.length),h.splice(d,0,h.splice(e,1)[0])}};LocalCollection._diffQueryOrderedChanges(d,f,i),a.equal(h,f)};b(5,[5,1,2,3,4]),b(0,[1,2,3,4]),b(4,[]),b(7,[4,5,6,7,1,2,3]),b(7,[5,6,7,1,2,3,4]),b(10,[7,4,11,6,12,1,5]),b(3,[3,2,1]),b(10,[2,7,4,6,11,3,8,9]),b(0,[]),b(1,[]),b(0,[1]),b(1,[1]),b(5,[1,2,3,4,5]),b(5,[-5,-1,2,-3,4]),b(7,[-4,-5,6,7,-1,2,3]),b(7,[5,6,-7,1,2,-3,4]),b(10,[7,-4,11,6,12,-1,5]),b(3,[-3,-2,-1]),b(10,[-2,7,4,6,11,-3,-8,9])}),Tinytest.add("minimongo - saveOriginals",function(a){var b,c=new LocalCollection;c.insert({_id:"foo",x:"untouched"}),c.insert({_id:"bar",x:"updateme"}),c.insert({_id:"baz",x:"updateme"}),c.insert({_id:"quux",y:"removeme"}),c.insert({_id:"whoa",y:"removeme"}),c.saveOriginals(),c.insert({_id:"hooray",z:"insertme"}),c.remove({y:"removeme"}),b=c.update({x:"updateme"},{$set:{z:5}},{multi:!0}),c.update("bar",{$set:{k:7}}),a.equal(b,2);var d=c.retrieveOriginals(),e=["bar","baz","quux","whoa","hooray"];a.equal(d.size(),_.size(e)),_.each(e,function(b){a.isTrue(d.has(b))}),a.equal(d.get("bar"),{_id:"bar",x:"updateme"}),a.equal(d.get("baz"),{_id:"baz",x:"updateme"}),a.equal(d.get("quux"),{_id:"quux",y:"removeme"}),a.equal(d.get("whoa"),{_id:"whoa",y:"removeme"}),a.equal(d.get("hooray"),void 0),a.equal(c.find().count(),4),a.equal(c.findOne("foo"),{_id:"foo",x:"untouched"}),a.equal(c.findOne("bar"),{_id:"bar",x:"updateme",z:5,k:7}),a.equal(c.findOne("baz"),{_id:"baz",x:"updateme",z:5}),a.equal(c.findOne("hooray"),{_id:"hooray",z:"insertme"}),c.saveOriginals(),d=c.retrieveOriginals(),a.isTrue(d),a.isTrue(d.empty()),c.saveOriginals(),c.insert({_id:"temp",q:8}),c.remove("temp"),d=c.retrieveOriginals(),a.equal(d.size(),1),a.isTrue(d.has("temp")),a.equal(d.get("temp"),void 0)}),Tinytest.add("minimongo - saveOriginals errors",function(a){var b=new LocalCollection;a["throws"](function(){b.retrieveOriginals()}),b.saveOriginals(),a["throws"](function(){b.saveOriginals()})}),Tinytest.add("minimongo - objectid transformation",function(a){var b=function(b){a.equal(b,LocalCollection._idParse(LocalCollection._idStringify(b)))},c=new LocalCollection._ObjectID;b(c),b("FOO"),b("ffffffffffff"),b("0987654321abcdef09876543"),b(new LocalCollection._ObjectID),b("--a string"),a.equal("ffffffffffff",LocalCollection._idParse(LocalCollection._idStringify("ffffffffffff")))}),Tinytest.add("minimongo - objectid",function(a){var b=new LocalCollection._ObjectID,c=new LocalCollection._ObjectID;a.notEqual(b,c),a["throws"](function(){new LocalCollection._ObjectID("qqqqqqqqqqqqqqqqqqqqqqqq")}),a["throws"](function(){new LocalCollection._ObjectID("ABCDEF")}),a.equal(b,new LocalCollection._ObjectID(b.valueOf()))}),Tinytest.add("minimongo - pause",function(a){var c=[],d=b(c),e=new LocalCollection,f=e.find({}).observe(d);e.insert({_id:1,a:1}),a.equal(c.shift(),["added",{a:1},0,null]),e.pauseObservers(),e.remove({_id:1}),a.length(c,0),e.insert({_id:1,a:1}),a.length(c,0),e.resumeObservers(),a.length(c,0),e.pauseObservers(),e.update({_id:1},{a:2}),e.update({_id:1},{a:3}),e.resumeObservers(),a.equal(c.shift(),["changed",{a:3},0,{a:1}]),a.length(c,0),e.pauseObservers(),a.equal(e.remove({}),1),a.length(c,0),e.resumeObservers(),a.equal(c.shift(),["removed",1,0,{a:3}]),a.length(c,0),f.stop()}),Tinytest.add("minimongo - ids matched by selector",function(a){var b=function(b,c){var d=LocalCollection._idsMatchedBySelector(b);a.equal(d,c)};b("foo",["foo"]),b({_id:"foo"},["foo"]);var c=new LocalCollection._ObjectID;b(c,[c]),b({_id:c},[c]),b({_id:"foo",x:42},["foo"]),b({},null),b({_id:{$in:["foo",c]}},["foo",c]),b({_id:{$ne:"foo"}},null),b({$and:["foo"]},["foo"]),b({$and:[{x:42},{_id:c}]},[c]),b({$and:[{x:42},{_id:{$in:[c]}}]},[c])}),Tinytest.add("minimongo - reactive stop",function(a){var b=new LocalCollection;b.insert({_id:"A"}),b.insert({_id:"B"}),b.insert({_id:"C"});var c,d,e=function(a,b,c){var d=a.indexOf(c);return-1===d?a+b:a.slice(0,d)+b+a.slice(d)},f=ReactiveVar(1),g=Tracker.autorun(function(){var a=b.find({},{sort:{_id:f.get()}});c="",a.observe({addedAt:function(a,b,d){c=e(c,a._id,d)}}),d="",a.observeChanges({addedBefore:function(a,b,c){d=e(d,a,c)}})});a.equal(c,"ABC"),a.equal(d,"ABC"),f.set(-1),a.equal(c,"ABC"),a.equal(d,"ABC"),Tracker.flush(),a.equal(c,"CBA"),a.equal(d,"CBA"),b.insert({_id:"D"}),b.insert({_id:"E"}),a.equal(c,"EDCBA"),a.equal(d,"EDCBA"),g.stop(),b.insert({_id:"F"}),a.equal(c,"EDCBA"),a.equal(d,"EDCBA")}),Tinytest.add("minimongo - immediate invalidate",function(){var a=new LocalCollection;a.insert({_id:"A"});var b=Tracker.autorun(function(){a.findOne("A"),a.findOne("A")});a.update("A",{$set:{x:42}}),b.stop()}),Tinytest.add("minimongo - count on cursor with limit",function(a){var b,c=new LocalCollection;c.insert({_id:"A"}),c.insert({_id:"B"}),c.insert({_id:"C"}),c.insert({_id:"D"});var d=Tracker.autorun(function(){var a=c.find({_id:{$exists:!0}},{sort:{_id:1},limit:3});b=a.count()});a.equal(b,3),c.remove("A"),Tracker.flush(),a.equal(b,3),c.remove("B"),Tracker.flush(),a.equal(b,2),c.insert({_id:"A"}),Tracker.flush(),a.equal(b,3),c.insert({_id:"B"}),Tracker.flush(),a.equal(b,3),d.stop()}),Tinytest.add("minimongo - reactive count with cached cursor",function(a){var b,c,d=new LocalCollection,e=d.find({});Tracker.autorun(function(){b=e.count()}),Tracker.autorun(function(){c=d.find({}).count()}),a.equal(b,0),a.equal(c,0),d.insert({i:1}),d.insert({i:2}),d.insert({i:3}),Tracker.flush(),a.equal(b,3),a.equal(c,3)}),Tinytest.add("minimongo - $near operator tests",function(a){function c(a,b){var c=a[0]-b[0],d=a[1]-b[1];return Math.sqrt(c*c+d*d)}var d=new LocalCollection;d.insert({rest:{loc:[2,3]}}),d.insert({rest:{loc:[-3,3]}}),d.insert({rest:{loc:[5,5]}}),a.equal(d.find({"rest.loc":{$near:[0,0],$maxDistance:30}}).count(),3),a.equal(d.find({"rest.loc":{$near:[0,0],$maxDistance:4}}).count(),1);var e=d.find({"rest.loc":{$near:[0,0],$maxDistance:6}}).fetch();_.each(e,function(b,d,e){a.isTrue(!d||c([0,0],b.rest.loc)>=c([0,0],e[d-1].rest.loc))}),d=new LocalCollection;var f=[{category:"BURGLARY",descript:"BURGLARY OF STORE, FORCIBLE ENTRY",address:"100 Block of 10TH ST",location:{type:"Point",coordinates:[-122.415449723856,37.7749518087273]}},{category:"WEAPON LAWS",descript:"POSS OF PROHIBITED WEAPON",address:"900 Block of MINNA ST",location:{type:"Point",coordinates:[-122.415386041221,37.7747879744156]}},{category:"LARCENY/THEFT",descript:"GRAND THEFT OF PROPERTY",address:"900 Block of MINNA ST",location:{type:"Point",coordinates:[-122.41538270191,37.774683628213]}},{category:"LARCENY/THEFT",descript:"PETTY THEFT FROM LOCKED AUTO",address:"900 Block of MINNA ST",location:{type:"Point",coordinates:[-122.415396041221,37.7747879744156]}},{category:"OTHER OFFENSES",descript:"POSSESSION OF BURGLARY TOOLS",address:"900 Block of MINNA ST",location:{type:"Point",coordinates:[-122.415386041221,37.7747879734156]}}];_.each(f,function(a,b){d.insert(_.extend(a,{x:b}))});var g=d.find({location:{$near:{$geometry:{type:"Point",coordinates:[-122.4154282,37.7746115]},$maxDistance:15}}}).fetch();a.length(g,1),a.equal(g[0].descript,"GRAND THEFT OF PROPERTY");var h=d.find({location:{$near:{$geometry:{type:"Point",coordinates:[-122.4154282,37.7746115]},$maxDistance:20}}}).fetch();a.length(h,4),a.equal(h[0].descript,"GRAND THEFT OF PROPERTY"),a.equal(h[1].descript,"PETTY THEFT FROM LOCKED AUTO"),a.equal(h[2].descript,"POSSESSION OF BURGLARY TOOLS"),a.equal(h[3].descript,"POSS OF PROHIBITED WEAPON"),a["throws"](function(){d.find({location:{$not:{$near:{$geometry:{type:"Point",coordinates:[-122.4154282,37.7746115]},$maxDistance:20}}}})}),a["throws"](function(){d.find({$and:[{location:{$near:{$geometry:{type:"Point",coordinates:[-122.4154282,37.7746115]},$maxDistance:20}}},{x:0}]})}),a["throws"](function(){d.find({$or:[{location:{$near:{$geometry:{type:"Point",coordinates:[-122.4154282,37.7746115]},$maxDistance:20}}},{x:0}]})}),a["throws"](function(){d.find({$nor:[{location:{$near:{$geometry:{type:"Point",coordinates:[-122.4154282,37.7746115]},$maxDistance:1}}},{x:0}]})}),a["throws"](function(){d.find({$and:[{$and:[{location:{$near:{$geometry:{type:"Point",coordinates:[-122.4154282,37.7746115]},$maxDistance:1}}}]}]})}),d=new LocalCollection,d.insert({_id:"x",k:9,a:[{b:[[100,100],[1,1]]},{b:[150,150]}]}),d.insert({_id:"y",k:9,a:{b:[5,5]}});var i=function(b,c,e){a.equal(_.pluck(d.find({
"a.b":{$near:b,$maxDistance:c}}).fetch(),"_id"),e)};i([149,149],4,["x"]),i([149,149],1e3,["x","y"]),i([2,2],1e3,["x","y"]),a.equal(_.pluck(d.find({"a.b":{$near:[1,1]}},{sort:{k:1}}).fetch(),"_id"),["x","y"]),a.equal(_.pluck(d.find({"a.b":{$near:[5,5]}},{sort:{k:1}}).fetch(),"_id"),["y","x"]);var j=[],k=b(j),l=d.find({"a.b":{$near:[7,7]}}).observe(k);a.length(j,2),a.equal(j.shift(),["added",{k:9,a:{b:[5,5]}},0,null]),a.equal(j.shift(),["added",{k:9,a:[{b:[[100,100],[1,1]]},{b:[150,150]}]},1,null]),d.insert({a:{b:[3,3]}}),a.length(j,1),a.equal(j.shift(),["added",{a:{b:[3,3]}},1,"x"]),l.stop()}),Tinytest.add("minimongo - fetch in observe",function(a){var b=new LocalCollection,c=!1,d=b.find().observeChanges({added:function(d,e){c=!0,a.equal(e,{foo:1});var f=b.findOne({foo:1});a.isTrue(f),a.equal(f.foo,1)}});a.isFalse(c);var e=Tracker.autorun(function(a){a.firstRun&&b.insert({foo:1})});a.isTrue(c),d.stop(),e.stop()}),Tinytest.add("minimongo - fine-grained reactivity of observe with fields projection",function(a){var b=new LocalCollection,c="asdf";b.insert({_id:c,foo:{bar:123}});var d=!1,e=b.find(c,{fields:{"foo.bar":1}}).observeChanges({changed:function(){d=!0}});a.isFalse(d),b.update(c,{$set:{"foo.baz":456}}),a.isFalse(d),e.stop()}),Tinytest.add("minimongo - fine-grained reactivity of query with fields projection",function(a){var b=new LocalCollection,c="asdf";b.insert({_id:c,foo:{bar:123}});var d=!1,e=Tracker.autorun(function(){return d=!0,b.findOne(c,{fields:{"foo.bar":1}})});a.isTrue(d),d=!1,b.update(c,{$set:{"foo.baz":456}}),a.isFalse(d),b.update(c,{$set:{"foo.bar":124}}),Tracker.flush(),a.isTrue(d),e.stop()})},{}],7:[function(){LocalCollection._modify=function(d,e,f){if(f=f||{},!isPlainObject(e))throw MinimongoError("Modifier must be an object");var g,h=isOperatorObject(e);if(h)g=EJSON.clone(d),_.each(e,function(d,e){var h=c[e];if(f.isInsert&&"$setOnInsert"===e&&(h=c.$set),!h)throw MinimongoError("Invalid modifier specified "+e);_.each(d,function(c,d){if(""===d)throw MinimongoError("An empty update path is not valid.");if("_id"===d)throw MinimongoError("Mod on _id not allowed");var i=d.split(".");if(!_.all(i,_.identity))throw MinimongoError("The update path '"+d+"' contains an empty field name, which is not allowed.");var j=(_.has(b,e),a(g,i,{noCreate:b[e],forbidArray:"$rename"===e,arrayIndices:f.arrayIndices})),k=i.pop();h(j,k,c,d,g)})});else{if(e._id&&!EJSON.equals(d._id,e._id))throw MinimongoError("Cannot change the _id of a document");for(var i in e)if(/\./.test(i))throw MinimongoError("When replacing document, field name may not contain '.'");g=e}_.each(_.keys(d),function(a){"_id"!==a&&delete d[a]}),_.each(g,function(a,b){d[b]=a})};var a=function(a,b,c){c=c||{};for(var d=!1,e=0;e<b.length;e++){var f=e===b.length-1,g=b[e],h=isIndexable(a);if(!h){if(c.noCreate)return void 0;var i=MinimongoError("cannot use the part '"+g+"' to traverse "+a);throw i.setPropertyError=!0,i}if(a instanceof Array){if(c.forbidArray)return null;if("$"===g){if(d)throw MinimongoError("Too many positional (i.e. '$') elements");if(!c.arrayIndices||!c.arrayIndices.length)throw MinimongoError("The positional operator did not find the match needed from the query");g=c.arrayIndices[0],d=!0}else{if(!isNumericKey(g)){if(c.noCreate)return void 0;throw MinimongoError("can't append to array using string field name ["+g+"]")}g=parseInt(g)}if(f&&(b[e]=g),c.noCreate&&g>=a.length)return void 0;for(;a.length<g;)a.push(null);if(!f)if(a.length===g)a.push({});else if("object"!=typeof a[g])throw MinimongoError("can't modify field '"+b[e+1]+"' of list value "+JSON.stringify(a[g]))}else{if(g.length&&"$"===g.substr(0,1))throw MinimongoError("can't set field named "+g);if(!(g in a)){if(c.noCreate)return void 0;f||(a[g]={})}}if(f)return a;a=a[g]}},b={$unset:!0,$pop:!0,$rename:!0,$pull:!0,$pullAll:!0},c={$inc:function(a,b,c){if("number"!=typeof c)throw MinimongoError("Modifier $inc allowed for numbers only");if(b in a){if("number"!=typeof a[b])throw MinimongoError("Cannot apply $inc modifier to non-number");a[b]+=c}else a[b]=c},$set:function(a,b,c){if(!_.isObject(a)){var d=MinimongoError("Cannot set property on non-object field");throw d.setPropertyError=!0,d}if(null===a){var d=MinimongoError("Cannot set property on null");throw d.setPropertyError=!0,d}a[b]=EJSON.clone(c)},$setOnInsert:function(){},$unset:function(a,b){void 0!==a&&(a instanceof Array?b in a&&(a[b]=null):delete a[b])},$push:function(a,b,c){if(void 0===a[b]&&(a[b]=[]),!(a[b]instanceof Array))throw MinimongoError("Cannot apply $push modifier to non-array");if(!c||!c.$each)return void a[b].push(EJSON.clone(c));var d=c.$each;if(!(d instanceof Array))throw MinimongoError("$each must be an array");var e=void 0;if("$slice"in c){if("number"!=typeof c.$slice)throw MinimongoError("$slice must be a numeric value");if(c.$slice>0)throw MinimongoError("$slice in $push must be zero or negative");e=c.$slice}var f=void 0;if(c.$sort){if(void 0===e)throw MinimongoError("$sort requires $slice to be present");f=new Minimongo.Sorter(c.$sort).getComparator();for(var g=0;g<d.length;g++)if(3!==LocalCollection._f._type(d[g]))throw MinimongoError("$push like modifiers using $sort require all elements to be objects")}for(var h=0;h<d.length;h++)a[b].push(EJSON.clone(d[h]));f&&a[b].sort(f),void 0!==e&&(a[b]=0===e?[]:a[b].slice(e))},$pushAll:function(a,b,c){if(!("object"==typeof c&&c instanceof Array))throw MinimongoError("Modifier $pushAll/pullAll allowed for arrays only");var d=a[b];if(void 0===d)a[b]=c;else{if(!(d instanceof Array))throw MinimongoError("Cannot apply $pushAll modifier to non-array");for(var e=0;e<c.length;e++)d.push(c[e])}},$addToSet:function(a,b,c){var d=!1;if("object"==typeof c)for(var e in c){"$each"===e&&(d=!0);break}var f=d?c.$each:[c],g=a[b];if(void 0===g)a[b]=f;else{if(!(g instanceof Array))throw MinimongoError("Cannot apply $addToSet modifier to non-array");_.each(f,function(a){for(var b=0;b<g.length;b++)if(LocalCollection._f._equal(a,g[b]))return;g.push(EJSON.clone(a))})}},$pop:function(a,b,c){if(void 0!==a){var d=a[b];if(void 0!==d){if(!(d instanceof Array))throw MinimongoError("Cannot apply $pop modifier to non-array");"number"==typeof c&&0>c?d.splice(0,1):d.pop()}}},$pull:function(a,b,c){if(void 0!==a){var d=a[b];if(void 0!==d){if(!(d instanceof Array))throw MinimongoError("Cannot apply $pull/pullAll modifier to non-array");var e=[];if("object"!=typeof c||c instanceof Array)for(var f=0;f<d.length;f++)LocalCollection._f._equal(d[f],c)||e.push(d[f]);else for(var g=new Minimongo.Matcher(c),f=0;f<d.length;f++)g.documentMatches(d[f]).result||e.push(d[f]);a[b]=e}}},$pullAll:function(a,b,c){if(!("object"==typeof c&&c instanceof Array))throw MinimongoError("Modifier $pushAll/pullAll allowed for arrays only");if(void 0!==a){var d=a[b];if(void 0!==d){if(!(d instanceof Array))throw MinimongoError("Cannot apply $pull/pullAll modifier to non-array");for(var e=[],f=0;f<d.length;f++){for(var g=!1,h=0;h<c.length;h++)if(LocalCollection._f._equal(d[f],c[h])){g=!0;break}g||e.push(d[f])}a[b]=e}}},$rename:function(b,c,d,e,f){if(e===d)throw MinimongoError("$rename source must differ from target");if(null===b)throw MinimongoError("$rename source field invalid");if("string"!=typeof d)throw MinimongoError("$rename target must be a string");if(void 0!==b){var g=b[c];delete b[c];var h=d.split("."),i=a(f,h,{forbidArray:!0});if(null===i)throw MinimongoError("$rename target field invalid");var j=h.pop();i[j]=g}},$bit:function(){throw MinimongoError("$bit is not supported")}}},{}],8:[function(){LocalCollection._looksLikeObjectID=function(a){return 24===a.length&&a.match(/^[0-9a-f]*$/)},LocalCollection._ObjectID=function(a){var b=this;if(a){if(a=a.toLowerCase(),!LocalCollection._looksLikeObjectID(a))throw new Error("Invalid hexadecimal string for creating an ObjectID");b._str=a}else b._str=Random.hexString(24)},LocalCollection._ObjectID.prototype.toString=function(){var a=this;return'ObjectID("'+a._str+'")'},LocalCollection._ObjectID.prototype.equals=function(a){var b=this;return a instanceof LocalCollection._ObjectID&&b.valueOf()===a.valueOf()},LocalCollection._ObjectID.prototype.clone=function(){var a=this;return new LocalCollection._ObjectID(a._str)},LocalCollection._ObjectID.prototype.typeName=function(){return"oid"},LocalCollection._ObjectID.prototype.getTimestamp=function(){var a=this;return parseInt(a._str.substr(0,8),16)},LocalCollection._ObjectID.prototype.valueOf=LocalCollection._ObjectID.prototype.toJSONValue=LocalCollection._ObjectID.prototype.toHexString=function(){return this._str},LocalCollection._selectorIsId=function(a){return"string"==typeof a||"number"==typeof a||a instanceof LocalCollection._ObjectID},LocalCollection._selectorIsIdPerhapsAsObject=function(a){return LocalCollection._selectorIsId(a)||a&&"object"==typeof a&&a._id&&LocalCollection._selectorIsId(a._id)&&1===_.size(a)},LocalCollection._idsMatchedBySelector=function(a){if(LocalCollection._selectorIsId(a))return[a];if(!a)return null;if(_.has(a,"_id"))return LocalCollection._selectorIsId(a._id)?[a._id]:a._id&&a._id.$in&&_.isArray(a._id.$in)&&!_.isEmpty(a._id.$in)&&_.all(a._id.$in,LocalCollection._selectorIsId)?a._id.$in:null;if(a.$and&&_.isArray(a.$and))for(var b=0;b<a.$and.length;++b){var c=LocalCollection._idsMatchedBySelector(a.$and[b]);if(c)return c}return null},EJSON.addType("oid",function(a){return new LocalCollection._ObjectID(a)})},{}],9:[function(){LocalCollection._CachingChangeObserver=function(a){var b=this;a=a||{};var c=a.callbacks&&LocalCollection._observeChangesCallbacksAreOrdered(a.callbacks);if(_.has(a,"ordered")){if(b.ordered=a.ordered,a.callbacks&&a.ordered!==c)throw Error("ordered option doesn't match callbacks")}else{if(!a.callbacks)throw Error("must provide ordered or callbacks");b.ordered=c}var d=a.callbacks||{};b.ordered?(b.docs=new OrderedDict(LocalCollection._idStringify),b.applyChange={addedBefore:function(a,c,e){var f=EJSON.clone(c);f._id=a,d.addedBefore&&d.addedBefore.call(b,a,c,e),d.added&&d.added.call(b,a,c),b.docs.putBefore(a,f,e||null)},movedBefore:function(a,c){b.docs.get(a);d.movedBefore&&d.movedBefore.call(b,a,c),b.docs.moveBefore(a,c||null)}}):(b.docs=new LocalCollection._IdMap,b.applyChange={added:function(a,c){var e=EJSON.clone(c);d.added&&d.added.call(b,a,c),e._id=a,b.docs.set(a,e)}}),b.applyChange.changed=function(a,c){var e=b.docs.get(a);if(!e)throw new Error("Unknown id for changed: "+a);d.changed&&d.changed.call(b,a,EJSON.clone(c)),LocalCollection._applyChanges(e,c)},b.applyChange.removed=function(a){d.removed&&d.removed.call(b,a),b.docs.remove(a)}},LocalCollection._observeFromObserveChanges=function(a,b){var c,d=a.getTransform()||function(a){return a},e=!!b._suppress_initial;if(LocalCollection._observeCallbacksAreOrdered(b)){var f=!b._no_indices;c={addedBefore:function(a,c,g){var h=this;if(!e&&(b.addedAt||b.added)){var i=d(_.extend(c,{_id:a}));if(b.addedAt){var j=f?g?h.docs.indexOf(g):h.docs.size():-1;b.addedAt(i,j,g)}else b.added(i)}},changed:function(a,c){var e=this;if(b.changedAt||b.changed){var g=EJSON.clone(e.docs.get(a));if(!g)throw new Error("Unknown id for changed: "+a);var h=d(EJSON.clone(g));if(LocalCollection._applyChanges(g,c),g=d(g),b.changedAt){var i=f?e.docs.indexOf(a):-1;b.changedAt(g,h,i)}else b.changed(g,h)}},movedBefore:function(a,c){var e=this;if(b.movedTo){var g=f?e.docs.indexOf(a):-1,h=f?c?e.docs.indexOf(c):e.docs.size():-1;h>g&&--h,b.movedTo(d(EJSON.clone(e.docs.get(a))),g,h,c||null)}},removed:function(a){var c=this;if(b.removedAt||b.removed){var e=d(c.docs.get(a));if(b.removedAt){var g=f?c.docs.indexOf(a):-1;b.removedAt(e,g)}else b.removed(e)}}}}else c={added:function(a,c){if(!e&&b.added){var f=_.extend(c,{_id:a});b.added(d(f))}},changed:function(a,c){var e=this;if(b.changed){var f=e.docs.get(a),g=EJSON.clone(f);LocalCollection._applyChanges(g,c),b.changed(d(g),d(EJSON.clone(f)))}},removed:function(a){var c=this;b.removed&&b.removed(d(c.docs.get(a)))}};var g=new LocalCollection._CachingChangeObserver({callbacks:c}),h=a.observeChanges(g.applyChange);return e=!1,h}},{}],10:[function(){Package.describe({summary:"Meteor's client-side datastore: a port of MongoDB to Javascript",version:"1.0.8"}),Package.onUse(function(a){a["export"]("LocalCollection"),a["export"]("Minimongo"),a["export"]("MinimongoTest",{testOnly:!0}),a.use(["underscore","json","ejson","id-map","ordered-dict","tracker","random","ordered-dict"]),a.use("geojson-utils"),a.addFiles(["minimongo.js","wrap_transform.js","helpers.js","selector.js","sort.js","projection.js","modify.js","diff.js","id_map.js","observe.js","objectid.js"]),a.addFiles(["selector_projection.js","selector_modifier.js","sorter_projection.js"],"server")}),Package.onTest(function(a){a.use("minimongo",["client","server"]),a.use("test-helpers","client"),a.use(["tinytest","underscore","ejson","ordered-dict","random","tracker","reactive-var"]),a.addFiles("minimongo_tests.js","client"),a.addFiles("wrap_transform_tests.js"),a.addFiles("minimongo_server_tests.js","server")})},{}],11:[function(){LocalCollection._compileProjection=function(a){LocalCollection._checkSupportedProjection(a);var b=_.isUndefined(a._id)?!0:a._id,c=projectionDetails(a),d=function(a,b){if(_.isArray(a))return _.map(a,function(a){return d(a,b)});var e=c.including?{}:EJSON.clone(a);return _.each(b,function(b,f){_.has(a,f)&&(_.isObject(b)?_.isObject(a[f])&&(e[f]=d(a[f],b)):c.including?e[f]=EJSON.clone(a[f]):delete e[f])}),e};return function(a){var e=d(a,c.tree);return b&&_.has(a,"_id")&&(e._id=a._id),!b&&_.has(e,"_id")&&delete e._id,e}},projectionDetails=function(a){var b=_.keys(a).sort();b.length>0&&(1!==b.length||"_id"!==b[0])&&(b=_.reject(b,function(a){return"_id"===a}));var c=null;_.each(b,function(b){var d=!!a[b];if(null===c&&(c=d),c!==d)throw MinimongoError("You cannot currently mix including and excluding fields.")});var d=pathsToTree(b,function(){return c},function(a,b,c){var d=c,e=b;throw MinimongoError("both "+d+" and "+e+" found in fields option, using both of them may trigger unexpected behavior. Did you mean to use only one of them?")});return{tree:d,including:c}},pathsToTree=function(a,b,c,d){return d=d||{},_.each(a,function(a){var e=d,f=a.split("."),g=_.all(f.slice(0,-1),function(b,d){if(_.has(e,b)){if(!_.isObject(e[b])&&(e[b]=c(e[b],f.slice(0,d+1).join("."),a),!_.isObject(e[b])))return!1}else e[b]={};return e=e[b],!0});if(g){var h=_.last(f);e[h]=_.has(e,h)?c(e[h],a,a):b(a)}}),d},LocalCollection._checkSupportedProjection=function(a){if(!_.isObject(a)||_.isArray(a))throw MinimongoError("fields option must be an object");_.each(a,function(a,b){if(_.contains(b.split("."),"$"))throw MinimongoError("Minimongo doesn't support $ operator in projections yet.");if(-1===_.indexOf([1,0,!0,!1],a))throw MinimongoError("Projection values should be one of 1, 0, true, or false")})}},{}],12:[function(){Minimongo.Matcher=function(a){var b=this;b._paths={},b._hasGeoQuery=!1,b._hasWhere=!1,b._isSimple=!0,b._matchingDocument=void 0,b._selector=null,b._docMatcher=b._compileSelector(a)},_.extend(Minimongo.Matcher.prototype,{documentMatches:function(a){if(!a||"object"!=typeof a)throw Error("documentMatches needs a document");return this._docMatcher(a)},hasGeoQuery:function(){return this._hasGeoQuery},hasWhere:function(){return this._hasWhere},isSimple:function(){return this._isSimple},_compileSelector:function(b){var c=this;if(b instanceof Function)return c._isSimple=!1,c._selector=b,c._recordPathUsed(""),function(a){return{result:!!b.call(a)}};if(LocalCollection._selectorIsId(b))return c._selector={_id:b},c._recordPathUsed("_id"),function(a){return{result:EJSON.equals(a._id,b)}};if(!b||"_id"in b&&!b._id)return c._isSimple=!1,l;if("boolean"==typeof b||isArray(b)||EJSON.isBinary(b))throw new Error("Invalid selector: "+b);return c._selector=EJSON.clone(b),a(b,c,{isRoot:!0})},_recordPathUsed:function(a){this._paths[a]=!0},_getPaths:function(){return _.keys(this._paths)}});var a=function(a,c,d){d=d||{};var e=[];return _.each(a,function(a,g){if("$"===g.substr(0,1)){if(!_.has(f,g))throw new Error("Unrecognized logical operator: "+g);c._isSimple=!1,e.push(f[g](a,c,d.inElemMatch))}else{d.inElemMatch||c._recordPathUsed(g);var h=makeLookupFunction(g),i=b(a,c,d.isRoot);e.push(function(a){var b=h(a);return i(b)})}}),o(e)},b=function(a,b,e){return a instanceof RegExp?(b._isSimple=!1,c(regexpElementMatcher(a))):isOperatorObject(a)?d(a,b,e):c(equalityElementMatcher(a))},c=function(a,b){return b=b||{},function(c){var d=c;b.dontExpandLeafArrays||(d=expandArraysInBranches(c,b.dontIncludeLeafArrays));var e={};return e.result=_.any(d,function(b){var c=a(b.value);return"number"==typeof c&&(b.arrayIndices||(b.arrayIndices=[c]),c=!0),c&&b.arrayIndices&&(e.arrayIndices=b.arrayIndices),c}),e}};regexpElementMatcher=function(a){return function(b){return b instanceof RegExp?_.isEqual(b,a):"string"!=typeof b?!1:(a.lastIndex=0,a.test(b))}},equalityElementMatcher=function(a){if(isOperatorObject(a))throw Error("Can't create equalityValueSelector for operator object");return null==a?function(a){return null==a}:function(b){return LocalCollection._f._equal(a,b)}};var d=function(a,b,d){var e=[];return _.each(a,function(f,g){var i=_.contains(["$lt","$lte","$gt","$gte"],g)&&_.isNumber(f),j="$ne"===g&&!_.isObject(f),k=_.contains(["$in","$nin"],g)&&_.isArray(f)&&!_.any(f,_.isObject);if("$eq"===g||i||k||j||(b._isSimple=!1),_.has(h,g))e.push(h[g](f,a,b,d));else{if(!_.has(ELEMENT_OPERATORS,g))throw new Error("Unrecognized operator: "+g);var l=ELEMENT_OPERATORS[g];e.push(c(l.compileElementSelector(f,a,b),l))}}),p(e)},e=function(b,c,d){if(!isArray(b)||_.isEmpty(b))throw Error("$and/$or/$nor must be nonempty array");return _.map(b,function(b){if(!isPlainObject(b))throw Error("$or/$and/$nor entries need to be full objects");return a(b,c,{inElemMatch:d})})},f={$and:function(a,b,c){var d=e(a,b,c);return o(d)},$or:function(a,b,c){var d=e(a,b,c);return 1===d.length?d[0]:function(a){var b=_.any(d,function(b){return b(a).result});return{result:b}}},$nor:function(a,b,c){var d=e(a,b,c);return function(a){var b=_.all(d,function(b){return!b(a).result});return{result:b}}},$where:function(a,b){return b._recordPathUsed(""),b._hasWhere=!0,a instanceof Function||(a=Function("obj","return "+a)),function(b){return{result:a.call(b,b)}}},$comment:function(){return function(){return{result:!0}}}},g=function(a){return function(b){var c=a(b);return{result:!c.result}}},h={$not:function(a,c,d){return g(b(a,d))},$ne:function(a){return g(c(equalityElementMatcher(a)))},$nin:function(a){return g(c(ELEMENT_OPERATORS.$in.compileElementSelector(a)))},$exists:function(a){var b=c(function(a){return void 0!==a});return a?b:g(b)},$options:function(a,b){if(!_.has(b,"$regex"))throw Error("$options needs a $regex");return m},$maxDistance:function(a,b){if(!b.$near)throw Error("$maxDistance needs a $near");return m},$all:function(a,c,d){if(!isArray(a))throw Error("$all requires array");if(_.isEmpty(a))return l;var e=[];return _.each(a,function(a){if(isOperatorObject(a))throw Error("no $ expressions in $all");e.push(b(a,d))}),p(e)},$near:function(a,b,c,d){if(!d)throw Error("$near can't be inside another $ operator");c._hasGeoQuery=!0;var e,f,g;if(isPlainObject(a)&&_.has(a,"$geometry"))e=a.$maxDistance,f=a.$geometry,g=function(a){return a&&a.type?"Point"===a.type?GeoJSON.pointDistance(f,a):GeoJSON.geometryWithinRadius(a,f,e)?0:e+1:null};else{if(e=b.$maxDistance,!isArray(a)&&!isPlainObject(a))throw Error("$near argument must be coordinate pair or GeoJSON");f=j(a),g=function(a){return isArray(a)||isPlainObject(a)?i(f,a):null}}return function(a){a=expandArraysInBranches(a);var b={result:!1};return _.each(a,function(a){var c=g(a.value);null===c||c>e||void 0!==b.distance&&b.distance<=c||(b.result=!0,b.distance=c,a.arrayIndices?b.arrayIndices=a.arrayIndices:delete b.arrayIndices)}),b}}},i=function(a,b){a=j(a),b=j(b);var c=a[0]-b[0],d=a[1]-b[1];return _.isNaN(c)||_.isNaN(d)?null:Math.sqrt(c*c+d*d)},j=function(a){return _.map(a,_.identity)},k=function(a){return{compileElementSelector:function(b){if(isArray(b))return function(){return!1};void 0===b&&(b=null);var c=LocalCollection._f._type(b);return function(d){return void 0===d&&(d=null),LocalCollection._f._type(d)!==c?!1:a(LocalCollection._f._cmp(d,b))}}}};ELEMENT_OPERATORS={$lt:k(function(a){return 0>a}),$gt:k(function(a){return a>0}),$lte:k(function(a){return 0>=a}),$gte:k(function(a){return a>=0}),$mod:{compileElementSelector:function(a){if(!isArray(a)||2!==a.length||"number"!=typeof a[0]||"number"!=typeof a[1])throw Error("argument to $mod must be an array of two numbers");var b=a[0],c=a[1];return function(a){return"number"==typeof a&&a%b===c}}},$in:{compileElementSelector:function(a){if(!isArray(a))throw Error("$in needs an array");var b=[];return _.each(a,function(a){if(a instanceof RegExp)b.push(regexpElementMatcher(a));else{if(isOperatorObject(a))throw Error("cannot nest $ under $in");b.push(equalityElementMatcher(a))}}),function(a){return void 0===a&&(a=null),_.any(b,function(b){return b(a)})}}},$size:{dontExpandLeafArrays:!0,compileElementSelector:function(a){if("string"==typeof a)a=0;else if("number"!=typeof a)throw Error("$size needs a number");return function(b){return isArray(b)&&b.length===a}}},$type:{dontIncludeLeafArrays:!0,compileElementSelector:function(a){if("number"!=typeof a)throw Error("$type needs a number");return function(b){return void 0!==b&&LocalCollection._f._type(b)===a}}},$regex:{compileElementSelector:function(a,b){if(!("string"==typeof a||a instanceof RegExp))throw Error("$regex has to be a string or RegExp");var c;if(void 0!==b.$options){if(/[^gim]/.test(b.$options))throw new Error("Only the i, m, and g regexp options are supported");var d=a instanceof RegExp?a.source:a;c=new RegExp(d,b.$options)}else c=a instanceof RegExp?a:new RegExp(a);return regexpElementMatcher(c)}},$elemMatch:{dontExpandLeafArrays:!0,compileElementSelector:function(c,d,e){if(!isPlainObject(c))throw Error("$elemMatch need an object");var f,g;return isOperatorObject(c,!0)?(f=b(c,e),g=!1):(f=a(c,e,{inElemMatch:!0}),g=!0),function(a){if(!isArray(a))return!1;for(var b=0;b<a.length;++b){var c,d=a[b];if(g){if(!isPlainObject(d)&&!isArray(d))return!1;c=d}else c=[{value:d,dontIterate:!0}];if(f(c).result)return b}return!1}}}},makeLookupFunction=function(a,b){b=b||{};var c,d=a.split("."),e=d.length?d[0]:"",f=isNumericKey(e),g=d.length>=2&&isNumericKey(d[1]);d.length>1&&(c=makeLookupFunction(d.slice(1).join(".")));var h=function(a){return a.dontIterate||delete a.dontIterate,a.arrayIndices&&!a.arrayIndices.length&&delete a.arrayIndices,a};return function(a,d){if(d||(d=[]),isArray(a)){if(!(f&&e<a.length))return[];d=d.concat(+e,"x")}var i=a[e];if(!c)return[h({value:i,dontIterate:isArray(a)&&isArray(i),arrayIndices:d})];if(!isIndexable(i))return isArray(a)?[]:[h({value:void 0,arrayIndices:d})];var j=[],k=function(a){Array.prototype.push.apply(j,a)};return k(c(i,d)),!isArray(i)||g&&b.forSort||_.each(i,function(a,b){isPlainObject(a)&&k(c(a,d.concat(b)))}),j}},MinimongoTest.makeLookupFunction=makeLookupFunction,expandArraysInBranches=function(a,b){var c=[];return _.each(a,function(a){var d=isArray(a.value);b&&d&&!a.dontIterate||c.push({value:a.value,arrayIndices:a.arrayIndices}),d&&!a.dontIterate&&_.each(a.value,function(b,d){c.push({value:b,arrayIndices:(a.arrayIndices||[]).concat(d)})})}),c};var l=function(){return{result:!1}},m=function(){return{result:!0}},n=function(a){return 0===a.length?m:1===a.length?a[0]:function(b){var c={};return c.result=_.all(a,function(a){var d=a(b);return d.result&&void 0!==d.distance&&void 0===c.distance&&(c.distance=d.distance),d.result&&d.arrayIndices&&(c.arrayIndices=d.arrayIndices),d.result}),c.result||(delete c.distance,delete c.arrayIndices),c}},o=n,p=n;LocalCollection._f={_type:function(a){return"number"==typeof a?1:"string"==typeof a?2:"boolean"==typeof a?8:isArray(a)?4:null===a?10:a instanceof RegExp?11:"function"==typeof a?13:a instanceof Date?9:EJSON.isBinary(a)?5:a instanceof LocalCollection._ObjectID?7:3},_equal:function(a,b){return EJSON.equals(a,b,{keyOrderSensitive:!0})},_typeorder:function(a){return[-1,1,2,3,4,5,-1,6,7,8,0,9,-1,100,2,100,1,8,1][a]},_cmp:function(a,b){if(void 0===a)return void 0===b?0:-1;if(void 0===b)return 1;var c=LocalCollection._f._type(a),d=LocalCollection._f._type(b),e=LocalCollection._f._typeorder(c),f=LocalCollection._f._typeorder(d);if(e!==f)return f>e?-1:1;if(c!==d)throw Error("Missing type coercion logic in _cmp");if(7===c&&(c=d=2,a=a.toHexString(),b=b.toHexString()),9===c&&(c=d=1,a=a.getTime(),b=b.getTime()),1===c)return a-b;if(2===d)return b>a?-1:a===b?0:1;if(3===c){var g=function(a){var b=[];for(var c in a)b.push(c),b.push(a[c]);return b};return LocalCollection._f._cmp(g(a),g(b))}if(4===c)for(var h=0;;h++){if(h===a.length)return h===b.length?0:-1;if(h===b.length)return 1;var i=LocalCollection._f._cmp(a[h],b[h]);if(0!==i)return i}if(5===c){if(a.length!==b.length)return a.length-b.length;for(h=0;h<a.length;h++){if(a[h]<b[h])return-1;if(a[h]>b[h])return 1}return 0}if(8===c)return a?b?0:1:b?-1:0;if(10===c)return 0;if(11===c)throw Error("Sorting not supported on regular expression");if(13===c)throw Error("Sorting not supported on Javascript code");throw Error("Unknown type to sort")}},LocalCollection._removeDollarOperators=function(a){var b={};for(var c in a)"$"!==c.substr(0,1)&&(b[c]=a[c]);return b}},{}],13:[function(){Minimongo.Matcher.prototype.affectedByModifier=function(a){var b=this;a=_.extend({$set:{},$unset:{}},a);var c=_.keys(a.$set).concat(_.keys(a.$unset)),d=b._getPaths();return _.any(c,function(a){var b=a.split(".");return _.any(d,function(a){for(var c=a.split("."),d=0,e=0;d<c.length&&e<b.length;)if(isNumericKey(c[d])&&isNumericKey(b[e])){if(c[d]!==b[e])return!1;d++,e++}else{if(isNumericKey(c[d]))return!1;if(isNumericKey(b[e]))e++;else{if(c[d]!==b[e])return!1;d++,e++}}return!0})})},Minimongo.Sorter.prototype.affectedByModifier=function(a){var b=this;return b._selectorForAffectedByModifier.affectedByModifier(a)},Minimongo.Matcher.prototype.canBecomeTrueByModifier=function(a){var d=this;if(!this.affectedByModifier(a))return!1;a=_.extend({$set:{},$unset:{}},a);var e=_.keys(a.$set).concat(_.keys(a.$unset));if(!d.isSimple())return!0;if(_.any(d._getPaths(),b)||_.any(e,b))return!0;var f=_.any(d._selector,function(a,b){return isOperatorObject(a)?_.any(e,function(a){return c(a,b+".")}):!1});if(f)return!1;var g=EJSON.clone(d.matchingDocument());if(null===g)return!0;try{LocalCollection._modify(g,a)}catch(h){if("MinimongoError"===h.name&&h.setPropertyError)return!1;throw h}return d.documentMatches(g).result},Minimongo.Matcher.prototype.matchingDocument=function(){var b=this;if(void 0!==b._matchingDocument)return b._matchingDocument;var c=!1;return b._matchingDocument=pathsToTree(b._getPaths(),function(d){var e=b._selector[d];if(isOperatorObject(e)){if(e.$in){var f=new Minimongo.Matcher({placeholder:e});return _.find(e.$in,function(a){return f.documentMatches({placeholder:a}).result})}if(a(e,["$gt","$gte","$lt","$lte"])){var g=-(1/0),h=1/0;_.each(["$lte","$lt"],function(a){_.has(e,a)&&e[a]<h&&(h=e[a])}),_.each(["$gte","$gt"],function(a){_.has(e,a)&&e[a]>g&&(g=e[a])});var i=(g+h)/2,f=new Minimongo.Matcher({placeholder:e});return f.documentMatches({placeholder:i}).result||i!==g&&i!==h||(c=!0),i}if(a(e,["$nin"," $ne"]))return{};c=!0}return b._selector[d]},_.identity),c&&(b._matchingDocument=null),b._matchingDocument};var a=function(a,b){return _.all(a,function(a,c){return _.contains(b,c)})},b=function(a){return _.any(a.split("."),isNumericKey)},c=function(a,b){return a.length>=b.length&&a.substring(0,b.length)===b}},{}],14:[function(){Minimongo.Matcher.prototype.combineIntoProjection=function(a){var b=this,c=Minimongo._pathsElidingNumericKeys(b._getPaths());return _.contains(c,"")?{}:combineImportantPathsIntoProjection(c,a)},Minimongo._pathsElidingNumericKeys=function(a){return _.map(a,function(a){return _.reject(a.split("."),isNumericKey).join(".")})},combineImportantPathsIntoProjection=function(b,c){var d=projectionDetails(c),e=d.tree,f={};if(e=pathsToTree(b,function(){return!0},function(){return!0},e),f=a(e),d.including)return f;var g={};return _.each(f,function(a,b){a||(g[b]=!1)}),g};var a=function(b,c){c=c||"";var d={};return _.each(b,function(b,e){_.isObject(b)?_.extend(d,a(b,c+e+".")):d[c+e]=b}),d}},{}],15:[function(){Minimongo.Sorter=function(b,c){var d=this;c=c||{},d._sortSpecParts=[];var e=function(a,b){if(!a)throw Error("sort keys must be non-empty");if("$"===a.charAt(0))throw Error("unsupported sort key: "+a);d._sortSpecParts.push({path:a,lookup:makeLookupFunction(a,{forSort:!0}),ascending:b})};if(b instanceof Array)for(var f=0;f<b.length;f++)"string"==typeof b[f]?e(b[f],!0):e(b[f][0],"desc"!==b[f][1]);else{if("object"!=typeof b)throw Error("Bad sort specification: "+JSON.stringify(b));_.each(b,function(a,b){e(b,a>=0)})}if(d.affectedByModifier){var g={};_.each(d._sortSpecParts,function(a){g[a.path]=1}),d._selectorForAffectedByModifier=new Minimongo.Matcher(g)}d._keyComparator=a(_.map(d._sortSpecParts,function(a,b){return d._keyFieldComparator(b)})),d._keyFilter=null,c.matcher&&d._useWithMatcher(c.matcher)},_.extend(Minimongo.Sorter.prototype,{getComparator:function(b){var c=this;if(!b||!b.distances)return c._getBaseComparator();var d=b.distances;return a([c._getBaseComparator(),function(a,b){if(!d.has(a._id))throw Error("Missing distance for "+a._id);if(!d.has(b._id))throw Error("Missing distance for "+b._id);return d.get(a._id)-d.get(b._id)}])},_getPaths:function(){var a=this;return _.pluck(a._sortSpecParts,"path")},_getMinKeyFromDoc:function(a){var b=this,c=null;if(b._generateKeysFromDoc(a,function(a){return b._keyCompatibleWithSelector(a)?null===c?void(c=a):void(b._compareKeys(a,c)<0&&(c=a)):void 0}),null===c)throw Error("sort selector found no keys in doc?");return c},_keyCompatibleWithSelector:function(a){var b=this;return!b._keyFilter||b._keyFilter(a)},_generateKeysFromDoc:function(a,b){var c=this;if(0===c._sortSpecParts.length)throw new Error("can't generate keys without a spec");var d=[],e=function(a){return a.join(",")+","},f=null;if(_.each(c._sortSpecParts,function(b,c){var g=expandArraysInBranches(b.lookup(a),!0);g.length||(g=[{value:null}]);var h=!1;if(d[c]={},_.each(g,function(a){if(!a.arrayIndices){if(g.length>1)throw Error("multiple branches but no array used?");return void(d[c][""]=a.value)}h=!0;var b=e(a.arrayIndices);if(_.has(d[c],b))throw Error("duplicate path: "+b);if(d[c][b]=a.value,f&&!_.has(f,b))throw Error("cannot index parallel arrays")}),f){if(!_.has(d[c],"")&&_.size(f)!==_.size(d[c]))throw Error("cannot index parallel arrays!")}else h&&(f={},_.each(d[c],function(a,b){f[b]=!0}))}),!f){var g=_.map(d,function(a){if(!_.has(a,""))throw Error("no value in sole key case?");return a[""]});return void b(g)}_.each(f,function(a,c){var e=_.map(d,function(a){if(_.has(a,""))return a[""];if(!_.has(a,c))throw Error("missing path?");return a[c]});b(e)})},_compareKeys:function(a,b){var c=this;if(a.length!==c._sortSpecParts.length||b.length!==c._sortSpecParts.length)throw Error("Key has wrong length");return c._keyComparator(a,b)},_keyFieldComparator:function(a){var b=this,c=!b._sortSpecParts[a].ascending;return function(b,d){var e=LocalCollection._f._cmp(b[a],d[a]);return c&&(e=-e),e}},_getBaseComparator:function(){var a=this;return a._sortSpecParts.length?function(b,c){var d=a._getMinKeyFromDoc(b),e=a._getMinKeyFromDoc(c);return a._compareKeys(d,e)}:function(){return 0}},_useWithMatcher:function(a){var b=this;if(b._keyFilter)throw Error("called _useWithMatcher twice?");if(!_.isEmpty(b._sortSpecParts)){var c=a._selector;if(!(c instanceof Function)){var d={};_.each(b._sortSpecParts,function(a){d[a.path]=[]}),_.each(c,function(a,b){var c=d[b];if(c){if(a instanceof RegExp){if(a.ignoreCase||a.multiline)return;return void c.push(regexpElementMatcher(a))}return isOperatorObject(a)?void _.each(a,function(b,d){_.contains(["$lt","$lte","$gt","$gte"],d)&&c.push(ELEMENT_OPERATORS[d].compileElementSelector(b)),"$regex"!==d||a.$options||c.push(ELEMENT_OPERATORS.$regex.compileElementSelector(b,a));

}):void c.push(equalityElementMatcher(a))}}),_.isEmpty(d[b._sortSpecParts[0].path])||(b._keyFilter=function(a){return _.all(b._sortSpecParts,function(b,c){return _.all(d[b.path],function(b){return b(a[c])})})})}}}});var a=function(a){return function(b,c){for(var d=0;d<a.length;++d){var e=a[d](b,c);if(0!==e)return e}return 0}}},{}],16:[function(){Minimongo.Sorter.prototype.combineIntoProjection=function(a){var b=this,c=Minimongo._pathsElidingNumericKeys(b._getPaths());return combineImportantPathsIntoProjection(c,a)}},{}],17:[function(){LocalCollection.wrapTransform=function(a){if(!a)return null;if(a.__wrappedTransform__)return a;var b=function(b){if(!_.has(b,"_id"))throw new Error("can only transform documents with _id");var c=b._id,d=Tracker.nonreactive(function(){return a(b)});if(!isPlainObject(d))throw new Error("transform must return object");if(_.has(d,"_id")){if(!EJSON.equals(d._id,c))throw new Error("transformed document can't have different _id")}else d._id=c;return d};return b.__wrappedTransform__=!0,b}},{}],18:[function(){Tinytest.add("minimongo - wrapTransform",function(a){var b=LocalCollection.wrapTransform;a.isFalse(b(void 0)),a.isFalse(b(null));var c=function(a){return delete a.x,a.y=42,a.z=function(){return 43},a},d=b(c)({_id:"asdf",x:54});a.equal(_.keys(d),["_id","y","z"]),a.equal(d.y,42),a.equal(d.z(),43);var e=new LocalCollection._ObjectID,f=new LocalCollection._ObjectID(e.toHexString());a.equal(b(function(){return{_id:f}})({_id:e}),{_id:f});var g=["asdf",new LocalCollection._ObjectID,!1,null,!0,27,[123],/adsf/,new Date,function(){},void 0];_.each(g,function(c){var d=b(function(){return c});a["throws"](function(){d({_id:"asdf"})})},/transform must return object/);var h=b(function(a){return a._id="x",a});a["throws"](function(){h({_id:"y"})},/can't have different _id/),a.equal({_id:"a",x:2},b(function(a){return delete a._id,a})({_id:"a",x:2}));var i=function(b){return a.isFalse(Tracker.active),b},j=Tracker.autorun(function(){a.isTrue(Tracker.active),b(i)({_id:"xxx"})});j.stop()})},{}]},{},[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18]);